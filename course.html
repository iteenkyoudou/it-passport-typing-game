<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Segoe UI','Hiragino Sans','Meiryo',sans-serif;
  background:#000;color:#fff;min-height:100vh;line-height:1.7;
  padding-left:220px;
}
button{cursor:pointer;font-family:inherit}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#111}
::-webkit-scrollbar-thumb{background:#555;border-radius:3px}

/* ===== DQÈ¢®Êû† ===== */
.dq-box{background:#000;border:2px solid #fff;border-radius:8px;padding:16px}

/* ===== „Ç¢„Ç´„Ç¶„É≥„ÉàÂêçÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ ===== */
.account-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.9);z-index:9999;
  display:flex;align-items:center;justify-content:center;
}
.account-modal.hidden{display:none}
.account-modal-content{
  background:#000;border:3px solid #ffd700;border-radius:12px;
  padding:32px;max-width:400px;width:90%;text-align:center;
  animation:modalAppear .4s ease;
}
@keyframes modalAppear{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
.account-modal-title{
  font-size:1.5rem;font-weight:bold;color:#ffd700;margin-bottom:12px;
}
.account-modal-desc{
  font-size:.9rem;color:#ccc;line-height:1.7;margin-bottom:24px;
}
.account-input{
  width:100%;padding:12px 16px;font-size:1rem;
  background:#111;border:2px solid #666;border-radius:8px;
  color:#fff;font-family:inherit;margin-bottom:20px;
  transition:border-color .2s;
}
.account-input:focus{outline:none;border-color:#ffd700}
.account-login-btn{
  width:100%;padding:14px;font-size:1rem;font-weight:bold;
  background:#ffd700;color:#000;border:none;border-radius:8px;
  cursor:pointer;transition:all .2s;
}
.account-login-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(255,215,0,.4)}
.account-login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* ===== „Çµ„Ç§„Éâ„Éë„Éç„É´ ===== */
.side-panel{
  position:fixed;left:0;top:0;width:220px;height:100vh;
  background:#000;border-right:2px solid #888;z-index:101;
  padding:20px 16px;overflow-y:auto;
  display:flex;flex-direction:column;gap:16px;
}
.sp-account-name{
  font-size:1rem;font-weight:bold;color:#fff;text-align:center;
  padding:8px 0 4px;
}
.sp-account-title{
  font-size:.75rem;color:#ffd700;text-align:center;
  padding-bottom:8px;
}
.sp-logout-btn{
  display:block;margin:4px auto 0;padding:4px 16px;font-size:.7rem;
  background:transparent;color:#999;border:1px solid #555;border-radius:8px;
  cursor:pointer;transition:all .2s;
}
.sp-logout-btn:hover{color:#fff;border-color:#e57373;background:rgba(229,115,115,.15)}
.sp-section{text-align:center}
.sp-level-label{font-size:.65rem;color:#aaa;letter-spacing:2px;text-transform:uppercase}
.sp-level-num{font-size:2.8rem;font-weight:bold;color:#fff;line-height:1.1}
.sp-bar{width:100%;height:8px;background:#222;border-radius:4px;overflow:hidden;margin:6px 0 4px}
.sp-bar-fill{height:100%;border-radius:4px;transition:width .6s ease}
.sp-bar-fill.exp-fill{background:linear-gradient(90deg,#7ecfff,#4fc3f7)}
.sp-bar-fill.cur-fill{background:linear-gradient(90deg,#4caf50,#66bb6a)}
.sp-bar-text{font-size:.65rem;color:#777}
.sp-row{display:flex;justify-content:space-between;align-items:center;padding:2px 0}
.sp-label{font-size:.7rem;color:#aaa}.sp-val{font-weight:bold}
.sp-val.exp-color{color:#7ecfff}.sp-val.gold-color{color:#ffd700}.sp-val.playtime-color{color:#a0e8af}
.sp-title-label{font-size:.8rem;color:#ffd700;font-weight:bold;letter-spacing:1px}
.sp-title-next{font-size:.6rem;color:#888;margin-top:2px}
.sp-divider{height:1px;background:#555}
.sp-cur-label{font-size:.75rem;color:#ccc;margin-bottom:6px;font-weight:bold}
.sp-flash .sp-bar-fill.exp-fill{filter:brightness(2);transition:filter .15s}

/* ===== „Éò„ÉÉ„ÉÄ„Éº ===== */
.app-header{
  background:#000;padding:10px 16px;display:flex;align-items:center;
  border-bottom:2px solid #888;position:sticky;top:0;z-index:100;
}
.app-title{font-size:1rem;font-weight:bold;color:#ffd700}

.main-container{max-width:800px;margin:0 auto;padding:16px}
.screen{display:none}.screen.active{display:block}

/* ===== „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû ===== */
.chapter-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-bottom:24px}
.chapter-card{
  background:#000;border:2px solid #888;border-radius:10px;padding:16px;
  transition:all .2s;position:relative;overflow:hidden;cursor:pointer;
}
.chapter-card:hover:not(.locked){border-color:#ffd700;transform:translateY(-3px)}
.chapter-card.locked{opacity:.35;cursor:not-allowed}
.chapter-card.cleared{border-color:#4caf50}
.chapter-card.cleared::after{content:'‚úì';position:absolute;top:8px;right:12px;font-size:1.4rem;color:#4caf50}
.chapter-card.current{border-color:#ffd700;box-shadow:0 0 12px rgba(255,215,0,.3)}
.chapter-num{font-size:.75rem;color:#888;margin-bottom:4px}
.chapter-card-title{font-size:1rem;font-weight:bold;color:#fff;margin-bottom:4px}
.chapter-card-desc{font-size:.8rem;color:#aaa;margin-bottom:6px}
.chapter-domain{font-size:.7rem;padding:2px 8px;border-radius:10px;display:inline-block}
.chapter-domain.tech{background:rgba(33,150,243,.2);color:#42a5f5}
.chapter-domain.strat{background:rgba(255,152,0,.2);color:#ffb74d}
.chapter-domain.mgmt{background:rgba(76,175,80,.2);color:#81c784}
.chapter-domain.exam{background:rgba(156,39,176,.2);color:#ce93d8}
.mock-exam-start{text-align:center;padding:30px 20px}
.mock-exam-start h2{color:#ce93d8;margin-bottom:12px;font-size:1.5rem}
.mock-exam-start .exam-desc{color:#ccc;font-size:.95rem;line-height:1.7;margin-bottom:20px}
.mock-exam-start .exam-ratio{display:flex;justify-content:center;gap:12px;margin:16px 0;flex-wrap:wrap}
.mock-exam-start .exam-ratio-item{background:rgba(255,255,255,.06);border-radius:8px;padding:10px 16px;text-align:center;min-width:100px}
.mock-exam-start .exam-ratio-label{font-size:.7rem;color:#aaa;margin-bottom:4px}
.mock-exam-start .exam-ratio-num{font-size:1.3rem;font-weight:bold}
.mock-category-select{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;max-width:400px;margin-left:auto;margin-right:auto}
.mock-cat-btn{background:rgba(255,255,255,.06);border:2px solid transparent;border-radius:12px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s}
.mock-cat-btn:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
.mock-cat-btn.selected{border-color:#ab47bc;background:rgba(171,71,188,.15)}
.mock-cat-icon{font-size:1.5rem;margin-bottom:4px}
.mock-cat-name{font-size:.9rem;font-weight:bold;color:#e0e0e0;margin-bottom:2px}
.mock-cat-detail{font-size:.7rem;color:#999}
.mock-exam-q{padding:12px}
.mock-exam-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:.85rem;color:#aaa}
.mock-exam-progress{width:100%;height:6px;background:#333;border-radius:3px;margin-bottom:16px;overflow:hidden}
.mock-exam-progress-fill{height:100%;background:linear-gradient(90deg,#ce93d8,#ab47bc);border-radius:3px;transition:width .3s}
.mock-exam-qtext{font-size:1.15rem;line-height:1.7;padding:14px;background:rgba(255,255,255,.04);border-radius:8px;margin-bottom:16px}
.mock-exam-choices{display:flex;flex-direction:column;gap:10px}
.mock-exam-choice{padding:14px 18px;background:rgba(255,255,255,.06);border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:1rem;text-align:left;transition:background .2s,border-color .2s}
.mock-exam-choice:hover{background:rgba(255,255,255,.1);border-color:rgba(206,147,216,.4)}
.mock-exam-result{text-align:center;padding:30px 20px}
.mock-exam-result h2{margin-bottom:16px;font-size:1.5rem}
.mock-exam-result .result-score{font-size:3rem;font-weight:bold;margin:16px 0}
.mock-exam-result .result-pass{color:#81c784;font-size:1.3rem;font-weight:bold;margin-bottom:20px}
.mock-exam-result .result-fail{color:#ff5252;font-size:1.3rem;font-weight:bold;margin-bottom:20px}
.mock-exam-result .result-breakdown{display:flex;justify-content:center;gap:16px;margin:20px 0;flex-wrap:wrap}
.mock-exam-result .breakdown-item{background:rgba(255,255,255,.06);border-radius:10px;padding:14px 20px;min-width:120px}
.mock-exam-result .breakdown-label{font-size:.75rem;color:#aaa;margin-bottom:6px}
.mock-exam-result .breakdown-score{font-size:1.2rem;font-weight:bold}
.mock-exam-loading{text-align:center;padding:60px 20px;color:#aaa;font-size:1.1rem}
/* ===== ÂïèÈ°å„Çø„Ç§„Éû„Éº ===== */
.q-timer{margin:8px 0 4px;display:flex;align-items:center;gap:8px}
.q-timer-bar{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
.q-timer-fill{height:100%;border-radius:3px;transition:width 1s linear;background:#4caf50}
.q-timer-fill.warning{background:#ff9800}
.q-timer-fill.danger{background:#f44336}
.q-timer-fill.expired{background:#666;width:0%!important;transition:none}
.q-timer-text{font-size:.75rem;font-weight:bold;color:#aaa;min-width:32px;text-align:right}
.q-timer-text.warning{color:#ff9800}
.q-timer-text.danger{color:#f44336}
.q-timer-text.expired{color:#666}
.q-timer-expired-msg{text-align:center;color:#f44;font-weight:bold;font-size:.9rem;margin:8px 0;animation:timer-flash .5s ease-in-out 2}
.chapter-progress{font-size:.7rem;color:#888;margin-top:6px}
.chapter-back-btn{background:none;border:1px solid #666;color:#aaa;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;margin-bottom:16px}
.chapter-back-btn:hover{border-color:#fff;color:#fff}

/* ===== „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû ===== */
.chapter-title{text-align:center;margin:16px 0 8px;font-size:1.4rem;color:#ffd700}
.chapter-desc{text-align:center;color:#ccc;margin-bottom:24px;font-size:0.9rem}
.stage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.stage-card{
  background:#000;border:2px solid #888;border-radius:8px;padding:14px;
  transition:all .2s;position:relative;overflow:hidden;
}
.stage-card:hover:not(.locked){border-color:#fff;transform:translateY(-2px)}
.stage-card.locked{opacity:.4;cursor:not-allowed}
.stage-card.locked::after{content:'üîí';position:absolute;top:8px;right:8px;font-size:1.2rem}
.stage-card.cleared{border-color:#ffd700}
.stage-card.cleared::after{content:'‚úì';position:absolute;top:6px;right:10px;font-size:1.3rem;color:#ffd700;font-weight:bold}
.stage-card.boss{border-color:#ff5252}
.stage-card.boss.locked{border-color:#553333}
.stage-num{font-size:.75rem;color:#aaa}
.stage-name{font-size:1rem;font-weight:bold;margin:4px 0;color:#fff}
.stage-sub{font-size:.75rem;color:#ccc}
.stage-category{display:inline-block;font-size:.65rem;padding:2px 8px;border-radius:10px;margin-top:6px;background:#222;color:#ccc}

/* ===== Â≠¶ÁøíÁîªÈù¢ ===== */
.learn-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.back-btn{background:none;border:1px solid #888;color:#ccc;padding:6px 12px;border-radius:6px;font-size:.85rem}
.back-btn:hover{border-color:#fff;color:#fff}
.learn-stage-title{font-size:1.2rem;font-weight:bold;color:#fff}
.learn-stage-sub{font-size:.8rem;color:#ccc}
.progress-bar-container{display:flex;align-items:center;gap:8px;margin-bottom:20px}
.progress-bar{flex:1;height:6px;background:#333;border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:#ffd700;border-radius:3px;transition:width .5s ease}
.progress-label{font-size:.75rem;color:#aaa;white-space:nowrap}

/* ===== „Çª„ÇØ„Ç∑„Éß„É≥„Ç´„Éº„Éâ ===== */
.section-card{background:#000;border:2px solid #888;border-radius:8px;padding:20px;margin-bottom:16px}
.section-title{font-size:1rem;font-weight:bold;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #555}
.section-title.question-title{color:#ffb74d}
.section-title.knowledge-title{color:#ffd700}
.section-title.practice-title{color:#ffd700}
.section-title.reward-title{color:#ffd700}

/* ===== ÂïèÈ°åË°®Á§∫ ===== */
.q-source{font-size:.75rem;color:#aaa;margin-bottom:8px}
.q-text{font-size:1.4rem;line-height:1.9;background:#111;padding:16px 18px;border-radius:8px;border-left:4px solid #ffb74d;margin-bottom:12px}

/* ===== ÈñãÈñâ„Éë„Éç„É´ ===== */
.accordion{margin:8px 0;border:1px solid #666;border-radius:8px;overflow:hidden}
.accordion-header{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;background:#111;cursor:pointer;
  font-size:.9rem;font-weight:bold;transition:background .2s;
  user-select:none;
}
.accordion-header:hover{background:#1a1a1a}
.accordion-header .acc-icon{
  transition:transform .3s;font-size:.7rem;color:#aaa;
}
.accordion.open .accordion-header .acc-icon{transform:rotate(90deg)}
.accordion-header .acc-label{flex:1}
.acc-tag{font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:normal}
.acc-tag.hint{background:#222;color:#ffb74d}
.acc-tag.guide{background:#222;color:#ffd700}
.acc-tag.words{background:#222;color:#ccc}
.accordion-body{
  max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease;
  padding:0 14px;background:#0a0a0a;
}
.accordion.open .accordion-body{max-height:2000px;padding:12px 14px}

/* ===== ÈÅ∏ÊäûËÇ¢ ===== */
.q-choices{list-style:none}
.choice-item{
  margin:8px 0;border:2px solid #666;border-radius:8px;
  overflow:hidden;transition:all .3s ease;
}
.choice-item:hover:not(.answered):not(.selected){border-color:#fff}
.choice-main{
  display:flex;align-items:center;gap:8px;
  padding:12px 14px;cursor:pointer;font-size:.95rem;transition:background .2s;
}
.choice-main:hover{background:#111}
.choice-label{font-weight:bold;color:#ffd700;flex-shrink:0}
.choice-text{flex:1}
.choice-hint-btn{
  flex-shrink:0;background:#111;border:1px solid #666;color:#ffb74d;
  padding:5px 12px;border-radius:8px;font-size:.75rem;font-weight:bold;cursor:pointer;
  transition:all .2s;animation:btnPulse 2.5s ease-in-out infinite;
}
.choice-hint-btn:hover{background:#222;border-color:#ffb74d;animation:none;transform:scale(1.05)}
@keyframes btnPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,183,77,0)}50%{box-shadow:0 0 8px 2px rgba(255,183,77,.25)}}
.choice-hint{
  max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease,opacity .3s ease;
  padding:0 14px;background:#111;font-size:.85rem;color:#ffb74d;
  border-top:1px solid transparent;opacity:0;
}
.choice-hint.open{max-height:300px;padding:10px 14px;border-top-color:#444;opacity:1}
.choice-item.selected{border-color:#ffd700;background:#111}
.choice-item.selected .choice-main{color:#ffd700}
.choice-item.correct{border-color:#4caf50;background:#0a1a0a}
.choice-item.correct .choice-main{color:#81c784}
.choice-item.wrong{border-color:#f44336;background:#1a0a0a}
.choice-item.wrong .choice-main{color:#ef9a9a}
.answer-confirm{
  display:none;margin-top:12px;padding:16px;text-align:center;
  background:#111;border:2px solid #ffd700;
  border-radius:8px;animation:fadeIn .3s ease;
}
.answer-confirm .confirm-text{color:#ffd700}
.answer-confirm .confirm-yes{background:#ffd700;color:#000}

/* ===== ÂõûÁ≠îÂæå„ÅÆËß£Ë™¨ ===== */
.post-answer{display:none;margin-top:16px;animation:fadeIn .4s ease}
.post-answer.visible{display:block}
.result-banner{
  padding:14px 18px;border-radius:8px;margin-bottom:12px;
  font-weight:bold;font-size:1.1rem;text-align:center;
  animation:fadeIn .3s ease;
}
.retry-message{
  background:rgba(244,67,54,.12);border:2px solid #f44336;border-radius:8px;
  padding:12px 16px;margin-bottom:10px;color:#ef9a9a;
  font-weight:bold;font-size:.95rem;text-align:center;
  animation:shakeX .4s ease-in-out;
}
@keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
.result-banner.correct{background:#0a2a0a;border:2px solid #4caf50;color:#81c784;box-shadow:0 0 16px rgba(76,175,80,.4)}
.result-banner.wrong{background:#2a0a0a;border:2px solid #f44336;color:#ef9a9a;box-shadow:0 0 16px rgba(244,67,54,.4)}
.analysis-item{padding:10px 14px;margin:6px 0;background:#111;border-radius:8px}
.analysis-item.is-correct{border-left:3px solid #4caf50}
.analysis-item.is-wrong{border-left:3px solid #555}
.analysis-verdict{font-weight:bold;margin-right:6px}
.analysis-verdict.correct{color:#4caf50}.analysis-verdict.wrong{color:#888}
.strategy-steps{list-style:none;counter-reset:step}
.strategy-steps li{
  counter-increment:step;padding:8px 14px 8px 48px;margin:6px 0;
  background:#111;border-radius:8px;position:relative;font-size:.9rem;
}
.strategy-steps li::before{content:'Step ' counter(step);position:absolute;left:8px;top:9px;font-size:.7rem;color:#ffb74d;font-weight:bold}
.trap-box{background:#1a0a0a;border:1px solid #553333;border-radius:8px;padding:12px 14px;margin-top:10px;font-size:.85rem}
.trap-label{color:#ff5252;font-weight:bold;margin-bottom:4px}

/* ===== ÂçòË™ûËß£Ë™¨Ôºà„Éë„Éç„É´ÂÜÖÔºâ ===== */
.word-item{padding:8px 0;border-bottom:1px solid #333}
.word-item:last-child{border-bottom:none}
.word-term{font-weight:bold;color:#ffd700;margin-bottom:2px;font-size:.9rem}
.word-reading{font-size:.7rem;color:#aaa}
.word-desc{font-size:.82rem;color:#ccc;margin-top:2px}

/* ===== Èñ¢ÈÄ£Áü•Ë≠ò ===== */
.knowledge-item{padding:10px 14px;margin:6px 0;background:#111;border-radius:8px;border-left:3px solid #ffd700}
.knowledge-term{font-weight:bold;color:#ffd700;margin-bottom:4px}
.knowledge-desc{font-size:.85rem;color:#ccc;white-space:pre-line}

/* ===== Á∑¥ÁøíÂïèÈ°å ===== */
.practice-q{background:#111;border-radius:8px;padding:16px;margin:10px 0;border:1px solid #555}
.practice-q .q-text{margin-bottom:8px;border-left-color:#ffb74d}
.practice-explanation{display:none;margin-top:10px;padding:10px;background:#0a1a0a;border-radius:8px;font-size:.85rem;color:#a5d6a7}
.practice-explanation.visible{display:block}

/* ===== „Ç´„Éº„ÉâÁç≤Âæó ===== */
.reward-card{
  text-align:center;padding:24px;
  background:#000;border:2px solid #ffd700;
  border-radius:8px;animation:cardAppear .6s ease;
}
@keyframes cardAppear{0%{transform:scale(.8) rotateY(90deg);opacity:0}100%{transform:scale(1) rotateY(0deg);opacity:1}}
.reward-card-name{font-size:1.3rem;font-weight:bold;color:#ffd700;margin-bottom:4px}
.reward-rarity{color:#ffb74d;margin-bottom:10px}
.reward-summary{font-size:.85rem;color:#ccc;margin-bottom:16px;line-height:1.6}
.reward-stats{display:flex;justify-content:center;gap:24px;margin-bottom:16px}
.reward-stat{text-align:center}
.reward-stat-value{font-size:1.3rem;font-weight:bold}
.reward-stat-value.exp{color:#7ecfff}
.reward-stat-value.gold{color:#ffd700}
.reward-stat-label{font-size:.7rem;color:#aaa}

/* ===== „Éú„Çø„É≥ ===== */
.next-btn{
  display:block;width:100%;padding:14px;margin:16px 0;
  background:#ffd700;color:#000;
  font-size:1rem;font-weight:bold;border:none;border-radius:8px;transition:all .2s;
}
.next-btn:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(255,215,0,.3)}
.next-btn.secondary{background:#333;color:#fff;border:1px solid #666}
.next-btn.secondary:hover{border-color:#fff}

/* ===== „Éú„Çπ„Éê„Éà„É´ ===== */
.boss-header{text-align:center;padding:20px;background:#000;border:2px solid #ff5252;border-radius:8px;margin-bottom:16px}
.boss-name{font-size:1.5rem;font-weight:bold;color:#ff5252;margin-bottom:4px}
.boss-desc{font-size:.85rem;color:#ff8a80}
.boss-hp-container{margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px}
.boss-hp-bar{flex:1;max-width:200px;height:10px;background:#333;border-radius:5px;overflow:hidden}
.boss-hp-fill{height:100%;background:linear-gradient(90deg,#f44336,#ff5252);transition:width .5s ease;border-radius:5px}
.boss-hp-text{font-size:.8rem;color:#ff8a80}
.boss-q-counter{text-align:center;color:#aaa;font-size:.85rem;margin:12px 0}
.boss-sticky-q{position:sticky;top:0;z-index:50;background:#000;padding:8px 12px 4px;border-bottom:2px solid #ff5252;box-shadow:0 4px 12px rgba(0,0,0,.9)}
.boss-sticky-q .boss-q-counter{margin:0 0 6px}
.boss-sticky-q .q-text{max-height:35vh;overflow-y:auto;font-size:1.2rem;line-height:1.7;margin-bottom:4px;padding:10px 14px}
@media(max-width:768px){
  .boss-sticky-q .q-text{max-height:30vh;font-size:1.05rem;line-height:1.6;padding:8px 10px}
}
.boss-result{text-align:center;padding:30px}
.boss-result h2{font-size:1.5rem;margin-bottom:8px}
.boss-result.win h2{color:#ffd700}
.boss-result.lose h2{color:#ff5252}
.boss-result p{color:#ccc;margin-bottom:16px}
.boss-score{font-size:1.2rem;color:#fff;margin-bottom:16px}

/* ===== „Ç´„Éº„ÉâÂõ≥Èëë ===== */
.collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.coll-card{background:#000;border:1px solid #666;border-radius:8px;padding:12px;text-align:center;font-size:.8rem;position:relative;overflow:hidden}
.coll-card.owned{border-color:#ffd700}.coll-card.not-owned{opacity:.35}
.coll-card-name{font-weight:bold;color:#ffd700;margin-bottom:4px}
.coll-card-rarity{color:#ffb74d;font-size:.7rem}
.card-boss-emblem{display:block;width:56px;height:56px;object-fit:contain;image-rendering:pixelated;margin:6px auto 8px;opacity:.7;filter:drop-shadow(0 0 4px rgba(255,215,0,.3))}
.coll-card.not-owned .card-boss-emblem{filter:brightness(0) invert(.3)}
.reward-card-emblem{display:block;width:72px;height:72px;object-fit:contain;image-rendering:pixelated;margin:8px auto 10px;opacity:.8;filter:drop-shadow(0 0 6px rgba(255,215,0,.4));animation:emblemGlow 2s ease-in-out infinite alternate}
@keyframes emblemGlow{0%{filter:drop-shadow(0 0 4px rgba(255,215,0,.3))}100%{filter:drop-shadow(0 0 10px rgba(255,215,0,.6))}}

/* ===== „Åì„Å®„Å∞„Çπ„ÉÜ„ÉÉ„Éó ===== */
.vocab-intro{font-size:.9rem;color:#ccc;margin-bottom:16px;line-height:1.8;background:#111;padding:14px;border-radius:8px;border-left:3px solid #ffd700}
.vocab-grid{display:grid;gap:12px}
.vocab-card{background:#111;border:1px solid #555;border-radius:8px;padding:14px 16px;transition:border-color .2s}
.vocab-card:hover{border-color:#ffd700}
.vocab-word{font-size:1rem;font-weight:bold;color:#ffd700}
.vocab-reading{font-size:.75rem;color:#aaa;margin-left:6px}
.vocab-meaning{font-size:.88rem;color:#ddd;margin-top:6px;line-height:1.7}
.step-badge{display:inline-block;font-size:.7rem;padding:3px 10px;border-radius:12px;margin-bottom:10px;font-weight:bold}
.step-badge.step-vocab{background:#111;color:#ffd700;border:1px solid #555}
.step-badge.step-question{background:#111;color:#ffb74d;border:1px solid #555}
.step-badge.step-knowledge{background:#111;color:#ffd700;border:1px solid #555}
.step-badge.step-practice{background:#111;color:#ffb74d;border:1px solid #555}
.step-badge.step-reward{background:#111;color:#ff5252;border:1px solid #ff5252}
.question-guide{background:#111;border:1px solid #555;border-radius:8px;padding:14px;margin-bottom:14px}
.question-guide-title{font-size:.85rem;font-weight:bold;color:#ffb74d;margin-bottom:8px}
.question-guide-text{font-size:.88rem;color:#ddd;line-height:1.8;white-space:pre-line}

/* ===== ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ ===== */
.strategy-hint-wrap{margin-bottom:12px}
.strategy-hint-btn{
  display:flex;align-items:center;gap:8px;width:100%;
  padding:10px 14px;background:#111;border:1px solid #666;border-radius:8px;
  color:#ffb74d;font-size:.85rem;font-weight:bold;cursor:pointer;
  transition:all .3s;user-select:none;
  animation:hintPulse 2.5s ease-in-out infinite;
}
.strategy-hint-btn:hover{background:#1a1a1a;border-color:#ffb74d;animation:none;transform:scale(1.02)}
.strategy-hint-btn.open{animation:none}
@keyframes hintPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,183,77,0)}50%{box-shadow:0 0 10px 2px rgba(255,183,77,.25)}}
.strategy-hint-icon{font-size:.7rem;transition:transform .3s}
.strategy-hint-btn.open .strategy-hint-icon{transform:rotate(90deg)}
.strategy-hint-body{
  max-height:0;overflow:hidden;transition:max-height .5s ease,padding .3s ease,opacity .3s ease;
  padding:0 14px;background:#111;border-radius:0 0 8px 8px;opacity:0;
}
.strategy-hint-body.open{max-height:600px;padding:12px 14px;opacity:1}

/* ===== È†ÜÊ¨°Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É† ===== */
.reveal-block{opacity:0;max-height:0;overflow:hidden;transition:opacity .5s ease,max-height .5s ease,margin .3s ease;margin:0;pointer-events:none}
.reveal-block.revealed{opacity:1;max-height:2000px;overflow:visible;margin:12px 0;pointer-events:auto}
.tap-indicator{
  text-align:center;padding:14px;margin:8px 16px;cursor:pointer;
  background:#111;border:1px dashed #666;border-radius:8px;
  color:#ffd700;font-size:.85rem;font-weight:bold;
  transition:all .2s;user-select:none;display:none;
}
.tap-indicator:hover{background:#1a1a1a;border-color:#ffd700}
.tap-indicator.active{display:block;animation:tapPulse 2s infinite}
@keyframes tapPulse{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.02)}}
.confirm-box{
  background:#000;border:2px solid #4caf50;
  border-radius:8px;padding:20px;text-align:center;
}
.confirm-text{font-size:1rem;font-weight:bold;color:#fff;margin-bottom:14px}
.confirm-subtext{font-size:.8rem;color:#ccc;margin-bottom:14px}
.confirm-btn{padding:12px 24px;border:none;border-radius:8px;font-size:.9rem;font-weight:bold;margin:4px;cursor:pointer;transition:all .2s}
.confirm-yes{background:#4caf50;color:#fff;animation:btnGlow 2s ease-in-out infinite}
.confirm-yes:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(76,175,80,.4);animation:none}
@keyframes btnGlow{0%,100%{box-shadow:0 0 0 0 rgba(76,175,80,0)}50%{box-shadow:0 0 10px 2px rgba(76,175,80,.2)}}
.confirm-retry{background:#333;color:#ccc;border:1px solid #666}
.confirm-retry:hover{border-color:#fff;color:#fff}

/* ===== „Ç¢„Éã„É° ===== */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .4s ease}
.content-spacer{height:70px}

/* ===== „Çø„ÉÉ„ÉóÁµåÈ®ìÂÄ§„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ ===== */
.xp-particle{
  position:fixed;pointer-events:none;z-index:9999;
  width:8px;height:8px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,#7ecfff 60%,#4fc3f7 100%);
  box-shadow:0 0 6px 1px rgba(79,195,247,.4);
}
.tap-ripple{
  position:fixed;pointer-events:none;z-index:9998;
  width:24px;height:24px;border-radius:50%;border:1.5px solid rgba(126,207,255,.4);
  animation:rippleOut .5s ease-out forwards;
}
@keyframes rippleOut{0%{transform:scale(0);opacity:.5}100%{transform:scale(2);opacity:0}}
.gold-particle{
  position:fixed;pointer-events:none;z-index:9999;
  width:10px;height:10px;border-radius:50%;
  background:radial-gradient(circle,#fff176 0%,#ffd700 50%,#f9a825 100%);
  box-shadow:0 0 6px 1px rgba(255,215,0,.4);
  border:1px solid #ffb300;
}
.sidebar-gain{
  position:fixed;pointer-events:none;z-index:9999;
  font-weight:bold;font-size:.7rem;white-space:nowrap;
}
.sp-buff{font-size:.6rem;color:#ce93d8;margin-top:4px;font-weight:bold;min-height:14px}

/* ===== „Éê„ÉïÁç≤ÂæóÊºîÂá∫ ===== */
.buff-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;display:flex;align-items:center;justify-content:center;
  animation:buffFlash .8s ease forwards;
}
@keyframes buffFlash{0%{background:rgba(206,147,216,0)}12%{background:rgba(206,147,216,.2)}100%{background:rgba(206,147,216,0)}}
.buff-banner{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9998;
  pointer-events:none;text-align:center;
}
.buff-banner-text{
  font-size:1.6rem;font-weight:bold;color:#ce93d8;letter-spacing:2px;
  text-shadow:0 0 20px rgba(206,147,216,.6),0 0 40px rgba(206,147,216,.2);
}
.buff-banner-sub{font-size:.8rem;color:#e1bee7;margin-top:6px}

/* ===== „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫ ===== */
.levelup-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9998;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:rgba(0,0,0,.85);opacity:0;pointer-events:none;
  transition:opacity .3s;
}
.levelup-overlay.active{opacity:1;pointer-events:auto}
.levelup-box{text-align:center}
.levelup-label{font-size:1.1rem;color:#ffd700;margin-bottom:8px;letter-spacing:3px;animation:lvLabelIn .5s ease .2s both}
.levelup-number{font-size:3rem;font-weight:bold;color:#fff;text-shadow:0 0 30px #ffd700,0 0 60px rgba(255,215,0,.3);animation:lvNumIn .6s ease .4s both}
.levelup-sub{font-size:.85rem;color:#aaa;margin-top:14px;animation:lvSubIn .4s ease .8s both}
@keyframes lvLabelIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes lvNumIn{0%{transform:scale(0) rotate(-5deg);opacity:0}60%{transform:scale(1.15) rotate(2deg)}100%{transform:scale(1) rotate(0);opacity:1}}
@keyframes lvSubIn{0%{opacity:0}100%{opacity:1}}
.levelup-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;animation:lvFlash .6s ease forwards;
}
@keyframes lvFlash{0%{background:rgba(255,215,0,0)}15%{background:rgba(255,215,0,.35)}100%{background:rgba(255,215,0,0)}}

/* ===== Áß∞Âè∑Áç≤ÂæóÊºîÂá∫ ===== */
.title-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:rgba(0,0,0,.9);opacity:0;pointer-events:none;
  transition:opacity .4s;
}
.title-overlay.active{opacity:1;pointer-events:auto}
.title-got-label{font-size:.9rem;color:#fff;letter-spacing:4px;margin-bottom:12px;animation:titleLabelIn .5s ease .2s both}
.title-got-name{
  font-size:2rem;font-weight:bold;color:#ffd700;
  text-shadow:0 0 20px #ffd700,0 0 40px rgba(255,215,0,.4),0 0 80px rgba(255,215,0,.2);
  animation:titleNameIn .7s ease .5s both;
}
.title-got-sub{font-size:.8rem;color:#aaa;margin-top:16px;animation:titleSubIn .4s ease 1s both}
.title-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;animation:titleFlashAnim .8s ease forwards;
}
@keyframes titleLabelIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes titleNameIn{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes titleSubIn{0%{opacity:0}100%{opacity:1}}
@keyframes titleFlashAnim{0%{background:rgba(255,215,0,0)}10%{background:rgba(255,215,0,.5)}100%{background:rgba(255,215,0,0)}}

/* ===== „É¨„Çπ„Éù„É≥„Ç∑„Éñ ===== */
@media(max-width:768px){
  body{padding-left:0;padding-top:0;padding-bottom:88px}
  .side-panel{
    top:auto;bottom:0;
    width:100%;height:auto;
    display:grid;
    grid-template-columns:auto 1fr auto;
    grid-template-rows:auto auto;
    padding:6px 10px;
    border-right:none;border-top:2px solid #555;border-bottom:none;
    gap:3px 10px;align-items:center;
    overflow:hidden;
  }
  #sp-account-area{display:none}
  .sp-divider{display:none}
  .sp-title-next{display:none}
  .app-header{display:none}
  /* Row 1: Level | Title | Gold */
  #sp-level-area{grid-row:1;grid-column:1;text-align:left}
  #sp-title-area{grid-row:1;grid-column:2;text-align:center;overflow:hidden}
  #sp-gold-area{grid-row:1;grid-column:3;text-align:right}
  #sp-playtime-area{display:none}
  /* Row 2: EXP | Items | Progress */
  #sp-exp-area{grid-row:2;grid-column:1;text-align:left}
  #sp-items-area{grid-row:2;grid-column:2;text-align:center}
  #sp-progress-area{grid-row:2;grid-column:3;text-align:right}
  .sp-level-num{font-size:1.2rem;line-height:1}
  .sp-level-label{font-size:.5rem}
  .sp-section{white-space:nowrap;min-width:0}
  .sp-bar{width:60px;margin:2px 0 1px}.sp-bar-text{font-size:.5rem}
  .sp-cur-label{font-size:.55rem;margin-bottom:1px}
  .sp-title-label{font-size:.65rem;text-overflow:ellipsis;overflow:hidden}
  .sp-row{gap:3px}
  .mc-item-bar{gap:2px}
  .mc-slot{width:26px;height:26px}
  .mc-slot img{width:20px;height:20px}
}
@media(max-width:380px){
  .mc-slot{width:22px;height:22px}
  .mc-slot img{width:17px;height:17px}
  .mc-item-bar{gap:1px}
}
/* „Çπ„Éû„Éõ: ÂïèÈ°åÊñá„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº */
@media(max-width:768px){
  .sticky-q.revealed{
    position:sticky;top:0;z-index:50;
    background:#000;
    padding:8px 12px 6px;margin:0;
    border-bottom:2px solid #ffb74d;
    box-shadow:0 4px 12px rgba(0,0,0,.8);
  }
  .sticky-q.revealed .q-text{
    max-height:30vh;overflow-y:auto;
    font-size:1.1rem;line-height:1.7;
    margin-bottom:4px;padding:10px 12px;
  }
  .sticky-q.revealed .q-source{
    font-size:.65rem;margin-bottom:4px;
  }
}

@media(max-width:600px){
  .stage-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
  .main-container{padding:10px}
  .section-card{padding:14px}
  .choice-main{padding:10px 10px}
  .choice-hint-btn{padding:3px 6px;font-size:.65rem}
}
/* ===== „Ç∑„Éß„ÉÉ„Éó ===== */
.shop-warning{background:rgba(255,82,82,.15);border:1px solid #ff5252;border-radius:8px;padding:12px;margin-bottom:16px;color:#ff8a80;font-size:.85rem;line-height:1.5;text-align:center}
.shop-gold{text-align:center;font-size:1.1rem;color:#ffd700;font-weight:bold;margin-bottom:12px}
.shop-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.05);border:1px solid #555;border-radius:8px;padding:12px;margin-bottom:10px}
.shop-item-icon{flex-shrink:0;width:40px;height:40px;overflow:hidden}
.shop-item-icon img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
.boss-bag-item-icon{width:24px;height:24px;max-width:24px;max-height:24px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px}
.boss-bag-item{display:flex;align-items:center;gap:4px;margin:4px 0}
.shop-item-info{flex:1}
.shop-item-name{font-weight:bold;color:#fff;font-size:.9rem}
.shop-item-desc{font-size:.75rem;color:#aaa;margin-top:2px}
.shop-item-price{color:#ffd700;font-size:.8rem;margin-top:4px}
.shop-buy-btn{background:#ffd700;color:#1a1a2e;border:none;border-radius:6px;padding:6px 14px;font-weight:bold;cursor:pointer;font-size:.8rem;flex-shrink:0}
.shop-buy-btn:disabled{background:#555;color:#888;cursor:not-allowed}
.boss-bag{background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:12px;margin:16px 0}
.boss-bag-title{font-size:.85rem;color:#ffd700;font-weight:bold;margin-bottom:8px}
.boss-bag-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.85rem;color:#fff}
.boss-bag-empty{font-size:.8rem;color:#888}
.boss-item-btns{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;justify-content:center}
.boss-use-glasses,.boss-use-kendama,.boss-use-watch{border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;font-size:.85rem;animation:itemBtnIn .3s ease-out;box-shadow:0 2px 8px rgba(0,0,0,.3);transition:transform .15s,opacity .15s}
.boss-use-glasses:hover,.boss-use-kendama:hover,.boss-use-watch:hover{transform:scale(1.05)}
.boss-use-glasses{background:#4fc3f7;color:#1a1a2e}
.boss-use-kendama{background:#ff9800;color:#1a1a2e}
.boss-use-watch{background:#7ecfff;color:#1a1a2e}
@keyframes itemBtnIn{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.choice-hidden{opacity:.3;pointer-events:none;text-decoration:line-through}

/* ===== „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®„Ç®„Éï„Çß„ÇØ„Éà ===== */
/* ÂÖ®ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•ÂÖ±ÈÄö */
.item-flash{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;pointer-events:none}
/* Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç: Èùí„ÅÑÊ¥ûÂØü„ÅÆÊ≥¢Âãï */
.item-flash-glasses{animation:glassesFlash .8s ease forwards}
@keyframes glassesFlash{0%{background:rgba(79,195,247,0)}12%{background:rgba(79,195,247,.3)}100%{background:rgba(79,195,247,0)}}
.choice-item.item-glow-glasses{
  border-color:#4fc3f7!important;
  box-shadow:0 0 12px rgba(79,195,247,.6),0 0 24px rgba(79,195,247,.3),inset 0 0 8px rgba(79,195,247,.15);
  animation:glassesGlow 1.5s ease-in-out infinite alternate;
}
@keyframes glassesGlow{
  0%{box-shadow:0 0 8px rgba(79,195,247,.4),0 0 16px rgba(79,195,247,.2)}
  100%{box-shadow:0 0 16px rgba(79,195,247,.7),0 0 32px rgba(79,195,247,.4),inset 0 0 12px rgba(79,195,247,.2)}
}
/* 2ÂÄç„ÅÆ„Åë„ÇìÁéâ: „Ç™„É¨„É≥„Ç∏„ÅÆÁÇé */
.item-flash-kendama{animation:kendamaFlash .8s ease forwards}
@keyframes kendamaFlash{0%{background:rgba(255,152,0,0)}12%{background:rgba(255,152,0,.3)}100%{background:rgba(255,152,0,0)}}
.choice-item.item-glow-kendama{
  border-color:#ff9800!important;
  box-shadow:0 0 12px rgba(255,152,0,.5),0 0 24px rgba(255,87,34,.3);
  animation:kendamaGlow 1s ease-in-out infinite alternate;
}
@keyframes kendamaGlow{
  0%{box-shadow:0 0 8px rgba(255,152,0,.4),0 0 16px rgba(255,87,34,.2)}
  100%{box-shadow:0 0 18px rgba(255,152,0,.7),0 0 36px rgba(255,87,34,.4)}
}
/* „Ç∑„É£„ÉÉ„Éï„É´„Çø„Ç§„Éû„Éº: Èùí„ÅÑÂáçÁµê */
.item-flash-watch{animation:watchFlash 1s ease forwards}
@keyframes watchFlash{0%{background:rgba(126,207,255,0)}8%{background:rgba(126,207,255,.35)}40%{background:rgba(126,207,255,.15)}100%{background:rgba(126,207,255,0)}}
.choice-item.item-glow-watch{
  border-color:#7ecfff!important;opacity:.5;
  box-shadow:0 0 16px rgba(126,207,255,.5);
  filter:brightness(1.3) saturate(.5);
  transition:all .4s ease;
}
/* ÂëΩ„ÅÆ„Åü„Åæ: ÈáëËâ≤„ÅÆ„Ç∑„Éº„É´„Éâ */
.item-flash-stone{animation:stoneFlash 1s ease forwards}
@keyframes stoneFlash{0%{background:rgba(255,215,0,0)}10%{background:rgba(255,215,0,.4)}30%{background:rgba(255,215,0,.2)}100%{background:rgba(255,215,0,0)}}
/* „Ç¢„Ç§„ÉÜ„É†„Éê„Éä„Éº */
.item-banner{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9998;
  pointer-events:none;text-align:center;animation:itemBannerIn .6s ease-out forwards;
}
.item-banner-icon{font-size:3rem;margin-bottom:4px;filter:drop-shadow(0 0 12px rgba(255,255,255,.6))}
.item-banner-text{
  font-size:1.4rem;font-weight:bold;letter-spacing:3px;
  text-shadow:0 0 20px currentColor,0 0 40px currentColor;
}
.item-banner-sub{font-size:.8rem;margin-top:6px;opacity:.8}
@keyframes itemBannerIn{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}
  30%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}
  100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
}
.item-banner.fade-out{animation:itemBannerOut .4s ease-in forwards}
@keyframes itemBannerOut{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.3)}}

/* „Ç¢„Ç§„ÉÜ„É†Êû†Êã°ÂºµÈÄöÁü• */
.inventory-expand-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;animation:fadeIn .3s}
.inventory-expand-box{background:linear-gradient(135deg,#1a1a2e,#2a2a4e);border:2px solid #ffd700;border-radius:16px;padding:24px 32px;text-align:center;max-width:320px;box-shadow:0 0 30px rgba(255,215,0,.3);animation:popIn .4s ease-out}
.inventory-expand-icon{font-size:3rem;margin-bottom:8px}
.inventory-expand-title{font-size:1.2rem;font-weight:bold;color:#ffd700;margin-bottom:8px}
.inventory-expand-detail{font-size:.9rem;color:#fff;margin-bottom:16px;line-height:1.6}
@keyframes popIn{0%{transform:scale(.5);opacity:0}100%{transform:scale(1);opacity:1}}

/* ===== „É¢„Éº„ÉÄ„É´ ===== */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .2s}
.modal-box{background:#1a1a2e;border:2px solid #ff5252;border-radius:12px;padding:24px;max-width:340px;width:90%;text-align:center}
.modal-box h3{color:#ff5252;margin:0 0 12px;font-size:1.1rem}
.modal-bag{background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:8px 12px;margin:12px 0;font-size:.85rem;color:#ffd700}
.modal-bag-item-icon{width:20px;height:20px;vertical-align:middle;image-rendering:pixelated;margin-right:4px}
.modal-note{color:#aaa;font-size:.8rem;margin:12px 0 16px}
.modal-btns{display:flex;gap:10px;justify-content:center}
.modal-btns button{flex:1;padding:10px;border:none;border-radius:8px;font-size:.9rem;font-weight:bold;cursor:pointer}
.modal-btn-go{background:#ff5252;color:#fff}
.modal-btn-back{background:#333;color:#aaa}
/* ===== „Éú„Çπ„Çπ„Éó„É©„Ç§„Éà ===== */
.boss-sprite{display:block;margin:0 auto 8px;image-rendering:pixelated;width:120px;height:auto}
.boss-sprite-sm{image-rendering:pixelated;width:120px;height:auto}
@keyframes bossIdle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-sprite-anim{animation:bossIdle 1.2s ease-in-out infinite}
@keyframes bossHit{0%{filter:brightness(3) drop-shadow(0 0 12px #ff0);transform:translateX(-6px)}25%{transform:translateX(6px)}50%{filter:brightness(2);transform:translateX(-4px)}75%{transform:translateX(4px)}100%{filter:brightness(1);transform:translateX(0)}}
.boss-sprite-hit{animation:bossHit .5s ease}
/* ===== „Éú„Çπ2„Ç´„É©„É†„Éò„ÉÉ„ÉÄ„Éº ===== */
.boss-header-row{display:flex;align-items:center;justify-content:center;gap:24px;padding:12px 20px;background:#111;border:2px solid #ff5252;border-radius:12px;margin-bottom:12px}
.boss-info-col{text-align:center;min-width:0}
.boss-sprite-col{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:6px}
/* ===== CSS„É°„Ç´„Éâ„É©„Ç¥„É≥ ===== */
.css-dragon{width:100px;height:100px;position:relative;image-rendering:pixelated}
.css-dragon .d-body{position:absolute;width:50px;height:36px;background:#c62828;border-radius:8px 12px 6px 10px;top:36px;left:24px;box-shadow:inset -4px -4px 0 #8e0000,inset 4px 4px 0 #e53935}
.css-dragon .d-head{position:absolute;width:30px;height:26px;background:#d32f2f;border-radius:6px 16px 4px 4px;top:22px;left:56px;box-shadow:inset -3px -3px 0 #8e0000,inset 3px 3px 0 #ef5350}
.css-dragon .d-eye{position:absolute;width:6px;height:6px;background:#ffd700;border-radius:50%;top:27px;left:72px;box-shadow:0 0 6px #ffd700,0 0 12px rgba(255,215,0,.4)}
.css-dragon .d-eye::after{content:'';position:absolute;width:3px;height:6px;background:#000;border-radius:1px;left:2px;top:0}
.css-dragon .d-horn1{position:absolute;width:0;height:0;border-left:4px solid transparent;border-right:4px solid transparent;border-bottom:12px solid #ff8a80;top:12px;left:62px;transform:rotate(-10deg)}
.css-dragon .d-horn2{position:absolute;width:0;height:0;border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:10px solid #ff8a80;top:14px;left:72px;transform:rotate(10deg)}
.css-dragon .d-mouth{position:absolute;width:14px;height:4px;background:#8e0000;border-radius:0 0 3px 1px;top:40px;left:68px}
.css-dragon .d-mouth::after{content:'';position:absolute;width:6px;height:3px;background:#ff6f00;border-radius:0 2px 2px 0;left:14px;top:0;box-shadow:6px -1px 0 #ff8f00,12px -2px 0 #ffa000;opacity:.8}
.css-dragon .d-wing{position:absolute;width:0;height:0;border-left:28px solid #ef5350;border-top:18px solid transparent;border-bottom:6px solid transparent;top:18px;left:16px;filter:drop-shadow(-2px 2px 0 #b71c1c)}
.css-dragon .d-wing2{position:absolute;width:0;height:0;border-left:20px solid #e53935;border-top:14px solid transparent;border-bottom:4px solid transparent;top:22px;left:22px}
.css-dragon .d-tail{position:absolute;width:30px;height:8px;background:#c62828;border-radius:10px 0 4px 6px;top:50px;left:-2px;transform:rotate(8deg);box-shadow:inset -3px -2px 0 #8e0000}
.css-dragon .d-tail::after{content:'';position:absolute;width:10px;height:6px;background:#ff5252;border-radius:0 6px 6px 0;right:-8px;top:1px;transform:rotate(-20deg)}
.css-dragon .d-leg1{position:absolute;width:8px;height:14px;background:#b71c1c;border-radius:0 0 3px 3px;top:68px;left:34px}
.css-dragon .d-leg2{position:absolute;width:8px;height:14px;background:#b71c1c;border-radius:0 0 3px 3px;top:68px;left:54px}
.css-dragon .d-claw1{position:absolute;width:12px;height:4px;background:#8e0000;border-radius:2px;top:80px;left:32px}
.css-dragon .d-claw2{position:absolute;width:12px;height:4px;background:#8e0000;border-radius:2px;top:80px;left:52px}
.css-dragon .d-gear{position:absolute;width:10px;height:10px;border:2px solid #78909c;border-radius:50%;top:42px;left:44px;box-shadow:0 0 4px rgba(120,144,156,.6)}
.css-dragon .d-gear::after{content:'';position:absolute;width:6px;height:2px;background:#78909c;top:4px;left:-4px}
.css-dragon .d-bolt{position:absolute;width:4px;height:4px;background:#4fc3f7;border-radius:50%;box-shadow:0 0 4px #4fc3f7;top:50px;left:30px}
.css-dragon .d-bolt2{position:absolute;width:3px;height:3px;background:#4fc3f7;border-radius:50%;box-shadow:0 0 3px #4fc3f7;top:38px;left:50px}
/* ===== ÁîªÈù¢Êè∫„Çå ===== */
@keyframes screenShake{0%{transform:translate(0,0)}10%{transform:translate(-8px,4px)}20%{transform:translate(6px,-6px)}30%{transform:translate(-4px,6px)}40%{transform:translate(4px,-2px)}50%{transform:translate(-2px,4px)}60%{transform:translate(6px,-4px)}70%{transform:translate(-4px,2px)}80%{transform:translate(2px,-6px)}90%{transform:translate(-2px,2px)}100%{transform:translate(0,0)}}
.screen-shake{animation:screenShake .4s ease}

/* ===== „Éú„ÇπÊà¶ VSÊºîÂá∫ ===== */
.boss-vs-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;
  background:#000;display:flex;align-items:center;justify-content:center;
  flex-direction:column;pointer-events:none;
}
.boss-vs-flash{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:radial-gradient(circle,rgba(255,82,82,.3) 0%,transparent 70%);
  animation:vsFlashPulse 1s ease-in-out infinite;
}
@keyframes vsFlashPulse{0%,100%{opacity:.3}50%{opacity:.8}}
.boss-vs-text{
  font-size:4rem;font-weight:900;color:#ff5252;letter-spacing:12px;
  text-shadow:0 0 40px rgba(255,82,82,.8),0 0 80px rgba(255,82,82,.4),0 0 120px rgba(255,82,82,.2);
  animation:vsTextIn .6s cubic-bezier(.17,.67,.3,1.33) both;
  z-index:1;
}
@keyframes vsTextIn{0%{transform:scale(0) rotate(-10deg);opacity:0}60%{transform:scale(1.3) rotate(3deg)}100%{transform:scale(1) rotate(0);opacity:1}}
.boss-vs-name{
  font-size:1.2rem;color:#fff;margin-top:16px;letter-spacing:4px;opacity:0;
  animation:vsNameIn .5s ease .4s forwards;z-index:1;
}
@keyframes vsNameIn{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
.boss-vs-line{
  width:0;height:2px;background:linear-gradient(90deg,transparent,#ff5252,transparent);
  margin-top:12px;animation:vsLineIn .6s ease .3s forwards;z-index:1;
}
@keyframes vsLineIn{0%{width:0}100%{width:60%}}

/* ===== „Éú„ÇπÊà¶ Êà¶ÈóòÈõ∞Âõ≤Ê∞ó ===== */
.boss-battle-atmosphere{
  position:relative;
}
.boss-battle-atmosphere::before{
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:0;
  background:radial-gradient(ellipse at center,transparent 50%,rgba(255,0,0,.08) 100%);
  animation:atmPulse 3s ease-in-out infinite;
}
@keyframes atmPulse{0%,100%{opacity:.5}50%{opacity:1}}
#screen-boss .main-container{position:relative;z-index:1}

/* ===== „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó ===== */
.boss-dmg-num{
  position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);
  pointer-events:none;z-index:200;
  font-size:4rem;font-weight:900;color:#ff5252;
  text-shadow:0 0 20px rgba(255,82,82,.8),0 0 40px rgba(255,82,82,.3),3px 3px 0 #000;
  animation:dmgFloat 1.8s ease-out forwards;
}
@keyframes dmgFloat{
  0%{opacity:1;transform:translate(-50%,-50%) scale(2)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  60%{opacity:1;transform:translate(-50%,-70%) scale(1)}
  100%{opacity:0;transform:translate(-50%,-100%) scale(.7)}
}
.boss-dmg-critical{
  font-size:5.5rem;color:#ffd700;
  text-shadow:0 0 30px rgba(255,215,0,.8),0 0 60px rgba(255,215,0,.4),3px 3px 0 #000;
}

/* ===== „Éú„ÇπÂèçÊíÉÊºîÂá∫ ===== */
.boss-counterattack-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9990;
  pointer-events:none;animation:counterFlash .6s ease forwards;
}
@keyframes counterFlash{
  0%{background:rgba(255,0,0,0)}
  15%{background:rgba(255,0,0,.4)}
  30%{background:rgba(255,0,0,.1)}
  45%{background:rgba(255,0,0,.3)}
  100%{background:rgba(0,0,0,0)}
}
.boss-sprite-attack{animation:bossAttack .6s ease !important}
@keyframes bossAttack{
  0%{transform:translateX(0) scale(1)}
  20%{transform:translateX(20px) scale(1.2)}
  40%{transform:translateX(-60px) scale(1.3);filter:brightness(2) drop-shadow(0 0 20px #f00)}
  60%{transform:translateX(10px) scale(1.1)}
  100%{transform:translateX(0) scale(1);filter:brightness(1)}
}

/* ===== „Ç≥„É≥„Éú„Ç´„Ç¶„É≥„Çø„Éº ===== */
.boss-combo{
  position:absolute;top:8px;right:16px;z-index:10;
  text-align:right;opacity:0;transition:opacity .3s;
}
.boss-combo.active{opacity:1}
.boss-combo-count{
  font-size:2rem;font-weight:900;color:#ffd700;line-height:1;
  text-shadow:0 0 15px rgba(255,215,0,.6),2px 2px 0 #000;
}
.boss-combo-label{font-size:.65rem;color:#ffb74d;letter-spacing:2px;font-weight:bold}
.boss-combo-pop{animation:comboPop .3s ease}
@keyframes comboPop{0%{transform:scale(1.5)}50%{transform:scale(.9)}100%{transform:scale(1)}}

/* ===== HP‰Ωé‰∏ãÊôÇ„ÅÆËÑàÂãï ===== */
.boss-hp-fill.hp-danger{
  background:linear-gradient(90deg,#ff1744,#ff5252) !important;
  animation:hpDangerPulse .8s ease-in-out infinite;
}
@keyframes hpDangerPulse{0%,100%{opacity:1;box-shadow:0 0 8px rgba(255,23,68,.6)}50%{opacity:.6;box-shadow:0 0 16px rgba(255,23,68,1)}}
.boss-hp-fill.hp-critical{
  background:linear-gradient(90deg,#d50000,#ff1744) !important;
  animation:hpCriticalPulse .4s ease-in-out infinite;
}
@keyframes hpCriticalPulse{0%,100%{opacity:1;box-shadow:0 0 12px rgba(213,0,0,.8)}50%{opacity:.4;box-shadow:0 0 20px rgba(213,0,0,1)}}

/* ===== „Éú„ÇπÊíÉÁ†¥„Ç®„ÇØ„Çπ„Éó„É≠„Éº„Ç∏„Éß„É≥ ===== */
.boss-explosion-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9998;
  pointer-events:none;
}
.boss-explosion-particle{
  position:absolute;width:6px;height:6px;border-radius:50%;
  pointer-events:none;
}
.boss-explosion-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;animation:bossExplodeFlash 1s ease forwards;
}
@keyframes bossExplodeFlash{
  0%{background:rgba(255,255,255,0)}
  8%{background:rgba(255,255,255,.9)}
  20%{background:rgba(255,82,82,.4)}
  40%{background:rgba(255,215,0,.2)}
  100%{background:rgba(0,0,0,0)}
}
.boss-sprite-defeat{animation:bossDefeat 1.5s ease forwards !important}
@keyframes bossDefeat{
  0%{transform:scale(1);filter:brightness(1)}
  20%{transform:scale(1.1);filter:brightness(3) drop-shadow(0 0 30px #fff)}
  40%{transform:scale(1.05);filter:brightness(2) drop-shadow(0 0 20px #ff0)}
  60%{transform:scale(.9) rotate(5deg);filter:brightness(1.5);opacity:.8}
  80%{transform:scale(.7) rotate(-3deg);filter:brightness(1);opacity:.4}
  100%{transform:scale(0) rotate(10deg);opacity:0}
}

/* ===== „Éû„Ç§„ÇØ„É©È¢®„Ç¢„Ç§„ÉÜ„É†„Éú„ÉÉ„ÇØ„Çπ ===== */
.mc-item-bar{display:flex;gap:2px;justify-content:center}
.mc-slot{width:36px;height:36px;background:#555;border:2px solid #222;border-top-color:#373737;border-left-color:#373737;border-right-color:#8b8b8b;border-bottom-color:#8b8b8b;display:flex;align-items:center;justify-content:center;position:relative}
.mc-slot.empty{background:#555}
.mc-slot img{width:28px;height:28px;object-fit:contain;image-rendering:pixelated}
.mc-slot-label{position:absolute;bottom:-1px;right:1px;font-size:8px;color:#fff;text-shadow:1px 1px 0 #000;font-weight:bold}
/* ===== ÂÆüÁ∏æÈÄöÁü• ===== */
.achievement-notify{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:flex-start;justify-content:center;z-index:10000;pointer-events:none;padding-top:60px}
.achievement-notify-box{background:linear-gradient(135deg,#1a1a2e,#2a1a3e);border:2px solid #c084fc;border-radius:16px;padding:20px 28px;text-align:center;max-width:300px;box-shadow:0 0 30px rgba(192,132,252,.4),0 8px 32px rgba(0,0,0,.6);animation:popIn .4s ease-out}
.achievement-notify-icon{font-size:2.5rem;margin-bottom:4px}
.achievement-notify-label{font-size:.7rem;color:#c084fc;letter-spacing:2px;font-weight:bold;text-transform:uppercase}
.achievement-notify-name{font-size:1.2rem;font-weight:bold;color:#fff;margin:4px 0}
.achievement-notify-desc{font-size:.8rem;color:#aaa}
.achievement-notify.fade-out{animation:fadeOut .5s ease forwards}
@keyframes fadeOut{to{opacity:0;transform:translateY(-20px)}}
/* ===== ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏‰∏ÄË¶ß ===== */
.badge-cat{margin-bottom:20px}
.badge-cat-title{font-size:.85rem;color:#c084fc;font-weight:bold;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:10px;letter-spacing:1px}
.badge-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.badge-item{background:#1a1a2e;border:2px solid #333;border-radius:12px;padding:12px 10px;text-align:center;transition:all .3s}
.badge-item.unlocked{border-color:#c084fc;box-shadow:0 0 12px rgba(192,132,252,.2)}
.badge-item.locked{opacity:.5;filter:grayscale(.8)}
.badge-icon{font-size:2rem;margin-bottom:4px}
.badge-name{font-size:.85rem;font-weight:bold;color:#fff;margin-bottom:2px}
.badge-desc{font-size:.7rem;color:#aaa;line-height:1.3}
@media(max-width:768px){.badge-row{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}.badge-item{padding:10px 6px}}
</style>
</head>
<body>

<!-- „Ç¢„Ç´„Ç¶„É≥„ÉàÂêçÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
<div class="account-modal" id="account-modal">
  <div class="account-modal-content">
    <div class="account-modal-title">„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ</div>
    <div class="account-modal-desc">
      Â≠¶Áøí„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
      Â•Ω„Åç„Å™ÂêçÂâç„ÅßÁôªÈå≤„Åß„Åç„Åæ„Åô„ÄÇ
    </div>
    <input type="text" class="account-input" id="account-input" placeholder="„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ" maxlength="20" />
    <button class="account-login-btn" id="account-login-btn">„É≠„Ç∞„Ç§„É≥</button>
  </div>
</div>

<aside class="side-panel" id="side-panel">
  <div class="sp-section" id="sp-account-area">
    <div class="sp-account-name" id="sp-account-name">„Ç≤„Çπ„Éà„É¶„Éº„Ç∂„ÉºÔºà‰ªÆÔºâ</div>
    <div class="sp-account-title" id="sp-account-title">ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥ÊâãÔºà‰ªÆÔºâ</div>
    <button class="sp-logout-btn" onclick="handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
  </div>

  <div class="sp-section" id="sp-level-area">
    <div class="sp-level-label">LEVEL</div>
    <div class="sp-level-num" id="sp-level">1</div>
  </div>

  <div class="sp-section" id="sp-title-area">
    <div class="sp-title-label" id="sp-title">ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã</div>
    <div class="sp-title-next" id="sp-title-next"></div>
  </div>

  <div class="sp-section" id="sp-items-area">
    <div style="font-size:.65rem;color:#aaa;margin-bottom:2px;letter-spacing:1px" id="sp-items-label">ITEMS</div>
    <div id="sp-item-bar" class="mc-item-bar"></div>
  </div>

  <div class="sp-section" id="sp-exp-area">
    <div class="sp-row"><span class="sp-label">EXP</span><span class="sp-val exp-color" id="sp-exp">0</span></div>
    <div class="sp-bar"><div class="sp-bar-fill exp-fill" id="sp-exp-bar" style="width:0%"></div></div>
    <div class="sp-bar-text" id="sp-exp-next">Ê¨°„ÅÆLv„Åæ„Åß 5</div>
    <div class="sp-buff" id="sp-buff"></div>
  </div>

  <div class="sp-section" id="sp-gold-area">
    <div class="sp-row"><span class="sp-label">GOLD</span><span class="sp-val gold-color" id="sp-gold">0</span></div>
  </div>

  <div class="sp-section" id="sp-playtime-area">
    <div class="sp-row"><span class="sp-label">PLAY TIME</span><span class="sp-val playtime-color" id="sp-playtime">0:00</span></div>
  </div>

  <div class="sp-divider"></div>

  <div class="sp-section" id="sp-progress-area">
    <div class="sp-cur-label">„Ç´„É™„Ç≠„É•„É©„É†ÈÄ≤Êçó</div>
    <div class="sp-bar"><div class="sp-bar-fill cur-fill" id="sp-cur-fill" style="width:0%"></div></div>
    <div class="sp-bar-text" id="sp-cur-text">0 / 12 „ÇØ„É™„Ç¢</div>
  </div>
</aside>

<div class="app-header">
  <div class="app-title">IT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß</div>
</div>

<div id="screen-chapters" class="screen active">
  <div class="main-container">
    <div class="chapter-title">IT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß</div>
    <div class="chapter-desc">ÂÖ®8Á´†„ÅßË©¶È®ìÁØÑÂõ≤„ÇíÂÆåÂÖ®„Ç´„Éê„ÉºÔºÅ</div>
    <div class="chapter-grid" id="chapter-grid"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="next-btn secondary" onclick="showScreen('screen-collection')">„Ç´„Éº„ÉâÂõ≥Èëë</button>
      <button class="next-btn secondary" onclick="showScreen('screen-badges')">ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏</button>
    </div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-map" class="screen">
  <div class="main-container">
    <button class="chapter-back-btn" onclick="showScreen('screen-chapters')">‚Üê Á´†„ÅÆÈÅ∏Êäû„Å´Êàª„Çã</button>
    <div class="chapter-title" id="map-chapter-title"></div>
    <div class="chapter-desc" id="map-chapter-desc"></div>
    <div class="stage-grid" id="stage-grid"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="next-btn secondary" onclick="showScreen('screen-collection')">„Ç´„Éº„ÉâÂõ≥Èëë</button>
      <button class="next-btn secondary" onclick="showScreen('screen-badges')">ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏</button>
    </div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-learn" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div>
        <div class="learn-stage-title" id="learn-title"></div>
        <div class="learn-stage-sub" id="learn-sub"></div>
      </div>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar"><div class="progress-fill" id="learn-progress"></div></div>
      <div class="progress-label" id="learn-progress-label"></div>
    </div>
    <div id="learn-content"></div>
    <div id="tap-indicator" class="tap-indicator" onclick="revealNext(event)">„Çø„ÉÉ„Éó or „Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÅßÁ∂ö„Åç„ÇíË™≠„ÇÄ ‚ñº</div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-boss-prep" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title" style="color:#ff5252" id="boss-prep-title">„Éú„ÇπÊà¶Ê∫ñÂÇô</div></div>
    </div>
    <div id="boss-prep-content"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-boss" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="confirmBossExit()">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title" style="color:#ff5252" id="boss-title">Á´†„Éú„Çπ</div></div>
    </div>
    <div id="boss-exit-confirm" style="display:none;margin-bottom:12px;padding:16px;background:#1a0a0a;border:2px solid #ff5252;border-radius:10px;text-align:center;animation:fadeIn .3s">
      <div style="font-size:1rem;font-weight:bold;color:#ff5252;margin-bottom:6px">„Éú„ÇπÊà¶„Åã„ÇâÈõ¢ËÑ±„Åó„Åæ„Åô„ÅãÔºü</div>
      <div style="font-size:.85rem;color:#ccc;margin-bottom:14px">Êà¶Èóò„ÅÆÈÄ≤Ë°å„ÅØ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ<br>‰ΩøÁî®Ê∏à„Åø„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØÊàª„Çä„Åæ„Åõ„Çì„ÄÇ</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="next-btn secondary" style="flex:1;max-width:130px" onclick="dismissBossExit()">Êà¶Èóò„Å´Êàª„Çã</button>
        <button class="next-btn" style="flex:1;max-width:130px;background:#ff5252" onclick="executeBossExit()">Èõ¢ËÑ±„Åô„Çã</button>
      </div>
    </div>
    <div id="boss-content"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-mock-exam" class="screen">
  <div class="main-container">
    <div id="mock-exam-content"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-collection" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-chapters')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title">„Ç´„Éº„ÉâÂõ≥Èëë</div></div>
    </div>
    <div class="collection-grid" id="collection-grid"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-badges" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-chapters')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title">ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏</div></div>
    </div>
    <div class="badge-progress" id="badge-progress"></div>
    <div class="badge-grid" id="badge-grid"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div class="levelup-overlay" id="levelup-overlay" onclick="closeLevelUp()">
  <div class="levelup-box">
    <div class="levelup-label">LEVEL UP!</div>
    <div class="levelup-number" id="levelup-number">Lv.2</div>
    <div class="levelup-sub">„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã</div>
  </div>
</div>

<div class="title-overlay" id="title-overlay" onclick="closeTitleOverlay()">
  <div class="title-got-label">Êñ∞„Åó„ÅÑÁß∞Âè∑„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ</div>
  <div class="title-got-name" id="title-got-name"></div>
  <div class="title-got-sub">„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã</div>
</div>

<script>
/* ===== „Éá„É¢„É¢„Éº„ÉâÂà§ÂÆö ===== */
const IS_DEMO = new URLSearchParams(location.search).has('demo');

/* ===== „Ç¢„Ç´„Ç¶„É≥„ÉàÁÆ°ÁêÜ ===== */
const ACCOUNT_KEY = 'course_accountName';

// „Ç¢„Ç´„Ç¶„É≥„ÉàÂêçÂèñÂæó
function getAccountName() {
  return localStorage.getItem(ACCOUNT_KEY);
}

// „Ç¢„Ç´„Ç¶„É≥„ÉàÂêç‰øùÂ≠ò
function setAccountName(name) {
  localStorage.setItem(ACCOUNT_KEY, name);
}

// „Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Çª„Éº„Éñ„Éá„Éº„Çø„Ç≠„Éº
function getSaveDataKey() {
  const name = getAccountName();
  return name ? 'course_saveData_' + name : 'course_saveData';
}

// „Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§
function getDefaultSaveData() {
  return {
    level: 1,
    exp: 0,
    gold: 0,
    chapters: {},
    ownedCards: [],
    titles: ['ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã'],
    currentTitle: 'ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã',
    inventory: [],
    achievements: [],
    usedItemTypes: [],
    playTime: 0,
    cardChapterMap: {}
  };
}

// Êóß„Çª„Éº„Éñ„Éá„Éº„Çø‚ÜíÊñ∞ÂΩ¢Âºè„Å∏„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
function migrateSaveData(data) {
  if (!data.chapters) {
    data.chapters = {};
    if (data.clearedStages || data.bossCleared) {
      data.chapters[1] = {
        clearedStages: data.clearedStages || [],
        bossCleared: data.bossCleared || false
      };
    }
    delete data.clearedStages;
    delete data.bossCleared;
  }
  if(!data.achievements)data.achievements=[];
  if(!data.usedItemTypes)data.usedItemTypes=[];
  if(data.playTime==null)data.playTime=0;
  if(!data.cardChapterMap)data.cardChapterMap={};
  return data;
}

// ÁèæÂú®„ÅÆÁ´†„ÅÆÈÄ≤Êçó„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„Éº
function chapterState() {
  if (!currentChapter) return { clearedStages: [], bossCleared: false };
  const cid = currentChapter.id;
  if (!state.chapters[cid]) {
    state.chapters[cid] = { clearedStages: [], bossCleared: false };
  }
  return state.chapters[cid];
}

// „Çª„Éº„Éñ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
function loadSaveData() {
  try {
    const key = getSaveDataKey();
    let data = localStorage.getItem(key);
    // ÊóßÂÖ±ÈÄö„Ç≠„Éº„Åã„Çâ„ÅÆ‰∏ÄÂõûÈôê„Çä„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
    if (!data && key !== 'course_saveData') {
      const oldData = localStorage.getItem('course_saveData');
      if (oldData && !localStorage.getItem('course_saveData_migrated')) {
        localStorage.setItem('course_saveData_migrated', '1');
        data = oldData;
      }
    }
    if (!data) return getDefaultSaveData();
    return migrateSaveData(JSON.parse(data));
  } catch (e) {
    console.error('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
    return getDefaultSaveData();
  }
}

// „Çª„Éº„Éñ„Éá„Éº„Çø‰øùÂ≠ò
function saveSaveData(data) {
  localStorage.setItem(getSaveDataKey(), JSON.stringify(data));
}

// „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
function handleLogin() {
  const input = document.getElementById('account-input');
  const accountName = input.value.trim();

  if (!accountName) {
    alert('„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // „Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„Çí‰øùÂ≠òÔºà„Åì„ÅÆÂæå getSaveDataKey() „Åå„Ç¢„Ç´„Ç¶„É≥„ÉàÂà•„Ç≠„Éº„ÇíËøî„ÅôÔºâ
  setAccountName(accountName);

  // „Ç¢„Ç´„Ç¶„É≥„ÉàÂõ∫Êúâ„ÅÆ„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
  state = loadSaveData();

  // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  document.getElementById('account-modal').classList.add('hidden');

  // Ë°®Á§∫„ÇíÊõ¥Êñ∞
  updateAccountDisplay();
  if(typeof updateHeader==='function') updateHeader();
  updatePlayTimeDisplay();

  // „Éá„É¢Áâà: „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû„Çí„Çπ„Ç≠„ÉÉ„Éó„ÅóÁ¨¨1Á´†„Å´Áõ¥Ë°å
  if(IS_DEMO){
    selectChapter(1);
  }else{
    showScreen('screen-chapters');
  }
}

// „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±Ë°®Á§∫Êõ¥Êñ∞
function updateAccountDisplay() {
  const accountName = getAccountName();
  const saveData = loadSaveData();

  document.getElementById('sp-account-name').textContent = accountName || '„Ç≤„Çπ„Éà';
  document.getElementById('sp-account-title').textContent = saveData.currentTitle || 'ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã';
}

// „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
function handleLogout() {
  // ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Å¶„Åã„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà
  saveState();
  // „Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„Çí„ÇØ„É™„Ç¢
  localStorage.removeItem(ACCOUNT_KEY);
  // state„Çí„Éá„Éï„Ç©„É´„Éà„Å´„É™„Çª„ÉÉ„Éà
  state = getDefaultSaveData();
  // „É≠„Ç∞„Ç§„É≥„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
  document.getElementById('account-modal').classList.remove('hidden');
  document.getElementById('account-input').value = '';
  // „Çµ„Ç§„Éâ„Éë„Éç„É´Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
  updateAccountDisplay();
  updatePlayTimeDisplay();
}

// „Éó„É¨„Ç§ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÁßí‚Üí "XÊôÇÈñìYÂàÜ" or "YÂàÜ"Ôºâ
function formatPlayTime(seconds){
  const h=Math.floor(seconds/3600);
  const m=Math.floor((seconds%3600)/60);
  if(h>0)return `${h}ÊôÇÈñì${m}ÂàÜ`;
  return `${m}ÂàÜ`;
}

// „Éó„É¨„Ç§ÊôÇÈñìË°®Á§∫Êõ¥Êñ∞
function updatePlayTimeDisplay(){
  const el=document.getElementById('sp-playtime');
  if(el&&typeof state!=='undefined')el.textContent=formatPlayTime(state.playTime||0);
}

// „Éó„É¨„Ç§ÊôÇÈñì„Çø„Ç§„Éû„ÉºÔºà30Áßí„Åî„Å®„Å´Âä†ÁÆó„Éª‰øùÂ≠òÔºâ
let _playTimeInterval=null;
function startPlayTimeTracker(){
  if(_playTimeInterval)return;
  _playTimeInterval=setInterval(()=>{
    if(typeof state==='undefined'||!getAccountName())return;
    state.playTime=(state.playTime||0)+30;
    updatePlayTimeDisplay();
    saveSaveData(state);
  },30000);
}

// „Éö„Éº„Ç∏ÈùûË°®Á§∫ÊôÇ„ÅØ„Ç´„Ç¶„É≥„ÉàÂÅúÊ≠¢„ÄÅË°®Á§∫ÊôÇ„Å´ÂÜçÈñã
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    if(_playTimeInterval){clearInterval(_playTimeInterval);_playTimeInterval=null;}
  }else{
    startPlayTimeTracker();
  }
});

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂá¶ÁêÜ
window.addEventListener('DOMContentLoaded', () => {
  // „Éá„É¢Áâà: „É¢„Éº„ÉÄ„É´„Éª„Çµ„Ç§„Éâ„Éê„Éº„ÉªUI„ÅÆË°®Á§∫„ÇíÂ§âÊõ¥
  if(IS_DEMO){
    document.querySelector('.account-modal-title').textContent='„Éá„É¢Áâà - „Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ';
    document.querySelector('.account-modal-desc').innerHTML='„Çπ„ÉÜ„Éº„Ç∏1„Éª„Çπ„ÉÜ„Éº„Ç∏2„Éª„Éú„ÇπÊà¶„Åå‰ΩìÈ®ì„Åß„Åç„Åæ„Åô„ÄÇ<br>„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    document.title='„Äê„Éá„É¢Áâà„ÄëIT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß';
    // „Çµ„Ç§„Éâ„Éê„Éº„Å´„Éá„É¢Áâà„Éê„ÉÉ„Ç∏
    const badge=document.createElement('div');
    badge.style.cssText='background:#ff5252;color:#fff;text-align:center;padding:6px;font-size:.75rem;font-weight:bold;letter-spacing:2px;';
    badge.textContent='DEMO VERSION';
    document.getElementById('side-panel').prepend(badge);
    // „Éò„ÉÉ„ÉÄ„Éº„Å´„Éá„É¢ÁâàË°®Á§∫
    document.querySelector('.app-title').textContent='„Äê„Éá„É¢Áâà„ÄëIT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß';
    // „ÄåÁ´†„ÅÆÈÅ∏Êäû„Å´Êàª„Çã„Äç„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
    const backBtn=document.querySelector('.chapter-back-btn');
    if(backBtn)backBtn.style.display='none';
    // „Ç´„Éº„ÉâÂõ≥Èëë„ÉªÂÆüÁ∏æ„Éê„ÉÉ„Ç∏„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
    document.querySelectorAll('#screen-map .next-btn.secondary').forEach(b=>b.style.display='none');
  }

  const accountName = getAccountName();

  if (!accountName) {
    document.getElementById('account-modal').classList.remove('hidden');
  } else {
    document.getElementById('account-modal').classList.add('hidden');
    updateAccountDisplay();
    if(IS_DEMO){
      selectChapter(1);
    }else{
      showScreen('screen-chapters');
    }
  }

  // „Éó„É¨„Ç§ÊôÇÈñì„ÅÆÂàùÊúüË°®Á§∫ÔºÜ„Çø„Ç§„Éû„ÉºÈñãÂßã
  updatePlayTimeDisplay();
  startPlayTimeTracker();

  // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
  document.getElementById('account-login-btn').addEventListener('click', handleLogin);

  // Enter„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
  document.getElementById('account-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });
});

/* ===== „Ç≥„Éº„Çπ„Éá„Éº„Çø ===== */
let COURSE_DATA = [];
let BOSS_DATA = {};
let currentChapter = null;

/* ===== „ÉÅ„É£„Éó„Çø„ÉºÂÆöÁæ© ===== */
const CHAPTERS = [
  {
    id:1, title:'Á¨¨1Á´† „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆ‰∏ñÁïå',
    description:'ÊØéÊó•‰Ωø„Å£„Å¶„Çã„Çπ„Éû„Éõ„ÇÑ„Éë„ÇΩ„Ç≥„É≥„ÄÅ‰∏≠Ë∫´„ÇíÁü•„Çç„ÅÜ',
    domain:'„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª', domainClass:'tech',
    stageCount:11,
    bossName:'„É°„Ç´„Éâ„É©„Ç¥„É≥',
    bossSprite:'„Éú„Çπ/character_monster_dragon_01_red.png',
    files:{
      stages:['course/chapter1_stages1-4.json','course/chapter1_stages5-8.json','course/chapter1_stages9-11.json'],
      boss:'course/chapter1_boss.json'
    }
  },
  {
    id:2, title:'Á¨¨2Á´† „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÅÆÂÜíÈô∫',
    description:'„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà„ÅÆ‰∏ñÁïå„ÇíÊé¢Ê§ú„Åó„Çà„ÅÜ',
    domain:'„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª', domainClass:'tech',
    stageCount:8,
    bossName:'„Éç„ÉÉ„Éà„ÉØ„Ç§„Éê„Éº„É≥',
    bossSprite:'„Éú„Çπ/character_monster_dragon_01_white.png',
    files:{
      stages:['course/chapter2_stages1-4.json','course/chapter2_stages5-8.json'],
      boss:'course/chapter2_boss.json'
    }
  },
  {
    id:3, title:'Á¨¨3Á´† „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆÁ†¶',
    description:'Â§ßÂàá„Å™ÊÉÖÂ†±„ÇíÂÆà„ÇãÊñπÊ≥ï„ÇíÂ≠¶„Åº„ÅÜ',
    domain:'„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª', domainClass:'tech',
    stageCount:8,
    bossName:'„ÉÄ„Éº„ÇØ„Éï„Ç°„Ç§„Ç¢„Ç¶„Ç©„Éº„É´',
    bossSprite:'„Éú„Çπ/character_darkknight_04.png',
    files:{
      stages:['course/chapter3_stages1-4.json','course/chapter3_stages5-8.json'],
      boss:'course/chapter3_boss.json'
    }
  },
  {
    id:4, title:'Á¨¨4Á´† „Éá„Éº„Çø„Å®„Ç¢„É´„Ç¥„É™„Ç∫„É†',
    description:'„Éá„Éº„Çø„ÅÆÊï¥ÁêÜ„Å®ËÄÉ„Åà„ÇãÂäõ„ÇíË∫´„Å´„Å§„Åë„Çà„ÅÜ',
    domain:'„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª', domainClass:'tech',
    stageCount:8,
    bossName:'„Éá„Éº„Çø„Ç¥„Éº„É¨„É†',
    bossSprite:'„Éú„Çπ/character_hero_red.png',
    files:{
      stages:['course/chapter4_stages1-4.json','course/chapter4_stages5-8.json'],
      boss:'course/chapter4_boss.json'
    }
  },
  {
    id:5, title:'Á¨¨5Á´† ‰ºÅÊ•≠„Å®Ê≥ïÂæã„ÅÆ‰∏ñÁïå',
    description:'‰ºöÁ§æ„ÅÆ„É´„Éº„É´„Å®Ê≥ïÂæã„ÇíÁü•„Çç„ÅÜ',
    domain:'„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª', domainClass:'strat',
    stageCount:8,
    bossName:'Ê≥ïÂæã„Ç≠„É°„É©',
    bossSprite:'„Éú„Çπ/character_daiakuma_01_02_black.png',
    files:{
      stages:['course/chapter5_stages1-4.json','course/chapter5_stages5-8.json'],
      boss:'course/chapter5_boss.json'
    }
  },
  {
    id:6, title:'Á¨¨6Á´† ÁµåÂñ∂Êà¶Áï•„ÅÆÈÅî‰∫∫',
    description:'„Éì„Ç∏„Éç„Çπ„ÅÆ‰ΩúÊà¶„ÇíËÄÉ„Åà„Çà„ÅÜ',
    domain:'„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª', domainClass:'strat',
    stageCount:8,
    bossName:'„Çπ„Éà„É©„ÉÜ„Ç∏„Éº„Éâ„É©„Ç¥„É≥',
    bossSprite:'„Éú„Çπ/character_monster_dragon_02_yellow.png',
    files:{
      stages:['course/chapter6_stages1-4.json','course/chapter6_stages5-8.json'],
      boss:'course/chapter6_boss.json'
    }
  },
  {
    id:7, title:'Á¨¨7Á´† „Ç∑„Çπ„ÉÜ„É†Êà¶Áï•„Å®‰ºÅÁîª',
    description:'IT„Åß‰ªï‰∫ã„ÇíÂ§â„Åà„ÇãÊñπÊ≥ï„ÇíÂ≠¶„Åº„ÅÜ',
    domain:'„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª', domainClass:'strat',
    stageCount:8,
    bossName:'„Éó„É©„É≥„Éã„É≥„Ç∞„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ',
    bossSprite:'„Éú„Çπ/character_daitenshi_02_02_brown.png',
    files:{
      stages:['course/chapter7_stages1-4.json','course/chapter7_stages5-8.json'],
      boss:'course/chapter7_boss.json'
    }
  },
  {
    id:8, title:'Á¨¨8Á´† „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å®„Çµ„Éº„Éì„Çπ',
    description:'„ÉÅ„Éº„É†„Åß‰Ωú„Çã„Ç∑„Çπ„ÉÜ„É†ÈñãÁô∫„ÇíÂ≠¶„Åº„ÅÜ',
    domain:'„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª', domainClass:'mgmt',
    stageCount:8,
    bossName:'„Éû„Éç„Ç∏„É°„É≥„Éà„Éè„Ç§„Éâ„É©',
    bossSprite:'„Éú„Çπ/character_datenshi_01_01_black.png',
    files:{
      stages:['course/chapter8_stages1-4.json','course/chapter8_stages5-8.json'],
      boss:'course/chapter8_boss.json'
    }
  },
  {
    id:9, title:'Á¨¨9Á´† Ê®°Êì¨Ë©¶È®ì',
    description:'Êú¨Áï™„Åï„Å™„Åå„Çâ„ÅÆ100Âïè„Å´ÊåëÊà¶ÔºÅ',
    domain:'Á∑èÂêà', domainClass:'exam',
    stageCount:0,
    isMockExam:true,
    bossName:'',
    bossSprite:'',
    files:{stages:[],boss:''}
  }
];

/* ===== „Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ© ===== */
const ITEM_ICONS={
  life_stone:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAKpCAYAAABKLt4+AAAAAXNSR0IArs4c6QAADMxJREFUeJzt1yFuZfcZh+F7LG+h8DKrgQYDCwIsVfIKwsIGdAUer8D1CgaElc0KLI1kKQGFAwwTmUQXdg++hWWtzsl0Pvu9z7OCn46O/q++ZQf/y/5yesF6h6fj9AReuf3lMj1htcPT9AJesbPpAQDAHyfoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsEwP2Oy776cXrPfrL8fpCafi7OZxegKv3Mv91fSE0/Hd92+vNb/+Mr1gNRc6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAELNMD/oDj9IC1zm4epycAfHMv91fTE7Z4c310oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DA+W5/Ob1hm8PT9IKTcXd9MT1htduH5+kJm7zcX01PWO3s5nF6wib+a/6rN9hGFzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsu93uOD1ii7Obx+kJq91dX0xP2OT24Xl6wmov91fTEzZZ/vLjMr1hreM///Em35D7n3+fnnAyvCHfhgsdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACzqcHwP/D2c3j9IRNXu6vjtMb1nqr3xpqXOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQcD49APiPs5vH6QnAG+VCB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAgPPd/nKZHrHFy/3VcXrDWre7x+kJm9xdX0xPWO324Xl6AsA35UIHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAgPPd4Wl6A/CG3V1fTE84GbcPz9MTNnm5v5qesN7+cpmesJYLHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAs6nB2y2v1ymJ6z1cn91nN6wyfXv0wsAvq3D0/SC1VzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQcD49gNfv9uF5egJ8dR8+fp6esNrx0/vpCdvsL5fpCasdnqYXrOZCB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgIDz3f7d9IZtDl+O0xPWOrt5nJ7AK3d3fTE9YbUPHz9PT+C1OzxNLzgJLnQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAhYdrvdcXrEFssPP01POBl//9tfpyecjA8fP09POBnHT++nJ6y3f7dMT9jk8GV6wUlwoQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DAstvtjtMjtlh++Gl6Anx1x0/vpyecjv27ZXrCaocv0wt4xVzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsOz276Y3bHP4cpyeAF/dn/68TE9Y7V+/TS8Adi50AEgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAI+Dewi3GmZnUriQAAAABJRU5ErkJggg==',
  sage_glasses:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAEdCAYAAAD6nZXAAAAAAXNSR0IArs4c6QAABT1JREFUeJzt17ttG1EURdEZg2pAlagJxQ5cpwPHroKVqAEC41QgTAey4ftma60KDvi5G2/fOJtjesDC9ukBnJb/1WP+VyfxZXoAAPD3BB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAvbpASdwTA+44zsD/ic38CS80AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIGCfHvAbx/SAOyt+RgCflUY84IUOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAH7tm3H9AiI2qcHLMzdgX/MCx0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAL2bduO6RHvHcdSc5ZzfbtNT1jWy/PT9AROyt15zM35s5Xujhc6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAEXKYHrO76dpuewHnt0wMWdkwPWJm7w0d4oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAwGV6wL3r2216AvDJuDsUeKEDQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DA5fXrt316xHsvz0/H9AbOabXf8s8f36cnLGu178rd4aNW+i17oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAwC9uWitvipNWkAAAAABJRU5ErkJggg==',
  double_kendama:'kendama_blue.png',
  time_watch:'udedokei_gold.png'
};
const SHOP_ITEMS=[
  {id:'life_stone',name:'ÂëΩ„ÅÆ„Åü„Åæ',price:500,desc:'‰∏çÊ≠£Ëß£„Åß„ÇÇ„É™„Çª„ÉÉ„Éà„Åï„Çå„Å™„ÅÑÔºàËá™Âãï‰ΩøÁî®Ôºâ',icon:ITEM_ICONS.life_stone},
  {id:'sage_glasses',name:'Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç',price:300,desc:'ÈÅ∏ÊäûËÇ¢„Çí2„Å§„Å´Áµû„Çã„Éí„É≥„Éà„Åå‰Ωø„Åà„Çã',icon:ITEM_ICONS.sage_glasses},
  {id:'double_kendama',name:'2ÂÄç„ÅÆ„Åë„ÇìÁéâ',price:400,desc:'Ê¨°„ÅÆÊ≠£Ëß£„Åå2ÂÄç„ÉÄ„É°„Éº„Ç∏„Å´„Å™„ÇãÔºàÊâãÂãï‰ΩøÁî®Ôºâ',icon:ITEM_ICONS.double_kendama},
  {id:'time_watch',name:'„Ç∑„É£„ÉÉ„Éï„É´„Çø„Ç§„Éû„Éº',price:600,desc:'ÂïèÈ°å„ÇíÂà•„ÅÆÂïèÈ°å„Å´‰∫§Êèõ„Åß„Åç„Çã',icon:ITEM_ICONS.time_watch}
];

/* ===== ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏„Ç∑„Çπ„ÉÜ„É† ===== */
const ACHIEVEMENTS=[
  {id:'first_clear',name:'„ÅØ„Åò„ÇÅ„ÅÆ‰∏ÄÊ≠©',desc:'Âàù„ÇÅ„Å¶„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Åü',icon:'üë£',cat:'ÈÄ≤Ë°å'},
  {id:'first_boss',name:'„Éâ„É©„Ç¥„É≥„Çπ„É¨„Ç§„É§„Éº',desc:'Âàù„ÇÅ„Å¶„Éú„Çπ„ÇíÊíÉÁ†¥„Åó„Åü',icon:'üêâ',cat:'„Éú„Çπ'},
  {id:'boss_perfect',name:'„Éë„Éº„Éï„Çß„ÇØ„Éà„Ç≠„É´',desc:'„Éú„ÇπÊà¶„ÅßÂÖ®ÂïèÊ≠£Ëß£„Åó„Åü',icon:'üíØ',cat:'„Éú„Çπ'},
  {id:'boss_no_items',name:'Á¥†Êâã„ÅÆÂãáËÄÖ',desc:'„Ç¢„Ç§„ÉÜ„É†Êú™‰ΩøÁî®„Åß„Éú„Çπ„ÇíÊíÉÁ†¥„Åó„Åü',icon:'‚úä',cat:'„Éú„Çπ'},
  {id:'all_bosses',name:'ÂÖ®Á´†Âà∂Ë¶á',desc:'ÂÖ®8Á´†„ÅÆ„Éú„Çπ„ÇíÊíÉÁ†¥„Åó„Åü',icon:'üëë',cat:'„Éú„Çπ'},
  {id:'combo_3',name:'„Éà„É™„Éó„É´„Ç≥„É≥„Éú',desc:'„Éú„ÇπÊà¶„Åß3ÈÄ£Á∂öÊ≠£Ëß£„ÇíÈÅîÊàê',icon:'üî•',cat:'ÈÄ£Á∂öÊ≠£Ëß£'},
  {id:'combo_5',name:'„Éö„É≥„Çø„Ç≥„É≥„Éú',desc:'„Éú„ÇπÊà¶„Åß5ÈÄ£Á∂öÊ≠£Ëß£„ÇíÈÅîÊàê',icon:'‚ö°',cat:'ÈÄ£Á∂öÊ≠£Ëß£'},
  {id:'combo_10',name:'„Ç¥„ÉÉ„Éâ„Ç≥„É≥„Éú',desc:'„Éú„ÇπÊà¶„Åß10ÈÄ£Á∂öÊ≠£Ëß£„ÇíÈÅîÊàê',icon:'üåü',cat:'ÈÄ£Á∂öÊ≠£Ëß£'},
  {id:'practice_perfect',name:'Á∑¥Áøí„ÅÆÈ¨º',desc:'Á∑¥ÁøíÂïèÈ°å„ÇíÂÖ®Âïè‰∏ÄÁô∫Ê≠£Ëß£„Åó„Åü',icon:'üìù',cat:'Â≠¶Áøí'},
  {id:'use_all_items',name:'„Ç¢„Ç§„ÉÜ„É†„Éû„Çπ„Çø„Éº',desc:'ÂÖ®4Á®Æ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Çí‰ΩøÁî®„Åó„Åü',icon:'üéí',cat:'„Ç¢„Ç§„ÉÜ„É†'},
  {id:'first_purchase',name:'„ÅäË≤∑„ÅÑÁâ©„Éá„Éì„É•„Éº',desc:'„Ç∑„Éß„ÉÉ„Éó„ÅßÂàù„ÇÅ„Å¶Ë≤∑„ÅÑÁâ©„Åó„Åü',icon:'üõí',cat:'„Ç¢„Ç§„ÉÜ„É†'},
  {id:'half_clear',name:'Êäò„ÇäËøî„ÅóÂú∞ÁÇπ',desc:'ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„ÅÆÂçäÂàÜ„Çí„ÇØ„É™„Ç¢„Åó„Åü',icon:'üèÉ',cat:'ÈÄ≤Ë°å'},
  {id:'all_stages',name:'„Ç≥„É≥„Éó„É™„Éº„Éà',desc:'ÂÖ®„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Åü',icon:'üèÜ',cat:'ÈÄ≤Ë°å'},
  {id:'level_50',name:'Âçä‰∫∫ÂâçÂçíÊ•≠',desc:'„É¨„Éô„É´50„Å´Âà∞ÈÅî„Åó„Åü',icon:'‚≠ê',cat:'„É¨„Éô„É´'},
  {id:'level_100',name:'Áôæ„ÅÆÂ¢ÉÂú∞',desc:'„É¨„Éô„É´100„Å´Âà∞ÈÅî„Åó„Åü',icon:'üåô',cat:'„É¨„Éô„É´'},
  {id:'level_200',name:'‰∫åÁôæ„ÅÆÈ´ò„Åø',desc:'„É¨„Éô„É´200„Å´Âà∞ÈÅî„Åó„Åü',icon:'‚òÄÔ∏è',cat:'„É¨„Éô„É´'},
  {id:'gold_1000',name:'ÂçÉÈáëÊåÅ„Å°',desc:'„Ç¥„Éº„É´„Éâ„Çí1000‰ª•‰∏äÊâÄÊåÅ„Åó„Åü',icon:'üí∞',cat:'„Ç¥„Éº„É´„Éâ'},
  {id:'gold_5000',name:'Â§ßÂØåË±™',desc:'„Ç¥„Éº„É´„Éâ„Çí5000‰ª•‰∏äÊâÄÊåÅ„Åó„Åü',icon:'üíé',cat:'„Ç¥„Éº„É´„Éâ'}
];
let practiceFirstTryCount=0;
let bossItemsUsedThisFight=false;

function unlockAchievement(id){
  if(!state.achievements)state.achievements=[];
  if(state.achievements.includes(id))return false;
  const a=ACHIEVEMENTS.find(x=>x.id===id);if(!a)return false;
  state.achievements.push(id);saveState();
  showAchievementNotification(a);
  return true;
}
function showAchievementNotification(a){
  playSfx('victory');
  const ov=document.createElement('div');ov.className='achievement-notify';
  ov.innerHTML=`<div class="achievement-notify-box">
    <div class="achievement-notify-icon">${a.icon}</div>
    <div class="achievement-notify-label">ÂÆüÁ∏æËß£Èô§ÔºÅ</div>
    <div class="achievement-notify-name">${a.name}</div>
    <div class="achievement-notify-desc">${a.desc}</div>
  </div>`;
  document.body.appendChild(ov);
  setTimeout(()=>{ov.classList.add('fade-out');setTimeout(()=>ov.remove(),600)},2800);
}
function checkLevelAchievements(lv){
  if(lv>=50)unlockAchievement('level_50');
  if(lv>=100)unlockAchievement('level_100');
  if(lv>=200)unlockAchievement('level_200');
}
function checkGoldAchievements(){
  if(state.gold>=1000)unlockAchievement('gold_1000');
  if(state.gold>=5000)unlockAchievement('gold_5000');
}
function checkProgressAchievements(){
  let total=0,cleared=0;
  for(const ch of CHAPTERS){total+=ch.stageCount;const cs=state.chapters[ch.id];if(cs)cleared+=cs.clearedStages.length;}
  if(cleared>=1)unlockAchievement('first_clear');
  if(cleared>=Math.ceil(total/2))unlockAchievement('half_clear');
  if(cleared>=total)unlockAchievement('all_stages');
}
function checkAllBossesAchievement(){
  const allCleared=CHAPTERS.every(ch=>{const cs=state.chapters[ch.id];return cs&&cs.bossCleared;});
  if(allCleared)unlockAchievement('all_bosses');
}
function checkItemAchievements(){
  if(!state.usedItemTypes)state.usedItemTypes=[];
  const allTypes=SHOP_ITEMS.map(i=>i.id);
  if(allTypes.every(t=>state.usedItemTypes.includes(t)))unlockAchievement('use_all_items');
}
function trackItemUse(itemId){
  if(!state.usedItemTypes)state.usedItemTypes=[];
  if(!state.usedItemTypes.includes(itemId)){state.usedItemTypes.push(itemId);saveState();}
  checkItemAchievements();
}

/* ===== Áä∂ÊÖãÁÆ°ÁêÜ ===== */
let state=loadState();
function defaultState(){return getDefaultSaveData()}
function loadState(){
  return loadSaveData();
}
function saveState(){
  saveSaveData(state);
  updateHeader();
  updateAccountDisplay();
}

/* ===== ÂäπÊûúÈü≥ ===== */
const SFX={
  exp:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô22.mp3'),
  gold:new Audio('„ÅäÈáë„Åå„Ç∏„É£„É©„Ç∏„É£„É©.mp3'),
  select:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô3.mp3'),
  confirm:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô18.mp3'),
  buff:new Audio('„Ç≤„Éº„Ç∏ÂõûÂæ©1.mp3'),
  correct:new Audio('„ÇØ„Ç§„Ç∫Ê≠£Ëß£1.mp3'),
  wrong:new Audio('Â∞è„Éë„É≥„ÉÅ.mp3'),
  typing:new Audio('„Ç≠„Éº„Éú„Éº„Éâ1.mp3'),
  hit:new Audio('Â§ß„Ç≠„ÉÉ„ÇØ.mp3'),
  magic:new Audio('ÈáçÂäõÈ≠îÊ≥ï1.mp3'),
  victory:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô41.mp3'),
  buy:new Audio('„ÅäÈáë„Åå„Ç∏„É£„É©„Ç∏„É£„É©.mp3')
};
Object.values(SFX).forEach(a=>{a.volume=0.4;a.preload='auto';});
SFX.typing.volume=0.15;
SFX.hit.volume=0.5;
function playSfx(key){const a=SFX[key];if(!a)return;a.currentTime=0;a.play().catch(()=>{});}

/* „Çø„Ç§„Éû„ÉºBGMÔºà„É´„Éº„Éó„ÉªÊéß„Åà„ÇÅÈü≥ÈáèÔºâ */
const _timerBgm=new Audio('Âà∂ÈôêÊôÇÈñì„Çø„Ç§„Éû„Éº.mp3');
_timerBgm.loop=true;_timerBgm.volume=0.08;_timerBgm.preload='auto';
function playTimerSound(){_timerBgm.currentTime=0;_timerBgm.play().catch(()=>{});}
function stopTimerSound(){_timerBgm.pause();_timerBgm.currentTime=0;}

/* ===== „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºÊºîÂá∫ ===== */
let twTimer=null,twSkipFn=null;
function typewriter(el,text,speed,onDone){
  let i=0;el.textContent='';
  clearInterval(twTimer);
  twTimer=setInterval(()=>{
    if(i<text.length){
      el.textContent+=text[i];
      if(i%2===0)playSfx('typing');
      i++;
      if(i%20===0)el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }else{
      clearInterval(twTimer);twTimer=null;twSkipFn=null;
      if(onDone)onDone();
    }
  },speed);
  twSkipFn=()=>{clearInterval(twTimer);twTimer=null;el.textContent=text;twSkipFn=null;if(onDone)onDone();};
}
function skipTypewriter(){if(twSkipFn){twSkipFn();return true;}return false;}

/* ===== DQÈ¢®„É¨„Éô„É´Ë®àÁÆó ===== */
const MAX_LEVEL=999;
function expForLevel(lv){return Math.floor(45+lv*0.28);}
const CHAPTER_EXP_MULT=[0.5,0.7,0.9,1.0,1.2,1.4,1.6,1.8];
function chapterExpMult(){const id=currentChapter?currentChapter.id:1;return CHAPTER_EXP_MULT[id-1]||1.0;}
function calcLevel(totalExp){
  let lv=1,used=0;
  while(lv<MAX_LEVEL){
    const need=expForLevel(lv);
    if(totalExp<used+need)return{level:lv,cur:totalExp-used,next:need};
    used+=need;lv++;
  }
  return{level:MAX_LEVEL,cur:0,next:0};
}

/* ===== Áß∞Âè∑„Ç∑„Çπ„ÉÜ„É† ===== */
const TITLE_TABLE=[
  {lv:1,name:'ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã'},
  {lv:5,name:'Ë¶ãÁøí„ÅÑÂÜíÈô∫ËÄÖ'},
  {lv:10,name:'ÂÜíÈô∫ËÄÖ'},
  {lv:20,name:'ÊóÖ„ÅÆÂâ£Â£´'},
  {lv:30,name:'Áü•Ë≠ò„ÅÆÊé¢Ê±ÇËÄÖ'},
  {lv:50,name:'ÁÜüÁ∑¥„ÅÆÊà¶Â£´'},
  {lv:75,name:'ÁôΩÈäÄ„ÅÆÈ®éÂ£´'},
  {lv:100,name:'Áü•Ë≠ò„ÅÆÈ®éÂ£´'},
  {lv:150,name:'È≠îÊ≥ï‰Ωø„ÅÑ'},
  {lv:200,name:'Â§ßÈ≠îÊ≥ï‰Ωø„ÅÑ'},
  {lv:250,name:'Ë≥¢ËÄÖ'},
  {lv:300,name:'Â§ßË≥¢ËÄÖ'},
  {lv:400,name:'ÂãáËÄÖ'},
  {lv:500,name:'‰ºùË™¨„ÅÆÂãáËÄÖ'},
  {lv:600,name:'Ëã±ÈõÑ'},
  {lv:700,name:'Â§ßËã±ÈõÑ'},
  {lv:800,name:'Ë¶áÁéã'},
  {lv:900,name:'Á•û„ÅÆÈ†òÂüü'},
  {lv:950,name:'IT„ÅÆÂÆàË≠∑ËÄÖ'},
  {lv:999,name:'IT„ÅÆÁ•û'}
];
function getTitleForLevel(lv){
  let t=TITLE_TABLE[0];
  for(const e of TITLE_TABLE){if(lv>=e.lv)t=e;else break;}
  return t.name;
}
function getNextTitle(lv){
  for(const e of TITLE_TABLE){if(e.lv>lv)return e;}
  return null;
}
// Êó¢Â≠ò„Çª„Éº„Éñ„ÅÆÁß∞Âè∑„ÇíÁèæÂú®„É¨„Éô„É´„Å´Âêà„Çè„Åõ„Å¶Ë£úÊ≠£
(function(){
  const lv=calcLevel(state.exp).level;
  const t=getTitleForLevel(lv);
  if(state.currentTitle!==t){
    state.currentTitle=t;
    if(!state.titles)state.titles=[];
    for(const e of TITLE_TABLE){if(e.lv<=lv&&!state.titles.includes(e.name))state.titles.push(e.name);}
  }
})();
function updateHeader(){
  const info=calcLevel(state.exp);
  state.level=info.level;
  // „Çµ„Ç§„Éâ„Éë„Éç„É´Êõ¥Êñ∞
  const el=id=>document.getElementById(id);
  el('sp-level').textContent=state.level;
  el('sp-exp').textContent=state.exp;
  el('sp-gold').textContent=state.gold;
  updatePlayTimeDisplay();
  const pct=info.next>0?Math.min((info.cur/info.next)*100,100):100;
  el('sp-exp-bar').style.width=pct+'%';
  el('sp-exp-next').textContent=info.next>0?`Ê¨°„ÅÆLv„Åæ„Åß ${info.next-info.cur}`:'MAX';
  // Áß∞Âè∑Êõ¥Êñ∞
  const title=getTitleForLevel(info.level);
  if(!state.currentTitle)state.currentTitle=title;
  el('sp-title').textContent=state.currentTitle;
  const nt=getNextTitle(info.level);
  el('sp-title-next').textContent=nt?`Ê¨°„ÅÆÁß∞Âè∑: ${nt.name} (Lv${nt.lv})`:'ÊúÄÈ´òÁß∞Âè∑„Å´Âà∞ÈÅîÔºÅ';
  // „Ç´„É™„Ç≠„É•„É©„É†ÈÄ≤Êçó
  if(currentChapter){
    const cs=chapterState();
    const total=currentChapter.stageCount+1;
    const cleared=cs.clearedStages.length+(cs.bossCleared?1:0);
    el('sp-cur-fill').style.width=((cleared/total)*100)+'%';
    el('sp-cur-text').textContent=`${cleared} / ${total} „ÇØ„É™„Ç¢`;
  }else{
    // ÂÖ®‰ΩìÈÄ≤Êçó
    let totalAll=0,clearedAll=0;
    CHAPTERS.forEach(ch=>{
      totalAll+=ch.stageCount+1;
      const cs=state.chapters[ch.id];
      if(cs){clearedAll+=cs.clearedStages.length+(cs.bossCleared?1:0);}
    });
    el('sp-cur-fill').style.width=(totalAll>0?((clearedAll/totalAll)*100):0)+'%';
    el('sp-cur-text').textContent=`${clearedAll} / ${totalAll} „ÇØ„É™„Ç¢`;
  }
  // „Ç¢„Ç§„ÉÜ„É†„Éê„Éº
  renderSidebarItems();
}

/* ===== ÁîªÈù¢Âàá„ÇäÊõø„Åà ===== */
function showScreen(id){
  // „Éá„É¢Áâà: „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû„ÉªÂõ≥Èëë„Éª„Éê„ÉÉ„Ç∏„ÉªÊ®°Ë©¶„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÂà∂Èôê
  if(IS_DEMO && (id==='screen-chapters'||id==='screen-collection'||id==='screen-badges'||id==='screen-mock-exam')){
    id='screen-map';
  }
  clearQuestionTimer();
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
  if(id==='screen-chapters')renderChapterGrid();
  if(id==='screen-map')renderStageGrid();
  if(id==='screen-collection')renderCollection();
  if(id==='screen-badges')renderBadges();
  if(id==='screen-mock-exam')renderMockExamStart();
}

/* ===== „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû ===== */
function renderChapterGrid(){
  const grid=document.getElementById('chapter-grid');grid.innerHTML='';
  CHAPTERS.forEach((ch,i)=>{
    const cs=state.chapters[ch.id]||{clearedStages:[],bossCleared:false};
    const unlocked=i===0||(()=>{
      const prev=CHAPTERS[i-1];
      const prevCs=state.chapters[prev.id];
      return prevCs&&prevCs.bossCleared;
    })();
    const allCleared=ch.isMockExam?false:cs.bossCleared;
    const progress=ch.isMockExam?0:cs.clearedStages.length+(cs.bossCleared?1:0);
    const total=ch.isMockExam?'--':ch.stageCount+1;
    const c=document.createElement('div');
    c.className='chapter-card'+(unlocked?'':' locked')+(allCleared?' cleared':'');
    c.innerHTML=`<div class="chapter-num">${ch.title.split(' ')[0]}</div>
      <div class="chapter-card-title">${ch.title.replace(/^Á¨¨\dÁ´†\s*/,'')}</div>
      <div class="chapter-card-desc">${ch.description}</div>
      <div class="chapter-domain ${ch.domainClass}">${ch.domain}</div>
      <div class="chapter-progress">${ch.isMockExam?'‰ΩïÂ∫¶„Åß„ÇÇÊåëÊà¶ÂèØËÉΩ':`${progress}/${total} „ÇØ„É™„Ç¢`}</div>`;
    if(unlocked)c.onclick=()=>selectChapter(ch.id);
    grid.appendChild(c);
  });
}

async function selectChapter(chapterId){
  playSfx('confirm');
  const ch=CHAPTERS.find(c=>c.id===chapterId);
  if(!ch)return;
  currentChapter=ch;
  if(ch.isMockExam){
    showScreen('screen-mock-exam');
    return;
  }
  document.getElementById('map-chapter-title').textContent=ch.title;
  document.getElementById('map-chapter-desc').textContent=ch.description;
  showScreen('screen-map');
  await loadChapterData(chapterId);
}

/* ===== „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû ===== */
function renderStageGrid(){
  const grid=document.getElementById('stage-grid');grid.innerHTML='';

  if(!currentChapter){return;}

  // „Éá„Éº„Çø„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
  if(COURSE_DATA.length === 0 && !BOSS_DATA.bossName) {
    grid.innerHTML = '<div style="text-align:center; padding:50px; color:#aaa; font-size:18px;">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
    return;
  }

  const cs=chapterState();
  COURSE_DATA.forEach((st,i)=>{
    const unlocked=IS_DEMO?true:(i===0||cs.clearedStages.includes(COURSE_DATA[i-1].stageId));
    const cleared=cs.clearedStages.includes(st.stageId);
    const c=document.createElement('div');
    c.className='stage-card'+(unlocked?'':' locked')+(cleared?' cleared':'');
    c.innerHTML=`<div class="stage-num">Stage ${st.stageId}</div><div class="stage-name">${st.title}</div><div class="stage-sub">${st.subtitle}</div><div class="stage-category">${st.subcategory}</div>`;
    if(unlocked)c.onclick=()=>startStage(st.stageId);
    grid.appendChild(c);
  });
  const bu=IS_DEMO?true:cs.clearedStages.length>=currentChapter.stageCount;
  const bossStageNum=IS_DEMO?COURSE_DATA.length+1:currentChapter.stageCount+1;
  const bc=document.createElement('div');
  bc.className='stage-card boss'+(bu?'':' locked')+(cs.bossCleared?' cleared':'');
  bc.innerHTML=`<div class="stage-num">Stage ${bossStageNum}</div><div class="stage-name">${BOSS_DATA.bossName||'???'}</div><div class="stage-sub">${BOSS_DATA.bossDescription||''}</div><div class="stage-category" style="color:#ff5252">BOSS</div>`;
  if(bu)bc.onclick=()=>showBossPrep();
  grid.appendChild(bc);
}

/* ===== ÂïèÈ°å„Çø„Ç§„Éû„ÉºÔºà60ÁßíÂà∂ÈôêÔºâ ===== */
const Q_TIME_LIMIT=60;
let _qTimerInterval=null,_qTimerRemaining=0;
function startQuestionTimer(seconds,onExpire,barEl,textEl){
  clearQuestionTimer();
  _qTimerRemaining=seconds;
  playTimerSound();
  if(barEl){barEl.style.transition='none';barEl.style.width='100%';barEl.classList.remove('warning','danger','expired');void barEl.offsetWidth;barEl.style.transition='width 1s linear';}
  if(textEl){textEl.textContent=seconds+'Áßí';textEl.classList.remove('warning','danger','expired');}
  _qTimerInterval=setInterval(()=>{
    _qTimerRemaining--;
    const pct=(_qTimerRemaining/seconds*100);
    if(barEl){
      barEl.style.width=pct+'%';
      barEl.classList.remove('warning','danger');
      if(_qTimerRemaining<=10)barEl.classList.add('danger');
      else if(_qTimerRemaining<=20)barEl.classList.add('warning');
    }
    if(textEl){
      textEl.textContent=_qTimerRemaining+'Áßí';
      textEl.classList.remove('warning','danger');
      if(_qTimerRemaining<=10)textEl.classList.add('danger');
      else if(_qTimerRemaining<=20)textEl.classList.add('warning');
    }
    if(_qTimerRemaining<=0){
      clearQuestionTimer();
      if(barEl)barEl.classList.add('expired');
      if(textEl){textEl.textContent='0Áßí';textEl.classList.add('expired');}
      if(onExpire)onExpire();
    }
  },1000);
}
function clearQuestionTimer(){if(_qTimerInterval){clearInterval(_qTimerInterval);_qTimerInterval=null;}_qTimerRemaining=0;stopTimerSound();}
function getTimerHtml(id){return `<div class="q-timer" id="${id}"><div class="q-timer-bar"><div class="q-timer-fill" id="${id}-fill"></div></div><div class="q-timer-text" id="${id}-text">60Áßí</div></div>`;}

/* ===== Â≠¶Áøí„Éï„É≠„Éº ===== */
let currentStage=null,learnStep=0;
const PRACTICE_COUNT=4; // 1Âõû„ÅÆ„Éó„É¨„Ç§„ÅßÂá∫È°å„Åô„ÇãÁ∑¥ÁøíÂïèÈ°åÊï∞
let currentLearnSteps=[];
let currentStepNames={};

function startStage(id){
  playSfx('confirm');
  currentStage=COURSE_DATA.find(s=>s.stageId===id);
  if(!currentStage)return;
  learnStep=0;practiceFirstTryCount=0;

  // Á∑¥ÁøíÂïèÈ°å„Çí„Ç∑„É£„ÉÉ„Éï„É´„Åó„Å¶PRACTICE_COUNTÂïè„ÇíÈÅ∏Âá∫
  const allPrac=currentStage.practiceQuestions||[];
  const shuffled=[...allPrac];
  for(let i=shuffled.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];}
  currentStage.selectedPracticeQuestions=shuffled.slice(0,PRACTICE_COUNT);

  // ÈÅ∏Âá∫Êï∞„Å´Âøú„Åò„Å¶„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂãïÁöÑÁîüÊàê
  const circled='‚ë†‚ë°‚ë¢‚ë£‚ë§‚ë•‚ë¶‚ëß‚ë®‚ë©';
  const pracSteps=[];
  const pracNames={};
  currentStage.selectedPracticeQuestions.forEach((_,i)=>{
    const key='practice'+(i+1);
    pracSteps.push(key);
    pracNames[key]='Á∑¥ÁøíÂïèÈ°å'+circled[i];
  });
  currentLearnSteps=['vocab','question','knowledge',...pracSteps,'reward'];
  currentStepNames={vocab:'„Åì„Å®„Å∞„ÇíÁü•„Çç„ÅÜ',question:'ÂïèÈ°å„Å´ÊåëÊà¶',knowledge:'Áü•Ë≠ò„ÇíÂ∫É„Åí„Çà„ÅÜ',...pracNames,reward:'„Ç´„Éº„ÉâÁç≤Âæó'};

  document.getElementById('learn-title').textContent=`Stage ${id}: ${currentStage.title}`;
  document.getElementById('learn-sub').textContent=currentStage.subtitle;
  showScreen('screen-learn');
  renderLearnStep();
}

function renderLearnStep(){
  const c=document.getElementById('learn-content');
  const pct=((learnStep+1)/currentLearnSteps.length*100).toFixed(0);
  document.getElementById('learn-progress').style.width=pct+'%';
  const stepName=currentStepNames[currentLearnSteps[learnStep]]||'';
  document.getElementById('learn-progress-label').textContent=`${learnStep+1}/${currentLearnSteps.length} ${stepName}`;
  c.innerHTML='';
  const step=currentLearnSteps[learnStep];
  const mq=currentStage.mainQuestion;
  const pracQs=currentStage.selectedPracticeQuestions||[];
  if(step==='vocab')renderVocab(c,currentStage);
  else if(step==='question')renderIntegratedQuestion(c,mq);
  else if(step==='knowledge')renderKnowledge(c,currentStage.relatedKnowledge);
  else if(step.startsWith('practice')){
    const idx=parseInt(step.replace('practice',''))-1;
    if(pracQs[idx])renderPractice(c,pracQs[idx],idx+1);
  }
  else if(step==='reward')renderReward(c,currentStage);
  window.scrollTo({top:0,behavior:'smooth'});
}

function nextStep(){
  playSfx('confirm');
  learnStep++;
  if(learnStep>=currentLearnSteps.length){showScreen('screen-map');return}
  renderLearnStep();
}

/* ===== „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÈñãÈñâ ===== */
function toggleAcc(el){
  const acc=el.closest('.accordion');
  const wasOpen=acc.classList.contains('open');
  acc.classList.toggle('open');
  if(!wasOpen&&!acc.dataset.rewarded){acc.dataset.rewarded='1';const r=acc.getBoundingClientRect();rollTapReward(r.left+r.width/2,r.top+r.height/2);}
}

/* ===== ÈÅ∏ÊäûËÇ¢„Éí„É≥„ÉàÈñãÈñâ ===== */
function toggleHint(e,id){
  e.stopPropagation();
  const h=document.getElementById(id);
  const wasOpen=h.classList.contains('open');
  h.classList.toggle('open');
  if(!wasOpen){
    if(!h.dataset.rewarded){h.dataset.rewarded='1';rollTapReward(e.clientX,e.clientY);}
    // „Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßË°®Á§∫ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
    if(h.dataset.hint&&!h.dataset.filled){
      h.dataset.filled='1';
      h.textContent='';
      typewriter(h,h.dataset.hint,30);
    }
  }
}

/* ===== È†ÜÊ¨°Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É† ===== */
let revealPaused=false;

function revealNext(e){
  if(revealPaused)return;
  // „Çø„Ç§„Éó„É©„Ç§„Çø„Éº‰∏≠„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶ÁµÇ‰∫Ü
  if(skipTypewriter())return;
  const container=document.getElementById('learn-content');
  if(!container)return;
  const next=container.querySelector('.reveal-block:not(.revealed)');
  if(!next)return;
  next.classList.add('revealed');
  setTimeout(()=>{next.scrollIntoView({behavior:'smooth',block:'nearest'})},150);
  if(next.dataset.wait){revealPaused=true;}
  // „Çø„Ç§„Éû„ÉºÈñãÂßãÔºàdata-timerÂ±ûÊÄß‰ªò„Åç„Éñ„É≠„ÉÉ„ÇØÔºâ
  if(next.dataset.timer){
    const tid=next.dataset.timer;
    if(tid==='main'){
      const fill=document.getElementById('main-timer-fill'),txt=document.getElementById('main-timer-text');
      startQuestionTimer(Q_TIME_LIMIT,()=>onMainTimerExpire(),fill,txt);
    }else if(tid.startsWith('pq-')){
      const fill=document.getElementById(tid+'-timer-fill'),txt=document.getElementById(tid+'-timer-text');
      startQuestionTimer(Q_TIME_LIMIT,()=>onPracticeTimerExpire(tid),fill,txt);
    }
  }
  updateTapIndicator();
  // „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞ÈñãÂßã
  const twEl=next.querySelector('[data-tw]');
  if(twEl){typewriter(twEl,twEl.dataset.tw,35);}
  // „Çø„ÉÉ„ÉóÂ†±ÈÖ¨
  let x,y;
  if(e&&e.clientX!==undefined){x=e.clientX;y=e.clientY;}
  else{const ind=document.getElementById('tap-indicator');if(ind){const r=ind.getBoundingClientRect();x=r.left+r.width/2;y=r.top+r.height/2;}else{x=window.innerWidth/2;y=window.innerHeight/2;}}
  rollTapReward(x,y);
}

function resumeReveal(){revealPaused=false;updateTapIndicator();}

function updateTapIndicator(){
  const container=document.getElementById('learn-content');
  const indicator=document.getElementById('tap-indicator');
  if(!indicator||!container)return;
  const hasMore=container.querySelector('.reveal-block:not(.revealed)');
  if(hasMore&&!revealPaused){indicator.classList.add('active');}
  else{indicator.classList.remove('active');}
}

function retryStep(){renderLearnStep();}

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space'&&document.querySelector('#screen-learn.active')){
    e.preventDefault();revealNext(null);
  }
});

/* ===== „É©„É≥„ÉÄ„É†Â†±ÈÖ¨„Ç∑„Çπ„ÉÜ„É† ===== */
let expMultiplier=1,expBuffRemaining=0;

function rollTapReward(x,y){
  let baseExp=2;
  if(expBuffRemaining>0){baseExp=Math.ceil(baseExp*expMultiplier);expBuffRemaining--;updateBuffDisplay();}
  const roll=Math.random();
  if(roll<0.08){
    expMultiplier=1.2;expBuffRemaining=10;
    gainTapExp(x,y,baseExp);
    updateBuffDisplay();
    showBuffBanner();
  }else if(roll<0.23){
    const gold=1+Math.floor(Math.random()*3);
    state.gold+=gold;
    gainTapExp(x,y,baseExp);
    spawnGoldCoins(x,y,gold);
  }else{
    gainTapExp(x,y,baseExp);
  }
}

function spawnGoldCoins(fromX,fromY,amount){
  playSfx('gold');
  const target=document.getElementById('sp-gold');
  if(!target)return;
  const tRect=target.getBoundingClientRect();
  const tx=tRect.left+tRect.width/2,ty=tRect.top+tRect.height/2;
  const count=3;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');p.className='gold-particle';
    const ox=(Math.random()-.5)*30,oy=(Math.random()-.5)*30;
    p.style.left=(fromX+ox)+'px';p.style.top=(fromY+oy)+'px';
    document.body.appendChild(p);
    const dx=tx-(fromX+ox),dy=ty-(fromY+oy);
    const delay=i*50;
    p.animate([
      {transform:'translate(0,0) scale(1) rotate(0deg)',opacity:.8},
      {transform:`translate(${dx}px,${dy}px) scale(0.3) rotate(360deg)`,opacity:.3}
    ],{duration:500,delay:delay,easing:'ease-in',fill:'forwards'});
    setTimeout(()=>p.remove(),600+delay);
  }
  setTimeout(()=>showSidebarGain('sp-gold','+'+amount+' G','#ffd700'),400);
}

function updateBuffDisplay(){
  const el=document.getElementById('sp-buff');
  if(!el)return;
  if(expBuffRemaining>0){el.textContent=`EXP x${expMultiplier} (ÊÆã„Çä${expBuffRemaining}Âõû)`;}
  else{el.textContent='';}
}

/* ===== „Çµ„Ç§„Éâ„Éê„ÉºÂà∞ÁùÄÊôÇ„ÅÆÂ¢óÂä†Ë°®Á§∫ ===== */
function showSidebarGain(targetId,text,color){
  const el=document.getElementById(targetId);
  if(!el)return;
  const rect=el.getBoundingClientRect();
  const t=document.createElement('div');t.className='sidebar-gain';
  t.textContent=text;t.style.color=color;
  t.style.left=(rect.right+6)+'px';t.style.top=(rect.top)+'px';
  document.body.appendChild(t);
  t.animate([
    {transform:'translateY(0)',opacity:1},
    {transform:'translateY(-14px)',opacity:0}
  ],{duration:800,fill:'forwards'});
  setTimeout(()=>t.remove(),900);
}

/* ===== „Éê„ÉïÁç≤ÂæóÊºîÂá∫ ===== */
function showBuffBanner(){
  playSfx('buff');
  // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
  const flash=document.createElement('div');flash.className='buff-overlay';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),900);
  // ‰∏≠Â§Æ„Éê„Éä„Éº
  const b=document.createElement('div');b.className='buff-banner';
  b.innerHTML='<div class="buff-banner-text">EXP x1.2 GET!</div><div class="buff-banner-sub">10ÂõûÂàÜ„ÅÆEXP„Åå„Ç¢„ÉÉ„ÉóÔºÅ</div>';
  document.body.appendChild(b);
  b.animate([
    {transform:'translate(-50%,-50%) scale(.5)',opacity:0},
    {transform:'translate(-50%,-50%) scale(1.05)',opacity:1,offset:.2},
    {transform:'translate(-50%,-50%) scale(1)',opacity:1,offset:.5},
    {transform:'translate(-50%,-50%) scale(1)',opacity:0}
  ],{duration:1800,fill:'forwards'});
  setTimeout(()=>b.remove(),1900);
}

/* ===== „Çø„ÉÉ„ÉóÁµåÈ®ìÂÄ§ & „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊºîÂá∫ ===== */
function gainTapExp(x,y,amount){
  const oldLv=calcLevel(state.exp).level;
  state.exp+=amount;
  saveState();
  playSfx('exp');
  spawnTapRipple(x,y);
  spawnParticles(x,y,amount);
  const area=document.getElementById('sp-exp-area');
  if(area){area.classList.add('sp-flash');setTimeout(()=>area.classList.remove('sp-flash'),300);}
  const newLv=calcLevel(state.exp).level;
  if(newLv>oldLv){showLevelUp(newLv);checkLevelAchievements(newLv);}
}

function spawnTapRipple(x,y){
  const r=document.createElement('div');r.className='tap-ripple';
  r.style.left=(x-12)+'px';r.style.top=(y-12)+'px';
  document.body.appendChild(r);
  setTimeout(()=>r.remove(),600);
}

function spawnParticles(fromX,fromY,amount){
  const target=document.getElementById('sp-exp-area');
  if(!target)return;
  const tRect=target.getBoundingClientRect();
  const tx=tRect.left+tRect.width/2,ty=tRect.top+tRect.height/2;
  const count=4;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');p.className='xp-particle';
    const angle=(Math.PI*2/count)*i;
    const spread=12+Math.random()*10;
    const ox=Math.cos(angle)*spread,oy=Math.sin(angle)*spread;
    p.style.left=(fromX+ox)+'px';p.style.top=(fromY+oy)+'px';
    document.body.appendChild(p);
    const dx=tx-(fromX+ox),dy=ty-(fromY+oy);
    const delay=i*30;
    p.animate([
      {transform:'translate(0,0) scale(1)',opacity:.8},
      {transform:`translate(${dx}px,${dy}px) scale(0.2)`,opacity:.2}
    ],{duration:450,delay:delay,easing:'ease-in',fill:'forwards'});
    setTimeout(()=>p.remove(),550+delay);
  }
  setTimeout(()=>showSidebarGain('sp-exp','+'+amount,'#7ecfff'),350);
}

function showLevelUp(newLv){
  const flash=document.createElement('div');flash.className='levelup-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),700);
  const ov=document.getElementById('levelup-overlay');
  document.getElementById('levelup-number').textContent='Lv.'+newLv;
  setTimeout(()=>ov.classList.add('active'),300);
  // Áß∞Âè∑„ÉÅ„Çß„ÉÉ„ÇØ
  const newTitle=getTitleForLevel(newLv);
  if(newTitle!==state.currentTitle){
    state.currentTitle=newTitle;
    if(!state.titles)state.titles=[];
    if(!state.titles.includes(newTitle))state.titles.push(newTitle);
    saveState();
    setTimeout(()=>showTitleOverlay(newTitle),1200);
  }
}
function closeLevelUp(){document.getElementById('levelup-overlay').classList.remove('active');}

function showTitleOverlay(titleName){
  closeLevelUp();
  const flash=document.createElement('div');flash.className='title-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),900);
  document.getElementById('title-got-name').textContent=titleName;
  setTimeout(()=>document.getElementById('title-overlay').classList.add('active'),200);
}
function closeTitleOverlay(){document.getElementById('title-overlay').classList.remove('active');}

/* ===== „Åì„Å®„Å∞„Çπ„ÉÜ„ÉÉ„Éó ===== */
function renderVocab(c,stage){
  const mq=stage.mainQuestion;
  const words=mq.wordExplanations||[];
  revealPaused=false;
  const div=document.createElement('div');
  let html=`<div class="section-card">
    <span class="step-badge step-vocab">Step ${learnStep+1}</span>
    <div class="section-title" style="color:#ffd700;border-bottom-color:#5a4a00">„Åæ„Åö„ÄÅ„Åì„Å®„Å∞„ÇíÁü•„Çç„ÅÜ</div>

    <div class="reveal-block revealed">
      <div class="vocab-intro" data-tw="„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ„ÉÜ„Éº„Éû„ÅØ„Äå${stage.title}„Äç„Å†„Çà„ÄÇ\n${stage.subtitle}„ÄÇ\n\nÂïèÈ°å„ÇíËß£„ÅèÂâç„Å´„ÄÅÂá∫„Å¶„Åè„ÇãÂ§ß‰∫ã„Å™„Åì„Å®„Å∞„Çí1„Å§„Åö„Å§Ë¶ö„Åà„Çà„ÅÜÔºÅ"></div>
    </div>

    ${words.map(w=>`<div class="reveal-block">
      <div class="vocab-card">
        <div><span class="vocab-word">${w.word}</span>${w.reading&&w.reading!==w.word?`<span class="vocab-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
        <div class="vocab-meaning" data-tw="${w.explanation.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`).join('')}

    <div class="reveal-block">
      <div class="confirm-box">
        <div class="confirm-text">„Åì„Åì„Åæ„Åß„ÅÆ„Åì„Å®„Å∞„ÅØË¶ö„Åà„ÅüÔºü</div>
        <div class="confirm-subtext">${words.length}„Å§„ÅÆ„Åì„Å®„Å∞„ÇíÂ≠¶„Çì„Å†„Çà„ÄÇÂïèÈ°å„Å´Âá∫„Å¶„Åè„Çã„ÅÆ„ÅßË¶ö„Åà„Å¶„Åä„Åì„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">Ë¶ö„Åà„ÅüÔºÅÂïèÈ°å„Å´ÈÄ≤„ÇÄ</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== Áµ±ÂêàÂïèÈ°åÁîªÈù¢ ===== */
function renderIntegratedQuestion(c,mq){
  revealPaused=false;
  const div=document.createElement('div');

  // ÈÅ∏ÊäûËÇ¢„Çí„Ç∑„É£„ÉÉ„Éï„É´Ôºà„É©„Éô„É´„ÅØÂõ∫ÂÆö„ÄÅ‰∏≠Ë∫´„ÇíÂÖ•„ÇåÊõø„ÅàÔºâ
  const origKeys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  const vals=origKeys.filter(k=>mq.choices[k]).map(k=>({origKey:k,text:mq.choices[k]}));
  for(let i=vals.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[vals[i],vals[j]]=[vals[j],vals[i]];}
  const shuffledChoices={};
  let shuffledAnswer=mq.answer;
  const ansText=mq.choices[mq.answer];
  origKeys.forEach((k,i)=>{
    if(i<vals.length){
      shuffledChoices[k]=vals[i].text;
      if(vals[i].text===ansText)shuffledAnswer=k;
    }
  });

  window._mainShuffledAnswer=shuffledAnswer;

  // choiceAnalysis„Çí„Ç∑„É£„ÉÉ„Éï„É´Âæå„ÅÆ„É©„Éô„É´„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
  const analysisMap={};
  if(mq.choiceAnalysis)mq.choiceAnalysis.forEach(a=>{analysisMap[mq.choices[a.choice]]=a;});

  let choicesHtml='';
  origKeys.forEach(k=>{
    if(!shuffledChoices[k])return;
    const hintId='hint-main-'+k;
    const analysis=analysisMap[shuffledChoices[k]];
    const hintText=analysis?analysis.explanation:'';
    choicesHtml+=`<div class="choice-item" id="ci-${k}">
      <div class="choice-main" onclick="selectMain('${k}','${shuffledAnswer}')">
        <span class="choice-label">${k}.</span>
        <span class="choice-text">${shuffledChoices[k]}</span>
        <button class="choice-hint-btn" onclick="toggleHint(event,'${hintId}')">„Éí„É≥„Éà</button>
      </div>
      <div class="choice-hint" id="${hintId}" data-hint="${hintText.replace(/"/g,'&quot;')}"></div>
    </div>`;
  });

  let html=`<div class="section-card">
    <span class="step-badge step-question">Step ${learnStep+1}</span>
    <div class="section-title question-title">ÈÅéÂéªÂïè„Å´ÊåëÊà¶„Åó„Çà„ÅÜ</div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ1: ÂïèÈ°åÊñáÔºàËá™ÂãïË°®Á§∫„Éª„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÄÅ„É¢„Éê„Ç§„É´„Åß„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„ÉºÔºâ -->
    <div class="reveal-block revealed sticky-q">
      <div class="q-source">${mq.source}</div>
      <div class="q-text" data-tw="${mq.originalText.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ2: „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü -->
    <div class="reveal-block">
      <div class="question-guide">
        <div class="question-guide-title">„Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü</div>
        <div class="question-guide-text" data-tw="${mq.questionExplained.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ3: „Åì„Å®„Å∞Âæ©Áøí -->
    <div class="reveal-block">
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAcc(this)">
          <span class="acc-icon">‚ñ∂</span>
          <span class="acc-label">„Åì„Å®„Å∞„ÇíÂæ©Áøí„Åô„Çã</span>
          <span class="acc-tag words">Áî®Ë™û</span>
        </div>
        <div class="accordion-body">
          ${mq.wordExplanations.map(w=>`<div class="word-item">
            <div class="word-term">${w.word}${w.reading&&w.reading!==w.word?` <span class="word-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
            <div class="word-desc">${w.explanation}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ4: ÈÅ∏ÊäûËÇ¢ÔºàÂõûÁ≠î„ÇíÂæÖ„Å§Ôºâ -->
    <div class="reveal-block" data-wait="answer" data-timer="main">
      ${getTimerHtml('main-timer')}
      <div style="margin-top:8px;margin-bottom:8px;font-size:.9rem;color:#ffd700;font-weight:bold">„Åï„ÅÇ„ÄÅÁ≠î„Åà„ÇíÈÅ∏„Åº„ÅÜÔºÅ</div>
      <div class="strategy-hint-wrap">
        <button class="strategy-hint-btn" onclick="toggleStrategyHint(this)">
          <span class="strategy-hint-icon">‚ñ∂</span> ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà
        </button>
        <div class="strategy-hint-body" id="strategy-hint-body">
          <ol class="strategy-steps" id="strategy-hint-steps"></ol>
        </div>
      </div>
      <div id="main-choices">${choicesHtml}</div>
      <div class="answer-confirm" id="answer-confirm">
        <div class="confirm-text">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
        <div id="answer-confirm-label" style="font-size:.85rem;color:#aaa;margin:8px 0"></div>
        <button class="confirm-btn confirm-yes" onclick="confirmAnswer()">„Åì„ÅÆÁ≠î„Åà„ÅßÊ±∫ÂÆöÔºÅ</button>
        <button class="confirm-btn confirm-retry" onclick="cancelAnswer()">ÈÅ∏„Å≥Áõ¥„Åô</button>
      </div>
    </div>

    <!-- === ÂõûÁ≠îÂæå„Å´È†ÜÊ¨°Ë°®Á§∫„Åï„Çå„Çã„Éñ„É≠„ÉÉ„ÇØ === -->

    <!-- „Éñ„É≠„ÉÉ„ÇØ5: Ê≠£Ëß£/‰∏çÊ≠£Ëß£„Éê„Éä„Éº + ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨ -->
    <div class="reveal-block" id="rb-analysis">
      <div id="result-banner"></div>
      <div style="margin-top:12px;font-size:.9rem;font-weight:bold;color:#fff;margin-bottom:8px">ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨</div>
      <div id="choice-analysis-content">
        ${origKeys.filter(k=>shuffledChoices[k]).map(k=>{
          const a=analysisMap[shuffledChoices[k]];
          if(!a)return'';
          const isC=a.verdict.includes('Ê≠£Ëß£');
          return`<div class="analysis-item ${isC?'is-correct':'is-wrong'}">
            <span class="analysis-verdict ${isC?'correct':'wrong'}">${k}. ${a.verdict}</span>
            <div style="font-size:.85rem;color:#ccc;margin-top:4px">${a.explanation}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ7: Ëß£„ÅçÊñπ„ÅÆÊåØ„ÇäËøî„ÇäÔºàÂÖ®„Çπ„ÉÜ„ÉÉ„ÉóÔºã„Å≤„Å£„Åã„ÅëÔºâ -->
    <div class="reveal-block" id="rb-strategy">
      <div style="font-size:.9rem;font-weight:bold;color:#ffb74d;margin-bottom:8px">Ëß£„ÅçÊñπ„ÅÆÊåØ„ÇäËøî„Çä</div>
      <div style="font-size:.82rem;color:#aaa;margin-bottom:8px">Á≠î„Åà„ÇíÂê´„ÇÅ„ÅüÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜ</div>
      <ol class="strategy-steps">${mq.solvingStrategy.steps.map(s=>`<li>${s}</li>`).join('')}</ol>
      <div class="trap-box"><div class="trap-label">„Å≤„Å£„Åã„Åë„Éù„Ç§„É≥„Éà</div><div>${mq.solvingStrategy.trap}</div></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ7: ÁêÜËß£Â∫¶Á¢∫Ë™ç -->
    <div class="reveal-block" id="rb-confirm">
      <div class="confirm-box">
        <div class="confirm-text">„Åì„ÅÆÂïèÈ°å„ÅÆËß£„ÅçÊñπ„ÅØÁêÜËß£„Åß„Åç„ÅüÔºü</div>
        <div class="confirm-subtext">ÈÅ∏ÊäûËÇ¢„Åî„Å®„ÅÆÊ≠£Ë™§„ÅÆÁêÜÁî±„Å®„ÄÅËß£„ÅçÊñπ„ÅÆ„Ç≥„ÉÑ„ÇíË¶ö„Åà„Çà„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">ÁêÜËß£„Åß„Åç„ÅüÔºÅÊ¨°„Å∏ÈÄ≤„ÇÄ</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;

  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  // ‰øùÁïô‰∏≠„ÅÆ„Çπ„Éà„É©„ÉÜ„Ç∏„Éº„Çπ„ÉÜ„ÉÉ„Éó„Çí‰øùÂ≠ò
  window._strategySteps=mq.solvingStrategy.steps.slice(0,-1);
  // ÊúÄÂàù„ÅÆ„Éñ„É≠„ÉÉ„ÇØÔºàÂïèÈ°åÊñáÔºâ„ÅÆ„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÇíËá™ÂãïÈñãÂßã
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà ÈñãÈñâ ===== */
function toggleStrategyHint(btn){
  const wasOpen=btn.classList.contains('open');
  btn.classList.toggle('open');
  const body=document.getElementById('strategy-hint-body');
  if(!body)return;
  if(!wasOpen){
    body.classList.add('open');
    // ÂàùÂõû„ÅÆ„ÅøÂ†±ÈÖ¨Ôºã„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßÈ†ÜÊ¨°Ë°®Á§∫
    if(!btn.dataset.rewarded){
      btn.dataset.rewarded='1';
      const r=btn.getBoundingClientRect();
      rollTapReward(r.left+r.width/2,r.top+r.height/2);
    }
    // „Çπ„ÉÜ„ÉÉ„Éó„Çí1„Å§„Åö„Å§„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßË°®Á§∫
    const ol=document.getElementById('strategy-hint-steps');
    if(ol&&window._strategySteps&&!ol.dataset.filled){
      ol.dataset.filled='1';
      ol.innerHTML='';
      let idx=0;
      const steps=window._strategySteps;
      function showNextStep(){
        if(idx>=steps.length)return;
        const li=document.createElement('li');
        li.style.opacity='0';
        ol.appendChild(li);
        li.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
        typewriter(li,steps[idx],30,()=>{idx++;setTimeout(showNextStep,200);});
      }
      showNextStep();
    }
  }else{
    body.classList.remove('open');
  }
}

let pendingKey=null,pendingAnswer=null;

function selectMain(key,answer){
  if(document.querySelector('.choice-item.correct'))return;
  playSfx('select');
  // „É™„Éà„É©„Ç§Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
  document.querySelectorAll('#main-choices .choice-item.wrong').forEach(ci=>ci.classList.remove('wrong'));
  const _rm=document.getElementById('main-retry-msg');if(_rm)_rm.style.display='none';
  // Êó¢„Å´ÈÅ∏Êäû‰∏≠„Å™„ÇâËß£Èô§
  document.querySelectorAll('.choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  // ÈÅ∏Êäû„Çí„Éè„Ç§„É©„Ç§„Éà
  pendingKey=key;pendingAnswer=answer;
  document.getElementById('ci-'+key).classList.add('selected');
  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
  const conf=document.getElementById('answer-confirm');
  const label=document.getElementById('answer-confirm-label');
  label.textContent='ÈÅ∏„Çì„Å†Á≠î„Åà: '+key;
  conf.style.display='block';
  setTimeout(()=>{conf.scrollIntoView({behavior:'smooth',block:'nearest'})},100);
}

function confirmAnswer(){
  if(!pendingKey)return;
  clearQuestionTimer();
  playSfx('confirm');
  const key=pendingKey,answer=pendingAnswer;
  const correct=key===answer;
  document.getElementById('answer-confirm').style.display='none';
  /* ÂÖ±ÈÄö: ÂÖ®ÈÅ∏ÊäûËÇ¢„ÇíÁ¢∫ÂÆöË°®Á§∫ */
  document.querySelectorAll('.choice-item').forEach(ci=>{
    ci.classList.remove('selected');
    ci.classList.add('answered');
    if(ci.id==='ci-'+answer)ci.classList.add('correct');
    else if(ci.id==='ci-'+key&&!correct)ci.classList.add('wrong');
  });
  document.querySelectorAll('.choice-hint').forEach(h=>h.classList.add('open'));
  const banner=document.getElementById('result-banner');
  banner.className='result-banner '+(correct?'correct':'wrong');

  if(correct){
    /* === Ê≠£Ëß£ === */
    playSfx('correct');
    banner.textContent='Ê≠£Ëß£ÔºÅ';
    const ci=document.getElementById('ci-'+answer);
    const rect=ci?ci.getBoundingClientRect():{left:window.innerWidth/2,top:window.innerHeight/2,width:0,height:0};
    const bx=rect.left+rect.width/2,by=rect.top+rect.height/2;
    setTimeout(()=>gainTapExp(bx,by,20),200);
    pendingKey=null;pendingAnswer=null;
    resumeReveal();
    setTimeout(()=>{revealNext();},300);
  }else{
    /* === ‰∏çÊ≠£Ëß£: Ëß£Ë™¨„ÇíË™≠„Çì„Åß„É™„Éà„É©„Ç§ === */
    playSfx('wrong');
    banner.textContent='‰∏çÊ≠£Ëß£‚Ä¶Ëß£Ë™¨„ÇíË™≠„Çì„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ';
    const confirmBlock=document.getElementById('rb-confirm');
    confirmBlock._origHTML=confirmBlock.innerHTML;
    confirmBlock.innerHTML='<div class="confirm-box"><div class="confirm-text" style="color:#ef9a9a">Ëß£Ë™¨„ÇíË™≠„Çì„Å†„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</div><button class="confirm-btn confirm-yes" onclick="retryMainQuestion()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button></div>';
    pendingKey=null;pendingAnswer=null;
    resumeReveal();
    setTimeout(()=>{revealNext();},300);
  }
}

function cancelAnswer(){
  if(!pendingKey)return;
  document.querySelectorAll('.choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  document.getElementById('answer-confirm').style.display='none';
  pendingKey=null;pendingAnswer=null;
}

function retryMainQuestion(){
  const cb=document.getElementById('rb-confirm');
  if(cb._origHTML)cb.innerHTML=cb._origHTML;
  cb.classList.remove('revealed');
  document.getElementById('result-banner').className='result-banner';
  document.getElementById('result-banner').textContent='';
  const analysis=document.getElementById('rb-analysis');if(analysis)analysis.classList.remove('revealed');
  const strategy=document.getElementById('rb-strategy');if(strategy)strategy.classList.remove('revealed');
  document.querySelectorAll('#main-choices .choice-item').forEach(ci=>{
    ci.classList.remove('answered','correct','wrong','selected');
  });
  document.querySelectorAll('#main-choices .choice-hint').forEach(h=>h.classList.remove('open'));
  revealPaused=true;
  updateTapIndicator();
  document.querySelector('#main-choices').scrollIntoView({behavior:'smooth',block:'center'});
  // „É™„Éà„É©„Ç§ÊôÇ„ÇÇ„Çø„Ç§„Éû„ÉºÂÜçÈñã
  const fill=document.getElementById('main-timer-fill'),txt=document.getElementById('main-timer-text');
  if(fill&&txt)startQuestionTimer(Q_TIME_LIMIT,()=>onMainTimerExpire(),fill,txt);
}

function onMainTimerExpire(){
  stopTimerSound();
  playSfx('wrong');
  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈùûË°®Á§∫
  const conf=document.getElementById('answer-confirm');if(conf)conf.style.display='none';
  // ÂÖ®ÈÅ∏ÊäûËÇ¢„Çí‰∏çÊ≠£Ëß£Ë°®Á§∫
  const ans=pendingAnswer||window._mainShuffledAnswer;
  document.querySelectorAll('#main-choices .choice-item').forEach(ci=>{
    ci.classList.remove('selected');ci.classList.add('answered');
    if(ci.dataset.key===ans)ci.classList.add('correct');
  });
  document.querySelectorAll('#main-choices .choice-hint').forEach(h=>h.classList.add('open'));
  // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó„Éê„Éä„Éº
  const banner=document.getElementById('result-banner');
  banner.className='result-banner wrong';
  banner.textContent='„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ Âà∂ÈôêÊôÇÈñì„ÇíË∂Ö„Åà„Åæ„Åó„Åü';
  const confirmBlock=document.getElementById('rb-confirm');
  confirmBlock._origHTML=confirmBlock.innerHTML;
  confirmBlock.innerHTML='<div class="confirm-box"><div class="confirm-text" style="color:#ef9a9a">Ëß£Ë™¨„ÇíË™≠„Çì„Å†„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</div><button class="confirm-btn confirm-yes" onclick="retryMainQuestion()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button></div>';
  pendingKey=null;pendingAnswer=null;
  resumeReveal();
  setTimeout(()=>{revealNext();},300);
}

/* ===== Èñ¢ÈÄ£Áü•Ë≠ò ===== */
function renderKnowledge(c,rk){
  revealPaused=false;
  const div=document.createElement('div');
  let html=`<div class="section-card">
    <span class="step-badge step-knowledge">Step ${learnStep+1}</span>
    <div class="section-title knowledge-title">${rk.title}</div>

    <div class="reveal-block revealed">
      <div class="vocab-intro" data-tw="ÂïèÈ°å„Å´Èñ¢ÈÄ£„Åô„ÇãÁü•Ë≠ò„Çí„ÇÇ„Å£„Å®Â≠¶„Åº„ÅÜÔºÅ\n1„Å§„Åö„Å§Á¢∫Ë™ç„Åó„Å¶„ÅÑ„Åì„ÅÜ„ÄÇ"></div>
    </div>

    ${rk.content.map(k=>`<div class="reveal-block">
      <div class="knowledge-item">
        <div class="knowledge-term">${k.term}</div>
        <div class="knowledge-desc" data-tw="${k.description.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`).join('')}

    <div class="reveal-block">
      <div class="confirm-box">
        <div class="confirm-text">Èñ¢ÈÄ£Áü•Ë≠ò„ÇíË¶ö„Åà„ÅüÔºü</div>
        <div class="confirm-subtext">${rk.content.length}„Å§„ÅÆÁü•Ë≠ò„ÇíÂ≠¶„Çì„Å†„Çà„ÄÇÁ∑¥ÁøíÂïèÈ°å„ÅßÁ¢∫Ë™ç„Åó„Çà„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">Ë¶ö„Åà„ÅüÔºÅÁ∑¥ÁøíÂïèÈ°å„Å∏</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== Á∑¥ÁøíÂïèÈ°å ===== */
const _pqState={};
function renderPractice(c,pq,num){
  revealPaused=false;
  const uid='pq-'+num;
  const div=document.createElement('div');

  /* === ÈÅ∏ÊäûËÇ¢„Ç∑„É£„ÉÉ„Éï„É´Ôºà„É©„Éô„É´„ÅØ„Ç¢„Äú„Ç®Âõ∫ÂÆö„ÄÅ‰∏≠Ë∫´„ÇíÂÖ•„ÇåÊõø„ÅàÔºâ === */
  const origKeys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  const vals=origKeys.filter(k=>pq.choices[k]).map(k=>({origKey:k,text:pq.choices[k]}));
  for(let i=vals.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[vals[i],vals[j]]=[vals[j],vals[i]];}
  const shuffled={};let newAnswer=pq.answer;
  const ansText=pq.choices[pq.answer];
  origKeys.forEach((k,i)=>{if(i<vals.length){shuffled[k]=vals[i];if(vals[i].text===ansText)newAnswer=k;}});
  _pqState[uid]={answer:newAnswer,pendingKey:null,retried:false};

  /* === choiceAnalysis „Çí„Ç∑„É£„ÉÉ„Éï„É´Âæå„ÅÆ„É©„Éô„É´„Å´„Éû„ÉÉ„Éî„É≥„Ç∞ === */
  const analysisMap={};
  if(pq.choiceAnalysis)pq.choiceAnalysis.forEach(a=>{analysisMap[pq.choices[a.choice]]=a;});

  /* === ÈÅ∏ÊäûËÇ¢HTML === */
  let choicesHtml='';
  origKeys.forEach(k=>{
    if(!shuffled[k])return;
    const a=analysisMap[shuffled[k].text];
    const hintId=uid+'-hint-'+k;
    const hintText=a?a.explanation:'';
    choicesHtml+=`<div class="choice-item" id="${uid}-ci-${k}" data-key="${k}">
      <div class="choice-main" onclick="selectPractice('${uid}','${k}')">
        <span class="choice-label">${k}.</span>
        <span class="choice-text">${shuffled[k].text}</span>
        ${hintText?`<button class="choice-hint-btn" onclick="event.stopPropagation();toggleHint(event,'${hintId}')">„Éí„É≥„Éà</button>`:''}
      </div>
      ${hintText?`<div class="choice-hint" id="${hintId}" data-hint="${hintText.replace(/"/g,'&quot;')}"></div>`:''}
    </div>`;
  });

  /* === „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü === */
  const qExpHtml=pq.questionExplained?`
    <div class="reveal-block">
      <div class="question-guide">
        <div class="question-guide-title">„Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü</div>
        <div class="question-guide-text" data-tw="${pq.questionExplained.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`:'';

  /* === ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà === */
  const stratHtml=pq.solvingStrategy?`
      <div class="strategy-hint-wrap">
        <button class="strategy-hint-btn" onclick="togglePqStrategy(this,'${uid}')">
          <span class="strategy-hint-icon">‚ñ∂</span> ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà
        </button>
        <div class="strategy-hint-body" id="${uid}-strat-body">
          <ol class="strategy-steps" id="${uid}-strat-steps"></ol>
        </div>
      </div>`:'';

  div.innerHTML=`<div class="section-card">
    <span class="step-badge step-practice">Step ${learnStep+1}</span>
    <div class="section-title practice-title">Á∑¥ÁøíÂïèÈ°å ${num}</div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ1: ÂïèÈ°åÊñáÔºà„É¢„Éê„Ç§„É´„Åß„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„ÉºÔºâ -->
    <div class="reveal-block revealed sticky-q">
      <div class="q-source">${pq.source}</div>
      <div class="q-text" data-tw="${pq.questionText.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ2: „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü -->
    ${qExpHtml}

    <!-- „Éñ„É≠„ÉÉ„ÇØ3: „Åì„Å®„Å∞Âæ©Áøí -->
    <div class="reveal-block">
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAcc(this)">
          <span class="acc-icon">‚ñ∂</span>
          <span class="acc-label">„Åì„Å®„Å∞„ÇíÂæ©Áøí„Åô„Çã</span>
          <span class="acc-tag words">Áî®Ë™û</span>
        </div>
        <div class="accordion-body">
          ${(currentStage.mainQuestion.wordExplanations||[]).map(w=>`<div class="word-item">
            <div class="word-term">${w.word}${w.reading&&w.reading!==w.word?` <span class="word-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
            <div class="word-desc">${w.explanation}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ4: ÈÅ∏ÊäûËÇ¢ÔºàÂõûÁ≠î„ÇíÂæÖ„Å§Ôºâ -->
    <div class="reveal-block" data-wait="answer" data-timer="${uid}">
      ${getTimerHtml(uid+'-timer')}
      <div style="margin-top:8px;margin-bottom:8px;font-size:.9rem;color:#ffd700;font-weight:bold">„Åï„ÅÇ„ÄÅÁ≠î„Åà„ÇíÈÅ∏„Åº„ÅÜÔºÅ</div>
      ${stratHtml}
      <div id="${uid}-choices">${choicesHtml}</div>
      <div class="answer-confirm" id="${uid}-confirm">
        <div class="confirm-text">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
        <div id="${uid}-confirm-label" style="font-size:.85rem;color:#aaa;margin:8px 0"></div>
        <button class="confirm-btn confirm-yes" onclick="confirmPractice('${uid}')">„Åì„ÅÆÁ≠î„Åà„ÅßÊ±∫ÂÆöÔºÅ</button>
        <button class="confirm-btn confirm-retry" onclick="cancelPractice('${uid}')">ÈÅ∏„Å≥Áõ¥„Åô</button>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ5: Ê≠£Ëß£/‰∏çÊ≠£Ëß£„Éê„Éä„Éº + ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨ -->
    <div class="reveal-block" id="${uid}-result">
      <div id="${uid}-banner"></div>
      <div style="margin-top:12px;font-size:.9rem;font-weight:bold;color:#ffb74d;margin-bottom:8px">Ëß£Ë™¨</div>
      <div class="practice-explanation" id="${uid}-exp" data-tw="${pq.shortExplanation.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ6: ÁêÜËß£Â∫¶Á¢∫Ë™ç -->
    <div class="reveal-block" id="${uid}-done-block">
      <div class="confirm-box">
        <div class="confirm-text">${num<2?'ÁêÜËß£„Åß„Åç„ÅüÔºü„ÇÇ„ÅÜ1Âïè„ÇÑ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ':'ÁêÜËß£„Åß„Åç„ÅüÔºü„Ç´„Éº„Éâ„ÇíÁç≤Âæó„Åó„Çà„ÅÜÔºÅ'}</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">${num<2?'Ê¨°„ÅÆÁ∑¥ÁøíÂïèÈ°å„Å∏ ‚Üí':'„Ç´„Éº„ÉâÁç≤Âæó„Å∏ ‚Üí'}</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  if(pq.solvingStrategy)window['_pqStrat_'+uid]=pq.solvingStrategy.steps;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

function togglePqStrategy(btn,uid){
  const wasOpen=btn.classList.contains('open');
  btn.classList.toggle('open');
  const body=document.getElementById(uid+'-strat-body');
  if(!body)return;
  if(!wasOpen){
    body.classList.add('open');
    if(!btn.dataset.rewarded){btn.dataset.rewarded='1';const r=btn.getBoundingClientRect();rollTapReward(r.left+r.width/2,r.top+r.height/2);}
    const ol=document.getElementById(uid+'-strat-steps');
    const steps=window['_pqStrat_'+uid];
    if(ol&&steps&&!ol.dataset.filled){
      ol.dataset.filled='1';ol.innerHTML='';let idx=0;
      function showNext(){if(idx>=steps.length)return;const li=document.createElement('li');li.style.opacity='0';ol.appendChild(li);
        li.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
        typewriter(li,steps[idx],30,()=>{idx++;setTimeout(showNext,200);});}
      showNext();
    }
  }else{body.classList.remove('open');}
}

function selectPractice(uid,key){
  if(document.querySelector('#'+uid+'-choices .choice-item.correct'))return;
  // „É™„Éà„É©„Ç§Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
  document.querySelectorAll('#'+uid+'-choices .choice-item.wrong').forEach(ci=>ci.classList.remove('wrong'));
  const _rm=document.getElementById(uid+'-retry-msg');if(_rm)_rm.style.display='none';
  playSfx('select');
  document.querySelectorAll('#'+uid+'-choices .choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  _pqState[uid].pendingKey=key;
  document.getElementById(uid+'-ci-'+key).classList.add('selected');
  const conf=document.getElementById(uid+'-confirm');
  document.getElementById(uid+'-confirm-label').textContent='ÈÅ∏„Çì„Å†Á≠î„Åà: '+key;
  conf.style.display='block';
  setTimeout(()=>conf.scrollIntoView({behavior:'smooth',block:'nearest'}),100);
}

function confirmPractice(uid){
  const ps=_pqState[uid];
  if(!ps||!ps.pendingKey)return;
  clearQuestionTimer();stopTimerSound();
  playSfx('confirm');
  const key=ps.pendingKey,ans=ps.answer;
  const correct=key===ans;
  document.getElementById(uid+'-confirm').style.display='none';
  /* ÂÖ±ÈÄö: ÂÖ®ÈÅ∏ÊäûËÇ¢„ÇíÁ¢∫ÂÆöË°®Á§∫ */
  document.querySelectorAll('#'+uid+'-choices .choice-item').forEach(ci=>{
    ci.classList.remove('selected');
    ci.classList.add('answered');
    const k=ci.dataset.key;
    if(k===ans)ci.classList.add('correct');
    else if(k===key&&!correct)ci.classList.add('wrong');
  });
  document.querySelectorAll('#'+uid+'-choices .choice-hint').forEach(h=>h.classList.add('open'));
  const banner=document.getElementById(uid+'-banner');
  banner.className='result-banner '+(correct?'correct':'wrong');

  if(correct){
    /* === Ê≠£Ëß£ === */
    playSfx('correct');
    banner.textContent='Ê≠£Ëß£ÔºÅ';
    if(!ps.retried)practiceFirstTryCount++;
    const pracTotal=currentStage&&currentStage.selectedPracticeQuestions?currentStage.selectedPracticeQuestions.length:PRACTICE_COUNT;
    if(practiceFirstTryCount>=pracTotal)unlockAchievement('practice_perfect');
    const ci=document.getElementById(uid+'-ci-'+ans);
    if(ci){const r=ci.getBoundingClientRect();gainTapExp(r.left+r.width/2,r.top+r.height/2,15);}
    const expEl=document.getElementById(uid+'-exp');
    expEl.style.display='block';expEl.classList.add('visible');
    typewriter(expEl,expEl.dataset.tw,30);
    ps.pendingKey=null;
    resumeReveal();
    setTimeout(()=>revealNext(),300);
  }else{
    ps.retried=true;
    /* === ‰∏çÊ≠£Ëß£: Ëß£Ë™¨„ÇíË™≠„Çì„Åß„É™„Éà„É©„Ç§ === */
    playSfx('hit');
    banner.textContent='‰∏çÊ≠£Ëß£‚Ä¶Ëß£Ë™¨„ÇíË™≠„Çì„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ';
    const expEl=document.getElementById(uid+'-exp');
    expEl.style.display='block';expEl.classList.add('visible');
    typewriter(expEl,expEl.dataset.tw,30);
    const doneBlock=document.getElementById(uid+'-done-block');
    doneBlock._origHTML=doneBlock.innerHTML;
    doneBlock.innerHTML='<div class="confirm-box"><div class="confirm-text" style="color:#ef9a9a">Ëß£Ë™¨„ÇíË™≠„Çì„Å†„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</div><button class="confirm-btn confirm-yes" onclick="retryPractice(\''+uid+'\')">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button></div>';
    ps.pendingKey=null;
    resumeReveal();
    setTimeout(()=>revealNext(),300);
  }
}

function cancelPractice(uid){
  const ps=_pqState[uid];
  if(!ps)return;
  document.querySelectorAll('#'+uid+'-choices .choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  document.getElementById(uid+'-confirm').style.display='none';
  ps.pendingKey=null;
}

function retryPractice(uid){
  const db=document.getElementById(uid+'-done-block');
  if(db._origHTML)db.innerHTML=db._origHTML;
  db.classList.remove('revealed');
  const banner=document.getElementById(uid+'-banner');
  banner.className='result-banner';banner.textContent='';
  const resultBlock=document.getElementById(uid+'-result');
  if(resultBlock)resultBlock.classList.remove('revealed');
  const expEl=document.getElementById(uid+'-exp');
  if(expEl){expEl.style.display='none';expEl.classList.remove('visible');expEl.textContent='';}
  document.querySelectorAll('#'+uid+'-choices .choice-item').forEach(ci=>{
    ci.classList.remove('answered','correct','wrong','selected');
  });
  document.querySelectorAll('#'+uid+'-choices .choice-hint').forEach(h=>h.classList.remove('open'));
  revealPaused=true;
  updateTapIndicator();
  document.getElementById(uid+'-choices').scrollIntoView({behavior:'smooth',block:'center'});
  // „É™„Éà„É©„Ç§ÊôÇ„ÇÇ„Çø„Ç§„Éû„ÉºÂÜçÈñã
  const fill=document.getElementById(uid+'-timer-fill'),txt=document.getElementById(uid+'-timer-text');
  if(fill&&txt)startQuestionTimer(Q_TIME_LIMIT,()=>onPracticeTimerExpire(uid),fill,txt);
}

function onPracticeTimerExpire(uid){
  stopTimerSound();
  const ps=_pqState[uid];if(!ps)return;
  playSfx('wrong');
  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈùûË°®Á§∫
  const conf=document.getElementById(uid+'-confirm');if(conf)conf.style.display='none';
  // ÂÖ®ÈÅ∏ÊäûËÇ¢„Çí‰∏çÊ≠£Ëß£Ë°®Á§∫
  const ans=ps.answer;
  document.querySelectorAll('#'+uid+'-choices .choice-item').forEach(ci=>{
    ci.classList.remove('selected');ci.classList.add('answered');
    if(ci.dataset.key===ans)ci.classList.add('correct');
  });
  document.querySelectorAll('#'+uid+'-choices .choice-hint').forEach(h=>h.classList.add('open'));
  // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó„Éê„Éä„Éº
  const banner=document.getElementById(uid+'-banner');
  banner.className='result-banner wrong';
  banner.textContent='„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ Âà∂ÈôêÊôÇÈñì„ÇíË∂Ö„Åà„Åæ„Åó„Åü';
  const expEl=document.getElementById(uid+'-exp');
  if(expEl){expEl.style.display='block';expEl.classList.add('visible');typewriter(expEl,expEl.dataset.tw,30);}
  ps.retried=true;
  const doneBlock=document.getElementById(uid+'-done-block');
  doneBlock._origHTML=doneBlock.innerHTML;
  doneBlock.innerHTML='<div class="confirm-box"><div class="confirm-text" style="color:#ef9a9a">Ëß£Ë™¨„ÇíË™≠„Çì„Å†„Çâ„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ</div><button class="confirm-btn confirm-yes" onclick="retryPractice(\''+uid+'\')">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button></div>';
  ps.pendingKey=null;
  resumeReveal();
  setTimeout(()=>revealNext(),300);
}

/* ===== „Ç´„Éº„ÉâÁç≤Âæó ===== */
function renderReward(c,stage){
  const cr=stage.cardReward;
  const cs=chapterState();
  const isNew=!cs.clearedStages.includes(stage.stageId);
  if(isNew){
    cs.clearedStages.push(stage.stageId);state.exp+=Math.floor(cr.exp*chapterExpMult());state.gold+=cr.gold;
    if(!state.ownedCards.includes(cr.cardName))state.ownedCards.push(cr.cardName);
    if(currentChapter)state.cardChapterMap[cr.cardName]=currentChapter.id;
    saveState();
    checkProgressAchievements();checkGoldAchievements();
  }
  playSfx('victory');
  const stars='‚òÖ'.repeat(cr.rarity)+'‚òÜ'.repeat(5-cr.rarity);
  const div=document.createElement('div');
  revealPaused=false;
  const tipHtml=!chapterState().bossCleared?`<div style="background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:10px;margin-top:12px;font-size:.8rem;color:#ffd700;text-align:center">„Éú„ÇπÊà¶„Å´ÂÇô„Åà„Å¶„Ç¢„Ç§„ÉÜ„É†„ÇíË≤∑„Å£„Å¶„Åä„Åì„ÅÜÔºÅ<br><span style="color:#aaa">„Éú„ÇπÊà¶Ê∫ñÂÇôÁîªÈù¢„Åß„Ç∑„Éß„ÉÉ„Éó„ÅåÈñã„Åë„Çã„Çà</span></div>`:'';
  const chSprite=currentChapter?currentChapter.bossSprite:'';
  const emblemHtml=chSprite?`<img src="${chSprite}" alt="" class="reward-card-emblem">`:'';
  div.innerHTML=`<div class="section-card">
    <span class="step-badge step-reward">Step ${learnStep+1}</span>

    <div class="reveal-block revealed">
      <div class="section-title reward-title" data-tw="„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ„Ç´„Éº„ÉâÁç≤ÂæóÔºÅ"></div>
    </div>

    <div class="reveal-block">
      <div class="reward-card">
        ${emblemHtml}
        <div class="reward-rarity">${stars}</div>
        <div class="reward-card-name">${cr.cardName}</div>
        <div class="reward-summary" data-tw="${cr.summary.replace(/"/g,'&quot;')}"></div>
        <div class="reward-stats">
          <div class="reward-stat"><div class="reward-stat-value exp">+${Math.floor(cr.exp*chapterExpMult())}</div><div class="reward-stat-label">EXP</div></div>
          <div class="reward-stat"><div class="reward-stat-value gold">+${cr.gold}</div><div class="reward-stat-label">GOLD</div></div>
        </div>
      </div>
    </div>

    <div class="reveal-block">
      ${tipHtml}
      <button class="next-btn" onclick="showScreen('screen-map')">„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã</button>
    </div>
  </div>`;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
  // „Ç´„Éº„ÉâÁç≤ÂæóÊôÇ„ÅÆEXP„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊºîÂá∫
  if(isNew){
    setTimeout(()=>{
      const card=div.querySelector('.reward-card');
      if(card){const r=card.getBoundingClientRect();spawnParticles(r.left+r.width/2,r.top+r.height/2,0);playSfx('exp');}
    },800);
  }
}

/* ===== „Ç∑„Éß„ÉÉ„Éó & „Ç¢„Ç§„ÉÜ„É† ===== */
function getMaxInventory(){
  const ch=state.chapters||{};
  if(ch[4]&&ch[4].bossCleared)return 4;
  if(ch[2]&&ch[2].bossCleared)return 3;
  return 2;
}
function buyItem(itemId){
  const item=SHOP_ITEMS.find(i=>i.id===itemId);
  if(!item||state.gold<item.price)return;
  const maxInv=getMaxInventory();if(state.inventory.length>=maxInv){alert('ÊåÅ„Å°Áâ©„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„ÅôÔºàÊúÄÂ§ß'+maxInv+'ÂÄãÔºâ');return}
  playSfx('buy');
  state.gold-=item.price;state.inventory.push(itemId);saveState();updateHeader();
  unlockAchievement('first_purchase');
  renderBossPrep();
}
function removeItem(index){
  const item=SHOP_ITEMS.find(i=>i.id===state.inventory[index]);
  if(item){playSfx('gold');state.gold+=item.price;state.inventory.splice(index,1);saveState();updateHeader();renderBossPrep();}
}

/* ===== „Éú„ÇπÊà¶Ê∫ñÂÇôÁîªÈù¢ ===== */
function showBossPrep(){
  document.getElementById('boss-prep-title').textContent=BOSS_DATA.bossName+' Êà¶Ê∫ñÂÇô';
  showScreen('screen-boss-prep');renderBossPrep();
}
function renderBossPrep(){
  const c=document.getElementById('boss-prep-content');
  const bagHtml=state.inventory.length>0
    ?state.inventory.map((id,i)=>{const it=SHOP_ITEMS.find(s=>s.id===id);return`<div class="boss-bag-item"><img src="${it.icon}" class="boss-bag-item-icon"> ${it.name} <span style="color:#888;font-size:.7rem;cursor:pointer" onclick="removeItem(${i})">[Â£≤Âç¥+${it.price}G]</span></div>`}).join('')
    :'<div class="boss-bag-empty">„Ç¢„Ç§„ÉÜ„É†„Å™„Åó</div>';
  c.innerHTML=`
    ${getBossSpriteLg('boss-sprite-anim')}
    <div style="text-align:center;font-size:1.2rem;font-weight:bold;color:#ff5252;margin-bottom:8px">${BOSS_DATA.bossName}</div>
    <div class="shop-warning">„Éú„ÇπÊà¶„Åß„ÅØ„Éü„Çπ„ÅØË®±„Åï„Çå„Å™„ÅÑÔºÅ<br>„Ç¢„Ç§„ÉÜ„É†„ÇíË≤∑„Å£„Å¶‰∏áÂÖ®„ÅÆÊ∫ñÂÇô„Çí„Åó„Çà„ÅÜÔºÅ</div>
    <div class="shop-gold">ÊâÄÊåÅ„Ç¥„Éº„É´„Éâ: ${state.gold} G</div>
    <div class="boss-bag"><div class="boss-bag-title">ÊåÅ„Å°Áâ©Ôºà${state.inventory.length}/${getMaxInventory()}Ôºâ</div>${bagHtml}</div>
    ${SHOP_ITEMS.map(it=>{
      const canBuy=state.gold>=it.price&&state.inventory.length<getMaxInventory();
      return`<div class="shop-item"><div class="shop-item-icon"><img src="${it.icon}" alt="${it.name}"></div><div class="shop-item-info"><div class="shop-item-name">${it.name}</div><div class="shop-item-desc">${it.desc}</div><div class="shop-item-price">${it.price} G</div></div><button class="shop-buy-btn" ${canBuy?'':'disabled'} onclick="buyItem('${it.id}')">Ë≥ºÂÖ•</button></div>`;
    }).join('')}
    <button class="next-btn" style="margin-top:16px" onclick="confirmBossStart()">„Éê„Éà„É´ÈñãÂßãÔºÅ</button>
    <button class="next-btn secondary" style="margin-top:8px" onclick="showScreen('screen-map')">„ÇÑ„ÇÅ„Çã</button>`;
}

/* ===== „Éú„Çπ„Éê„Éà„É´ ===== */
let bossQIndex=0,bossCorrect=0,bossActiveQs=[],bossBag=[];
function confirmBossStart(){
  const bagHtml=state.inventory.length>0
    ?state.inventory.map(id=>{const it=SHOP_ITEMS.find(s=>s.id===id);return it?`<img src="${it.icon}" class="modal-bag-item-icon">${it.name}`:''}).join('<br>')
    :'„Å™„Åó';
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.innerHTML=`<div class="modal-box">
    ${BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" style="width:80px;image-rendering:pixelated;margin-bottom:8px">`:''}
    <h3>${BOSS_DATA.bossName}„Å´Êåë„ÇÄÔºÅ</h3>
    <div class="modal-bag">ÊåÅ„Å°Áâ©<br>${bagHtml}</div>
    <div class="modal-note">ÂÖ®ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊíÉÁ†¥ÔºÅ</div>
    <div class="modal-btns">
      <button class="modal-btn-back" id="modal-cancel">„ÇÑ„ÇÅ„Çã</button>
      <button class="modal-btn-go" id="modal-go">„Éê„Éà„É´ÈñãÂßã</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  document.getElementById('modal-cancel').onclick=()=>{playSfx('select');overlay.remove()};
  document.getElementById('modal-go').onclick=()=>{playSfx('confirm');overlay.remove();startBoss()};
}
function startBoss(){
  bossQIndex=0;bossCorrect=0;bossCombo=0;bossItemsUsedThisFight=false;
  const exitPanel=document.getElementById('boss-exit-confirm');if(exitPanel)exitPanel.style.display='none';
  bossBag=state.inventory.slice();
  /* Á´†ÂÜÖ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ practiceQuestions „ÇíÂèéÈõÜ */
  const pool=[];
  COURSE_DATA.forEach(st=>{
    if(st.practiceQuestions){
      st.practiceQuestions.forEach(pq=>{
        pool.push({questionText:pq.questionText,choices:pq.choices,answer:pq.answer,shortExplanation:pq.shortExplanation,choiceAnalysis:pq.choiceAnalysis,solvingStrategy:pq.solvingStrategy});
      });
    }
  });
  if(pool.length===0&&BOSS_DATA.questions)BOSS_DATA.questions.forEach(q=>pool.push(q));
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  const cnt=Math.min(currentChapter.id+2,pool.length);
  bossActiveQs=pool.slice(0,cnt);
  document.getElementById('boss-title').textContent=BOSS_DATA.bossName;
  /* VSÊºîÂá∫ */
  showBossVsIntro(()=>{
    showScreen('screen-boss');
    document.getElementById('screen-boss').classList.add('boss-battle-atmosphere');
    renderBossQ();
  });
}
/* ===== VSÊºîÂá∫ ===== */
function showBossVsIntro(callback){
  playSfx('hit');
  const ov=document.createElement('div');
  ov.className='boss-vs-overlay';
  const vsSprite=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" style="width:100px;image-rendering:pixelated;margin-bottom:12px;animation:bossIdle 1.2s ease-in-out infinite">`:cssDragonHtml('boss-sprite-anim');
  ov.innerHTML=`<div class="boss-vs-flash"></div>${vsSprite}<div class="boss-vs-text">V S</div><div class="boss-vs-line"></div><div class="boss-vs-name">${BOSS_DATA.bossName}</div>`;
  document.body.appendChild(ov);
  setTimeout(()=>{
    ov.style.transition='opacity .4s';ov.style.opacity='0';
    setTimeout(()=>{ov.remove();callback();},400);
  },1800);
}
/* ===== CSS„Éâ„É©„Ç¥„É≥ÁîüÊàê ===== */
function cssDragonHtml(cls,id){
  const extra=cls?' '+cls:'';const idAttr=id?` id="${id}"`:'';
  return `<div class="css-dragon${extra}"${idAttr}><div class="d-wing"></div><div class="d-wing2"></div><div class="d-tail"></div><div class="d-body"></div><div class="d-head"></div><div class="d-eye"></div><div class="d-horn1"></div><div class="d-horn2"></div><div class="d-mouth"></div><div class="d-leg1"></div><div class="d-leg2"></div><div class="d-claw1"></div><div class="d-claw2"></div><div class="d-gear"></div><div class="d-bolt"></div><div class="d-bolt2"></div></div>`;
}
function getBossSpriteHtml(extraClass,id){
  if(BOSS_DATA.bossSprite)return `<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite-sm ${extraClass||'boss-sprite-anim'}"${id?' id="'+id+'"':''}>`;
  return cssDragonHtml(extraClass||'boss-sprite-anim',id);
}
function getBossSpriteLg(extraClass){
  if(BOSS_DATA.bossSprite)return `<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite ${extraClass||'boss-sprite-anim'}">`;
  return cssDragonHtml(extraClass||'boss-sprite-anim');
}
/* ===== „Ç≥„É≥„ÉúÁÆ°ÁêÜ ===== */
let bossCombo=0;
let bossDoubleActive=false;
let bossSelectedEl=null,bossSelectedKey=null,bossSelectedAns=null;
function renderSidebarItems(){
  /* „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Éû„Ç§„ÇØ„É©È¢®„Ç¢„Ç§„ÉÜ„É†„Éê„ÉºÔºàÊúÄÂ§ß4„Çπ„É≠„ÉÉ„ÉàÔºâ */
  const bar=document.getElementById('sp-item-bar');
  if(!bar)return;
  const maxSlots=getMaxInventory();
  let slots='';
  for(let i=0;i<maxSlots;i++){
    const id=state.inventory[i];
    if(id){const it=SHOP_ITEMS.find(s=>s.id===id);slots+=`<div class="mc-slot"><img src="${it.icon}" alt="${it.name}" title="${it.name}"></div>`;}
    else{slots+=`<div class="mc-slot empty"></div>`;}
  }
  bar.innerHTML=slots;
  const label=document.getElementById('sp-items-label');
  if(label)label.textContent=`ITEMS ${state.inventory.length}/${maxSlots}`;
}
function updateItemBar(){
  renderSidebarItems();
}
/* ===== „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®„Ç®„Éï„Çß„ÇØ„Éà ===== */
function showItemEffect(type,iconText,mainText,subText,color){
  /* ÂÖ®ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É• */
  const flash=document.createElement('div');
  flash.className='item-flash item-flash-'+type;
  document.body.appendChild(flash);
  setTimeout(()=>flash.remove(),1200);
  /* „Éê„Éä„ÉºÔºà„Ç¢„Ç§„ÉÜ„É†ÂêçË°®Á§∫Ôºâ */
  const banner=document.createElement('div');
  banner.className='item-banner';
  banner.innerHTML=`<div class="item-banner-icon">${iconText}</div><div class="item-banner-text" style="color:${color}">${mainText}</div><div class="item-banner-sub" style="color:${color}">${subText}</div>`;
  document.body.appendChild(banner);
  setTimeout(()=>{banner.classList.add('fade-out');setTimeout(()=>banner.remove(),500)},1200);
}
function applyChoiceGlow(glowClass){
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{
    if(!li.classList.contains('choice-hidden'))li.classList.add(glowClass);
  });
}
function clearChoiceGlow(){
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{
    li.classList.remove('item-glow-glasses','item-glow-kendama','item-glow-watch');
  });
}
function renderBossQ(){
  const c=document.getElementById('boss-content'),total=bossActiveQs.length;
  if(bossQIndex>=total){renderBossResult(c);return}
  const q=bossActiveQs[bossQIndex];
  const hp=((total-bossCorrect)/total*100).toFixed(0);
  const hasGlasses=bossBag.includes('sage_glasses');
  const hasKendama=bossBag.includes('double_kendama');
  const hasWatch=bossBag.includes('time_watch');
  const spriteHtml=getBossSpriteHtml('boss-sprite-anim','boss-battle-sprite');
  bossSelectedEl=null;bossSelectedKey=null;bossSelectedAns=null;bossDoubleActive=false;

  // ÈÅ∏ÊäûËÇ¢„Çí„Ç∑„É£„ÉÉ„Éï„É´Ôºà„É©„Éô„É´„ÅØÂõ∫ÂÆö„ÄÅ‰∏≠Ë∫´„ÇíÂÖ•„ÇåÊõø„ÅàÔºâ
  const origKeys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  const vals=origKeys.filter(k=>q.choices[k]).map(k=>({origKey:k,text:q.choices[k]}));
  for(let i=vals.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[vals[i],vals[j]]=[vals[j],vals[i]];}
  const shuffledChoices={};
  let shuffledAnswer=q.answer;
  const ansText=q.choices[q.answer];
  origKeys.forEach((k,i)=>{
    if(i<vals.length){
      shuffledChoices[k]=vals[i].text;
      if(vals[i].text===ansText)shuffledAnswer=k;
    }
  });
  // Ê≠£Ëß£„É©„Éô„É´„ÇíÊõ¥Êñ∞
  q.shuffledAnswer=shuffledAnswer;
  // „Ç∑„É£„ÉÉ„Éï„É´„Ç≠„Éº‚ÜíÂÖÉ„Ç≠„Éº„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞„Çí‰øùÂ≠òÔºàËÄÉ„ÅàÊñπË°®Á§∫Áî®Ôºâ
  q._keyMap={};origKeys.forEach((k,i)=>{if(i<vals.length)q._keyMap[k]=vals[i].origKey;});

  const hpNum=parseFloat(hp);
  const hpClass=hpNum<=20?'hp-critical':hpNum<=40?'hp-danger':'';
  const comboHtml=bossCombo>0?`<div class="boss-combo active" id="boss-combo"><div class="boss-combo-count">${bossCombo}</div><div class="boss-combo-label">COMBO</div></div>`:`<div class="boss-combo" id="boss-combo"><div class="boss-combo-count">0</div><div class="boss-combo-label">COMBO</div></div>`;
  c.innerHTML=`<div class="boss-header-row fade-in" id="boss-header-row" style="position:relative">
    ${comboHtml}
    <div class="boss-info-col">
      <div class="boss-name" style="margin-bottom:4px">${BOSS_DATA.bossName}</div>
      <div class="boss-desc" style="font-size:.75rem;color:#aaa;margin-bottom:2px">HP</div>
      <div class="boss-hp-container"><div class="boss-hp-bar"><div class="boss-hp-fill ${hpClass}" style="width:${hp}%"></div></div><div class="boss-hp-text">${total-bossCorrect}/${total}</div></div>
      ${bossQIndex===0?`<div style="color:#ff5252;font-weight:bold;font-size:.8rem;margin-top:6px">${total}ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊíÉÁ†¥ÔºÅ</div>`:''}
    </div>
    <div class="boss-sprite-col">
      ${spriteHtml}
    </div>
  </div>
    <div class="boss-sticky-q" id="boss-sticky-q">
      <div class="boss-q-counter">Á¨¨${bossQIndex+1}Âïè / ${total}</div>
      <div class="q-text" id="boss-q-text"></div>
    </div>
    ${getTimerHtml('boss-timer')}
    <div class="section-card fade-in">
    ${q.solvingStrategy?`<div class="strategy-hint-wrap" id="boss-strategy-hint" style="display:none">
      <button class="strategy-hint-btn" onclick="toggleBossHint(this)">
        <span class="strategy-hint-icon">‚ñ∂</span> ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà
      </button>
      <div class="strategy-hint-body" id="boss-strategy-hint-body">
        <ol class="strategy-steps" id="boss-strategy-hint-steps"></ol>
      </div>
    </div>`:''}
    <ul class="q-choices" id="boss-ch" style="display:none">${origKeys.filter(k=>shuffledChoices[k]).map(k=>`<li class="choice-item" data-key="${k}" onclick="pickBoss(this,'${k}','${shuffledAnswer}')"><div class="choice-main"><span class="choice-label">${k}.</span><span class="choice-text">${shuffledChoices[k]}</span></div></li>`).join('')}</ul>
    <div class="boss-item-btns" style="display:none">
    ${hasGlasses?`<button class="boss-use-glasses" onclick="useGlasses()">Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç„Çí‰Ωø„ÅÜ</button>`:''}
    ${hasKendama?`<button class="boss-use-kendama" onclick="useKendama()">2ÂÄç„ÅÆ„Åë„ÇìÁéâ„Çí‰Ωø„ÅÜ</button>`:''}
    ${hasWatch?`<button class="boss-use-watch" onclick="useWatch()">ÂïèÈ°å„Çí‰∫§Êèõ„Åô„Çã</button>`:''}
    </div>
    <div id="boss-confirm" style="display:none;margin-top:12px;text-align:center">
      <div style="color:#ffd700;font-weight:bold;margin-bottom:8px">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="next-btn secondary" style="flex:1;max-width:120px" onclick="cancelBossPick()">ÈÅ∏„Å≥Áõ¥„Åô</button>
        <button class="next-btn" style="flex:1;max-width:120px;background:#ff5252" onclick="confirmBossPick()">Ê±∫ÂÆöÔºÅ</button>
      </div>
    </div>
    <div id="boss-fb" style="display:none;margin-top:12px"></div>
    <button class="next-btn" id="boss-next" style="display:none" onclick="nextBossQ()">Ê¨°„ÅÆÂïèÈ°å ‚Üí</button></div>`;
  /* „Éí„É≥„ÉàÁî®ÔºöÊúÄÂàù„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàËÄÉ„ÅàÊñπ„ÅÆ„ÅøÔºâÔºã„Å≤„Å£„Åã„Åë„Éù„Ç§„É≥„Éà„Çí‰øùÂ≠ò„ÄÇÁ≠î„Åà„Å´„Å§„Å™„Åå„ÇãË®àÁÆó„ÅØË¶ã„Åõ„Å™„ÅÑ */
  if(q.solvingStrategy&&q.solvingStrategy.steps&&q.solvingStrategy.steps.length){
    window._bossStrategySteps=[q.solvingStrategy.steps[0]];
    window._bossTrap=q.solvingStrategy.trap||'';
  }else{
    window._bossStrategySteps=null;window._bossTrap='';
  }
  /* „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºÊºîÂá∫ ‚Üí ÂÆå‰∫ÜÂæå„Å´ÈÅ∏ÊäûËÇ¢„Å®„Éí„É≥„Éà„Éú„Çø„É≥„ÇíË°®Á§∫ */
  const twEl=document.getElementById('boss-q-text');
  typewriter(twEl,q.questionText,30,()=>{
    const ch=document.getElementById('boss-ch');if(ch)ch.style.display='';
    const sh=document.getElementById('boss-strategy-hint');if(sh)sh.style.display='';
    const itemBtns=document.querySelector('.boss-item-btns');if(itemBtns)itemBtns.style.display='';
    // „Çø„Ç§„Éû„ÉºÈñãÂßã
    const bFill=document.getElementById('boss-timer-fill'),bTxt=document.getElementById('boss-timer-text');
    startQuestionTimer(Q_TIME_LIMIT,()=>onBossTimerExpire(),bFill,bTxt);
  });
}
function onBossTimerExpire(){
  stopTimerSound();
  // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó ‚Üí ‰∏çÊ≠£Ëß£„Å®Âêå„ÅòÊâ±„ÅÑ
  const q=bossActiveQs[bossQIndex];
  const ans=q.shuffledAnswer;
  // Ê≠£Ëß£„ÇíË°®Á§∫
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{
    if(li.dataset.key===ans)li.classList.add('correct');
    li.style.pointerEvents='none';
  });
  // ‰∏çÊ≠£Ëß£Âá¶ÁêÜÔºàselBoss„ÅÆ‰∏çÊ≠£Ëß£„Éë„Çπ„Å®ÂêåÁ≠âÔºâ
  bossCombo=0;
  playSfx('wrong');
  triggerBossCounterattack();
  const fb=document.getElementById('boss-fb');fb.style.display='block';
  const itemBtns=document.querySelector('.boss-item-btns');if(itemBtns)itemBtns.style.display='none';
  const hintWrap=document.getElementById('boss-strategy-hint');if(hintWrap)hintWrap.style.display='none';
  document.getElementById('boss-confirm').style.display='none';
  // „ÅÑ„ÅÆ„Å°„ÅÆ„ÅÑ„Åó„ÉÅ„Çß„ÉÉ„ÇØ
  const stoneIdx=bossBag.indexOf('life_stone');
  if(stoneIdx!==-1){
    playSfx('buff');
    bossBag.splice(stoneIdx,1);
    const si=state.inventory.indexOf('life_stone');if(si!==-1){state.inventory.splice(si,1);saveState();}
    bossItemsUsedThisFight=true;trackItemUse('life_stone');
    updateItemBar();
    showItemEffect('stone','üíé','ÂëΩ„ÅÆ„Åü„Åæ','„Çø„Ç§„É†„Ç¢„ÉÉ„Éó„ÇíËÄê„Åà„ÅüÔºÅ','#ffd700');
    fb.innerHTML='<div class="result-banner" style="background:#1a1a00;border:2px solid #ffd700;color:#ffd700;font-size:1.1rem;box-shadow:0 0 16px rgba(255,215,0,.4)">„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ ÂëΩ„ÅÆ„Åü„Åæ„ÅåÁ†ï„Åë„ÅüÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">'+(q.shortExplanation||'')+'</div><div style="color:#ffd700;margin-top:8px;font-weight:bold">ÂëΩ„ÅÆ„Åü„Åæ„ÅÆÂäõ„ÅßËÄê„Åà„ÅüÔºÅ</div>';
    document.getElementById('boss-next').style.display='block';
  }else{
    fb.innerHTML='<div class="result-banner wrong" style="font-size:1.1rem">„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºÅ '+BOSS_DATA.bossName+'„ÅÆÂèçÊíÉÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">'+(q.shortExplanation||'')+'</div><div style="color:#ff5252;margin-top:10px;font-weight:bold;font-size:1rem">ÂÖ®ÂïèÊ≠£Ëß£„Åó„Å™„ÅÑ„Å®ÊíÉÁ†¥„Åß„Åç„Å™„ÅÑÔºÅ</div>';
    document.getElementById('boss-next').style.display='none';
    const btns=document.createElement('div');btns.style.cssText='margin-top:12px;display:flex;flex-direction:column;gap:8px';
    const rb=document.createElement('button');rb.className='next-btn secondary';rb.textContent='Ê∫ñÂÇôÁîªÈù¢„Å´Êàª„Çã';rb.onclick=function(){document.getElementById('screen-boss').classList.remove('boss-battle-atmosphere');showBossPrep()};
    btns.appendChild(rb);fb.appendChild(btns);
  }
  updateBossCombo();
  triggerScreenShake();
}
function triggerScreenShake(){
  const el=document.getElementById('boss-content');
  if(!el)return;
  el.classList.remove('screen-shake');
  void el.offsetWidth;/* reflow */
  el.classList.add('screen-shake');
  el.addEventListener('animationend',()=>el.classList.remove('screen-shake'),{once:true});
}
function pickBoss(el,key,ans){
  if(document.querySelector('#boss-ch .choice-item.correct'))return;
  if(el.classList.contains('choice-hidden'))return;
  playSfx('select');
  /* ÂâçÂõû„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíËß£Èô§ */
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>li.classList.remove('selected'));
  el.classList.add('selected');
  bossSelectedEl=el;bossSelectedKey=key;bossSelectedAns=ans;
  document.getElementById('boss-confirm').style.display='block';
}
function cancelBossPick(){
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>li.classList.remove('selected'));
  bossSelectedEl=null;bossSelectedKey=null;bossSelectedAns=null;
  document.getElementById('boss-confirm').style.display='none';
}
function confirmBossPick(){
  if(!bossSelectedEl)return;
  clearQuestionTimer();stopTimerSound();
  playSfx('confirm');
  document.getElementById('boss-confirm').style.display='none';
  selBoss(bossSelectedEl,bossSelectedKey,bossSelectedAns);
}
function useGlasses(){
  const idx=bossBag.indexOf('sage_glasses');if(idx===-1)return;
  playSfx('magic');
  bossBag.splice(idx,1);
  /* inventory„Åã„Çâ„ÇÇÊ∂à„Åô */
  const si=state.inventory.indexOf('sage_glasses');if(si!==-1){state.inventory.splice(si,1);saveState();}
  const q=bossActiveQs[bossQIndex];
  /* „Ç∑„É£„ÉÉ„Éï„É´Âæå„ÅÆÊ≠£Ëß£„Ç≠„Éº„Çí‰Ωø„ÅÜ */
  const ans=q.shuffledAnswer||q.answer;
  const origKeys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  const wrongKeys=origKeys.filter(k=>k!==ans);
  /* „É©„É≥„ÉÄ„É†„Å´‰∏çÊ≠£Ëß£2„Å§„ÇíÊ∂à„Åô */
  for(let i=wrongKeys.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[wrongKeys[i],wrongKeys[j]]=[wrongKeys[j],wrongKeys[i]];}
  const hideKeys=wrongKeys.slice(0,2);
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{if(hideKeys.includes(li.dataset.key))li.classList.add('choice-hidden')});
  const btn=document.querySelector('.boss-use-glasses');if(btn)btn.remove();
  bossItemsUsedThisFight=true;trackItemUse('sage_glasses');
  updateItemBar();
  showItemEffect('glasses','üëì','Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç','ÈÅ∏ÊäûËÇ¢„ÇíË¶ãÊ•µ„ÇÅ„ÅüÔºÅ','#4fc3f7');
  applyChoiceGlow('item-glow-glasses');
}
function useKendama(){
  const idx=bossBag.indexOf('double_kendama');if(idx===-1)return;
  playSfx('buff');
  bossBag.splice(idx,1);
  const si=state.inventory.indexOf('double_kendama');if(si!==-1){state.inventory.splice(si,1);saveState();}
  bossDoubleActive=true;
  const btn=document.querySelector('.boss-use-kendama');if(btn){btn.textContent='2ÂÄç„Åë„ÇìÁéâ Áô∫Âãï‰∏≠ÔºÅ';btn.disabled=true;btn.style.opacity='.5';}
  bossItemsUsedThisFight=true;trackItemUse('double_kendama');
  updateItemBar();
  showItemEffect('kendama','üèè','2ÂÄç„ÅÆ„Åë„ÇìÁéâ','Ê¨°„ÅÆÊîªÊíÉ„ÅØ2ÂÄç„ÉÄ„É°„Éº„Ç∏ÔºÅ','#ff9800');
  applyChoiceGlow('item-glow-kendama');
}
function useWatch(){
  const idx=bossBag.indexOf('time_watch');if(idx===-1)return;
  clearQuestionTimer();stopTimerSound();
  playSfx('magic');
  bossBag.splice(idx,1);
  const si=state.inventory.indexOf('time_watch');if(si!==-1){state.inventory.splice(si,1);saveState();}
  const btn=document.querySelector('.boss-use-watch');if(btn)btn.remove();
  bossItemsUsedThisFight=true;trackItemUse('time_watch');
  updateItemBar();
  showItemEffect('watch','üîÑ','„Ç∑„É£„ÉÉ„Éï„É´„Çø„Ç§„Éû„Éº','ÂïèÈ°å„Çí‰∫§ÊèõÔºÅ','#7ecfff');
  /* ÁèæÂú®„ÅÆÂïèÈ°å„ÇíÂà•„ÅÆÂïèÈ°å„Å´Â∑Æ„ÅóÊõø„Åà„Çã */
  const curQ=bossActiveQs[bossQIndex];
  const allPool=[];
  COURSE_DATA.forEach(st=>{
    if(st.practiceQuestions){
      st.practiceQuestions.forEach(pq=>{
        allPool.push({questionText:pq.questionText,choices:pq.choices,answer:pq.answer,shortExplanation:pq.shortExplanation,choiceAnalysis:pq.choiceAnalysis,solvingStrategy:pq.solvingStrategy});
      });
    }
  });
  if(allPool.length===0&&BOSS_DATA.questions)BOSS_DATA.questions.forEach(q=>allPool.push(q));
  /* Êó¢Âá∫„ÅÆÂïèÈ°å„ÇíÈô§Â§ñ„Åó„Å¶ÂÄôË£ú„Çí‰Ωú„Çã */
  const usedTexts=new Set(bossActiveQs.map(q=>q.questionText));
  let candidates=allPool.filter(q=>!usedTexts.has(q.questionText));
  if(candidates.length===0)candidates=allPool.filter(q=>q.questionText!==curQ.questionText);
  if(candidates.length>0){
    const newQ=candidates[Math.floor(Math.random()*candidates.length)];
    bossActiveQs[bossQIndex]=newQ;
  }
  /* Âêå„ÅòÂïèÈ°åÁï™Âè∑„ÅßÂÜçÊèèÁîª */
  setTimeout(()=>renderBossQ(),600);
}
function selBoss(el,key,ans){
  if(document.querySelector('#boss-ch .choice-item.correct'))return;
  if(el.classList.contains('choice-hidden'))return;
  clearChoiceGlow();
  const ok=key===ans;
  const isDouble=ok&&bossDoubleActive;
  if(ok)bossCorrect=Math.min(bossCorrect+(isDouble?2:1),bossActiveQs.length);
  bossDoubleActive=false;
  const total=bossActiveQs.length;
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{
    if(li.dataset.key===ans)li.classList.add('correct');
    else if(li.dataset.key===key&&!ok)li.classList.add('wrong');
    li.style.pointerEvents='none';
  });
  const q=bossActiveQs[bossQIndex],fb=document.getElementById('boss-fb');fb.style.display='block';
  /* ÂõûÁ≠îÂæå„ÅØ„Ç¢„Ç§„ÉÜ„É†„Éú„Çø„É≥„ÇíÈùûË°®Á§∫ */
  const itemBtns=document.querySelector('.boss-item-btns');if(itemBtns)itemBtns.style.display='none';
  /* ÂõûÁ≠îÂæå„ÅØ„Éí„É≥„Éà„Éú„Çø„É≥„ÇíÈùûË°®Á§∫ */
  const hintWrap=document.getElementById('boss-strategy-hint');if(hintWrap)hintWrap.style.display='none';
  if(ok){
    bossCombo++;
    if(bossCombo>=3)unlockAchievement('combo_3');
    if(bossCombo>=5)unlockAchievement('combo_5');
    if(bossCombo>=10)unlockAchievement('combo_10');
    playSfx('correct');playSfx('hit');
    /* Ê≠£Ëß£Â†±ÈÖ¨: EXP + „Ç¥„Éº„É´„Éâ */
    const bossExp=15,bossGold=30+Math.floor(Math.random()*20);
    const oldLv=calcLevel(state.exp).level;
    state.exp+=bossExp;state.gold+=bossGold;saveState();
    checkGoldAchievements();
    const newLv=calcLevel(state.exp).level;
    if(newLv>oldLv){showLevelUp(newLv);checkLevelAchievements(newLv);}
    const comboText=bossCombo>=3?`<div style="color:#ffd700;font-size:.9rem;font-weight:bold;margin-top:4px">${bossCombo} COMBO!</div>`:'';
    const doubleText=isDouble?'<div style="color:#ff9800;font-size:.9rem;font-weight:bold;margin-top:4px">2ÂÄç„ÅÆ„Åë„ÇìÁéâ„Åß2ÂÄç„ÉÄ„É°„Éº„Ç∏ÔºÅ</div>':'';
    fb.innerHTML=`<div class="result-banner correct" style="font-size:1.1rem">Ê≠£Ëß£ÔºÅ„Éú„Çπ„Å´„ÉÄ„É°„Éº„Ç∏ÔºÅ</div>${comboText}${doubleText}<div style="color:#7ecfff;font-size:.8rem;margin-top:4px">+${bossExp} EXP / +${bossGold} G</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div>`;
    document.getElementById('boss-next').style.display='block';
    const hpP=((total-bossCorrect)/total*100).toFixed(0);
    const hf=document.querySelector('.boss-hp-fill');
    if(hf){
      hf.style.width=hpP+'%';hf.style.transition='width .5s ease';
      /* HP‰Ωé‰∏ãÊôÇ„ÅÆÊºîÂá∫„ÇØ„É©„Çπ */
      hf.classList.remove('hp-danger','hp-critical');
      const hpNum=parseFloat(hpP);
      if(hpNum<=20)hf.classList.add('hp-critical');
      else if(hpNum<=40)hf.classList.add('hp-danger');
    }
    const ht=document.querySelector('.boss-hp-text');if(ht)ht.textContent=`${total-bossCorrect}/${total}`;
    /* „Éí„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ + ÁîªÈù¢Êè∫„Çå */
    const sp=document.getElementById('boss-battle-sprite');
    if(sp){sp.classList.remove('boss-sprite-anim');sp.classList.add('boss-sprite-hit');sp.addEventListener('animationend',()=>{sp.classList.remove('boss-sprite-hit');sp.classList.add('boss-sprite-anim')},{once:true});}
    triggerScreenShake();
    /* „ÉÄ„É°„Éº„Ç∏Êï∞Â≠óÊºîÂá∫ */
    showBossDamage(bossCombo>=3||isDouble);
    if(isDouble)showBossDamage(true);
    /* „Ç≥„É≥„ÉúÊõ¥Êñ∞ */
    updateBossCombo();
    /* 2ÂÄç„ÉÄ„É°„Éº„Ç∏„ÅßHP„Åå0‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÂç≥ÊíÉÁ†¥ */
    if(bossCorrect>=total){setTimeout(()=>{renderBossResult(document.getElementById('boss-content'))},1200);return;}
  }else{
    bossCombo=0;
    playSfx('wrong');
    /* ÂèçÊíÉÊºîÂá∫ */
    triggerBossCounterattack();
    /* „ÅÑ„ÅÆ„Å°„ÅÆ„ÅÑ„Åó„ÉÅ„Çß„ÉÉ„ÇØ */
    const stoneIdx=bossBag.indexOf('life_stone');
    if(stoneIdx!==-1){
      playSfx('buff');
      bossBag.splice(stoneIdx,1);
      const si=state.inventory.indexOf('life_stone');if(si!==-1){state.inventory.splice(si,1);saveState();}
      bossItemsUsedThisFight=true;trackItemUse('life_stone');
      updateItemBar();
      showItemEffect('stone','üíé','ÂëΩ„ÅÆ„Åü„Åæ','‰∏çÊ≠£Ëß£„ÇíËÄê„Åà„ÅüÔºÅ','#ffd700');
      fb.innerHTML=`<div class="result-banner" style="background:#1a1a00;border:2px solid #ffd700;color:#ffd700;font-size:1.1rem;box-shadow:0 0 16px rgba(255,215,0,.4)">ÂëΩ„ÅÆ„Åü„Åæ„ÅåÁ†ï„Åë„ÅüÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div><div style="color:#ffd700;margin-top:8px;font-weight:bold">‰∏çÊ≠£Ëß£„Å†„Åå„ÄÅÂëΩ„ÅÆ„Åü„Åæ„ÅÆÂäõ„ÅßËÄê„Åà„ÅüÔºÅ</div>`;
      document.getElementById('boss-next').style.display='block';
    }else{
      fb.innerHTML=`<div class="result-banner wrong" style="font-size:1.1rem">‰∏çÊ≠£Ëß£‚Ä¶ ${BOSS_DATA.bossName}„ÅÆÂèçÊíÉÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div><div style="color:#ff5252;margin-top:10px;font-weight:bold;font-size:1rem">ÂÖ®ÂïèÊ≠£Ëß£„Åó„Å™„ÅÑ„Å®ÊíÉÁ†¥„Åß„Åç„Å™„ÅÑÔºÅ</div>`;
      document.getElementById('boss-next').style.display='none';
      const btns=document.createElement('div');btns.style.cssText='margin-top:12px;display:flex;flex-direction:column;gap:8px';
      const rb=document.createElement('button');rb.className='next-btn secondary';rb.textContent='Ê∫ñÂÇôÁîªÈù¢„Å´Êàª„Çã';rb.onclick=function(){document.getElementById('screen-boss').classList.remove('boss-battle-atmosphere');showBossPrep()};
      const bb=document.createElement('button');bb.className='next-btn secondary';bb.style.opacity='.7';bb.textContent='„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã';bb.onclick=function(){document.getElementById('screen-boss').classList.remove('boss-battle-atmosphere');showScreen('screen-map')};
      btns.appendChild(rb);btns.appendChild(bb);fb.parentNode.appendChild(btns);
    }
    /* „Ç≥„É≥„Éú„É™„Çª„ÉÉ„Éà */
    updateBossCombo();
  }
  /* „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç®„É™„Ç¢„ÅåË¶ã„Åà„Çã„Çà„ÅÜ„Çπ„ÇØ„É≠„Éº„É´ */
  setTimeout(()=>{fb.scrollIntoView({behavior:'smooth',block:'nearest'})},300);
}
/* ===== „Éú„ÇπÊà¶ ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà ÈñãÈñâ ===== */
function toggleBossHint(btn){
  const wasOpen=btn.classList.contains('open');
  btn.classList.toggle('open');
  const body=document.getElementById('boss-strategy-hint-body');
  if(!body)return;
  if(!wasOpen){
    body.classList.add('open');
    /* ÂàùÂõû„ÅÆ„Åø„Çπ„ÉÜ„ÉÉ„Éó„ÇíÈ†ÜÊ¨°Ë°®Á§∫ */
    const ol=document.getElementById('boss-strategy-hint-steps');
    if(ol&&window._bossStrategySteps&&!ol.dataset.filled){
      ol.dataset.filled='1';
      ol.innerHTML='';
      let idx=0;
      const steps=window._bossStrategySteps;
      function showNext(){
        if(idx>=steps.length){
          /* ÂÖ®„Çπ„ÉÜ„ÉÉ„ÉóË°®Á§∫Âæå„Å´„Å≤„Å£„Åã„Åë„Éù„Ç§„É≥„Éà„ÇíËøΩÂä† */
          if(window._bossTrap){
            const trapDiv=document.createElement('div');
            trapDiv.className='trap-box';
            trapDiv.innerHTML=`<div class="trap-label">„Å≤„Å£„Åã„Åë„Éù„Ç§„É≥„Éà</div><div>${window._bossTrap}</div>`;
            trapDiv.style.opacity='0';
            body.appendChild(trapDiv);
            trapDiv.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
          }
          return;
        }
        const li=document.createElement('li');
        li.style.opacity='0';
        ol.appendChild(li);
        li.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
        typewriter(li,steps[idx],30,()=>{idx++;setTimeout(showNext,200);});
      }
      showNext();
    }
  }else{
    body.classList.remove('open');
  }
}
/* ===== „ÉÄ„É°„Éº„Ç∏Êï∞Â≠óÊºîÂá∫ ===== */
function calcBossDamage(isCritical){
  const chId=currentChapter?currentChapter.id:1;
  const lv=calcLevel(state.exp).level;
  const base=chId*50+lv*5;
  const variance=0.8+Math.random()*0.4;/* ¬±20% */
  const comboMult=bossCombo>=5?2.0:bossCombo>=3?1.5:1.0;
  const critMult=isCritical?2.0:1.0;
  return Math.floor(base*variance*comboMult*critMult);
}
function showBossDamage(isCritical){
  const dmg=document.createElement('div');
  dmg.className='boss-dmg-num'+(isCritical?' boss-dmg-critical':'');
  const dmgVal=calcBossDamage(isCritical);
  dmg.textContent='0';
  document.body.appendChild(dmg);
  /* „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„ÉóÊºîÂá∫ */
  const duration=600,startTime=performance.now();
  function countUp(now){
    const elapsed=now-startTime;
    const progress=Math.min(elapsed/duration,1);
    const eased=1-Math.pow(1-progress,3);/* easeOutCubic */
    const current=Math.floor(dmgVal*eased);
    dmg.textContent=current;
    if(progress<1)requestAnimationFrame(countUp);
  }
  requestAnimationFrame(countUp);
  setTimeout(()=>dmg.remove(),1500);
}
/* ===== „Ç≥„É≥„ÉúÊõ¥Êñ∞ ===== */
function updateBossCombo(){
  const el=document.getElementById('boss-combo');
  if(!el)return;
  const cnt=el.querySelector('.boss-combo-count');
  if(cnt)cnt.textContent=bossCombo;
  if(bossCombo>0){
    el.classList.add('active');
    cnt.classList.remove('boss-combo-pop');
    void cnt.offsetWidth;
    cnt.classList.add('boss-combo-pop');
  }else{
    el.classList.remove('active');
  }
}
/* ===== „Éú„ÇπÂèçÊíÉÊºîÂá∫ ===== */
function triggerBossCounterattack(){
  /* ÁîªÈù¢Ëµ§„Éï„É©„ÉÉ„Ç∑„É• */
  const flash=document.createElement('div');
  flash.className='boss-counterattack-flash';
  document.body.appendChild(flash);
  setTimeout(()=>flash.remove(),600);
  /* „Éú„ÇπÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
  const sp=document.getElementById('boss-battle-sprite');
  if(sp){
    sp.classList.remove('boss-sprite-anim','boss-sprite-hit');
    sp.classList.add('boss-sprite-attack');
    sp.addEventListener('animationend',()=>{
      sp.classList.remove('boss-sprite-attack');
      sp.classList.add('boss-sprite-anim');
    },{once:true});
  }
  triggerScreenShake();
}
function nextBossQ(){playSfx('confirm');clearChoiceGlow();bossQIndex++;renderBossQ();window.scrollTo({top:0,behavior:'smooth'})}
/* ===== „Éú„ÇπÊà¶Èõ¢ËÑ±Á¢∫Ë™ç ===== */
function confirmBossExit(){
  playSfx('select');
  const panel=document.getElementById('boss-exit-confirm');
  if(panel.style.display==='none'){
    panel.style.display='block';
    window.scrollTo({top:0,behavior:'smooth'});
  }else{
    panel.style.display='none';
  }
}
function dismissBossExit(){
  playSfx('select');
  document.getElementById('boss-exit-confirm').style.display='none';
}
function executeBossExit(){
  playSfx('confirm');
  document.getElementById('boss-exit-confirm').style.display='none';
  document.getElementById('screen-boss').classList.remove('boss-battle-atmosphere');
  clearChoiceGlow();
  showScreen('screen-map');
}
function renderBossResult(c){
  /* ÊíÉÁ†¥„Ç®„ÇØ„Çπ„Éó„É≠„Éº„Ç∏„Éß„É≥ÊºîÂá∫ */
  triggerBossExplosion(()=>{
    playSfx('victory');
    const rw=BOSS_DATA.rewards,total=bossActiveQs.length;
    const oldMax=getMaxInventory();
    const cs=chapterState();if(!cs.bossCleared){cs.bossCleared=true;state.exp+=Math.floor(rw.exp*chapterExpMult());state.gold+=rw.gold;if(!state.ownedCards.includes(rw.bonusCard.cardName))state.ownedCards.push(rw.bonusCard.cardName);if(currentChapter)state.cardChapterMap[rw.bonusCard.cardName]=currentChapter.id;saveState()}
    const newMax=getMaxInventory();
    /* ÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ */
    unlockAchievement('first_boss');
    if(bossCorrect>=total)unlockAchievement('boss_perfect');
    if(!bossItemsUsedThisFight)unlockAchievement('boss_no_items');
    checkAllBossesAchievement();checkGoldAchievements();
    document.getElementById('screen-boss').classList.remove('boss-battle-atmosphere');
    const spriteWin=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite" style="opacity:.4;filter:grayscale(1)">`:cssDragonHtml('',null);
    c.innerHTML=`<div class="boss-result win fade-in">
      <div style="opacity:.4;filter:grayscale(1)">${spriteWin}</div>
      <h2>ÊíÉÁ†¥ÔºÅ ${BOSS_DATA.bossName}„ÇíÂÄí„Åó„ÅüÔºÅ</h2>
      <div class="boss-score">${bossCorrect}/${total}ÂïèÊ≠£Ëß£ - PERFECT!</div>
      <p>„Äå${rw.clearTitle}„Äç„ÅÆÁß∞Âè∑„ÇíÁç≤ÂæóÔºÅ</p>
      <div class="reward-card" style="margin:16px auto;max-width:300px">${BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" alt="" class="reward-card-emblem">`:''}<div class="reward-rarity">${'‚òÖ'.repeat(rw.bonusCard.rarity)+'‚òÜ'.repeat(5-rw.bonusCard.rarity)}</div><div class="reward-card-name">${rw.bonusCard.cardName}</div><div class="reward-summary">${rw.bonusCard.summary}</div><div class="reward-stats"><div class="reward-stat"><div class="reward-stat-value exp">+${Math.floor(rw.exp*chapterExpMult())}</div><div class="reward-stat-label">EXP</div></div><div class="reward-stat"><div class="reward-stat-value gold">+${rw.gold}</div><div class="reward-stat-label">GOLD</div></div></div></div>
      ${IS_DEMO?`<div style="background:rgba(255,215,0,.1);border:2px solid #ffd700;border-radius:12px;padding:16px;margin:16px 0;text-align:center">
        <div style="font-size:1.1rem;font-weight:bold;color:#ffd700;margin-bottom:8px">„Éá„É¢Áâà„ÇØ„É™„Ç¢„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div>
        <div style="font-size:.85rem;color:#ccc;line-height:1.7">Ë£ΩÂìÅÁâà„Åß„ÅØÂÖ®8Á´†„Éª80„Çπ„ÉÜ„Éº„Ç∏‰ª•‰∏ä„ÅÆÂïèÈ°å„Å´ÊåëÊà¶„Åß„Åç„Åæ„Åô„ÄÇ</div>
        <a href="${location.pathname}" style="display:inline-block;margin-top:12px;padding:10px 24px;background:#ffd700;color:#000;font-weight:bold;border-radius:8px;text-decoration:none;font-size:.9rem">Ë£ΩÂìÅÁâà„ÅßÂßã„ÇÅ„Çã</a>
      </div>`:''}
      <button class="next-btn" onclick="showScreen('screen-map')">„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã</button></div>`;
    if(newMax>oldMax){setTimeout(()=>showInventoryExpand(newMax),1500);}
  });
}
function showInventoryExpand(maxSlots){
  playSfx('buff');
  const ov=document.createElement('div');
  ov.className='inventory-expand-overlay';
  ov.innerHTML=`<div class="inventory-expand-box">
    <div class="inventory-expand-icon">üéí</div>
    <div class="inventory-expand-title">ÊåÅ„Å°Áâ©Êû†„ÅåÂ¢ó„Åà„ÅüÔºÅ</div>
    <div class="inventory-expand-detail">„Ç¢„Ç§„ÉÜ„É†„ÇíÊúÄÂ§ß <span style="color:#ffd700;font-size:1.3rem;font-weight:bold">${maxSlots}ÂÄã</span> ÊåÅ„Å¶„Çã„Çà„ÅÜ„Å´„Å™„Å£„ÅüÔºÅ</div>
    <button class="next-btn" onclick="this.closest('.inventory-expand-overlay').remove()">OK</button>
  </div>`;
  document.body.appendChild(ov);
  renderSidebarItems();
}
/* ===== ÊíÉÁ†¥„Ç®„ÇØ„Çπ„Éó„É≠„Éº„Ç∏„Éß„É≥ ===== */
function triggerBossExplosion(callback){
  const sp=document.getElementById('boss-battle-sprite');
  if(sp){
    sp.classList.remove('boss-sprite-anim','boss-sprite-hit');
    sp.classList.add('boss-sprite-defeat');
  }
  /* ÁôΩ„Éï„É©„ÉÉ„Ç∑„É• */
  setTimeout(()=>{
    const flash=document.createElement('div');
    flash.className='boss-explosion-flash';
    document.body.appendChild(flash);
    setTimeout(()=>flash.remove(),1000);
    playSfx('hit');
  },400);
  /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ */
  setTimeout(()=>{
    const ov=document.createElement('div');
    ov.className='boss-explosion-overlay';
    document.body.appendChild(ov);
    const colors=['#ff5252','#ffd700','#ff8a80','#fff','#ffb74d','#ff1744'];
    const cx=window.innerWidth/2,cy=window.innerHeight/2-50;
    for(let i=0;i<30;i++){
      const p=document.createElement('div');
      p.className='boss-explosion-particle';
      p.style.background=colors[Math.floor(Math.random()*colors.length)];
      p.style.boxShadow=`0 0 6px ${p.style.background}`;
      p.style.left=cx+'px';p.style.top=cy+'px';
      const angle=Math.random()*Math.PI*2;
      const dist=80+Math.random()*180;
      const dx=Math.cos(angle)*dist,dy=Math.sin(angle)*dist;
      const dur=600+Math.random()*600;
      p.style.transition=`all ${dur}ms cubic-bezier(.25,.46,.45,.94)`;
      p.style.width=(4+Math.random()*6)+'px';
      p.style.height=p.style.width;
      ov.appendChild(p);
      requestAnimationFrame(()=>{
        p.style.left=(cx+dx)+'px';
        p.style.top=(cy+dy)+'px';
        p.style.opacity='0';
      });
    }
    setTimeout(()=>ov.remove(),1200);
  },500);
  triggerScreenShake();
  setTimeout(callback,1800);
}

/* ===== ÂÆüÁ∏æ„Éê„ÉÉ„Ç∏‰∏ÄË¶ß ===== */
function renderBadges(){
  const g=document.getElementById('badge-grid');g.innerHTML='';
  const prog=document.getElementById('badge-progress');
  const unlocked=(state.achievements||[]).length;
  const total=ACHIEVEMENTS.length;
  prog.innerHTML=`<div style="text-align:center;margin-bottom:16px"><span style="font-size:1.2rem;font-weight:bold;color:#ffd700">${unlocked}</span><span style="color:#888"> / ${total} Ëß£Èô§</span></div>`;
  const cats=[...new Set(ACHIEVEMENTS.map(a=>a.cat))];
  cats.forEach(cat=>{
    const catDiv=document.createElement('div');catDiv.className='badge-cat';
    catDiv.innerHTML=`<div class="badge-cat-title">${cat}</div>`;
    const items=ACHIEVEMENTS.filter(a=>a.cat===cat);
    const row=document.createElement('div');row.className='badge-row';
    items.forEach(a=>{
      const owned=(state.achievements||[]).includes(a.id);
      const d=document.createElement('div');d.className='badge-item'+(owned?' unlocked':' locked');
      d.innerHTML=`<div class="badge-icon">${owned?a.icon:'?'}</div><div class="badge-name">${owned?a.name:'???'}</div><div class="badge-desc">${owned?a.desc:'„Åæ„Å†Ëß£Èô§„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì'}</div>`;
      row.appendChild(d);
    });
    catDiv.appendChild(row);g.appendChild(catDiv);
  });
}

/* ===== „Ç´„Éº„ÉâÂõ≥Èëë ===== */
function getChapterSprite(cardName){
  const chId=state.cardChapterMap[cardName];
  if(!chId)return '';
  const ch=CHAPTERS.find(c=>c.id===chId);
  return ch?ch.bossSprite:'';
}
function renderCollection(){
  const g=document.getElementById('collection-grid');g.innerHTML='';
  // ÁèæÂú®„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Çã„ÉÅ„É£„Éó„Çø„Éº„ÅÆ„Ç´„Éº„Éâ„ÇíË°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞ÊâÄÊåÅ„Ç´„Éº„Éâ‰∏ÄË¶ß
  const cards=[];
  if(COURSE_DATA.length>0){
    COURSE_DATA.forEach(s=>{if(s.cardReward)cards.push(s.cardReward)});
    if(BOSS_DATA.rewards&&BOSS_DATA.rewards.bonusCard)cards.push(BOSS_DATA.rewards.bonusCard);
  }
  if(cards.length===0){
    // „Éá„Éº„ÇøÊú™„É≠„Éº„ÉâÊôÇ„ÅØÊâÄÊåÅ„Ç´„Éº„Éâ„ÅÆ„ÅøË°®Á§∫
    state.ownedCards.forEach(name=>{
      const sprite=getChapterSprite(name);
      const emblem=sprite?`<img src="${sprite}" alt="" class="card-boss-emblem">`:'';
      const d=document.createElement('div');d.className='coll-card owned';
      d.innerHTML=`${emblem}<div class="coll-card-name">${name}</div>`;
      g.appendChild(d);
    });
    if(state.ownedCards.length===0)g.innerHTML='<div style="text-align:center;padding:40px;color:#888">„Åæ„Å†„Ç´„Éº„Éâ„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
    return;
  }
  const collSprite=currentChapter?currentChapter.bossSprite:'';
  cards.forEach(cr=>{
    const o=state.ownedCards.includes(cr.cardName);
    const sprite=collSprite||getChapterSprite(cr.cardName);
    const d=document.createElement('div');d.className='coll-card '+(o?'owned':'not-owned');
    const emblem=sprite?`<img src="${sprite}" alt="" class="card-boss-emblem">`:'';
    d.innerHTML=`${emblem}<div class="coll-card-rarity">${'‚òÖ'.repeat(cr.rarity)+'‚òÜ'.repeat(5-cr.rarity)}</div><div class="coll-card-name">${o?cr.cardName:'ÔºüÔºüÔºü'}</div><div style="font-size:.7rem;color:#888;margin-top:4px">${o?cr.summary:''}</div>`;
    g.appendChild(d);
  });
}

/* ===== Ê®°Êì¨Ë©¶È®ì ===== */
let mockExamQs=[],mockExamIndex=0,mockExamAnswers=[];
let mockExamCategory='all'; // 'all','tech','strat','mgmt'
const MOCK_EXAM_RATIO={tech:45,strat:35,mgmt:20};

function renderMockExamStart(){
  mockExamCategory='all';
  const c=document.getElementById('mock-exam-content');
  c.innerHTML=`<div class="mock-exam-start">
    <button class="back-btn" onclick="showScreen('screen-chapters')" style="position:absolute;left:16px;top:16px">‚Üê Êàª„Çã</button>
    <h2>Ê®°Êì¨Ë©¶È®ì</h2>
    <div class="exam-desc">
      Âá∫È°å„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏„Çì„ÅßÊåëÊà¶„Åó„Çà„ÅÜÔºÅ<br>
      Êú¨Áï™„Å®Âêå„Åò„Åè„ÄÅËß£Ë™¨„ÅØË©¶È®ìÂæå„Å´Á¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ
    </div>
    <div class="mock-category-select" id="mock-category-select">
      <div class="mock-cat-btn selected" onclick="selectMockCategory('all',this)" data-cat="all">
        <div class="mock-cat-icon">üìù</div>
        <div class="mock-cat-name">ÂÖ®ÂïèÈ°å</div>
        <div class="mock-cat-detail">100ÂïèÔºàÊú¨Áï™ÂΩ¢ÂºèÔºâ</div>
      </div>
      <div class="mock-cat-btn" onclick="selectMockCategory('tech',this)" data-cat="tech">
        <div class="mock-cat-icon" style="color:#42a5f5">üíª</div>
        <div class="mock-cat-name" style="color:#42a5f5">„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª</div>
        <div class="mock-cat-detail">45Âïè</div>
      </div>
      <div class="mock-cat-btn" onclick="selectMockCategory('strat',this)" data-cat="strat">
        <div class="mock-cat-icon" style="color:#ffb74d">üìä</div>
        <div class="mock-cat-name" style="color:#ffb74d">„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª</div>
        <div class="mock-cat-detail">35Âïè</div>
      </div>
      <div class="mock-cat-btn" onclick="selectMockCategory('mgmt',this)" data-cat="mgmt">
        <div class="mock-cat-icon" style="color:#81c784">üìã</div>
        <div class="mock-cat-name" style="color:#81c784">„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª</div>
        <div class="mock-cat-detail">20Âïè</div>
      </div>
    </div>
    <button class="next-btn" onclick="startMockExam()" style="margin-top:20px;background:linear-gradient(135deg,#ab47bc,#7b1fa2)">Ë©¶È®ìÈñãÂßã</button>
  </div>`;
}
function selectMockCategory(cat,el){
  mockExamCategory=cat;
  document.querySelectorAll('.mock-cat-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

async function startMockExam(){
  const c=document.getElementById('mock-exam-content');
  c.innerHTML='<div class="mock-exam-loading">ÂïèÈ°å„ÇíÊ∫ñÂÇô„Åó„Å¶„ÅÑ„Åæ„Åô...</div>';
  try{
    const techPool=[],stratPool=[],mgmtPool=[];
    const regularChs=CHAPTERS.filter(ch=>!ch.isMockExam);
    // ÂÖ®„ÉÅ„É£„Éó„Çø„Éº„ÅÆJSON„Çí‰∏¶ÂàóË™≠„ÅøËæº„Åø
    const allFetches=[];
    regularChs.forEach(ch=>{
      ch.files.stages.forEach(f=>allFetches.push(fetch(f).then(r=>r.ok?r.json():null).then(d=>({domain:ch.domain,data:d}))));
      if(ch.files.boss)allFetches.push(fetch(ch.files.boss).then(r=>r.ok?r.json():null).then(d=>({domain:ch.domain,data:d,isBoss:true})));
    });
    const results=await Promise.all(allFetches);
    results.forEach(r=>{
      if(!r||!r.data||!r.data.stages)return;
      const pool=r.domain==='„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª'?techPool:r.domain==='„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª'?stratPool:mgmtPool;
      r.data.stages.forEach(st=>{
        if(r.isBoss&&st.questions){
          st.questions.forEach(q=>pool.push({questionText:q.questionText,choices:q.choices,answer:q.answer,category:r.domain,source:q.id||''}));
        }else{
          if(st.mainQuestion){
            const mq=st.mainQuestion;
            pool.push({questionText:mq.originalText||mq.questionText||'',choices:mq.choices,answer:mq.answer,category:r.domain,source:mq.source||''});
          }
          if(st.practiceQuestions){
            st.practiceQuestions.forEach(pq=>pool.push({questionText:pq.questionText,choices:pq.choices,answer:pq.answer,category:r.domain,source:pq.source||''}));
          }
        }
      });
    });
    // „Ç∑„É£„ÉÉ„Éï„É´ & ÈÅ∏Âá∫
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
    shuffle(techPool);shuffle(stratPool);shuffle(mgmtPool);
    let selected;
    if(mockExamCategory==='tech'){
      selected=techPool.slice(0,45);
    }else if(mockExamCategory==='strat'){
      selected=stratPool.slice(0,35);
    }else if(mockExamCategory==='mgmt'){
      selected=mgmtPool.slice(0,20);
    }else{
      selected=[
        ...techPool.slice(0,MOCK_EXAM_RATIO.tech),
        ...stratPool.slice(0,MOCK_EXAM_RATIO.strat),
        ...mgmtPool.slice(0,MOCK_EXAM_RATIO.mgmt)
      ];
    }
    shuffle(selected);
    mockExamQs=selected;
    mockExamIndex=0;
    mockExamAnswers=[];
    renderMockExamQ();
  }catch(e){
    console.error('Ê®°Êì¨Ë©¶È®ì„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:',e);
    c.innerHTML='<div class="mock-exam-loading" style="color:#f44">„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ<br><button class="next-btn" onclick="showScreen(\'screen-chapters\')">Êàª„Çã</button></div>';
  }
}

function renderMockExamQ(){
  if(mockExamIndex>=mockExamQs.length){renderMockExamResult();return;}
  const q=mockExamQs[mockExamIndex];
  const total=mockExamQs.length;
  const pct=((mockExamIndex)/total*100).toFixed(0);
  const c=document.getElementById('mock-exam-content');
  // ÈÅ∏ÊäûËÇ¢„Ç∑„É£„ÉÉ„Éï„É´
  const keys=Object.keys(q.choices);
  const entries=keys.map(k=>({key:k,val:q.choices[k]}));
  for(let i=entries.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[entries[i],entries[j]]=[entries[j],entries[i]];}
  const correctVal=q.choices[q.answer];
  let shuffledAnswer='';
  entries.forEach((e,i)=>{if(e.val===correctVal)shuffledAnswer=keys[i];});
  // Êñ∞„Åó„ÅÑ„Ç≠„Éº„Çí„Éû„ÉÉ„Éî„É≥„Ç∞
  const shuffledChoices={};
  entries.forEach((e,i)=>{shuffledChoices[keys[i]]=e.val;});
  c.innerHTML=`<div class="mock-exam-q">
    <div class="mock-exam-header">
      <span>Âïè${mockExamIndex+1} / ${total}</span>
      <span style="font-size:.7rem;padding:2px 8px;border-radius:10px;background:${q.category==='„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª'?'rgba(33,150,243,.2)':q.category==='„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª'?'rgba(255,152,0,.2)':'rgba(76,175,80,.2)'};color:${q.category==='„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª'?'#42a5f5':q.category==='„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª'?'#ffb74d':'#81c784'}">${q.category}</span>
    </div>
    <div class="mock-exam-progress"><div class="mock-exam-progress-fill" style="width:${pct}%"></div></div>
    ${getTimerHtml('mock-timer')}
    <div class="mock-exam-qtext">${q.questionText}</div>
    <div class="mock-exam-choices" id="mock-choices">
      ${keys.map(k=>`<div class="mock-exam-choice" onclick="selectMockAnswer(this,'${k}','${shuffledAnswer}')">${k}. ${shuffledChoices[k]}</div>`).join('')}
    </div>
  </div>`;
  // „Çø„Ç§„Éû„ÉºÈñãÂßã
  window._mockShuffledAnswer=shuffledAnswer;
  const mFill=document.getElementById('mock-timer-fill'),mTxt=document.getElementById('mock-timer-text');
  startQuestionTimer(Q_TIME_LIMIT,()=>onMockTimerExpire(),mFill,mTxt);
}

function selectMockAnswer(el,selected,correct){
  if(el.parentElement.querySelector('.selected'))return;
  clearQuestionTimer();stopTimerSound();
  el.classList.add('selected');
  const isCorrect=selected===correct;
  mockExamAnswers.push({qIndex:mockExamIndex,selected,correct,isCorrect,category:mockExamQs[mockExamIndex].category});
  el.style.background=isCorrect?'rgba(76,175,80,.2)':'rgba(244,67,54,.2)';
  el.style.borderColor=isCorrect?'#81c784':'#ff5252';
  // Áü≠„ÅÑ„Éá„Ç£„É¨„Ç§„ÅßÊ¨°„ÅÆÂïèÈ°å„Å∏
  setTimeout(()=>{mockExamIndex++;renderMockExamQ();},400);
}
function onMockTimerExpire(){
  stopTimerSound();
  // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó ‚Üí ‰∏çÊ≠£Ëß£Êâ±„ÅÑ
  const correct=window._mockShuffledAnswer||'';
  mockExamAnswers.push({qIndex:mockExamIndex,selected:'',correct,isCorrect:false,category:mockExamQs[mockExamIndex].category});
  // ÈÅ∏ÊäûËÇ¢„ÇíÁÑ°ÂäπÂåñ&Ê≠£Ëß£„ÇíË°®Á§∫
  document.querySelectorAll('#mock-choices .mock-exam-choice').forEach(el=>{
    el.style.pointerEvents='none';
  });
  playSfx('wrong');
  setTimeout(()=>{mockExamIndex++;renderMockExamQ();},800);
}

function renderMockExamResult(){
  clearQuestionTimer();stopTimerSound();
  const total=mockExamAnswers.length;
  const correctCount=mockExamAnswers.filter(a=>a.isCorrect).length;
  const passLine=mockExamCategory==='all'?60:Math.ceil(total*0.6);
  const pass=correctCount>=passLine;
  const pct=total>0?Math.round(correctCount/total*100):0;
  const techCorrect=mockExamAnswers.filter(a=>a.category==='„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª'&&a.isCorrect).length;
  const techTotal=mockExamAnswers.filter(a=>a.category==='„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª').length;
  const stratCorrect=mockExamAnswers.filter(a=>a.category==='„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª'&&a.isCorrect).length;
  const stratTotal=mockExamAnswers.filter(a=>a.category==='„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª').length;
  const mgmtCorrect=mockExamAnswers.filter(a=>a.category==='„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª'&&a.isCorrect).length;
  const mgmtTotal=mockExamAnswers.filter(a=>a.category==='„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª').length;
  const catLabel=mockExamCategory==='tech'?'„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª':mockExamCategory==='strat'?'„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª':mockExamCategory==='mgmt'?'„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª':'Á∑èÂêà';
  const remaining=passLine-correctCount;
  const failMsg=remaining>0?'„ÅÇ„Å®'+remaining+'Âïè‚Ä¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Åå„Çì„Å∞„Çç„ÅÜÔºÅ':'ÊÉú„Åó„ÅÑÔºÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åó„Çà„ÅÜÔºÅ';
  // ÂàÜÈáéÂà•ÂÜÖË®≥ÔºàÂÖ®ÂïèÈ°å„É¢„Éº„Éâ„ÅÆ„ÅøË°®Á§∫Ôºâ
  let breakdownHtml='';
  if(mockExamCategory==='all'){
    breakdownHtml=`<div class="result-breakdown">
      <div class="breakdown-item">
        <div class="breakdown-label" style="color:#42a5f5">„ÉÜ„ÇØ„Éé„É≠„Ç∏Á≥ª</div>
        <div class="breakdown-score" style="color:${techTotal>0&&techCorrect/techTotal>=0.6?'#81c784':'#ff5252'}">${techCorrect} / ${techTotal}</div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-label" style="color:#ffb74d">„Çπ„Éà„É©„ÉÜ„Ç∏Á≥ª</div>
        <div class="breakdown-score" style="color:${stratTotal>0&&stratCorrect/stratTotal>=0.6?'#81c784':'#ff5252'}">${stratCorrect} / ${stratTotal}</div>
      </div>
      <div class="breakdown-item">
        <div class="breakdown-label" style="color:#81c784">„Éû„Éç„Ç∏„É°„É≥„ÉàÁ≥ª</div>
        <div class="breakdown-score" style="color:${mgmtTotal>0&&mgmtCorrect/mgmtTotal>=0.6?'#81c784':'#ff5252'}">${mgmtCorrect} / ${mgmtTotal}</div>
      </div>
    </div>`;
  }
  const c=document.getElementById('mock-exam-content');
  c.innerHTML=`<div class="mock-exam-result">
    <h2>${pass?'ÂêàÊ†º':'‰∏çÂêàÊ†º'}</h2>
    <div style="font-size:.85rem;color:#aaa;margin-bottom:8px">${catLabel}ÔºàÂêàÊ†º„É©„Ç§„É≥: ${passLine}Âïè / Ê≠£Á≠îÁéá60%Ôºâ</div>
    <div class="result-score" style="color:${pass?'#81c784':'#ff5252'}">${correctCount} / ${total}<span style="font-size:1rem;margin-left:8px">(${pct}%)</span></div>
    <div class="${pass?'result-pass':'result-fail'}">${pass?'„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅÂêàÊ†º„É©„Ç§„É≥„ÇíÁ™ÅÁ†¥ÔºÅ':failMsg}</div>
    ${breakdownHtml}
    <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
      <button class="next-btn" onclick="renderMockExamStart()" style="background:linear-gradient(135deg,#ab47bc,#7b1fa2)">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶</button>
      <button class="next-btn secondary" onclick="showScreen('screen-chapters')">Á´†„ÅÆÈÅ∏Êäû„Å´Êàª„Çã</button>
    </div>
  </div>`;
}

/* ===== JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ===== */
async function loadChapterData(chapterId){
  const chapter=CHAPTERS.find(c=>c.id===chapterId);
  if(!chapter)return;
  COURSE_DATA=[];
  BOSS_DATA={};
  renderStageGrid();
  try{
    const responses=await Promise.all(chapter.files.stages.map(f=>fetch(f)));
    if(responses.some(r=>!r.ok)){
      throw new Error('Stage file load failed');
    }
    const stageData=await Promise.all(responses.map(r=>r.json()));
    COURSE_DATA=stageData.flatMap(d=>d.stages);
    // „Éá„É¢Áâà: „Çπ„ÉÜ„Éº„Ç∏1,2„ÅÆ„Åø„Å´Áµû„Çã
    if(IS_DEMO) COURSE_DATA=COURSE_DATA.filter(s=>s.stageId<=2);

    const bossResp=await fetch(chapter.files.boss);
    if(bossResp.ok){
      const bossJSON=await bossResp.json();
      const bs=bossJSON.stages[0];
      BOSS_DATA={stageId:bs.stageId,title:bs.title,isBossBattle:true,passingScore:bs.passingScore,bossName:bs.bossName,bossDescription:bs.bossDescription,questions:bs.questions,rewards:bs.rewards,bossSprite:bs.bossSprite||''};
    }
    // Êó¢Â≠ò„Ç´„Éº„Éâ„ÅÆcardChapterMap„Éê„ÉÉ„ÇØ„Éï„Ç£„É´
    let mapUpdated=false;
    COURSE_DATA.forEach(s=>{if(s.cardReward&&state.ownedCards.includes(s.cardReward.cardName)&&!state.cardChapterMap[s.cardReward.cardName]){state.cardChapterMap[s.cardReward.cardName]=chapterId;mapUpdated=true;}});
    if(BOSS_DATA.rewards&&BOSS_DATA.rewards.bonusCard&&state.ownedCards.includes(BOSS_DATA.rewards.bonusCard.cardName)&&!state.cardChapterMap[BOSS_DATA.rewards.bonusCard.cardName]){state.cardChapterMap[BOSS_DATA.rewards.bonusCard.cardName]=chapterId;mapUpdated=true;}
    if(mapUpdated)saveSaveData(state);
    renderStageGrid();
  }catch(e){
    console.error('„ÉÅ„É£„Éó„Çø„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
    const grid=document.getElementById('stage-grid');
    grid.innerHTML='<div style="text-align:center; padding:50px; color:#f44; font-size:18px;">„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº<br>„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
  }
}

updateHeader();
renderChapterGrid();
</script>
</body>
</html>
