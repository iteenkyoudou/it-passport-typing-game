<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Segoe UI','Hiragino Sans','Meiryo',sans-serif;
  background:#000;color:#fff;min-height:100vh;line-height:1.7;
  padding-left:220px;
}
button{cursor:pointer;font-family:inherit}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:#111}
::-webkit-scrollbar-thumb{background:#555;border-radius:3px}

/* ===== DQÈ¢®Êû† ===== */
.dq-box{background:#000;border:2px solid #fff;border-radius:8px;padding:16px}

/* ===== „Çµ„Ç§„Éâ„Éë„Éç„É´ ===== */
.side-panel{
  position:fixed;left:0;top:0;width:220px;height:100vh;
  background:#000;border-right:2px solid #888;z-index:101;
  padding:20px 16px;overflow-y:auto;
  display:flex;flex-direction:column;gap:16px;
}
.sp-account-name{
  font-size:1rem;font-weight:bold;color:#fff;text-align:center;
  padding:8px 0 4px;
}
.sp-account-title{
  font-size:.75rem;color:#ffd700;text-align:center;
  padding-bottom:12px;border-bottom:1px solid #555;
}
.sp-section{text-align:center}
.sp-level-label{font-size:.65rem;color:#aaa;letter-spacing:2px;text-transform:uppercase}
.sp-level-num{font-size:2.8rem;font-weight:bold;color:#fff;line-height:1.1}
.sp-bar{width:100%;height:8px;background:#222;border-radius:4px;overflow:hidden;margin:6px 0 4px}
.sp-bar-fill{height:100%;border-radius:4px;transition:width .6s ease}
.sp-bar-fill.exp-fill{background:linear-gradient(90deg,#7ecfff,#4fc3f7)}
.sp-bar-fill.cur-fill{background:linear-gradient(90deg,#4caf50,#66bb6a)}
.sp-bar-text{font-size:.65rem;color:#777}
.sp-row{display:flex;justify-content:space-between;align-items:center;padding:2px 0}
.sp-label{font-size:.7rem;color:#aaa}.sp-val{font-weight:bold}
.sp-val.exp-color{color:#7ecfff}.sp-val.gold-color{color:#ffd700}
.sp-title-label{font-size:.8rem;color:#ffd700;font-weight:bold;letter-spacing:1px}
.sp-title-next{font-size:.6rem;color:#888;margin-top:2px}
.sp-divider{height:1px;background:#555}
.sp-cur-label{font-size:.75rem;color:#ccc;margin-bottom:6px;font-weight:bold}
.sp-flash .sp-bar-fill.exp-fill{filter:brightness(2);transition:filter .15s}

/* ===== „Éò„ÉÉ„ÉÄ„Éº ===== */
.app-header{
  background:#000;padding:10px 16px;display:flex;align-items:center;
  border-bottom:2px solid #888;position:sticky;top:0;z-index:100;
}
.app-title{font-size:1rem;font-weight:bold;color:#ffd700}

.main-container{max-width:800px;margin:0 auto;padding:16px}
.screen{display:none}.screen.active{display:block}

/* ===== „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû ===== */
.chapter-title{text-align:center;margin:16px 0 8px;font-size:1.4rem;color:#ffd700}
.chapter-desc{text-align:center;color:#ccc;margin-bottom:24px;font-size:0.9rem}
.stage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.stage-card{
  background:#000;border:2px solid #888;border-radius:8px;padding:14px;
  transition:all .2s;position:relative;overflow:hidden;
}
.stage-card:hover:not(.locked){border-color:#fff;transform:translateY(-2px)}
.stage-card.locked{opacity:.4;cursor:not-allowed}
.stage-card.locked::after{content:'üîí';position:absolute;top:8px;right:8px;font-size:1.2rem}
.stage-card.cleared{border-color:#ffd700}
.stage-card.cleared::after{content:'‚úì';position:absolute;top:6px;right:10px;font-size:1.3rem;color:#ffd700;font-weight:bold}
.stage-card.boss{border-color:#ff5252}
.stage-card.boss.locked{border-color:#553333}
.stage-num{font-size:.75rem;color:#aaa}
.stage-name{font-size:1rem;font-weight:bold;margin:4px 0;color:#fff}
.stage-sub{font-size:.75rem;color:#ccc}
.stage-category{display:inline-block;font-size:.65rem;padding:2px 8px;border-radius:10px;margin-top:6px;background:#222;color:#ccc}

/* ===== Â≠¶ÁøíÁîªÈù¢ ===== */
.learn-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.back-btn{background:none;border:1px solid #888;color:#ccc;padding:6px 12px;border-radius:6px;font-size:.85rem}
.back-btn:hover{border-color:#fff;color:#fff}
.learn-stage-title{font-size:1.2rem;font-weight:bold;color:#fff}
.learn-stage-sub{font-size:.8rem;color:#ccc}
.progress-bar-container{display:flex;align-items:center;gap:8px;margin-bottom:20px}
.progress-bar{flex:1;height:6px;background:#333;border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:#ffd700;border-radius:3px;transition:width .5s ease}
.progress-label{font-size:.75rem;color:#aaa;white-space:nowrap}

/* ===== „Çª„ÇØ„Ç∑„Éß„É≥„Ç´„Éº„Éâ ===== */
.section-card{background:#000;border:2px solid #888;border-radius:8px;padding:20px;margin-bottom:16px}
.section-title{font-size:1rem;font-weight:bold;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #555}
.section-title.question-title{color:#ffb74d}
.section-title.knowledge-title{color:#ffd700}
.section-title.practice-title{color:#ffd700}
.section-title.reward-title{color:#ffd700}

/* ===== ÂïèÈ°åË°®Á§∫ ===== */
.q-source{font-size:.75rem;color:#aaa;margin-bottom:8px}
.q-text{font-size:1.4rem;line-height:1.9;background:#111;padding:16px 18px;border-radius:8px;border-left:4px solid #ffb74d;margin-bottom:12px}

/* ===== ÈñãÈñâ„Éë„Éç„É´ ===== */
.accordion{margin:8px 0;border:1px solid #666;border-radius:8px;overflow:hidden}
.accordion-header{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;background:#111;cursor:pointer;
  font-size:.9rem;font-weight:bold;transition:background .2s;
  user-select:none;
}
.accordion-header:hover{background:#1a1a1a}
.accordion-header .acc-icon{
  transition:transform .3s;font-size:.7rem;color:#aaa;
}
.accordion.open .accordion-header .acc-icon{transform:rotate(90deg)}
.accordion-header .acc-label{flex:1}
.acc-tag{font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:normal}
.acc-tag.hint{background:#222;color:#ffb74d}
.acc-tag.guide{background:#222;color:#ffd700}
.acc-tag.words{background:#222;color:#ccc}
.accordion-body{
  max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease;
  padding:0 14px;background:#0a0a0a;
}
.accordion.open .accordion-body{max-height:2000px;padding:12px 14px}

/* ===== ÈÅ∏ÊäûËÇ¢ ===== */
.q-choices{list-style:none}
.choice-item{
  margin:8px 0;border:2px solid #666;border-radius:8px;
  overflow:hidden;transition:all .3s ease;
}
.choice-item:hover:not(.answered):not(.selected){border-color:#fff}
.choice-main{
  display:flex;align-items:center;gap:8px;
  padding:12px 14px;cursor:pointer;font-size:.95rem;transition:background .2s;
}
.choice-main:hover{background:#111}
.choice-label{font-weight:bold;color:#ffd700;flex-shrink:0}
.choice-text{flex:1}
.choice-hint-btn{
  flex-shrink:0;background:#111;border:1px solid #666;color:#ffb74d;
  padding:5px 12px;border-radius:8px;font-size:.75rem;font-weight:bold;cursor:pointer;
  transition:all .2s;animation:btnPulse 2.5s ease-in-out infinite;
}
.choice-hint-btn:hover{background:#222;border-color:#ffb74d;animation:none;transform:scale(1.05)}
@keyframes btnPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,183,77,0)}50%{box-shadow:0 0 8px 2px rgba(255,183,77,.25)}}
.choice-hint{
  max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s ease,opacity .3s ease;
  padding:0 14px;background:#111;font-size:.85rem;color:#ffb74d;
  border-top:1px solid transparent;opacity:0;
}
.choice-hint.open{max-height:300px;padding:10px 14px;border-top-color:#444;opacity:1}
.choice-item.selected{border-color:#ffd700;background:#111}
.choice-item.selected .choice-main{color:#ffd700}
.choice-item.correct{border-color:#4caf50;background:#0a1a0a}
.choice-item.correct .choice-main{color:#81c784}
.choice-item.wrong{border-color:#f44336;background:#1a0a0a}
.choice-item.wrong .choice-main{color:#ef9a9a}
.answer-confirm{
  display:none;margin-top:12px;padding:16px;text-align:center;
  background:#111;border:2px solid #ffd700;
  border-radius:8px;animation:fadeIn .3s ease;
}
.answer-confirm .confirm-text{color:#ffd700}
.answer-confirm .confirm-yes{background:#ffd700;color:#000}

/* ===== ÂõûÁ≠îÂæå„ÅÆËß£Ë™¨ ===== */
.post-answer{display:none;margin-top:16px;animation:fadeIn .4s ease}
.post-answer.visible{display:block}
.result-banner{
  padding:14px 18px;border-radius:8px;margin-bottom:12px;
  font-weight:bold;font-size:1.1rem;text-align:center;
  animation:fadeIn .3s ease;
}
.result-banner.correct{background:#0a2a0a;border:2px solid #4caf50;color:#81c784;box-shadow:0 0 16px rgba(76,175,80,.4)}
.result-banner.wrong{background:#2a0a0a;border:2px solid #f44336;color:#ef9a9a;box-shadow:0 0 16px rgba(244,67,54,.4)}
.analysis-item{padding:10px 14px;margin:6px 0;background:#111;border-radius:8px}
.analysis-item.is-correct{border-left:3px solid #4caf50}
.analysis-item.is-wrong{border-left:3px solid #555}
.analysis-verdict{font-weight:bold;margin-right:6px}
.analysis-verdict.correct{color:#4caf50}.analysis-verdict.wrong{color:#888}
.strategy-steps{list-style:none;counter-reset:step}
.strategy-steps li{
  counter-increment:step;padding:8px 14px 8px 48px;margin:6px 0;
  background:#111;border-radius:8px;position:relative;font-size:.9rem;
}
.strategy-steps li::before{content:'Step ' counter(step);position:absolute;left:8px;top:9px;font-size:.7rem;color:#ffb74d;font-weight:bold}
.trap-box{background:#1a0a0a;border:1px solid #553333;border-radius:8px;padding:12px 14px;margin-top:10px;font-size:.85rem}
.trap-label{color:#ff5252;font-weight:bold;margin-bottom:4px}

/* ===== ÂçòË™ûËß£Ë™¨Ôºà„Éë„Éç„É´ÂÜÖÔºâ ===== */
.word-item{padding:8px 0;border-bottom:1px solid #333}
.word-item:last-child{border-bottom:none}
.word-term{font-weight:bold;color:#ffd700;margin-bottom:2px;font-size:.9rem}
.word-reading{font-size:.7rem;color:#aaa}
.word-desc{font-size:.82rem;color:#ccc;margin-top:2px}

/* ===== Èñ¢ÈÄ£Áü•Ë≠ò ===== */
.knowledge-item{padding:10px 14px;margin:6px 0;background:#111;border-radius:8px;border-left:3px solid #ffd700}
.knowledge-term{font-weight:bold;color:#ffd700;margin-bottom:4px}
.knowledge-desc{font-size:.85rem;color:#ccc;white-space:pre-line}

/* ===== Á∑¥ÁøíÂïèÈ°å ===== */
.practice-q{background:#111;border-radius:8px;padding:16px;margin:10px 0;border:1px solid #555}
.practice-q .q-text{margin-bottom:8px;border-left-color:#ffb74d}
.practice-explanation{display:none;margin-top:10px;padding:10px;background:#0a1a0a;border-radius:8px;font-size:.85rem;color:#a5d6a7}
.practice-explanation.visible{display:block}

/* ===== „Ç´„Éº„ÉâÁç≤Âæó ===== */
.reward-card{
  text-align:center;padding:24px;
  background:#000;border:2px solid #ffd700;
  border-radius:8px;animation:cardAppear .6s ease;
}
@keyframes cardAppear{0%{transform:scale(.8) rotateY(90deg);opacity:0}100%{transform:scale(1) rotateY(0deg);opacity:1}}
.reward-card-name{font-size:1.3rem;font-weight:bold;color:#ffd700;margin-bottom:4px}
.reward-rarity{color:#ffb74d;margin-bottom:10px}
.reward-summary{font-size:.85rem;color:#ccc;margin-bottom:16px;line-height:1.6}
.reward-stats{display:flex;justify-content:center;gap:24px;margin-bottom:16px}
.reward-stat{text-align:center}
.reward-stat-value{font-size:1.3rem;font-weight:bold}
.reward-stat-value.exp{color:#7ecfff}
.reward-stat-value.gold{color:#ffd700}
.reward-stat-label{font-size:.7rem;color:#aaa}

/* ===== „Éú„Çø„É≥ ===== */
.next-btn{
  display:block;width:100%;padding:14px;margin:16px 0;
  background:#ffd700;color:#000;
  font-size:1rem;font-weight:bold;border:none;border-radius:8px;transition:all .2s;
}
.next-btn:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(255,215,0,.3)}
.next-btn.secondary{background:#333;color:#fff;border:1px solid #666}
.next-btn.secondary:hover{border-color:#fff}

/* ===== „Éú„Çπ„Éê„Éà„É´ ===== */
.boss-header{text-align:center;padding:20px;background:#000;border:2px solid #ff5252;border-radius:8px;margin-bottom:16px}
.boss-name{font-size:1.5rem;font-weight:bold;color:#ff5252;margin-bottom:4px}
.boss-desc{font-size:.85rem;color:#ff8a80}
.boss-hp-container{margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px}
.boss-hp-bar{flex:1;max-width:200px;height:10px;background:#333;border-radius:5px;overflow:hidden}
.boss-hp-fill{height:100%;background:linear-gradient(90deg,#f44336,#ff5252);transition:width .5s ease;border-radius:5px}
.boss-hp-text{font-size:.8rem;color:#ff8a80}
.boss-q-counter{text-align:center;color:#aaa;font-size:.85rem;margin:12px 0}
.boss-result{text-align:center;padding:30px}
.boss-result h2{font-size:1.5rem;margin-bottom:8px}
.boss-result.win h2{color:#ffd700}
.boss-result.lose h2{color:#ff5252}
.boss-result p{color:#ccc;margin-bottom:16px}
.boss-score{font-size:1.2rem;color:#fff;margin-bottom:16px}

/* ===== „Ç´„Éº„ÉâÂõ≥Èëë ===== */
.collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.coll-card{background:#000;border:1px solid #666;border-radius:8px;padding:12px;text-align:center;font-size:.8rem}
.coll-card.owned{border-color:#ffd700}.coll-card.not-owned{opacity:.35}
.coll-card-name{font-weight:bold;color:#ffd700;margin-bottom:4px}
.coll-card-rarity{color:#ffb74d;font-size:.7rem}

/* ===== „Åì„Å®„Å∞„Çπ„ÉÜ„ÉÉ„Éó ===== */
.vocab-intro{font-size:.9rem;color:#ccc;margin-bottom:16px;line-height:1.8;background:#111;padding:14px;border-radius:8px;border-left:3px solid #ffd700}
.vocab-grid{display:grid;gap:12px}
.vocab-card{background:#111;border:1px solid #555;border-radius:8px;padding:14px 16px;transition:border-color .2s}
.vocab-card:hover{border-color:#ffd700}
.vocab-word{font-size:1rem;font-weight:bold;color:#ffd700}
.vocab-reading{font-size:.75rem;color:#aaa;margin-left:6px}
.vocab-meaning{font-size:.88rem;color:#ddd;margin-top:6px;line-height:1.7}
.step-badge{display:inline-block;font-size:.7rem;padding:3px 10px;border-radius:12px;margin-bottom:10px;font-weight:bold}
.step-badge.step-vocab{background:#111;color:#ffd700;border:1px solid #555}
.step-badge.step-question{background:#111;color:#ffb74d;border:1px solid #555}
.step-badge.step-knowledge{background:#111;color:#ffd700;border:1px solid #555}
.step-badge.step-practice{background:#111;color:#ffb74d;border:1px solid #555}
.step-badge.step-reward{background:#111;color:#ff5252;border:1px solid #ff5252}
.question-guide{background:#111;border:1px solid #555;border-radius:8px;padding:14px;margin-bottom:14px}
.question-guide-title{font-size:.85rem;font-weight:bold;color:#ffb74d;margin-bottom:8px}
.question-guide-text{font-size:.88rem;color:#ddd;line-height:1.8;white-space:pre-line}

/* ===== ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ ===== */
.strategy-hint-wrap{margin-bottom:12px}
.strategy-hint-btn{
  display:flex;align-items:center;gap:8px;width:100%;
  padding:10px 14px;background:#111;border:1px solid #666;border-radius:8px;
  color:#ffb74d;font-size:.85rem;font-weight:bold;cursor:pointer;
  transition:all .3s;user-select:none;
  animation:hintPulse 2.5s ease-in-out infinite;
}
.strategy-hint-btn:hover{background:#1a1a1a;border-color:#ffb74d;animation:none;transform:scale(1.02)}
.strategy-hint-btn.open{animation:none}
@keyframes hintPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,183,77,0)}50%{box-shadow:0 0 10px 2px rgba(255,183,77,.25)}}
.strategy-hint-icon{font-size:.7rem;transition:transform .3s}
.strategy-hint-btn.open .strategy-hint-icon{transform:rotate(90deg)}
.strategy-hint-body{
  max-height:0;overflow:hidden;transition:max-height .5s ease,padding .3s ease,opacity .3s ease;
  padding:0 14px;background:#111;border-radius:0 0 8px 8px;opacity:0;
}
.strategy-hint-body.open{max-height:600px;padding:12px 14px;opacity:1}

/* ===== È†ÜÊ¨°Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É† ===== */
.reveal-block{opacity:0;max-height:0;overflow:hidden;transition:opacity .5s ease,max-height .5s ease,margin .3s ease;margin:0;pointer-events:none}
.reveal-block.revealed{opacity:1;max-height:2000px;overflow:visible;margin:12px 0;pointer-events:auto}
.tap-indicator{
  text-align:center;padding:14px;margin:8px 16px;cursor:pointer;
  background:#111;border:1px dashed #666;border-radius:8px;
  color:#ffd700;font-size:.85rem;font-weight:bold;
  transition:all .2s;user-select:none;display:none;
}
.tap-indicator:hover{background:#1a1a1a;border-color:#ffd700}
.tap-indicator.active{display:block;animation:tapPulse 2s infinite}
@keyframes tapPulse{0%,100%{opacity:.7;transform:scale(1)}50%{opacity:1;transform:scale(1.02)}}
.confirm-box{
  background:#000;border:2px solid #4caf50;
  border-radius:8px;padding:20px;text-align:center;
}
.confirm-text{font-size:1rem;font-weight:bold;color:#fff;margin-bottom:14px}
.confirm-subtext{font-size:.8rem;color:#ccc;margin-bottom:14px}
.confirm-btn{padding:12px 24px;border:none;border-radius:8px;font-size:.9rem;font-weight:bold;margin:4px;cursor:pointer;transition:all .2s}
.confirm-yes{background:#4caf50;color:#fff;animation:btnGlow 2s ease-in-out infinite}
.confirm-yes:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(76,175,80,.4);animation:none}
@keyframes btnGlow{0%,100%{box-shadow:0 0 0 0 rgba(76,175,80,0)}50%{box-shadow:0 0 10px 2px rgba(76,175,80,.2)}}
.confirm-retry{background:#333;color:#ccc;border:1px solid #666}
.confirm-retry:hover{border-color:#fff;color:#fff}

/* ===== „Ç¢„Éã„É° ===== */
@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .4s ease}
.content-spacer{height:70px}

/* ===== „Çø„ÉÉ„ÉóÁµåÈ®ìÂÄ§„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ ===== */
.xp-particle{
  position:fixed;pointer-events:none;z-index:9999;
  width:8px;height:8px;border-radius:50%;
  background:radial-gradient(circle,#fff 0%,#7ecfff 60%,#4fc3f7 100%);
  box-shadow:0 0 6px 1px rgba(79,195,247,.4);
}
.tap-ripple{
  position:fixed;pointer-events:none;z-index:9998;
  width:24px;height:24px;border-radius:50%;border:1.5px solid rgba(126,207,255,.4);
  animation:rippleOut .5s ease-out forwards;
}
@keyframes rippleOut{0%{transform:scale(0);opacity:.5}100%{transform:scale(2);opacity:0}}
.gold-particle{
  position:fixed;pointer-events:none;z-index:9999;
  width:10px;height:10px;border-radius:50%;
  background:radial-gradient(circle,#fff176 0%,#ffd700 50%,#f9a825 100%);
  box-shadow:0 0 6px 1px rgba(255,215,0,.4);
  border:1px solid #ffb300;
}
.sidebar-gain{
  position:fixed;pointer-events:none;z-index:9999;
  font-weight:bold;font-size:.7rem;white-space:nowrap;
}
.sp-buff{font-size:.6rem;color:#ce93d8;margin-top:4px;font-weight:bold;min-height:14px}

/* ===== „Éê„ÉïÁç≤ÂæóÊºîÂá∫ ===== */
.buff-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;display:flex;align-items:center;justify-content:center;
  animation:buffFlash .8s ease forwards;
}
@keyframes buffFlash{0%{background:rgba(206,147,216,0)}12%{background:rgba(206,147,216,.2)}100%{background:rgba(206,147,216,0)}}
.buff-banner{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9998;
  pointer-events:none;text-align:center;
}
.buff-banner-text{
  font-size:1.6rem;font-weight:bold;color:#ce93d8;letter-spacing:2px;
  text-shadow:0 0 20px rgba(206,147,216,.6),0 0 40px rgba(206,147,216,.2);
}
.buff-banner-sub{font-size:.8rem;color:#e1bee7;margin-top:6px}

/* ===== „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÊºîÂá∫ ===== */
.levelup-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9998;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:rgba(0,0,0,.85);opacity:0;pointer-events:none;
  transition:opacity .3s;
}
.levelup-overlay.active{opacity:1;pointer-events:auto}
.levelup-box{text-align:center}
.levelup-label{font-size:1.1rem;color:#ffd700;margin-bottom:8px;letter-spacing:3px;animation:lvLabelIn .5s ease .2s both}
.levelup-number{font-size:3rem;font-weight:bold;color:#fff;text-shadow:0 0 30px #ffd700,0 0 60px rgba(255,215,0,.3);animation:lvNumIn .6s ease .4s both}
.levelup-sub{font-size:.85rem;color:#aaa;margin-top:14px;animation:lvSubIn .4s ease .8s both}
@keyframes lvLabelIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes lvNumIn{0%{transform:scale(0) rotate(-5deg);opacity:0}60%{transform:scale(1.15) rotate(2deg)}100%{transform:scale(1) rotate(0);opacity:1}}
@keyframes lvSubIn{0%{opacity:0}100%{opacity:1}}
.levelup-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;animation:lvFlash .6s ease forwards;
}
@keyframes lvFlash{0%{background:rgba(255,215,0,0)}15%{background:rgba(255,215,0,.35)}100%{background:rgba(255,215,0,0)}}

/* ===== Áß∞Âè∑Áç≤ÂæóÊºîÂá∫ ===== */
.title-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:rgba(0,0,0,.9);opacity:0;pointer-events:none;
  transition:opacity .4s;
}
.title-overlay.active{opacity:1;pointer-events:auto}
.title-got-label{font-size:.9rem;color:#fff;letter-spacing:4px;margin-bottom:12px;animation:titleLabelIn .5s ease .2s both}
.title-got-name{
  font-size:2rem;font-weight:bold;color:#ffd700;
  text-shadow:0 0 20px #ffd700,0 0 40px rgba(255,215,0,.4),0 0 80px rgba(255,215,0,.2);
  animation:titleNameIn .7s ease .5s both;
}
.title-got-sub{font-size:.8rem;color:#aaa;margin-top:16px;animation:titleSubIn .4s ease 1s both}
.title-flash{
  position:fixed;top:0;left:0;width:100%;height:100%;z-index:9997;
  pointer-events:none;animation:titleFlashAnim .8s ease forwards;
}
@keyframes titleLabelIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
@keyframes titleNameIn{0%{transform:scale(0);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes titleSubIn{0%{opacity:0}100%{opacity:1}}
@keyframes titleFlashAnim{0%{background:rgba(255,215,0,0)}10%{background:rgba(255,215,0,.5)}100%{background:rgba(255,215,0,0)}}

/* ===== „É¨„Çπ„Éù„É≥„Ç∑„Éñ ===== */
@media(max-width:768px){
  body{padding-left:0;padding-top:0;padding-bottom:88px}
  .side-panel{
    top:auto;bottom:0;
    width:100%;height:auto;
    display:grid;
    grid-template-columns:auto 1fr auto;
    grid-template-rows:auto auto;
    padding:6px 10px;
    border-right:none;border-top:2px solid #555;border-bottom:none;
    gap:3px 10px;align-items:center;
    overflow:hidden;
  }
  #sp-account-area{display:none}
  .sp-divider{display:none}
  .sp-title-next{display:none}
  .app-header{display:none}
  /* Row 1: Level | Title | Gold */
  #sp-level-area{grid-row:1;grid-column:1;text-align:left}
  #sp-title-area{grid-row:1;grid-column:2;text-align:center;overflow:hidden}
  #sp-gold-area{grid-row:1;grid-column:3;text-align:right}
  /* Row 2: EXP | Items | Progress */
  #sp-exp-area{grid-row:2;grid-column:1;text-align:left}
  #sp-items-area{grid-row:2;grid-column:2;text-align:center}
  #sp-progress-area{grid-row:2;grid-column:3;text-align:right}
  .sp-level-num{font-size:1.2rem;line-height:1}
  .sp-level-label{font-size:.5rem}
  .sp-section{white-space:nowrap;min-width:0}
  .sp-bar{width:60px;margin:2px 0 1px}.sp-bar-text{font-size:.5rem}
  .sp-cur-label{font-size:.55rem;margin-bottom:1px}
  .sp-title-label{font-size:.65rem;text-overflow:ellipsis;overflow:hidden}
  .sp-row{gap:3px}
  .mc-item-bar{gap:1px}
  .mc-slot{width:28px;height:28px}
  .mc-slot img{width:22px;height:22px}
}
/* „Çπ„Éû„Éõ: ÂïèÈ°åÊñá„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„Éº */
@media(max-width:768px){
  .sticky-q.revealed{
    position:sticky;top:0;z-index:50;
    background:#000;
    padding:8px 12px 6px;margin:0;
    border-bottom:2px solid #ffb74d;
    box-shadow:0 4px 12px rgba(0,0,0,.8);
  }
  .sticky-q.revealed .q-text{
    max-height:30vh;overflow-y:auto;
    font-size:1.1rem;line-height:1.7;
    margin-bottom:4px;padding:10px 12px;
  }
  .sticky-q.revealed .q-source{
    font-size:.65rem;margin-bottom:4px;
  }
}

@media(max-width:600px){
  .stage-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
  .main-container{padding:10px}
  .section-card{padding:14px}
  .choice-main{padding:10px 10px}
  .choice-hint-btn{padding:3px 6px;font-size:.65rem}
}
/* ===== „Ç∑„Éß„ÉÉ„Éó ===== */
.shop-warning{background:rgba(255,82,82,.15);border:1px solid #ff5252;border-radius:8px;padding:12px;margin-bottom:16px;color:#ff8a80;font-size:.85rem;line-height:1.5;text-align:center}
.shop-gold{text-align:center;font-size:1.1rem;color:#ffd700;font-weight:bold;margin-bottom:12px}
.shop-item{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.05);border:1px solid #555;border-radius:8px;padding:12px;margin-bottom:10px}
.shop-item-icon{flex-shrink:0;width:40px;height:40px;overflow:hidden}
.shop-item-icon img{width:100%;height:100%;object-fit:contain;image-rendering:pixelated}
.boss-bag-item-icon{width:24px;height:24px;max-width:24px;max-height:24px;object-fit:contain;image-rendering:pixelated;vertical-align:middle;margin-right:4px}
.boss-bag-item{display:flex;align-items:center;gap:4px;margin:4px 0}
.shop-item-info{flex:1}
.shop-item-name{font-weight:bold;color:#fff;font-size:.9rem}
.shop-item-desc{font-size:.75rem;color:#aaa;margin-top:2px}
.shop-item-price{color:#ffd700;font-size:.8rem;margin-top:4px}
.shop-buy-btn{background:#ffd700;color:#1a1a2e;border:none;border-radius:6px;padding:6px 14px;font-weight:bold;cursor:pointer;font-size:.8rem;flex-shrink:0}
.shop-buy-btn:disabled{background:#555;color:#888;cursor:not-allowed}
.boss-bag{background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:12px;margin:16px 0}
.boss-bag-title{font-size:.85rem;color:#ffd700;font-weight:bold;margin-bottom:8px}
.boss-bag-item{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.85rem;color:#fff}
.boss-bag-empty{font-size:.8rem;color:#888}
.boss-use-glasses{background:#4fc3f7;color:#1a1a2e;border:none;border-radius:6px;padding:6px 14px;font-weight:bold;cursor:pointer;font-size:.8rem;margin-top:8px;display:none}
.boss-use-glasses.visible{display:inline-block}
.choice-hidden{opacity:.3;pointer-events:none;text-decoration:line-through}
/* ===== „É¢„Éº„ÉÄ„É´ ===== */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .2s}
.modal-box{background:#1a1a2e;border:2px solid #ff5252;border-radius:12px;padding:24px;max-width:340px;width:90%;text-align:center}
.modal-box h3{color:#ff5252;margin:0 0 12px;font-size:1.1rem}
.modal-bag{background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:8px 12px;margin:12px 0;font-size:.85rem;color:#ffd700}
.modal-bag-item-icon{width:20px;height:20px;vertical-align:middle;image-rendering:pixelated;margin-right:4px}
.modal-note{color:#aaa;font-size:.8rem;margin:12px 0 16px}
.modal-btns{display:flex;gap:10px;justify-content:center}
.modal-btns button{flex:1;padding:10px;border:none;border-radius:8px;font-size:.9rem;font-weight:bold;cursor:pointer}
.modal-btn-go{background:#ff5252;color:#fff}
.modal-btn-back{background:#333;color:#aaa}
/* ===== „Éú„Çπ„Çπ„Éó„É©„Ç§„Éà ===== */
.boss-sprite{display:block;margin:0 auto 8px;image-rendering:pixelated;width:120px;height:auto}
.boss-sprite-sm{image-rendering:pixelated;width:120px;height:auto}
@keyframes bossIdle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.boss-sprite-anim{animation:bossIdle 1.2s ease-in-out infinite}
@keyframes bossHit{0%{filter:brightness(3) drop-shadow(0 0 12px #ff0);transform:translateX(-6px)}25%{transform:translateX(6px)}50%{filter:brightness(2);transform:translateX(-4px)}75%{transform:translateX(4px)}100%{filter:brightness(1);transform:translateX(0)}}
.boss-sprite-hit{animation:bossHit .5s ease}
/* ===== „Éú„Çπ2„Ç´„É©„É†„Éò„ÉÉ„ÉÄ„Éº ===== */
.boss-header-row{display:flex;align-items:center;justify-content:center;gap:24px;padding:12px 20px;background:#111;border:2px solid #ff5252;border-radius:12px;margin-bottom:12px}
.boss-info-col{text-align:center;min-width:0}
.boss-sprite-col{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:6px}
/* ===== ÁîªÈù¢Êè∫„Çå ===== */
@keyframes screenShake{0%{transform:translate(0,0)}10%{transform:translate(-8px,4px)}20%{transform:translate(6px,-6px)}30%{transform:translate(-4px,6px)}40%{transform:translate(4px,-2px)}50%{transform:translate(-2px,4px)}60%{transform:translate(6px,-4px)}70%{transform:translate(-4px,2px)}80%{transform:translate(2px,-6px)}90%{transform:translate(-2px,2px)}100%{transform:translate(0,0)}}
.screen-shake{animation:screenShake .4s ease}
/* ===== „Éû„Ç§„ÇØ„É©È¢®„Ç¢„Ç§„ÉÜ„É†„Éú„ÉÉ„ÇØ„Çπ ===== */
.mc-item-bar{display:flex;gap:2px;justify-content:center}
.mc-slot{width:36px;height:36px;background:#555;border:2px solid #222;border-top-color:#373737;border-left-color:#373737;border-right-color:#8b8b8b;border-bottom-color:#8b8b8b;display:flex;align-items:center;justify-content:center;position:relative}
.mc-slot.empty{background:#555}
.mc-slot img{width:28px;height:28px;object-fit:contain;image-rendering:pixelated}
.mc-slot-label{position:absolute;bottom:-1px;right:1px;font-size:8px;color:#fff;text-shadow:1px 1px 0 #000;font-weight:bold}
</style>
</head>
<body>

<aside class="side-panel" id="side-panel">
  <div class="sp-section" id="sp-account-area">
    <div class="sp-account-name" id="sp-account-name">„Ç≤„Çπ„Éà„É¶„Éº„Ç∂„ÉºÔºà‰ªÆÔºâ</div>
    <div class="sp-account-title" id="sp-account-title">ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥ÊâãÔºà‰ªÆÔºâ</div>
  </div>

  <div class="sp-section" id="sp-level-area">
    <div class="sp-level-label">LEVEL</div>
    <div class="sp-level-num" id="sp-level">1</div>
  </div>

  <div class="sp-section" id="sp-title-area">
    <div class="sp-title-label" id="sp-title">ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã</div>
    <div class="sp-title-next" id="sp-title-next"></div>
  </div>

  <div class="sp-section" id="sp-items-area">
    <div style="font-size:.65rem;color:#aaa;margin-bottom:4px;letter-spacing:1px">ITEMS</div>
    <div id="sp-item-bar" class="mc-item-bar"></div>
  </div>

  <div class="sp-section" id="sp-exp-area">
    <div class="sp-row"><span class="sp-label">EXP</span><span class="sp-val exp-color" id="sp-exp">0</span></div>
    <div class="sp-bar"><div class="sp-bar-fill exp-fill" id="sp-exp-bar" style="width:0%"></div></div>
    <div class="sp-bar-text" id="sp-exp-next">Ê¨°„ÅÆLv„Åæ„Åß 5</div>
    <div class="sp-buff" id="sp-buff"></div>
  </div>

  <div class="sp-section" id="sp-gold-area">
    <div class="sp-row"><span class="sp-label">GOLD</span><span class="sp-val gold-color" id="sp-gold">0</span></div>
  </div>

  <div class="sp-divider"></div>

  <div class="sp-section" id="sp-progress-area">
    <div class="sp-cur-label">„Ç´„É™„Ç≠„É•„É©„É†ÈÄ≤Êçó</div>
    <div class="sp-bar"><div class="sp-bar-fill cur-fill" id="sp-cur-fill" style="width:0%"></div></div>
    <div class="sp-bar-text" id="sp-cur-text">0 / 12 „ÇØ„É™„Ç¢</div>
  </div>
</aside>

<div class="app-header">
  <div class="app-title">IT„Éë„Çπ„Éù„Éº„ÉàÂØæÁ≠ñË¨õÂ∫ß</div>
</div>

<div id="screen-map" class="screen active">
  <div class="main-container">
    <div class="chapter-title">Á¨¨1Á´† „Ç≥„É≥„Éî„É•„Éº„Çø„ÅÆ‰∏ñÁïå</div>
    <div class="chapter-desc">ÊØéÊó•‰Ωø„Å£„Å¶„Çã„Çπ„Éû„Éõ„ÇÑ„Éë„ÇΩ„Ç≥„É≥„ÄÅ‰∏≠Ë∫´„ÇíÁü•„Çç„ÅÜ</div>
    <div class="stage-grid" id="stage-grid"></div>
    <div style="margin-top:20px">
      <button class="next-btn secondary" onclick="showScreen('screen-collection')">„Ç´„Éº„ÉâÂõ≥Èëë</button>
    </div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-learn" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div>
        <div class="learn-stage-title" id="learn-title"></div>
        <div class="learn-stage-sub" id="learn-sub"></div>
      </div>
    </div>
    <div class="progress-bar-container">
      <div class="progress-bar"><div class="progress-fill" id="learn-progress"></div></div>
      <div class="progress-label" id="learn-progress-label"></div>
    </div>
    <div id="learn-content"></div>
    <div id="tap-indicator" class="tap-indicator" onclick="revealNext(event)">„Çø„ÉÉ„Éó or „Çπ„Éö„Éº„Çπ„Ç≠„Éº„ÅßÁ∂ö„Åç„ÇíË™≠„ÇÄ ‚ñº</div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-boss-prep" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title" style="color:#ff5252" id="boss-prep-title">„Éú„ÇπÊà¶Ê∫ñÂÇô</div></div>
    </div>
    <div id="boss-prep-content"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-boss" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title" style="color:#ff5252" id="boss-title">Á´†„Éú„Çπ</div></div>
    </div>
    <div id="boss-content"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div id="screen-collection" class="screen">
  <div class="main-container">
    <div class="learn-header">
      <button class="back-btn" onclick="showScreen('screen-map')">‚Üê Êàª„Çã</button>
      <div><div class="learn-stage-title">„Ç´„Éº„ÉâÂõ≥Èëë</div></div>
    </div>
    <div class="collection-grid" id="collection-grid"></div>
    <div class="content-spacer"></div>
  </div>
</div>

<div class="levelup-overlay" id="levelup-overlay" onclick="closeLevelUp()">
  <div class="levelup-box">
    <div class="levelup-label">LEVEL UP!</div>
    <div class="levelup-number" id="levelup-number">Lv.2</div>
    <div class="levelup-sub">„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã</div>
  </div>
</div>

<div class="title-overlay" id="title-overlay" onclick="closeTitleOverlay()">
  <div class="title-got-label">Êñ∞„Åó„ÅÑÁß∞Âè∑„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ</div>
  <div class="title-got-name" id="title-got-name"></div>
  <div class="title-got-sub">„Çø„ÉÉ„Éó„Åó„Å¶Èñâ„Åò„Çã</div>
</div>

<script>
/* ===== „Ç≥„Éº„Çπ„Éá„Éº„Çø ===== */
// „Ç§„É≥„É©„Ç§„É≥„Éá„Éº„Çø„ÅØÂâäÈô§„ÄÇJSON„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÇÄ„ÄÇ
let COURSE_DATA =
[];

let BOSS_DATA = {};

/* ===== „Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ© ===== */
const ITEM_ICONS={
  life_stone:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAKpCAYAAABKLt4+AAAAAXNSR0IArs4c6QAADMxJREFUeJzt1yFuZfcZh+F7LG+h8DKrgQYDCwIsVfIKwsIGdAUer8D1CgaElc0KLI1kKQGFAwwTmUQXdg++hWWtzsl0Pvu9z7OCn46O/q++ZQf/y/5yesF6h6fj9AReuf3lMj1htcPT9AJesbPpAQDAHyfoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsEwP2Oy776cXrPfrL8fpCafi7OZxegKv3Mv91fSE0/Hd92+vNb/+Mr1gNRc6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAELNMD/oDj9IC1zm4epycAfHMv91fTE7Z4c310oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DA+W5/Ob1hm8PT9IKTcXd9MT1htduH5+kJm7zcX01PWO3s5nF6wib+a/6rN9hGFzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsu93uOD1ii7Obx+kJq91dX0xP2OT24Xl6wmov91fTEzZZ/vLjMr1hreM///Em35D7n3+fnnAyvCHfhgsdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACzqcHwP/D2c3j9IRNXu6vjtMb1nqr3xpqXOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQcD49APiPs5vH6QnAG+VCB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAgPPd/nKZHrHFy/3VcXrDWre7x+kJm9xdX0xPWO324Xl6AsA35UIHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAgPPd4Wl6A/CG3V1fTE84GbcPz9MTNnm5v5qesN7+cpmesJYLHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAs6nB2y2v1ymJ6z1cn91nN6wyfXv0wsAvq3D0/SC1VzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQcD49gNfv9uF5egJ8dR8+fp6esNrx0/vpCdvsL5fpCasdnqYXrOZCB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgABBB4AAQQeAAEEHgIDz3f7d9IZtDl+O0xPWOrt5nJ7AK3d3fTE9YbUPHz9PT+C1OzxNLzgJLnQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAhYdrvdcXrEFssPP01POBl//9tfpyecjA8fP09POBnHT++nJ6y3f7dMT9jk8GV6wUlwoQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DAstvtjtMjtlh++Gl6Anx1x0/vpyecjv27ZXrCaocv0wt4xVzoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQsOz276Y3bHP4cpyeAF/dn/68TE9Y7V+/TS8Adi50AEgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAI+Dewi3GmZnUriQAAAABJRU5ErkJggg==',
  sage_glasses:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAEdCAYAAAD6nZXAAAAAAXNSR0IArs4c6QAABT1JREFUeJzt17ttG1EURdEZg2pAlagJxQ5cpwPHroKVqAEC41QgTAey4ftma60KDvi5G2/fOJtjesDC9ukBnJb/1WP+VyfxZXoAAPD3BB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAvbpASdwTA+44zsD/ic38CS80AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIEDQASBA0AEgQNABIGCfHvAbx/SAOyt+RgCflUY84IUOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAGCDgABgg4AAYIOAAH7tm3H9AiI2qcHLMzdgX/MCx0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAIEHQACBB0AAgQdAAL2bduO6RHvHcdSc5ZzfbtNT1jWy/PT9AROyt15zM35s5Xujhc6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAECDoABAg6AAQIOgAEXKYHrO76dpuewHnt0wMWdkwPWJm7w0d4oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAwGV6wL3r2216AvDJuDsUeKEDQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0DA5fXrt316xHsvz0/H9AbOabXf8s8f36cnLGu178rd4aNW+i17oQNAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAgKADQICgA0CAoANAwC9uWitvipNWkAAAAABJRU5ErkJggg=='
};
const SHOP_ITEMS=[
  {id:'life_stone',name:'ÂëΩ„ÅÆ„Åü„Åæ',price:500,desc:'‰∏çÊ≠£Ëß£„Åß„ÇÇ„É™„Çª„ÉÉ„Éà„Åï„Çå„Å™„ÅÑÔºàËá™Âãï‰ΩøÁî®Ôºâ',icon:ITEM_ICONS.life_stone},
  {id:'sage_glasses',name:'Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç',price:300,desc:'ÈÅ∏ÊäûËÇ¢„Çí2„Å§„Å´Áµû„Çã„Éí„É≥„Éà„Åå‰Ωø„Åà„Çã',icon:ITEM_ICONS.sage_glasses}
];

/* ===== Áä∂ÊÖãÁÆ°ÁêÜ ===== */
let state=loadState();
function defaultState(){return{exp:0,gold:5000,level:1,clearedStages:[1,2,3,4,5,6,7,8,9,10,11],ownedCards:[],bossCleared:false,titles:['ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã'],currentTitle:'ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã',inventory:[]}}
/* ‚Üë „ÉÜ„Çπ„ÉàÁî®: gold:5000, clearedStagesÂÖ®ÈñãÊîæ„ÄÇÊú¨Áï™„Åß„ÅØ gold:0, clearedStages:[] „Å´Êàª„Åô */
function loadState(){
  /* „ÉÜ„Çπ„ÉàÁî®: Âº∑Âà∂„É™„Çª„ÉÉ„Éà„ÄÇÊú¨Áï™„Åß„ÅØ‰∏ã„ÅÆ1Ë°å„ÇíÂâäÈô§ */
  localStorage.removeItem('it-course-state');return defaultState();
  try{
    const s=localStorage.getItem('it-course-state');
    if(!s)return defaultState();
    const d=JSON.parse(s);
    if(!d.titles){d.titles=['ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã'];d.currentTitle='ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã';}
    if(!d.inventory)d.inventory=[];
    return d;
  }catch(e){return defaultState();}
}
function saveState(){localStorage.setItem('it-course-state',JSON.stringify(state));updateHeader()}

/* ===== ÂäπÊûúÈü≥ ===== */
const SFX={
  exp:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô22.mp3'),
  gold:new Audio('„ÅäÈáë„Åå„Ç∏„É£„É©„Ç∏„É£„É©.mp3'),
  select:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô3.mp3'),
  confirm:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô18.mp3'),
  buff:new Audio('„Ç≤„Éº„Ç∏ÂõûÂæ©1.mp3'),
  correct:new Audio('„ÇØ„Ç§„Ç∫Ê≠£Ëß£1.mp3'),
  wrong:new Audio('Â∞è„Éë„É≥„ÉÅ.mp3'),
  typing:new Audio('„Ç≠„Éº„Éú„Éº„Éâ1.mp3'),
  hit:new Audio('Â§ß„Ç≠„ÉÉ„ÇØ.mp3'),
  magic:new Audio('ÈáçÂäõÈ≠îÊ≥ï1.mp3'),
  victory:new Audio('Ê±∫ÂÆö„Éú„Çø„É≥„ÇíÊäº„Åô41.mp3'),
  buy:new Audio('„ÅäÈáë„Åå„Ç∏„É£„É©„Ç∏„É£„É©.mp3')
};
Object.values(SFX).forEach(a=>{a.volume=0.4;a.preload='auto';});
SFX.typing.volume=0.15;
SFX.hit.volume=0.5;
function playSfx(key){const a=SFX[key];if(!a)return;a.currentTime=0;a.play().catch(()=>{});}

/* ===== „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºÊºîÂá∫ ===== */
let twTimer=null,twSkipFn=null;
function typewriter(el,text,speed,onDone){
  let i=0;el.textContent='';
  clearInterval(twTimer);
  twTimer=setInterval(()=>{
    if(i<text.length){
      el.textContent+=text[i];
      if(i%2===0)playSfx('typing');
      i++;
      if(i%20===0)el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }else{
      clearInterval(twTimer);twTimer=null;twSkipFn=null;
      if(onDone)onDone();
    }
  },speed);
  twSkipFn=()=>{clearInterval(twTimer);twTimer=null;el.textContent=text;twSkipFn=null;if(onDone)onDone();};
}
function skipTypewriter(){if(twSkipFn){twSkipFn();return true;}return false;}

/* ===== DQÈ¢®„É¨„Éô„É´Ë®àÁÆó ===== */
const MAX_LEVEL=999;
function expForLevel(lv){return Math.floor(5+lv*0.35+Math.pow(lv/60,2)*3);}
function calcLevel(totalExp){
  let lv=1,used=0;
  while(lv<MAX_LEVEL){
    const need=expForLevel(lv);
    if(totalExp<used+need)return{level:lv,cur:totalExp-used,next:need};
    used+=need;lv++;
  }
  return{level:MAX_LEVEL,cur:0,next:0};
}

/* ===== Áß∞Âè∑„Ç∑„Çπ„ÉÜ„É† ===== */
const TITLE_TABLE=[
  {lv:1,name:'ÈßÜ„ÅëÂá∫„Åó„ÅÆÂ≠¶„Å≥Êâã'},
  {lv:5,name:'Ë¶ãÁøí„ÅÑÂÜíÈô∫ËÄÖ'},
  {lv:10,name:'ÂÜíÈô∫ËÄÖ'},
  {lv:20,name:'ÊóÖ„ÅÆÂâ£Â£´'},
  {lv:30,name:'Áü•Ë≠ò„ÅÆÊé¢Ê±ÇËÄÖ'},
  {lv:50,name:'ÁÜüÁ∑¥„ÅÆÊà¶Â£´'},
  {lv:75,name:'ÁôΩÈäÄ„ÅÆÈ®éÂ£´'},
  {lv:100,name:'Áü•Ë≠ò„ÅÆÈ®éÂ£´'},
  {lv:150,name:'È≠îÊ≥ï‰Ωø„ÅÑ'},
  {lv:200,name:'Â§ßÈ≠îÊ≥ï‰Ωø„ÅÑ'},
  {lv:250,name:'Ë≥¢ËÄÖ'},
  {lv:300,name:'Â§ßË≥¢ËÄÖ'},
  {lv:400,name:'ÂãáËÄÖ'},
  {lv:500,name:'‰ºùË™¨„ÅÆÂãáËÄÖ'},
  {lv:600,name:'Ëã±ÈõÑ'},
  {lv:700,name:'Â§ßËã±ÈõÑ'},
  {lv:800,name:'Ë¶áÁéã'},
  {lv:900,name:'Á•û„ÅÆÈ†òÂüü'},
  {lv:950,name:'IT„ÅÆÂÆàË≠∑ËÄÖ'},
  {lv:999,name:'IT„ÅÆÁ•û'}
];
function getTitleForLevel(lv){
  let t=TITLE_TABLE[0];
  for(const e of TITLE_TABLE){if(lv>=e.lv)t=e;else break;}
  return t.name;
}
function getNextTitle(lv){
  for(const e of TITLE_TABLE){if(e.lv>lv)return e;}
  return null;
}
// Êó¢Â≠ò„Çª„Éº„Éñ„ÅÆÁß∞Âè∑„ÇíÁèæÂú®„É¨„Éô„É´„Å´Âêà„Çè„Åõ„Å¶Ë£úÊ≠£
(function(){
  const lv=calcLevel(state.exp).level;
  const t=getTitleForLevel(lv);
  if(state.currentTitle!==t){
    state.currentTitle=t;
    if(!state.titles)state.titles=[];
    for(const e of TITLE_TABLE){if(e.lv<=lv&&!state.titles.includes(e.name))state.titles.push(e.name);}
  }
})();
function updateHeader(){
  const info=calcLevel(state.exp);
  state.level=info.level;
  // „Çµ„Ç§„Éâ„Éë„Éç„É´Êõ¥Êñ∞
  const el=id=>document.getElementById(id);
  el('sp-level').textContent=state.level;
  el('sp-exp').textContent=state.exp;
  el('sp-gold').textContent=state.gold;
  const pct=info.next>0?Math.min((info.cur/info.next)*100,100):100;
  el('sp-exp-bar').style.width=pct+'%';
  el('sp-exp-next').textContent=info.next>0?`Ê¨°„ÅÆLv„Åæ„Åß ${info.next-info.cur}`:'MAX';
  // Áß∞Âè∑Êõ¥Êñ∞
  const title=getTitleForLevel(info.level);
  if(!state.currentTitle)state.currentTitle=title;
  el('sp-title').textContent=state.currentTitle;
  const nt=getNextTitle(info.level);
  el('sp-title-next').textContent=nt?`Ê¨°„ÅÆÁß∞Âè∑: ${nt.name} (Lv${nt.lv})`:'ÊúÄÈ´òÁß∞Âè∑„Å´Âà∞ÈÅîÔºÅ';
  // „Ç´„É™„Ç≠„É•„É©„É†ÈÄ≤Êçó
  const total=12;
  const cleared=state.clearedStages.length+(state.bossCleared?1:0);
  el('sp-cur-fill').style.width=((cleared/total)*100)+'%';
  el('sp-cur-text').textContent=`${cleared} / ${total} „ÇØ„É™„Ç¢`;
  // „Ç¢„Ç§„ÉÜ„É†„Éê„Éº
  renderSidebarItems();
}

/* ===== ÁîªÈù¢Âàá„ÇäÊõø„Åà ===== */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
  if(id==='screen-map')renderStageGrid();
  if(id==='screen-collection')renderCollection();
}

/* ===== „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû ===== */
function renderStageGrid(){
  const grid=document.getElementById('stage-grid');grid.innerHTML='';

  // „Éá„Éº„Çø„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
  if(COURSE_DATA.length === 0 && !BOSS_DATA.bossName) {
    grid.innerHTML = '<div style="text-align:center; padding:50px; color:#aaa; font-size:18px;">üìö „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';
    return;
  }

  COURSE_DATA.forEach((st,i)=>{
    const unlocked=i===0||state.clearedStages.includes(COURSE_DATA[i-1].stageId);
    const cleared=state.clearedStages.includes(st.stageId);
    const c=document.createElement('div');
    c.className='stage-card'+(unlocked?'':' locked')+(cleared?' cleared':'');
    c.innerHTML=`<div class="stage-num">Stage ${st.stageId}</div><div class="stage-name">${st.title}</div><div class="stage-sub">${st.subtitle}</div><div class="stage-category">${st.subcategory}</div>`;
    if(unlocked)c.onclick=()=>startStage(st.stageId);
    grid.appendChild(c);
  });
  const bu=state.clearedStages.length>=11;
  const bc=document.createElement('div');
  bc.className='stage-card boss'+(bu?'':' locked')+(state.bossCleared?' cleared':'');
  bc.innerHTML=`<div class="stage-num">Stage 12</div><div class="stage-name">${BOSS_DATA.bossName}</div><div class="stage-sub">${BOSS_DATA.bossDescription}</div><div class="stage-category" style="color:#ff5252">BOSS</div>`;
  if(bu)bc.onclick=()=>showBossPrep();
  grid.appendChild(bc);
}

/* ===== Â≠¶Áøí„Éï„É≠„Éº ===== */
let currentStage=null,learnStep=0;
const LEARN_STEPS=['vocab','question','knowledge','practice1','practice2','reward'];
const STEP_NAMES={vocab:'„Åì„Å®„Å∞„ÇíÁü•„Çç„ÅÜ',question:'ÂïèÈ°å„Å´ÊåëÊà¶',knowledge:'Áü•Ë≠ò„ÇíÂ∫É„Åí„Çà„ÅÜ',practice1:'Á∑¥ÁøíÂïèÈ°å‚ë†',practice2:'Á∑¥ÁøíÂïèÈ°å‚ë°',reward:'„Ç´„Éº„ÉâÁç≤Âæó'};

function startStage(id){
  playSfx('confirm');
  currentStage=COURSE_DATA.find(s=>s.stageId===id);
  if(!currentStage)return;
  learnStep=0;
  document.getElementById('learn-title').textContent=`Stage ${id}: ${currentStage.title}`;
  document.getElementById('learn-sub').textContent=currentStage.subtitle;
  showScreen('screen-learn');
  renderLearnStep();
}

function renderLearnStep(){
  const c=document.getElementById('learn-content');
  const pct=((learnStep+1)/LEARN_STEPS.length*100).toFixed(0);
  document.getElementById('learn-progress').style.width=pct+'%';
  const stepName=STEP_NAMES[LEARN_STEPS[learnStep]]||'';
  document.getElementById('learn-progress-label').textContent=`${learnStep+1}/${LEARN_STEPS.length} ${stepName}`;
  c.innerHTML='';
  const step=LEARN_STEPS[learnStep];
  const mq=currentStage.mainQuestion;
  if(step==='vocab')renderVocab(c,currentStage);
  else if(step==='question')renderIntegratedQuestion(c,mq);
  else if(step==='knowledge')renderKnowledge(c,currentStage.relatedKnowledge);
  else if(step==='practice1')renderPractice(c,currentStage.practiceQuestions[0],1);
  else if(step==='practice2')renderPractice(c,currentStage.practiceQuestions[1],2);
  else if(step==='reward')renderReward(c,currentStage);
  window.scrollTo({top:0,behavior:'smooth'});
}

function nextStep(){
  playSfx('confirm');
  learnStep++;
  if(learnStep>=LEARN_STEPS.length){showScreen('screen-map');return}
  renderLearnStep();
}

/* ===== „Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥ÈñãÈñâ ===== */
function toggleAcc(el){
  const acc=el.closest('.accordion');
  const wasOpen=acc.classList.contains('open');
  acc.classList.toggle('open');
  if(!wasOpen&&!acc.dataset.rewarded){acc.dataset.rewarded='1';const r=acc.getBoundingClientRect();rollTapReward(r.left+r.width/2,r.top+r.height/2);}
}

/* ===== ÈÅ∏ÊäûËÇ¢„Éí„É≥„ÉàÈñãÈñâ ===== */
function toggleHint(e,id){
  e.stopPropagation();
  const h=document.getElementById(id);
  const wasOpen=h.classList.contains('open');
  h.classList.toggle('open');
  if(!wasOpen){
    if(!h.dataset.rewarded){h.dataset.rewarded='1';rollTapReward(e.clientX,e.clientY);}
    // „Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßË°®Á§∫ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
    if(h.dataset.hint&&!h.dataset.filled){
      h.dataset.filled='1';
      h.textContent='';
      typewriter(h,h.dataset.hint,30);
    }
  }
}

/* ===== È†ÜÊ¨°Ë°®Á§∫„Ç∑„Çπ„ÉÜ„É† ===== */
let revealPaused=false;

function revealNext(e){
  if(revealPaused)return;
  // „Çø„Ç§„Éó„É©„Ç§„Çø„Éº‰∏≠„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶ÁµÇ‰∫Ü
  if(skipTypewriter())return;
  const container=document.getElementById('learn-content');
  if(!container)return;
  const next=container.querySelector('.reveal-block:not(.revealed)');
  if(!next)return;
  next.classList.add('revealed');
  setTimeout(()=>{next.scrollIntoView({behavior:'smooth',block:'nearest'})},150);
  if(next.dataset.wait){revealPaused=true;}
  updateTapIndicator();
  // „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºË¶ÅÁ¥†„Åå„ÅÇ„Çå„Å∞ÈñãÂßã
  const twEl=next.querySelector('[data-tw]');
  if(twEl){typewriter(twEl,twEl.dataset.tw,35);}
  // „Çø„ÉÉ„ÉóÂ†±ÈÖ¨
  let x,y;
  if(e&&e.clientX!==undefined){x=e.clientX;y=e.clientY;}
  else{const ind=document.getElementById('tap-indicator');if(ind){const r=ind.getBoundingClientRect();x=r.left+r.width/2;y=r.top+r.height/2;}else{x=window.innerWidth/2;y=window.innerHeight/2;}}
  rollTapReward(x,y);
}

function resumeReveal(){revealPaused=false;updateTapIndicator();}

function updateTapIndicator(){
  const container=document.getElementById('learn-content');
  const indicator=document.getElementById('tap-indicator');
  if(!indicator||!container)return;
  const hasMore=container.querySelector('.reveal-block:not(.revealed)');
  if(hasMore&&!revealPaused){indicator.classList.add('active');}
  else{indicator.classList.remove('active');}
}

function retryStep(){renderLearnStep();}

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space'&&document.querySelector('#screen-learn.active')){
    e.preventDefault();revealNext(null);
  }
});

/* ===== „É©„É≥„ÉÄ„É†Â†±ÈÖ¨„Ç∑„Çπ„ÉÜ„É† ===== */
let expMultiplier=1,expBuffRemaining=0;

function rollTapReward(x,y){
  let baseExp=2;
  if(expBuffRemaining>0){baseExp=Math.ceil(baseExp*expMultiplier);expBuffRemaining--;updateBuffDisplay();}
  const roll=Math.random();
  if(roll<0.08){
    expMultiplier=1.2;expBuffRemaining=10;
    gainTapExp(x,y,baseExp);
    updateBuffDisplay();
    showBuffBanner();
  }else if(roll<0.23){
    const gold=1+Math.floor(Math.random()*3);
    state.gold+=gold;
    gainTapExp(x,y,baseExp);
    spawnGoldCoins(x,y,gold);
  }else{
    gainTapExp(x,y,baseExp);
  }
}

function spawnGoldCoins(fromX,fromY,amount){
  playSfx('gold');
  const target=document.getElementById('sp-gold');
  if(!target)return;
  const tRect=target.getBoundingClientRect();
  const tx=tRect.left+tRect.width/2,ty=tRect.top+tRect.height/2;
  const count=3;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');p.className='gold-particle';
    const ox=(Math.random()-.5)*30,oy=(Math.random()-.5)*30;
    p.style.left=(fromX+ox)+'px';p.style.top=(fromY+oy)+'px';
    document.body.appendChild(p);
    const dx=tx-(fromX+ox),dy=ty-(fromY+oy);
    const delay=i*50;
    p.animate([
      {transform:'translate(0,0) scale(1) rotate(0deg)',opacity:.8},
      {transform:`translate(${dx}px,${dy}px) scale(0.3) rotate(360deg)`,opacity:.3}
    ],{duration:500,delay:delay,easing:'ease-in',fill:'forwards'});
    setTimeout(()=>p.remove(),600+delay);
  }
  setTimeout(()=>showSidebarGain('sp-gold','+'+amount+' G','#ffd700'),400);
}

function updateBuffDisplay(){
  const el=document.getElementById('sp-buff');
  if(!el)return;
  if(expBuffRemaining>0){el.textContent=`EXP x${expMultiplier} (ÊÆã„Çä${expBuffRemaining}Âõû)`;}
  else{el.textContent='';}
}

/* ===== „Çµ„Ç§„Éâ„Éê„ÉºÂà∞ÁùÄÊôÇ„ÅÆÂ¢óÂä†Ë°®Á§∫ ===== */
function showSidebarGain(targetId,text,color){
  const el=document.getElementById(targetId);
  if(!el)return;
  const rect=el.getBoundingClientRect();
  const t=document.createElement('div');t.className='sidebar-gain';
  t.textContent=text;t.style.color=color;
  t.style.left=(rect.right+6)+'px';t.style.top=(rect.top)+'px';
  document.body.appendChild(t);
  t.animate([
    {transform:'translateY(0)',opacity:1},
    {transform:'translateY(-14px)',opacity:0}
  ],{duration:800,fill:'forwards'});
  setTimeout(()=>t.remove(),900);
}

/* ===== „Éê„ÉïÁç≤ÂæóÊºîÂá∫ ===== */
function showBuffBanner(){
  playSfx('buff');
  // ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•
  const flash=document.createElement('div');flash.className='buff-overlay';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),900);
  // ‰∏≠Â§Æ„Éê„Éä„Éº
  const b=document.createElement('div');b.className='buff-banner';
  b.innerHTML='<div class="buff-banner-text">EXP x1.2 GET!</div><div class="buff-banner-sub">10ÂõûÂàÜ„ÅÆEXP„Åå„Ç¢„ÉÉ„ÉóÔºÅ</div>';
  document.body.appendChild(b);
  b.animate([
    {transform:'translate(-50%,-50%) scale(.5)',opacity:0},
    {transform:'translate(-50%,-50%) scale(1.05)',opacity:1,offset:.2},
    {transform:'translate(-50%,-50%) scale(1)',opacity:1,offset:.5},
    {transform:'translate(-50%,-50%) scale(1)',opacity:0}
  ],{duration:1800,fill:'forwards'});
  setTimeout(()=>b.remove(),1900);
}

/* ===== „Çø„ÉÉ„ÉóÁµåÈ®ìÂÄ§ & „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊºîÂá∫ ===== */
function gainTapExp(x,y,amount){
  const oldLv=calcLevel(state.exp).level;
  state.exp+=amount;
  saveState();
  playSfx('exp');
  spawnTapRipple(x,y);
  spawnParticles(x,y,amount);
  const area=document.getElementById('sp-exp-area');
  if(area){area.classList.add('sp-flash');setTimeout(()=>area.classList.remove('sp-flash'),300);}
  const newLv=calcLevel(state.exp).level;
  if(newLv>oldLv)showLevelUp(newLv);
}

function spawnTapRipple(x,y){
  const r=document.createElement('div');r.className='tap-ripple';
  r.style.left=(x-12)+'px';r.style.top=(y-12)+'px';
  document.body.appendChild(r);
  setTimeout(()=>r.remove(),600);
}

function spawnParticles(fromX,fromY,amount){
  const target=document.getElementById('sp-exp-area');
  if(!target)return;
  const tRect=target.getBoundingClientRect();
  const tx=tRect.left+tRect.width/2,ty=tRect.top+tRect.height/2;
  const count=4;
  for(let i=0;i<count;i++){
    const p=document.createElement('div');p.className='xp-particle';
    const angle=(Math.PI*2/count)*i;
    const spread=12+Math.random()*10;
    const ox=Math.cos(angle)*spread,oy=Math.sin(angle)*spread;
    p.style.left=(fromX+ox)+'px';p.style.top=(fromY+oy)+'px';
    document.body.appendChild(p);
    const dx=tx-(fromX+ox),dy=ty-(fromY+oy);
    const delay=i*30;
    p.animate([
      {transform:'translate(0,0) scale(1)',opacity:.8},
      {transform:`translate(${dx}px,${dy}px) scale(0.2)`,opacity:.2}
    ],{duration:450,delay:delay,easing:'ease-in',fill:'forwards'});
    setTimeout(()=>p.remove(),550+delay);
  }
  setTimeout(()=>showSidebarGain('sp-exp','+'+amount,'#7ecfff'),350);
}

function showLevelUp(newLv){
  const flash=document.createElement('div');flash.className='levelup-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),700);
  const ov=document.getElementById('levelup-overlay');
  document.getElementById('levelup-number').textContent='Lv.'+newLv;
  setTimeout(()=>ov.classList.add('active'),300);
  // Áß∞Âè∑„ÉÅ„Çß„ÉÉ„ÇØ
  const newTitle=getTitleForLevel(newLv);
  if(newTitle!==state.currentTitle){
    state.currentTitle=newTitle;
    if(!state.titles)state.titles=[];
    if(!state.titles.includes(newTitle))state.titles.push(newTitle);
    saveState();
    setTimeout(()=>showTitleOverlay(newTitle),1200);
  }
}
function closeLevelUp(){document.getElementById('levelup-overlay').classList.remove('active');}

function showTitleOverlay(titleName){
  closeLevelUp();
  const flash=document.createElement('div');flash.className='title-flash';
  document.body.appendChild(flash);setTimeout(()=>flash.remove(),900);
  document.getElementById('title-got-name').textContent=titleName;
  setTimeout(()=>document.getElementById('title-overlay').classList.add('active'),200);
}
function closeTitleOverlay(){document.getElementById('title-overlay').classList.remove('active');}

/* ===== „Åì„Å®„Å∞„Çπ„ÉÜ„ÉÉ„Éó ===== */
function renderVocab(c,stage){
  const mq=stage.mainQuestion;
  const words=mq.wordExplanations||[];
  revealPaused=false;
  const div=document.createElement('div');
  let html=`<div class="section-card">
    <span class="step-badge step-vocab">Step ${learnStep+1}</span>
    <div class="section-title" style="color:#ffd700;border-bottom-color:#5a4a00">„Åæ„Åö„ÄÅ„Åì„Å®„Å∞„ÇíÁü•„Çç„ÅÜ</div>

    <div class="reveal-block revealed">
      <div class="vocab-intro" data-tw="„Åì„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ„ÉÜ„Éº„Éû„ÅØ„Äå${stage.title}„Äç„Å†„Çà„ÄÇ\n${stage.subtitle}„ÄÇ\n\nÂïèÈ°å„ÇíËß£„ÅèÂâç„Å´„ÄÅÂá∫„Å¶„Åè„ÇãÂ§ß‰∫ã„Å™„Åì„Å®„Å∞„Çí1„Å§„Åö„Å§Ë¶ö„Åà„Çà„ÅÜÔºÅ"></div>
    </div>

    ${words.map(w=>`<div class="reveal-block">
      <div class="vocab-card">
        <div><span class="vocab-word">${w.word}</span>${w.reading&&w.reading!==w.word?`<span class="vocab-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
        <div class="vocab-meaning" data-tw="${w.explanation.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`).join('')}

    <div class="reveal-block">
      <div class="confirm-box">
        <div class="confirm-text">„Åì„Åì„Åæ„Åß„ÅÆ„Åì„Å®„Å∞„ÅØË¶ö„Åà„ÅüÔºü</div>
        <div class="confirm-subtext">${words.length}„Å§„ÅÆ„Åì„Å®„Å∞„ÇíÂ≠¶„Çì„Å†„Çà„ÄÇÂïèÈ°å„Å´Âá∫„Å¶„Åè„Çã„ÅÆ„ÅßË¶ö„Åà„Å¶„Åä„Åì„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">Ë¶ö„Åà„ÅüÔºÅÂïèÈ°å„Å´ÈÄ≤„ÇÄ</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== Áµ±ÂêàÂïèÈ°åÁîªÈù¢ ===== */
function renderIntegratedQuestion(c,mq){
  revealPaused=false;
  const div=document.createElement('div');

  const keys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  let choicesHtml='';
  keys.forEach(k=>{
    if(!mq.choices[k])return;
    const hintId='hint-main-'+k;
    const analysis=mq.choiceAnalysis.find(a=>a.choice===k);
    const hintText=analysis?analysis.explanation:'';
    choicesHtml+=`<div class="choice-item" id="ci-${k}">
      <div class="choice-main" onclick="selectMain('${k}','${mq.answer}')">
        <span class="choice-label">${k}.</span>
        <span class="choice-text">${mq.choices[k]}</span>
        <button class="choice-hint-btn" onclick="toggleHint(event,'${hintId}')">„Éí„É≥„Éà</button>
      </div>
      <div class="choice-hint" id="${hintId}" data-hint="${hintText.replace(/"/g,'&quot;')}"></div>
    </div>`;
  });

  let html=`<div class="section-card">
    <span class="step-badge step-question">Step ${learnStep+1}</span>
    <div class="section-title question-title">ÈÅéÂéªÂïè„Å´ÊåëÊà¶„Åó„Çà„ÅÜ</div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ1: ÂïèÈ°åÊñáÔºàËá™ÂãïË°®Á§∫„Éª„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÄÅ„É¢„Éê„Ç§„É´„Åß„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„ÉºÔºâ -->
    <div class="reveal-block revealed sticky-q">
      <div class="q-source">${mq.source}</div>
      <div class="q-text" data-tw="${mq.originalText.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ2: „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü -->
    <div class="reveal-block">
      <div class="question-guide">
        <div class="question-guide-title">„Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü</div>
        <div class="question-guide-text" data-tw="${mq.questionExplained.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ3: „Åì„Å®„Å∞Âæ©Áøí -->
    <div class="reveal-block">
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAcc(this)">
          <span class="acc-icon">‚ñ∂</span>
          <span class="acc-label">„Åì„Å®„Å∞„ÇíÂæ©Áøí„Åô„Çã</span>
          <span class="acc-tag words">Áî®Ë™û</span>
        </div>
        <div class="accordion-body">
          ${mq.wordExplanations.map(w=>`<div class="word-item">
            <div class="word-term">${w.word}${w.reading&&w.reading!==w.word?` <span class="word-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
            <div class="word-desc">${w.explanation}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ4: ÈÅ∏ÊäûËÇ¢ÔºàÂõûÁ≠î„ÇíÂæÖ„Å§Ôºâ -->
    <div class="reveal-block" data-wait="answer">
      <div style="margin-top:8px;margin-bottom:8px;font-size:.9rem;color:#ffd700;font-weight:bold">„Åï„ÅÇ„ÄÅÁ≠î„Åà„ÇíÈÅ∏„Åº„ÅÜÔºÅ</div>
      <div class="strategy-hint-wrap">
        <button class="strategy-hint-btn" onclick="toggleStrategyHint(this)">
          <span class="strategy-hint-icon">‚ñ∂</span> ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà
        </button>
        <div class="strategy-hint-body" id="strategy-hint-body">
          <ol class="strategy-steps" id="strategy-hint-steps"></ol>
        </div>
      </div>
      <div id="main-choices">${choicesHtml}</div>
      <div class="answer-confirm" id="answer-confirm">
        <div class="confirm-text">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
        <div id="answer-confirm-label" style="font-size:.85rem;color:#aaa;margin:8px 0"></div>
        <button class="confirm-btn confirm-yes" onclick="confirmAnswer()">„Åì„ÅÆÁ≠î„Åà„ÅßÊ±∫ÂÆöÔºÅ</button>
        <button class="confirm-btn confirm-retry" onclick="cancelAnswer()">ÈÅ∏„Å≥Áõ¥„Åô</button>
      </div>
    </div>

    <!-- === ÂõûÁ≠îÂæå„Å´È†ÜÊ¨°Ë°®Á§∫„Åï„Çå„Çã„Éñ„É≠„ÉÉ„ÇØ === -->

    <!-- „Éñ„É≠„ÉÉ„ÇØ5: Ê≠£Ëß£/‰∏çÊ≠£Ëß£„Éê„Éä„Éº + ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨ -->
    <div class="reveal-block" id="rb-analysis">
      <div id="result-banner"></div>
      <div style="margin-top:12px;font-size:.9rem;font-weight:bold;color:#fff;margin-bottom:8px">ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨</div>
      <div id="choice-analysis-content">
        ${mq.choiceAnalysis.map(a=>{
          const isC=a.verdict.includes('Ê≠£Ëß£');
          return`<div class="analysis-item ${isC?'is-correct':'is-wrong'}">
            <span class="analysis-verdict ${isC?'correct':'wrong'}">${a.choice}. ${a.verdict}</span>
            <div style="font-size:.85rem;color:#ccc;margin-top:4px">${a.explanation}</div>
          </div>`;
        }).join('')}
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ7: Ëß£„ÅçÊñπ„ÅÆÊåØ„ÇäËøî„ÇäÔºàÂÖ®„Çπ„ÉÜ„ÉÉ„ÉóÔºã„Å≤„Å£„Åã„ÅëÔºâ -->
    <div class="reveal-block" id="rb-strategy">
      <div style="font-size:.9rem;font-weight:bold;color:#ffb74d;margin-bottom:8px">Ëß£„ÅçÊñπ„ÅÆÊåØ„ÇäËøî„Çä</div>
      <div style="font-size:.82rem;color:#aaa;margin-bottom:8px">Á≠î„Åà„ÇíÂê´„ÇÅ„ÅüÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜ</div>
      <ol class="strategy-steps">${mq.solvingStrategy.steps.map(s=>`<li>${s}</li>`).join('')}</ol>
      <div class="trap-box"><div class="trap-label">„Å≤„Å£„Åã„Åë„Éù„Ç§„É≥„Éà</div><div>${mq.solvingStrategy.trap}</div></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ7: ÁêÜËß£Â∫¶Á¢∫Ë™ç -->
    <div class="reveal-block" id="rb-confirm">
      <div class="confirm-box">
        <div class="confirm-text">„Åì„ÅÆÂïèÈ°å„ÅÆËß£„ÅçÊñπ„ÅØÁêÜËß£„Åß„Åç„ÅüÔºü</div>
        <div class="confirm-subtext">ÈÅ∏ÊäûËÇ¢„Åî„Å®„ÅÆÊ≠£Ë™§„ÅÆÁêÜÁî±„Å®„ÄÅËß£„ÅçÊñπ„ÅÆ„Ç≥„ÉÑ„ÇíË¶ö„Åà„Çà„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">ÁêÜËß£„Åß„Åç„ÅüÔºÅÊ¨°„Å∏ÈÄ≤„ÇÄ</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;

  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  // ‰øùÁïô‰∏≠„ÅÆ„Çπ„Éà„É©„ÉÜ„Ç∏„Éº„Çπ„ÉÜ„ÉÉ„Éó„Çí‰øùÂ≠ò
  window._strategySteps=mq.solvingStrategy.steps.slice(0,-1);
  // ÊúÄÂàù„ÅÆ„Éñ„É≠„ÉÉ„ÇØÔºàÂïèÈ°åÊñáÔºâ„ÅÆ„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÇíËá™ÂãïÈñãÂßã
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà ÈñãÈñâ ===== */
function toggleStrategyHint(btn){
  const wasOpen=btn.classList.contains('open');
  btn.classList.toggle('open');
  const body=document.getElementById('strategy-hint-body');
  if(!body)return;
  if(!wasOpen){
    body.classList.add('open');
    // ÂàùÂõû„ÅÆ„ÅøÂ†±ÈÖ¨Ôºã„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßÈ†ÜÊ¨°Ë°®Á§∫
    if(!btn.dataset.rewarded){
      btn.dataset.rewarded='1';
      const r=btn.getBoundingClientRect();
      rollTapReward(r.left+r.width/2,r.top+r.height/2);
    }
    // „Çπ„ÉÜ„ÉÉ„Éó„Çí1„Å§„Åö„Å§„Çø„Ç§„Éó„É©„Ç§„Çø„Éº„ÅßË°®Á§∫
    const ol=document.getElementById('strategy-hint-steps');
    if(ol&&window._strategySteps&&!ol.dataset.filled){
      ol.dataset.filled='1';
      ol.innerHTML='';
      let idx=0;
      const steps=window._strategySteps;
      function showNextStep(){
        if(idx>=steps.length)return;
        const li=document.createElement('li');
        li.style.opacity='0';
        ol.appendChild(li);
        li.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
        typewriter(li,steps[idx],30,()=>{idx++;setTimeout(showNextStep,200);});
      }
      showNextStep();
    }
  }else{
    body.classList.remove('open');
  }
}

let pendingKey=null,pendingAnswer=null;

function selectMain(key,answer){
  if(document.querySelector('.choice-item.correct'))return;
  playSfx('select');
  // Êó¢„Å´ÈÅ∏Êäû‰∏≠„Å™„ÇâËß£Èô§
  document.querySelectorAll('.choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  // ÈÅ∏Êäû„Çí„Éè„Ç§„É©„Ç§„Éà
  pendingKey=key;pendingAnswer=answer;
  document.getElementById('ci-'+key).classList.add('selected');
  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
  const conf=document.getElementById('answer-confirm');
  const label=document.getElementById('answer-confirm-label');
  label.textContent='ÈÅ∏„Çì„Å†Á≠î„Åà: '+key;
  conf.style.display='block';
  setTimeout(()=>{conf.scrollIntoView({behavior:'smooth',block:'nearest'})},100);
}

function confirmAnswer(){
  if(!pendingKey)return;
  playSfx('confirm');
  const key=pendingKey,answer=pendingAnswer;
  const correct=key===answer;
  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈùûË°®Á§∫
  document.getElementById('answer-confirm').style.display='none';
  // Ê≠£Ëß£/‰∏çÊ≠£Ëß£„ÇíÂèçÊò†
  document.querySelectorAll('.choice-item').forEach(ci=>{
    ci.classList.remove('selected');
    ci.classList.add('answered');
    if(ci.id==='ci-'+answer)ci.classList.add('correct');
    else if(ci.id==='ci-'+key&&!correct)ci.classList.add('wrong');
  });
  document.querySelectorAll('.choice-hint').forEach(h=>h.classList.add('open'));
  const banner=document.getElementById('result-banner');
  banner.className='result-banner '+(correct?'correct':'wrong');
  if(correct){
    playSfx('correct');
    banner.textContent='Ê≠£Ëß£ÔºÅ';
    const ci=document.getElementById('ci-'+answer);
    const rect=ci?ci.getBoundingClientRect():{left:window.innerWidth/2,top:window.innerHeight/2,width:0,height:0};
    const bx=rect.left+rect.width/2,by=rect.top+rect.height/2;
    setTimeout(()=>gainTapExp(bx,by,20),200);
  }else{
    playSfx('wrong');
    const lost=Math.floor(state.gold/2);
    state.gold=state.gold-lost;
    saveState();
    banner.textContent='‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£Ëß£„ÅØ '+answer+(lost>0?' ÔºàGOLD -'+lost+'Ôºâ':'');
  }
  pendingKey=null;pendingAnswer=null;
  // ÂõûÁ≠îÂæå„ÅÆÈ†ÜÊ¨°Ë°®Á§∫„ÇíÂÜçÈñã
  resumeReveal();
  setTimeout(()=>{revealNext();},300);
}

function cancelAnswer(){
  if(!pendingKey)return;
  document.querySelectorAll('.choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  document.getElementById('answer-confirm').style.display='none';
  pendingKey=null;pendingAnswer=null;
}

/* ===== Èñ¢ÈÄ£Áü•Ë≠ò ===== */
function renderKnowledge(c,rk){
  revealPaused=false;
  const div=document.createElement('div');
  let html=`<div class="section-card">
    <span class="step-badge step-knowledge">Step ${learnStep+1}</span>
    <div class="section-title knowledge-title">${rk.title}</div>

    <div class="reveal-block revealed">
      <div class="vocab-intro" data-tw="ÂïèÈ°å„Å´Èñ¢ÈÄ£„Åô„ÇãÁü•Ë≠ò„Çí„ÇÇ„Å£„Å®Â≠¶„Åº„ÅÜÔºÅ\n1„Å§„Åö„Å§Á¢∫Ë™ç„Åó„Å¶„ÅÑ„Åì„ÅÜ„ÄÇ"></div>
    </div>

    ${rk.content.map(k=>`<div class="reveal-block">
      <div class="knowledge-item">
        <div class="knowledge-term">${k.term}</div>
        <div class="knowledge-desc" data-tw="${k.description.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`).join('')}

    <div class="reveal-block">
      <div class="confirm-box">
        <div class="confirm-text">Èñ¢ÈÄ£Áü•Ë≠ò„ÇíË¶ö„Åà„ÅüÔºü</div>
        <div class="confirm-subtext">${rk.content.length}„Å§„ÅÆÁü•Ë≠ò„ÇíÂ≠¶„Çì„Å†„Çà„ÄÇÁ∑¥ÁøíÂïèÈ°å„ÅßÁ¢∫Ë™ç„Åó„Çà„ÅÜÔºÅ</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">Ë¶ö„Åà„ÅüÔºÅÁ∑¥ÁøíÂïèÈ°å„Å∏</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  div.innerHTML=html;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

/* ===== Á∑¥ÁøíÂïèÈ°å ===== */
const _pqState={};
function renderPractice(c,pq,num){
  revealPaused=false;
  const uid='pq-'+num;
  const div=document.createElement('div');

  /* === ÈÅ∏ÊäûËÇ¢„Ç∑„É£„ÉÉ„Éï„É´Ôºà„É©„Éô„É´„ÅØ„Ç¢„Äú„Ç®Âõ∫ÂÆö„ÄÅ‰∏≠Ë∫´„ÇíÂÖ•„ÇåÊõø„ÅàÔºâ === */
  const origKeys=['„Ç¢','„Ç§','„Ç¶','„Ç®'];
  const vals=origKeys.filter(k=>pq.choices[k]).map(k=>({origKey:k,text:pq.choices[k]}));
  for(let i=vals.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[vals[i],vals[j]]=[vals[j],vals[i]];}
  const shuffled={};let newAnswer=pq.answer;
  const ansText=pq.choices[pq.answer];
  origKeys.forEach((k,i)=>{if(i<vals.length){shuffled[k]=vals[i];if(vals[i].text===ansText)newAnswer=k;}});
  _pqState[uid]={answer:newAnswer,pendingKey:null};

  /* === choiceAnalysis „Çí„Ç∑„É£„ÉÉ„Éï„É´Âæå„ÅÆ„É©„Éô„É´„Å´„Éû„ÉÉ„Éî„É≥„Ç∞ === */
  const analysisMap={};
  if(pq.choiceAnalysis)pq.choiceAnalysis.forEach(a=>{analysisMap[pq.choices[a.choice]]=a;});

  /* === ÈÅ∏ÊäûËÇ¢HTML === */
  let choicesHtml='';
  origKeys.forEach(k=>{
    if(!shuffled[k])return;
    const a=analysisMap[shuffled[k].text];
    const hintId=uid+'-hint-'+k;
    const hintText=a?a.explanation:'';
    choicesHtml+=`<div class="choice-item" id="${uid}-ci-${k}" data-key="${k}">
      <div class="choice-main" onclick="selectPractice('${uid}','${k}')">
        <span class="choice-label">${k}.</span>
        <span class="choice-text">${shuffled[k].text}</span>
        ${hintText?`<button class="choice-hint-btn" onclick="event.stopPropagation();toggleHint(event,'${hintId}')">„Éí„É≥„Éà</button>`:''}
      </div>
      ${hintText?`<div class="choice-hint" id="${hintId}" data-hint="${hintText.replace(/"/g,'&quot;')}"></div>`:''}
    </div>`;
  });

  /* === „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü === */
  const qExpHtml=pq.questionExplained?`
    <div class="reveal-block">
      <div class="question-guide">
        <div class="question-guide-title">„Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü</div>
        <div class="question-guide-text" data-tw="${pq.questionExplained.replace(/"/g,'&quot;')}"></div>
      </div>
    </div>`:'';

  /* === ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà === */
  const stratHtml=pq.solvingStrategy?`
      <div class="strategy-hint-wrap">
        <button class="strategy-hint-btn" onclick="togglePqStrategy(this,'${uid}')">
          <span class="strategy-hint-icon">‚ñ∂</span> ËÄÉ„ÅàÊñπ„ÅÆ„Éí„É≥„Éà
        </button>
        <div class="strategy-hint-body" id="${uid}-strat-body">
          <ol class="strategy-steps" id="${uid}-strat-steps"></ol>
        </div>
      </div>`:'';

  div.innerHTML=`<div class="section-card">
    <span class="step-badge step-practice">Step ${learnStep+1}</span>
    <div class="section-title practice-title">Á∑¥ÁøíÂïèÈ°å ${num}</div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ1: ÂïèÈ°åÊñáÔºà„É¢„Éê„Ç§„É´„Åß„Çπ„ÉÜ„Ç£„ÉÉ„Ç≠„ÉºÔºâ -->
    <div class="reveal-block revealed sticky-q">
      <div class="q-source">${pq.source}</div>
      <div class="q-text" data-tw="${pq.questionText.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ2: „Åì„ÅÆÂïèÈ°å„ÅØ‰Ωï„ÇíËÅû„ÅÑ„Å¶„ÅÑ„ÇãÔºü -->
    ${qExpHtml}

    <!-- „Éñ„É≠„ÉÉ„ÇØ3: „Åì„Å®„Å∞Âæ©Áøí -->
    <div class="reveal-block">
      <div class="accordion">
        <div class="accordion-header" onclick="toggleAcc(this)">
          <span class="acc-icon">‚ñ∂</span>
          <span class="acc-label">„Åì„Å®„Å∞„ÇíÂæ©Áøí„Åô„Çã</span>
          <span class="acc-tag words">Áî®Ë™û</span>
        </div>
        <div class="accordion-body">
          ${(currentStage.mainQuestion.wordExplanations||[]).map(w=>`<div class="word-item">
            <div class="word-term">${w.word}${w.reading&&w.reading!==w.word?` <span class="word-reading">Ôºà${w.reading}Ôºâ</span>`:''}</div>
            <div class="word-desc">${w.explanation}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ4: ÈÅ∏ÊäûËÇ¢ÔºàÂõûÁ≠î„ÇíÂæÖ„Å§Ôºâ -->
    <div class="reveal-block" data-wait="answer">
      <div style="margin-top:8px;margin-bottom:8px;font-size:.9rem;color:#ffd700;font-weight:bold">„Åï„ÅÇ„ÄÅÁ≠î„Åà„ÇíÈÅ∏„Åº„ÅÜÔºÅ</div>
      ${stratHtml}
      <div id="${uid}-choices">${choicesHtml}</div>
      <div class="answer-confirm" id="${uid}-confirm">
        <div class="confirm-text">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
        <div id="${uid}-confirm-label" style="font-size:.85rem;color:#aaa;margin:8px 0"></div>
        <button class="confirm-btn confirm-yes" onclick="confirmPractice('${uid}')">„Åì„ÅÆÁ≠î„Åà„ÅßÊ±∫ÂÆöÔºÅ</button>
        <button class="confirm-btn confirm-retry" onclick="cancelPractice('${uid}')">ÈÅ∏„Å≥Áõ¥„Åô</button>
      </div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ5: Ê≠£Ëß£/‰∏çÊ≠£Ëß£„Éê„Éä„Éº + ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆËß£Ë™¨ -->
    <div class="reveal-block" id="${uid}-result">
      <div id="${uid}-banner"></div>
      <div style="margin-top:12px;font-size:.9rem;font-weight:bold;color:#ffb74d;margin-bottom:8px">Ëß£Ë™¨</div>
      <div class="practice-explanation" id="${uid}-exp" data-tw="${pq.shortExplanation.replace(/"/g,'&quot;')}"></div>
    </div>

    <!-- „Éñ„É≠„ÉÉ„ÇØ6: ÁêÜËß£Â∫¶Á¢∫Ë™ç -->
    <div class="reveal-block" id="${uid}-done-block">
      <div class="confirm-box">
        <div class="confirm-text">${num<2?'ÁêÜËß£„Åß„Åç„ÅüÔºü„ÇÇ„ÅÜ1Âïè„ÇÑ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ':'ÁêÜËß£„Åß„Åç„ÅüÔºü„Ç´„Éº„Éâ„ÇíÁç≤Âæó„Åó„Çà„ÅÜÔºÅ'}</div>
        <button class="confirm-btn confirm-yes" onclick="nextStep()">${num<2?'Ê¨°„ÅÆÁ∑¥ÁøíÂïèÈ°å„Å∏ ‚Üí':'„Ç´„Éº„ÉâÁç≤Âæó„Å∏ ‚Üí'}</button>
        <button class="confirm-btn confirm-retry" onclick="retryStep()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë™≠„ÇÄ</button>
      </div>
    </div>
  </div>`;
  if(pq.solvingStrategy)window['_pqStrat_'+uid]=pq.solvingStrategy.steps;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
}

function togglePqStrategy(btn,uid){
  const wasOpen=btn.classList.contains('open');
  btn.classList.toggle('open');
  const body=document.getElementById(uid+'-strat-body');
  if(!body)return;
  if(!wasOpen){
    body.classList.add('open');
    if(!btn.dataset.rewarded){btn.dataset.rewarded='1';const r=btn.getBoundingClientRect();rollTapReward(r.left+r.width/2,r.top+r.height/2);}
    const ol=document.getElementById(uid+'-strat-steps');
    const steps=window['_pqStrat_'+uid];
    if(ol&&steps&&!ol.dataset.filled){
      ol.dataset.filled='1';ol.innerHTML='';let idx=0;
      function showNext(){if(idx>=steps.length)return;const li=document.createElement('li');li.style.opacity='0';ol.appendChild(li);
        li.animate([{opacity:0,transform:'translateY(8px)'},{opacity:1,transform:'translateY(0)'}],{duration:300,fill:'forwards'});
        typewriter(li,steps[idx],30,()=>{idx++;setTimeout(showNext,200);});}
      showNext();
    }
  }else{body.classList.remove('open');}
}

function selectPractice(uid,key){
  if(document.querySelector('#'+uid+'-choices .choice-item.correct'))return;
  playSfx('select');
  document.querySelectorAll('#'+uid+'-choices .choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  _pqState[uid].pendingKey=key;
  document.getElementById(uid+'-ci-'+key).classList.add('selected');
  const conf=document.getElementById(uid+'-confirm');
  document.getElementById(uid+'-confirm-label').textContent='ÈÅ∏„Çì„Å†Á≠î„Åà: '+key;
  conf.style.display='block';
  setTimeout(()=>conf.scrollIntoView({behavior:'smooth',block:'nearest'}),100);
}

function confirmPractice(uid){
  const ps=_pqState[uid];
  if(!ps||!ps.pendingKey)return;
  playSfx('confirm');
  const key=ps.pendingKey,ans=ps.answer;
  const correct=key===ans;
  document.getElementById(uid+'-confirm').style.display='none';
  document.querySelectorAll('#'+uid+'-choices .choice-item').forEach(ci=>{
    ci.classList.remove('selected');
    ci.classList.add('answered');
    const k=ci.dataset.key;
    if(k===ans)ci.classList.add('correct');
    else if(k===key&&!correct)ci.classList.add('wrong');
  });
  const banner=document.getElementById(uid+'-banner');
  banner.className='result-banner '+(correct?'correct':'wrong');
  if(correct){
    playSfx('correct');
    banner.textContent='Ê≠£Ëß£ÔºÅ';
    const ci=document.getElementById(uid+'-ci-'+ans);
    if(ci){const r=ci.getBoundingClientRect();gainTapExp(r.left+r.width/2,r.top+r.height/2,15);}
  }else{
    playSfx('wrong');
    const lost=Math.floor(state.gold*0.3);
    if(lost>0){state.gold-=lost;saveState();}
    banner.textContent='‰∏çÊ≠£Ëß£‚Ä¶ Ê≠£Ëß£„ÅØ '+ans+(lost>0?' ÔºàGOLD -'+lost+'Ôºâ':'');
  }
  /* ÂÖ®ÈÅ∏ÊäûËÇ¢„ÅÆ„Éí„É≥„Éà„ÇíÈñã„Åè */
  document.querySelectorAll('#'+uid+'-choices .choice-hint').forEach(h=>h.classList.add('open'));
  const expEl=document.getElementById(uid+'-exp');
  expEl.style.display='block';expEl.classList.add('visible');
  typewriter(expEl,expEl.dataset.tw,30);
  ps.pendingKey=null;
  resumeReveal();
  setTimeout(()=>revealNext(),300);
}

function cancelPractice(uid){
  const ps=_pqState[uid];
  if(!ps)return;
  document.querySelectorAll('#'+uid+'-choices .choice-item.selected').forEach(ci=>ci.classList.remove('selected'));
  document.getElementById(uid+'-confirm').style.display='none';
  ps.pendingKey=null;
}

/* ===== „Ç´„Éº„ÉâÁç≤Âæó ===== */
function renderReward(c,stage){
  const cr=stage.cardReward;
  const isNew=!state.clearedStages.includes(stage.stageId);
  if(isNew){
    state.clearedStages.push(stage.stageId);state.exp+=cr.exp;state.gold+=cr.gold;
    if(!state.ownedCards.includes(cr.cardName))state.ownedCards.push(cr.cardName);
    saveState();
  }
  playSfx('victory');
  const stars='‚òÖ'.repeat(cr.rarity)+'‚òÜ'.repeat(5-cr.rarity);
  const div=document.createElement('div');
  revealPaused=false;
  const tipHtml=!state.bossCleared?`<div style="background:rgba(255,215,0,.1);border:1px solid #5a4a00;border-radius:8px;padding:10px;margin-top:12px;font-size:.8rem;color:#ffd700;text-align:center">„Éú„ÇπÊà¶„Å´ÂÇô„Åà„Å¶„Ç¢„Ç§„ÉÜ„É†„ÇíË≤∑„Å£„Å¶„Åä„Åì„ÅÜÔºÅ<br><span style="color:#aaa">„Éú„ÇπÊà¶Ê∫ñÂÇôÁîªÈù¢„Åß„Ç∑„Éß„ÉÉ„Éó„ÅåÈñã„Åë„Çã„Çà</span></div>`:'';
  div.innerHTML=`<div class="section-card">
    <span class="step-badge step-reward">Step ${learnStep+1}</span>

    <div class="reveal-block revealed">
      <div class="section-title reward-title" data-tw="„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ„Ç´„Éº„ÉâÁç≤ÂæóÔºÅ"></div>
    </div>

    <div class="reveal-block">
      <div class="reward-card">
        <div class="reward-rarity">${stars}</div>
        <div class="reward-card-name">${cr.cardName}</div>
        <div class="reward-summary" data-tw="${cr.summary.replace(/"/g,'&quot;')}"></div>
        <div class="reward-stats">
          <div class="reward-stat"><div class="reward-stat-value exp">+${cr.exp}</div><div class="reward-stat-label">EXP</div></div>
          <div class="reward-stat"><div class="reward-stat-value gold">+${cr.gold}</div><div class="reward-stat-label">GOLD</div></div>
        </div>
      </div>
    </div>

    <div class="reveal-block">
      ${tipHtml}
      <button class="next-btn" onclick="showScreen('screen-map')">„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã</button>
    </div>
  </div>`;
  c.appendChild(div);
  updateTapIndicator();
  const firstTw=div.querySelector('.reveal-block.revealed [data-tw]');
  if(firstTw){typewriter(firstTw,firstTw.dataset.tw,35);}
  // „Ç´„Éº„ÉâÁç≤ÂæóÊôÇ„ÅÆEXP„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊºîÂá∫
  if(isNew){
    setTimeout(()=>{
      const card=div.querySelector('.reward-card');
      if(card){const r=card.getBoundingClientRect();gainTapExp(r.left+r.width/2,r.top+r.height/2,cr.exp);}
    },800);
  }
}

/* ===== „Ç∑„Éß„ÉÉ„Éó & „Ç¢„Ç§„ÉÜ„É† ===== */
function buyItem(itemId){
  const item=SHOP_ITEMS.find(i=>i.id===itemId);
  if(!item||state.gold<item.price)return;
  if(state.inventory.length>=2){alert('ÊåÅ„Å°Áâ©„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„ÅôÔºàÊúÄÂ§ß2ÂÄãÔºâ');return}
  playSfx('buy');
  state.gold-=item.price;state.inventory.push(itemId);saveState();updateHeader();
  renderBossPrep();
}
function removeItem(index){
  const item=SHOP_ITEMS.find(i=>i.id===state.inventory[index]);
  if(item){playSfx('gold');state.gold+=item.price;state.inventory.splice(index,1);saveState();updateHeader();renderBossPrep();}
}

/* ===== „Éú„ÇπÊà¶Ê∫ñÂÇôÁîªÈù¢ ===== */
function showBossPrep(){
  document.getElementById('boss-prep-title').textContent=BOSS_DATA.bossName+' Êà¶Ê∫ñÂÇô';
  showScreen('screen-boss-prep');renderBossPrep();
}
function renderBossPrep(){
  const c=document.getElementById('boss-prep-content');
  const bagHtml=state.inventory.length>0
    ?state.inventory.map((id,i)=>{const it=SHOP_ITEMS.find(s=>s.id===id);return`<div class="boss-bag-item"><img src="${it.icon}" class="boss-bag-item-icon"> ${it.name} <span style="color:#888;font-size:.7rem;cursor:pointer" onclick="removeItem(${i})">[Â£≤Âç¥+${it.price}G]</span></div>`}).join('')
    :'<div class="boss-bag-empty">„Ç¢„Ç§„ÉÜ„É†„Å™„Åó</div>';
  const spriteHtml=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite boss-sprite-anim">`:'';
  c.innerHTML=`
    ${spriteHtml}
    <div style="text-align:center;font-size:1.2rem;font-weight:bold;color:#ff5252;margin-bottom:8px">${BOSS_DATA.bossName}</div>
    <div class="shop-warning">„Éú„ÇπÊà¶„Åß„ÅØ„Éü„Çπ„ÅØË®±„Åï„Çå„Å™„ÅÑÔºÅ<br>„Ç¢„Ç§„ÉÜ„É†„ÇíË≤∑„Å£„Å¶‰∏áÂÖ®„ÅÆÊ∫ñÂÇô„Çí„Åó„Çà„ÅÜÔºÅ</div>
    <div class="shop-gold">ÊâÄÊåÅ„Ç¥„Éº„É´„Éâ: ${state.gold} G</div>
    <div class="boss-bag"><div class="boss-bag-title">ÊåÅ„Å°Áâ©Ôºà${state.inventory.length}/2Ôºâ</div>${bagHtml}</div>
    ${SHOP_ITEMS.map(it=>{
      const canBuy=state.gold>=it.price&&state.inventory.length<2;
      return`<div class="shop-item"><div class="shop-item-icon"><img src="${it.icon}" alt="${it.name}"></div><div class="shop-item-info"><div class="shop-item-name">${it.name}</div><div class="shop-item-desc">${it.desc}</div><div class="shop-item-price">${it.price} G</div></div><button class="shop-buy-btn" ${canBuy?'':'disabled'} onclick="buyItem('${it.id}')">Ë≥ºÂÖ•</button></div>`;
    }).join('')}
    <button class="next-btn" style="margin-top:16px" onclick="confirmBossStart()">„Éê„Éà„É´ÈñãÂßãÔºÅ</button>
    <button class="next-btn secondary" style="margin-top:8px" onclick="showScreen('screen-map')">„ÇÑ„ÇÅ„Çã</button>`;
}

/* ===== „Éú„Çπ„Éê„Éà„É´ ===== */
let bossQIndex=0,bossCorrect=0,bossActiveQs=[],bossBag=[];
function confirmBossStart(){
  const bagHtml=state.inventory.length>0
    ?state.inventory.map(id=>{const it=SHOP_ITEMS.find(s=>s.id===id);return it?`<img src="${it.icon}" class="modal-bag-item-icon">${it.name}`:''}).join('<br>')
    :'„Å™„Åó';
  const spriteHtml=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" style="width:80px;image-rendering:pixelated;margin-bottom:8px">`:'';
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.innerHTML=`<div class="modal-box">
    ${spriteHtml}
    <h3>${BOSS_DATA.bossName}„Å´Êåë„ÇÄÔºÅ</h3>
    <div class="modal-bag">ÊåÅ„Å°Áâ©<br>${bagHtml}</div>
    <div class="modal-note">ÂÖ®ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊíÉÁ†¥ÔºÅ</div>
    <div class="modal-btns">
      <button class="modal-btn-back" id="modal-cancel">„ÇÑ„ÇÅ„Çã</button>
      <button class="modal-btn-go" id="modal-go">„Éê„Éà„É´ÈñãÂßã</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  document.getElementById('modal-cancel').onclick=()=>{playSfx('select');overlay.remove()};
  document.getElementById('modal-go').onclick=()=>{playSfx('confirm');overlay.remove();startBoss()};
}
function startBoss(){
  bossQIndex=0;bossCorrect=0;
  bossBag=state.inventory.slice();
  /* Á´†ÂÜÖ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ practiceQuestions „ÇíÂèéÈõÜ */
  const pool=[];
  COURSE_DATA.forEach(st=>{
    if(st.practiceQuestions){
      st.practiceQuestions.forEach(pq=>{
        pool.push({questionText:pq.questionText,choices:pq.choices,answer:pq.answer,shortExplanation:pq.shortExplanation});
      });
    }
  });
  if(pool.length===0&&BOSS_DATA.questions)BOSS_DATA.questions.forEach(q=>pool.push(q));
  for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
  const cnt=Math.min(Math.floor(Math.random()*4)+3,pool.length);
  bossActiveQs=pool.slice(0,cnt);
  document.getElementById('boss-title').textContent=BOSS_DATA.bossName;showScreen('screen-boss');renderBossQ();
}
let bossSelectedEl=null,bossSelectedKey=null,bossSelectedAns=null;
function renderSidebarItems(){
  /* „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Éû„Ç§„ÇØ„É©È¢®2„Çπ„É≠„ÉÉ„Éà„Ç¢„Ç§„ÉÜ„É†„Éê„Éº */
  const bar=document.getElementById('sp-item-bar');
  if(!bar)return;
  let slots='';
  for(let i=0;i<2;i++){
    const id=state.inventory[i];
    if(id){const it=SHOP_ITEMS.find(s=>s.id===id);slots+=`<div class="mc-slot"><img src="${it.icon}" alt="${it.name}"></div>`;}
    else{slots+=`<div class="mc-slot empty"></div>`;}
  }
  bar.innerHTML=slots;
}
function updateItemBar(){
  renderSidebarItems();
}
function renderBossQ(){
  const c=document.getElementById('boss-content'),total=bossActiveQs.length;
  if(bossQIndex>=total){renderBossResult(c);return}
  const q=bossActiveQs[bossQIndex];
  const hp=((total-bossCorrect)/total*100).toFixed(0);
  const hasGlasses=bossBag.includes('sage_glasses');
  const spriteHtml=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite-sm boss-sprite-anim" id="boss-battle-sprite">`:'';
  bossSelectedEl=null;bossSelectedKey=null;bossSelectedAns=null;
  c.innerHTML=`<div class="boss-header-row fade-in" id="boss-header-row">
    <div class="boss-info-col">
      <div class="boss-name" style="margin-bottom:4px">${BOSS_DATA.bossName}</div>
      <div class="boss-desc" style="font-size:.75rem;color:#aaa;margin-bottom:2px">HP</div>
      <div class="boss-hp-container"><div class="boss-hp-bar"><div class="boss-hp-fill" style="width:${hp}%"></div></div><div class="boss-hp-text">${total-bossCorrect}/${total}</div></div>
      ${bossQIndex===0?`<div style="color:#ff5252;font-weight:bold;font-size:.8rem;margin-top:6px">${total}ÂïèÈÄ£Á∂öÊ≠£Ëß£„ÅßÊíÉÁ†¥ÔºÅ</div>`:''}
    </div>
    <div class="boss-sprite-col">
      ${spriteHtml}
    </div>
  </div>
    <div class="boss-q-counter">Á¨¨${bossQIndex+1}Âïè / ${total}</div>
    <div class="section-card fade-in"><div class="q-text" id="boss-q-text"></div>
    <ul class="q-choices" id="boss-ch" style="display:none">${Object.entries(q.choices).map(([k,v])=>`<li class="choice-item" data-key="${k}" onclick="pickBoss(this,'${k}','${q.answer}')"><div class="choice-main"><span class="choice-label">${k}.</span><span class="choice-text">${v}</span></div></li>`).join('')}</ul>
    ${hasGlasses?`<button class="boss-use-glasses" style="display:none" onclick="useGlasses()">Ë≥¢ËÄÖ„ÅÆ„É°„Ç¨„Éç„Çí‰Ωø„ÅÜ</button>`:''}
    <div id="boss-confirm" style="display:none;margin-top:12px;text-align:center">
      <div style="color:#ffd700;font-weight:bold;margin-bottom:8px">„Åì„ÅÆÁ≠î„Åà„Åß„ÅÑ„ÅÑÔºü</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="next-btn secondary" style="flex:1;max-width:120px" onclick="cancelBossPick()">ÈÅ∏„Å≥Áõ¥„Åô</button>
        <button class="next-btn" style="flex:1;max-width:120px;background:#ff5252" onclick="confirmBossPick()">Ê±∫ÂÆöÔºÅ</button>
      </div>
    </div>
    <div id="boss-fb" style="display:none;margin-top:12px"></div>
    <button class="next-btn" id="boss-next" style="display:none" onclick="nextBossQ()">Ê¨°„ÅÆÂïèÈ°å ‚Üí</button></div>`;
  /* „Çø„Ç§„Éó„É©„Ç§„Çø„ÉºÊºîÂá∫ ‚Üí ÂÆå‰∫ÜÂæå„Å´ÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫ */
  const twEl=document.getElementById('boss-q-text');
  typewriter(twEl,q.questionText,30,()=>{
    const ch=document.getElementById('boss-ch');if(ch)ch.style.display='';
    const gb=document.querySelector('.boss-use-glasses');if(gb)gb.classList.add('visible');
  });
}
function triggerScreenShake(){
  const el=document.getElementById('boss-content');
  if(!el)return;
  el.classList.remove('screen-shake');
  void el.offsetWidth;/* reflow */
  el.classList.add('screen-shake');
  el.addEventListener('animationend',()=>el.classList.remove('screen-shake'),{once:true});
}
function pickBoss(el,key,ans){
  if(document.querySelector('#boss-ch .choice-item.correct'))return;
  if(el.classList.contains('choice-hidden'))return;
  playSfx('select');
  /* ÂâçÂõû„ÅÆ„Éè„Ç§„É©„Ç§„Éà„ÇíËß£Èô§ */
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>li.classList.remove('selected'));
  el.classList.add('selected');
  bossSelectedEl=el;bossSelectedKey=key;bossSelectedAns=ans;
  document.getElementById('boss-confirm').style.display='block';
}
function cancelBossPick(){
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>li.classList.remove('selected'));
  bossSelectedEl=null;bossSelectedKey=null;bossSelectedAns=null;
  document.getElementById('boss-confirm').style.display='none';
}
function confirmBossPick(){
  if(!bossSelectedEl)return;
  playSfx('confirm');
  document.getElementById('boss-confirm').style.display='none';
  selBoss(bossSelectedEl,bossSelectedKey,bossSelectedAns);
}
function useGlasses(){
  const idx=bossBag.indexOf('sage_glasses');if(idx===-1)return;
  playSfx('magic');
  bossBag.splice(idx,1);
  /* inventory„Åã„Çâ„ÇÇÊ∂à„Åô */
  const si=state.inventory.indexOf('sage_glasses');if(si!==-1){state.inventory.splice(si,1);saveState();}
  const q=bossActiveQs[bossQIndex],ans=q.answer;
  const wrongKeys=Object.keys(q.choices).filter(k=>k!==ans);
  /* „É©„É≥„ÉÄ„É†„Å´‰∏çÊ≠£Ëß£2„Å§„ÇíÊ∂à„Åô */
  for(let i=wrongKeys.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[wrongKeys[i],wrongKeys[j]]=[wrongKeys[j],wrongKeys[i]];}
  const hideKeys=wrongKeys.slice(0,2);
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{if(hideKeys.includes(li.dataset.key))li.classList.add('choice-hidden')});
  const btn=document.querySelector('.boss-use-glasses');if(btn)btn.remove();
  updateItemBar();
}
function selBoss(el,key,ans){
  if(document.querySelector('#boss-ch .choice-item.correct'))return;
  if(el.classList.contains('choice-hidden'))return;
  const ok=key===ans;if(ok)bossCorrect++;
  const total=bossActiveQs.length;
  document.querySelectorAll('#boss-ch .choice-item').forEach(li=>{
    if(li.dataset.key===ans)li.classList.add('correct');
    else if(li.dataset.key===key&&!ok)li.classList.add('wrong');
    li.style.pointerEvents='none';
  });
  const q=bossActiveQs[bossQIndex],fb=document.getElementById('boss-fb');fb.style.display='block';
  const glassesBtn=document.querySelector('.boss-use-glasses');if(glassesBtn)glassesBtn.remove();
  if(ok){
    playSfx('correct');playSfx('hit');
    /* Ê≠£Ëß£Â†±ÈÖ¨: EXP + „Ç¥„Éº„É´„Éâ */
    const bossExp=15,bossGold=30+Math.floor(Math.random()*20);
    const oldLv=calcLevel(state.exp).level;
    state.exp+=bossExp;state.gold+=bossGold;saveState();
    const newLv=calcLevel(state.exp).level;
    if(newLv>oldLv)showLevelUp(newLv);
    fb.innerHTML=`<div class="result-banner correct" style="font-size:1.1rem">Ê≠£Ëß£ÔºÅ„Éú„Çπ„Å´„ÉÄ„É°„Éº„Ç∏ÔºÅ</div><div style="color:#7ecfff;font-size:.8rem;margin-top:4px">+${bossExp} EXP / +${bossGold} G</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div>`;
    document.getElementById('boss-next').style.display='block';
    const hpP=((total-bossCorrect)/total*100).toFixed(0);
    const hf=document.querySelector('.boss-hp-fill');if(hf){hf.style.width=hpP+'%';hf.style.transition='width .5s ease'}
    const ht=document.querySelector('.boss-hp-text');if(ht)ht.textContent=`${total-bossCorrect}/${total}`;
    /* „Éí„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ + ÁîªÈù¢Êè∫„Çå */
    const sp=document.getElementById('boss-battle-sprite');
    if(sp){sp.classList.remove('boss-sprite-anim');sp.classList.add('boss-sprite-hit');sp.addEventListener('animationend',()=>{sp.classList.remove('boss-sprite-hit');sp.classList.add('boss-sprite-anim')},{once:true});}
    triggerScreenShake();
  }else{
    playSfx('wrong');
    /* „ÅÑ„ÅÆ„Å°„ÅÆ„ÅÑ„Åó„ÉÅ„Çß„ÉÉ„ÇØ */
    const stoneIdx=bossBag.indexOf('life_stone');
    if(stoneIdx!==-1){
      playSfx('buff');
      bossBag.splice(stoneIdx,1);
      const si=state.inventory.indexOf('life_stone');if(si!==-1){state.inventory.splice(si,1);saveState();}
      updateItemBar();
      fb.innerHTML=`<div class="result-banner" style="background:#1a1a00;border:2px solid #ffd700;color:#ffd700;font-size:1.1rem;box-shadow:0 0 16px rgba(255,215,0,.4)">ÂëΩ„ÅÆ„Åü„Åæ„ÅåÁ†ï„Åë„ÅüÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div><div style="color:#ffd700;margin-top:8px;font-weight:bold">‰∏çÊ≠£Ëß£„Å†„Åå„ÄÅÂëΩ„ÅÆ„Åü„Åæ„ÅÆÂäõ„ÅßËÄê„Åà„ÅüÔºÅ</div>`;
      document.getElementById('boss-next').style.display='block';
    }else{
      fb.innerHTML=`<div class="result-banner wrong" style="font-size:1.1rem">‰∏çÊ≠£Ëß£‚Ä¶ ${BOSS_DATA.bossName}„ÅÆÂèçÊíÉÔºÅ</div><div style="color:#aaa;margin-top:8px;font-size:.85rem">${q.shortExplanation}</div><div style="color:#ff5252;margin-top:10px;font-weight:bold;font-size:1rem">ÂÖ®ÂïèÊ≠£Ëß£„Åó„Å™„ÅÑ„Å®ÊíÉÁ†¥„Åß„Åç„Å™„ÅÑÔºÅ</div>`;
      document.getElementById('boss-next').style.display='none';
      const btns=document.createElement('div');btns.style.cssText='margin-top:12px;display:flex;flex-direction:column;gap:8px';
      const rb=document.createElement('button');rb.className='next-btn secondary';rb.textContent='Ê∫ñÂÇôÁîªÈù¢„Å´Êàª„Çã';rb.onclick=function(){showBossPrep()};
      const bb=document.createElement('button');bb.className='next-btn secondary';bb.style.opacity='.7';bb.textContent='„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã';bb.onclick=function(){showScreen('screen-map')};
      btns.appendChild(rb);btns.appendChild(bb);fb.parentNode.appendChild(btns);
    }
  }
}
function nextBossQ(){playSfx('confirm');bossQIndex++;renderBossQ();window.scrollTo({top:0,behavior:'smooth'})}
function renderBossResult(c){
  playSfx('victory');
  const rw=BOSS_DATA.rewards,total=bossActiveQs.length;
  if(!state.bossCleared){state.bossCleared=true;state.exp+=rw.exp;state.gold+=rw.gold;if(!state.ownedCards.includes(rw.bonusCard.cardName))state.ownedCards.push(rw.bonusCard.cardName);saveState()}
  const spriteWin=BOSS_DATA.bossSprite?`<img src="${BOSS_DATA.bossSprite}" alt="${BOSS_DATA.bossName}" class="boss-sprite" style="opacity:.4;filter:grayscale(1)">`:'';
  c.innerHTML=`<div class="boss-result win fade-in">
    ${spriteWin}
    <h2>ÊíÉÁ†¥ÔºÅ ${BOSS_DATA.bossName}„ÇíÂÄí„Åó„ÅüÔºÅ</h2>
    <div class="boss-score">${bossCorrect}/${total}ÂïèÊ≠£Ëß£ - PERFECT!</div>
    <p>„Äå${rw.clearTitle}„Äç„ÅÆÁß∞Âè∑„ÇíÁç≤ÂæóÔºÅ</p>
    <div class="reward-card" style="margin:16px auto;max-width:300px"><div class="reward-rarity">${'‚òÖ'.repeat(rw.bonusCard.rarity)+'‚òÜ'.repeat(5-rw.bonusCard.rarity)}</div><div class="reward-card-name">${rw.bonusCard.cardName}</div><div class="reward-summary">${rw.bonusCard.summary}</div><div class="reward-stats"><div class="reward-stat"><div class="reward-stat-value exp">+${rw.exp}</div><div class="reward-stat-label">EXP</div></div><div class="reward-stat"><div class="reward-stat-value gold">+${rw.gold}</div><div class="reward-stat-label">GOLD</div></div></div></div>
    <button class="next-btn" onclick="showScreen('screen-map')">„Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Å´Êàª„Çã</button></div>`;
}

/* ===== „Ç´„Éº„ÉâÂõ≥Èëë ===== */
function renderCollection(){
  const g=document.getElementById('collection-grid');g.innerHTML='';
  [...COURSE_DATA.map(s=>s.cardReward),BOSS_DATA.rewards.bonusCard].forEach(cr=>{
    const o=state.ownedCards.includes(cr.cardName);
    const d=document.createElement('div');d.className='coll-card '+(o?'owned':'not-owned');
    d.innerHTML=`<div class="coll-card-rarity">${'‚òÖ'.repeat(cr.rarity)+'‚òÜ'.repeat(5-cr.rarity)}</div><div class="coll-card-name">${o?cr.cardName:'ÔºüÔºüÔºü'}</div><div style="font-size:.7rem;color:#888;margin-top:4px">${o?cr.summary:''}</div>`;
    g.appendChild(d);
  });
}

/* ===== JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„É™„ÉÉ„ÉÅ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ===== */
async function loadCourseDataFromJSON(){
  console.log('JSON„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÈñãÂßã...');
  try{
    const files=[
      'course/chapter1_stages1-4.json',
      'course/chapter1_stages5-8.json',
      'course/chapter1_stages9-11.json'
    ];
    console.log('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø‰∏≠:', files);

    const responses = await Promise.all(files.map(f=>fetch(f)));
    console.log('fetchÂÆå‰∫Ü, „Çπ„ÉÜ„Éº„Çø„Çπ:', responses.map(r => r.status));

    if(!responses[0].ok||!responses[1].ok||!responses[2].ok) {
      throw new Error(`Fetch failed: ${responses.map(r => r.status).join(', ')}`);
    }

    const [d1,d2,d3]=await Promise.all(responses.map(r => r.json()));
    console.log('JSON„Éë„Éº„ÇπÂÆå‰∫Ü');

    COURSE_DATA=d1.stages.concat(d2.stages).concat(d3.stages);
    console.log('COURSE_DATAË®≠ÂÆöÂÆå‰∫Ü:', COURSE_DATA.length, '„Çπ„ÉÜ„Éº„Ç∏');

    const bossResp=await fetch('course/chapter1_stage12_boss.json');
    if(bossResp.ok){
      const bossJSON=await bossResp.json();
      const bs=bossJSON.stages[0];
      BOSS_DATA={stageId:bs.stageId,title:bs.title,isBossBattle:true,passingScore:bs.passingScore,bossName:bs.bossName,bossDescription:bs.bossDescription,questions:bs.questions,rewards:bs.rewards};
      console.log('BOSS_DATAË®≠ÂÆöÂÆå‰∫Ü');
    }
    console.log('„Ç≥„Éº„Çπ„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà„Åµ„Çä„Åå„Å™‰ªò„ÅçÔºâ');
    renderStageGrid();
  }catch(e){
    console.error('JSON„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„ÉºË©≥Á¥∞:', e);
    // „Ç®„É©„ÉºÊôÇ„ÅØ„Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø„ÇíË®≠ÂÆö
    const grid = document.getElementById('stage-grid');
    grid.innerHTML = '<div style="text-align:center; padding:50px; color:#f44; font-size:18px;">‚ö†Ô∏è „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº<br>„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
  }
}

updateHeader();
renderStageGrid(); // ÂàùÊúü„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
loadCourseDataFromJSON();
</script>
</body>
</html>
