<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ITパスポート タイピングゲーム</title>
  <style>
    /* ===== リセット & 基本 ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== ヘッダー ===== */
    header {
      text-align: center;
      padding: 18px 16px 6px;
      flex-shrink: 0;
    }
    .header-title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .header-controls {
      display: none; /* ゲーム中のみ表示 */
      gap: 8px;
      align-items: center;
    }
    body.panel-open .header-controls {
      display: flex;
    }
    .sound-controls {
      display: flex;
      gap: 8px;
    }
    .sound-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      color: #ddd;
      font-size: 0.75rem;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .sound-btn:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.1);
    }
    .sound-btn.off {
      background: rgba(244,67,54,0.15);
      border-color: rgba(244,67,54,0.4);
      color: #f44336;
    }
    .home-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      color: #ddd;
      font-size: 0.75rem;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .home-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }
    header h1 {
      font-size: 1.6rem;
      background: linear-gradient(90deg, #00d2ff, #3a7bd5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #aaa;
    }

    /* ===== メインレイアウト ===== */
    #main-layout {
      display: flex;
      flex: 1;
      padding: 12px 24px;
      min-height: 0;
      position: relative;
      gap: 24px;
      align-items: flex-start;
      width: 100%;
    }
    /* ゲーム中は検索パネルを画面いっぱいに伸ばす */
    body.panel-open #main-layout {
      align-items: stretch;
    }

    /* 左右サイドバー */
    .sidebar {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
    }

    /* 中央: ゲーム本体 */
    #game-container {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
    }
    /* サイドパネル（検索）表示時 */
    body.panel-open .sidebar {
      display: none;
    }
    body.panel-open #game-container {
      flex: 6;
      margin: 0;
      max-width: none;
    }

    /* 右: 検索サイドパネル */
    #search-side-panel {
      flex: 4;
      min-width: 0;
      display: none; /* ゲーム開始時に表示 */
      flex-direction: column;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      overflow: hidden;
    }

    /* サイドパネル ヘッダー */
    #side-panel-header {
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    #side-panel-header h3 {
      font-size: 0.85rem;
      color: #ffb74d;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .search-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .search-chip {
      padding: 6px 14px;
      background: rgba(255,183,77,0.1);
      border: 1px solid rgba(255,183,77,0.3);
      border-radius: 20px;
      font-size: 0.82rem;
      color: #ffb74d;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .search-chip:hover {
      background: rgba(255,183,77,0.25);
      border-color: #ffb74d;
      transform: translateY(-1px);
    }
    .search-chip.active {
      background: rgba(255,183,77,0.3);
      border-color: #ffb74d;
      color: #fff;
    }

    /* ===== 魔法エフェクト（検索時） ===== */
    #magic-effect-container {
      position: fixed;
      pointer-events: none;
      z-index: 9998;
      overflow: visible;
    }
    .magic-particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0;
    }
    .magic-particle.spark {
      width: 6px;
      height: 6px;
      background: #ffb74d;
      box-shadow: 0 0 8px 2px rgba(255,183,77,0.8), 0 0 16px 4px rgba(255,183,77,0.4);
      animation: magicSpark var(--dur) ease-out forwards;
      animation-delay: var(--delay);
    }
    .magic-particle.star {
      width: 10px;
      height: 10px;
      background: transparent;
      box-shadow: 0 0 6px 2px rgba(160,130,255,0.9), 0 0 20px 6px rgba(160,130,255,0.4);
      animation: magicStar var(--dur) ease-out forwards;
      animation-delay: var(--delay);
    }
    .magic-particle.ring {
      width: 12px;
      height: 12px;
      background: transparent;
      border: 2px solid rgba(0,210,255,0.7);
      box-shadow: 0 0 10px rgba(0,210,255,0.5);
      animation: magicRing var(--dur) ease-out forwards;
      animation-delay: var(--delay);
    }
    #search-side-panel.magic-glow {
      animation: panelMagicGlow 0.8s ease-out;
    }
    @keyframes magicSpark {
      0% { opacity: 1; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
    }
    @keyframes magicStar {
      0% { opacity: 0; transform: translate(0, 0) scale(0) rotate(0deg); }
      20% { opacity: 1; transform: translate(calc(var(--tx) * 0.2), calc(var(--ty) * 0.2)) scale(1.5) rotate(90deg); }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0) rotate(360deg); }
    }
    @keyframes magicRing {
      0% { opacity: 0.8; transform: translate(0, 0) scale(0.5); }
      50% { opacity: 1; transform: translate(calc(var(--tx) * 0.5), calc(var(--ty) * 0.5)) scale(1.5); }
      100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(2.5); }
    }
    @keyframes panelMagicGlow {
      0% { box-shadow: 0 0 0 rgba(160,130,255,0); border-color: rgba(255,255,255,0.06); }
      30% { box-shadow: 0 0 25px rgba(160,130,255,0.5), inset 0 0 15px rgba(160,130,255,0.15); border-color: rgba(160,130,255,0.6); }
      100% { box-shadow: 0 0 0 rgba(160,130,255,0); border-color: rgba(255,255,255,0.06); }
    }

    /* ブラウザバー */
    #search-browser-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .browser-dots {
      display: flex;
      gap: 4px;
    }
    .browser-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }
    .browser-dot.red { background: #ff5f56; }
    .browser-dot.yellow { background: #ffbd2e; }
    .browser-dot.green { background: #27c93f; }
    #search-url-bar {
      flex: 1;
      padding: 4px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 5px;
      font-size: 0.72rem;
      color: #888;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* iframe 表示エリア */
    #search-content {
      flex: 1;
      position: relative;
      background: #fff;
      min-height: 0;
      overflow: hidden;
    }
    #search-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    #search-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 40px 20px;
      background: rgba(255,255,255,0.02);
    }
    #search-placeholder .placeholder-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    #search-placeholder p {
      font-size: 0.9rem;
      color: #888;
      line-height: 1.7;
    }
    #search-placeholder .placeholder-sub {
      font-size: 0.78rem;
      color: #666;
      margin-top: 8px;
    }
    #search-loading {
      display: none;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(26,26,46,0.9);
      z-index: 2;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 0.9rem;
    }
    .loading-spinner {
      display: inline-block;
      width: 28px;
      height: 28px;
      border: 3px solid rgba(255,183,77,0.2);
      border-top-color: #ffb74d;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* サイドパネル フッター */
    #side-panel-footer {
      padding: 8px 12px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.06);
      text-align: center;
    }
    #side-panel-footer .hint-text {
      font-size: 0.73rem;
      color: #666;
    }
    .google-open-btn {
      display: inline-block;
      margin-top: 6px;
      padding: 6px 16px;
      background: linear-gradient(135deg, #ffb74d, #ff9800);
      color: #1a1a2e;
      font-weight: bold;
      font-size: 0.78rem;
      border-radius: 6px;
      text-decoration: none;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .google-open-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(255,183,77,0.3);
    }

    /* ===== スタート画面 ===== */
    #start-screen {
      text-align: center;
      margin-top: 0;
    }
    #start-screen h2 {
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: #ddd;
    }
    #start-screen .description {
      font-size: 0.95rem;
      color: #aaa;
      line-height: 1.8;
      margin-bottom: 32px;
    }
    #start-screen .description strong {
      color: #00d2ff;
    }

    .btn {
      display: inline-block;
      padding: 14px 48px;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      color: #fff;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,210,255,0.3);
    }
    .btn-primary {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
    }

    /* ===== HUD (スコア・進捗) ===== */
    #hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 16px;
    }
    #hud span {
      font-size: 0.9rem;
      color: #aaa;
    }
    #hud .score {
      font-size: 1.1rem;
      color: #00d2ff;
      font-weight: bold;
    }

    /* ===== 問題エリア ===== */
    #question-area {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 22px 20px;
      margin-bottom: 16px;
      text-align: center;
    }
    .category-badge {
      display: inline-block;
      padding: 3px 10px;
      font-size: 0.73rem;
      border-radius: 20px;
      background: rgba(0,210,255,0.15);
      color: #00d2ff;
      margin-bottom: 10px;
    }
    #question-text {
      font-size: 1.1rem;
      line-height: 1.8;
      color: #fff;
    }
    .blank {
      display: inline-block;
      min-width: 100px;
      border-bottom: 3px solid #00d2ff;
      color: #00d2ff;
      font-weight: bold;
      padding: 2px 8px;
      margin: 0 4px;
      letter-spacing: 1px;
      font-size: 1.1rem;
    }

    /* ===== 選択肢表示 ===== */
    #choices-area {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }
    #choices-area h3 {
      font-size: 0.82rem;
      color: #888;
      margin-bottom: 8px;
    }
    .choices-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .choice-chip {
      padding: 7px 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #ddd;
      transition: background 0.2s;
    }
    .choice-chip.highlight {
      background: rgba(0,210,255,0.15);
      border-color: #00d2ff;
      color: #00d2ff;
    }
    .choice-chip.correct-done {
      background: rgba(76,175,80,0.2);
      border-color: #4caf50;
      color: #4caf50;
    }
    .choice-chip.wrong-done {
      background: rgba(244,67,54,0.15);
      border-color: #f44336;
      color: #f44336;
      text-decoration: line-through;
    }

    /* ===== タイピング入力 ===== */
    #typing-area {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    #typing-area label {
      display: block;
      font-size: 0.82rem;
      color: #888;
      margin-bottom: 6px;
    }
    #typing-input {
      width: 100%;
      max-width: 480px;
      padding: 12px 18px;
      font-size: 1.15rem;
      background: rgba(255,255,255,0.04);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      color: #fff;
      outline: none;
      text-align: center;
      letter-spacing: 2px;
      transition: border-color 0.3s;
    }
    #typing-input:focus {
      border-color: #00d2ff;
    }
    #typing-input.correct {
      border-color: #4caf50;
      background: rgba(76,175,80,0.1);
    }
    #typing-input.wrong {
      border-color: #f44336;
      background: rgba(244,67,54,0.1);
      animation: shake 0.4s;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    /* ===== ボスバトルUI ===== */
    #boss-battle-ui {
      text-align: center;
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(139,0,0,0.3), rgba(75,0,130,0.3));
      border: 3px solid #ff4444;
      border-radius: 12px;
      animation: bossPulse 1.5s ease-in-out infinite;
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.3s, transform 0.3s;
    }
    #boss-battle-ui.show {
      opacity: 1;
      transform: scale(1);
    }
    @keyframes bossPulse {
      0%, 100% { border-color: #ff4444; box-shadow: 0 0 20px rgba(255,68,68,0.5); }
      50% { border-color: #ff8800; box-shadow: 0 0 30px rgba(255,136,0,0.7); }
    }
    #boss-battle-title {
      font-size: 1.8rem;
      font-weight: 900;
      color: #ff4444;
      text-shadow: 0 0 10px #ff4444, 2px 2px 0 #000;
      letter-spacing: 4px;
      margin-bottom: 8px;
      animation: bossTextGlow 1s ease-in-out infinite alternate;
    }
    @keyframes bossTextGlow {
      0% { text-shadow: 0 0 10px #ff4444, 2px 2px 0 #000; }
      100% { text-shadow: 0 0 20px #ff8800, 0 0 40px #ff4444, 2px 2px 0 #000; }
    }
    #boss-combo-display {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 1px 1px 0 #000;
    }

    /* ===== モンスター表示エリア（ドラクエ風） ===== */
    #monster-area {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin: 20px 0 12px;
      min-height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #monster-container {
      position: relative;
      display: inline-block;
    }
    #monster-img {
      width: 160px;
      height: auto;
      image-rendering: pixelated;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,0.5));
      transition: filter 0.1s;
    }
    #monster-img.appear {
      animation: monsterAppear 0.6s ease-out;
    }
    #monster-img.hit {
      animation: monsterShake 0.15s ease-in-out;
      filter: drop-shadow(0 4px 16px rgba(0,0,0,0.5)) brightness(2);
    }
    #monster-img.defeat {
      animation: monsterDefeat 0.8s ease-in forwards;
    }
    #monster-img.fade-out {
      animation: monsterFadeOut 0.5s ease-out forwards;
    }
    #damage-effect {
      position: absolute;
      width: 100px;
      height: 100px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      pointer-events: none;
      z-index: 10;
    }
    #damage-effect.show {
      animation: damageFlash 0.35s ease-out forwards;
    }
    #damage-number {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      font-weight: 900;
      color: #ff4444;
      text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
      opacity: 0;
      pointer-events: none;
      z-index: 11;
      font-family: 'Arial Black', sans-serif;
      white-space: nowrap;
    }
    #damage-number.show {
      animation: damageNumberFloat 0.8s ease-out forwards;
    }

    @keyframes monsterAppear {
      0% { transform: translateY(40px) scale(0.3); opacity: 0; }
      60% { transform: translateY(-8px) scale(1.05); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes monsterShake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      50% { transform: translateX(8px); }
      75% { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }
    @keyframes monsterDefeat {
      0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
      30% { transform: translate(30px, -40px) scale(0.8) rotate(15deg); opacity: 1; }
      60% { transform: translate(80px, -100px) scale(0.5) rotate(30deg); opacity: 0.7; }
      100% { transform: translate(200px, -200px) scale(0.1) rotate(60deg); opacity: 0; }
    }
    @keyframes monsterFadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes damageFlash {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
    }
    @keyframes damageNumberFloat {
      0% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.2); }
      20% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1); }
      70% { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-40px); }
    }

    /* ===== ゴールド表示（HUD） ===== */
    .gold-display {
      font-size: 1.1rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 6px rgba(255,215,0,0.4);
    }
    .gold-display.flash {
      animation: goldFlash 0.4s ease-out;
    }
    @keyframes goldFlash {
      0% { transform: scale(1); }
      40% { transform: scale(1.3); color: #fff; text-shadow: 0 0 12px #ffd700; }
      100% { transform: scale(1); }
    }

    /* ===== 自分ダメージ演出 ===== */
    #player-damage-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 0, 0, 0.3);
      z-index: 9999;
      pointer-events: none;
    }
    #player-damage-overlay.show {
      display: block;
      animation: playerDamageFlash 0.8s ease-out forwards;
    }
    @keyframes playerDamageFlash {
      0% { opacity: 1; }
      20% { opacity: 0.1; }
      40% { opacity: 0.8; }
      60% { opacity: 0.1; }
      80% { opacity: 0.5; }
      100% { opacity: 0; display: none; }
    }
    /* 自分へのダメージ数値表示 */
    #player-damage-number {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10rem;
      font-weight: 900;
      color: #ff0000;
      text-shadow:
        6px 6px 0 #000,
        -3px -3px 0 #000,
        3px -3px 0 #000,
        -3px 3px 0 #000,
        0 0 40px rgba(255,0,0,0.9),
        0 0 80px rgba(255,0,0,0.6),
        0 0 120px rgba(255,0,0,0.4);
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      font-family: 'Arial Black', Impact, sans-serif;
      letter-spacing: 6px;
    }
    #player-damage-number.show {
      animation: playerDamageNumberPop 3s ease-out forwards;
    }
    @keyframes playerDamageNumberPop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.2);
      }
      10% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.4);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      75% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -60%) scale(0.8);
      }
    }
    #game-container.player-hit {
      animation: playerShake 0.4s ease-in-out;
    }
    @keyframes playerShake {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-10px) translateY(-3px); }
      30% { transform: translateX(8px) translateY(2px); }
      45% { transform: translateX(-6px) translateY(-2px); }
      60% { transform: translateX(6px) translateY(1px); }
      75% { transform: translateX(-3px); }
    }
    #game-container.critical-hit {
      animation: criticalShake 0.8s ease-in-out;
    }
    @keyframes criticalShake {
      0%, 100% { transform: translateX(0) translateY(0); }
      5% { transform: translateX(-25px) translateY(-10px); }
      10% { transform: translateX(25px) translateY(8px); }
      15% { transform: translateX(-20px) translateY(-8px); }
      20% { transform: translateX(20px) translateY(6px); }
      25% { transform: translateX(-18px) translateY(-6px); }
      30% { transform: translateX(18px) translateY(5px); }
      40% { transform: translateX(-15px) translateY(-4px); }
      50% { transform: translateX(12px) translateY(3px); }
      60% { transform: translateX(-10px) translateY(-2px); }
      70% { transform: translateX(8px) translateY(2px); }
      80% { transform: translateX(-5px) translateY(-1px); }
      90% { transform: translateX(3px); }
    }
    #critical-flash-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ff0000;
      pointer-events: none;
      z-index: 9998;
      opacity: 0;
    }
    #critical-flash-overlay.show {
      animation: criticalFlash 0.8s ease-out forwards;
    }
    @keyframes criticalFlash {
      0% { opacity: 0.7; }
      15% { opacity: 0.2; }
      30% { opacity: 0.6; }
      45% { opacity: 0.1; }
      60% { opacity: 0.4; }
      75% { opacity: 0.1; }
      100% { opacity: 0; }
    }

    /* ===== お金ドロップ演出 ===== */
    #money-drop-area {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 15;
      overflow: visible;
    }
    .money-sprite {
      position: absolute;
      width: 40px;
      height: auto;
      top: 50%;
      left: 50%;
      opacity: 0;
      pointer-events: none;
    }
    .money-sprite.animate {
      animation: moneyScatter var(--duration) ease-out forwards;
    }
    @keyframes moneyScatter {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.3) rotate(0deg); }
      30% { opacity: 1; transform: translate(calc(-50% + var(--tx) * 0.4), calc(-50% + var(--ty) * 0.4)) scale(1) rotate(var(--rot)); }
      70% { opacity: 1; }
      100% { opacity: 0; transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0.6) rotate(calc(var(--rot) * 2)); }
    }
    #gold-drop-text {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      font-weight: 900;
      color: #ffd700;
      text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 0 0 10px rgba(255,215,0,0.6);
      opacity: 0;
      pointer-events: none;
      z-index: 16;
      font-family: 'Arial Black', sans-serif;
      white-space: nowrap;
    }
    #gold-drop-text.show {
      animation: goldTextFloat 1.2s ease-out forwards;
    }
    @keyframes goldTextFloat {
      0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); }
      15% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1.2); }
      30% { opacity: 1; transform: translateX(-50%) translateY(-15px) scale(1); }
      70% { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-60px) scale(0.9); }
    }

    /* ===== ナビゲーションボックス ===== */
    #nav-guide-box {
      flex: 1;
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      padding: 12px 16px;
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 80px;
    }
    #nav-guide-box p {
      margin: 4px 0;
      font-size: 0.85rem;
      color: #fff;
      line-height: 1.5;
    }
    #nav-guide-box strong {
      color: #ffb74d;
    }
    #nav-guide-box.hidden {
      display: none !important;
    }

    /* ===== フィードバック・解説 ===== */
    #feedback {
      text-align: center;
      min-height: 22px;
      font-size: 1rem;
      margin-bottom: 8px;
      font-weight: bold;
    }
    #feedback.correct { color: #4caf50; }
    #feedback.wrong { color: #f44336; }

    #explanation-box {
      background: rgba(255,255,255,0.03);
      border-left: 4px solid #ffb74d;
      border-radius: 0 8px 8px 0;
      padding: 14px 18px;
      margin-bottom: 16px;
      display: none;
    }
    #explanation-box h4 {
      color: #ffb74d;
      font-size: 0.85rem;
      margin-bottom: 6px;
    }
    #explanation-box p {
      font-size: 0.85rem;
      line-height: 1.7;
      color: #ddd;
    }

    /* ===== 結果画面 ===== */
    #result-screen {
      display: none;
      text-align: center;
      margin-top: 40px;
    }
    #result-screen h2 {
      font-size: 1.6rem;
      margin-bottom: 20px;
      color: #00d2ff;
    }
    .result-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 24px;
    }
    .stat-box {
      text-align: center;
    }
    .stat-box .num {
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
    }
    .stat-box .label {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }
    .result-message {
      font-size: 1rem;
      color: #ddd;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    /* ===== 「次へ」ボタン ===== */
    #next-btn-area {
      text-align: center;
      margin-top: 16px;
      display: none;
    }
    #next-btn {
      display: inline-block;
      padding: 12px 40px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    #next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,210,255,0.3);
    }
    #next-btn-hint {
      display: block;
      margin-top: 8px;
      font-size: 0.75rem;
      color: #666;
    }

    /* ===== ステータス＆ナビゲーション横並びエリア ===== */
    #status-nav-row {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 12px;
      align-items: stretch;
      width: 100%;
    }

    /* ===== プレイヤーステータスエリア（HPバー＋アイテム） ===== */
    #player-status-container {
      display: none;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 12px;
      align-items: stretch;
    }
    #player-status-container.visible {
      display: flex;
    }
    /* ステータスボックスの横幅を均等に */
    #player-status-container > .status-box {
      flex: 0 0 auto;
    }
    /* ナビが非表示の場合、ステータスが全幅を使う */
    #player-status-container.full-width {
      flex: 1;
    }
    #player-status-container.full-width #player-hp-box {
      flex: 1;
    }
    #player-status-container.full-width #item-stock-area {
      flex: 0 0 auto;
    }

    /* 共通のステータスボックススタイル */
    .status-box {
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      padding: 12px 16px;
    }

    /* ===== プレイヤーHPゲージ ===== */
    #player-hp-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 180px;
      flex: 1;
    }
    #player-hp-label {
      font-size: 0.85rem;
      font-weight: bold;
      color: #ff6b6b;
      white-space: nowrap;
    }
    #player-hp-bar-container {
      width: 100%;
      height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    #player-hp-bar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #4caf50, #66bb6a);
      border-radius: 10px;
      transition: width 0.4s ease, background 0.4s ease;
    }
    #player-hp-bar.hp-mid {
      background: linear-gradient(90deg, #ff9800, #ffb74d);
    }
    #player-hp-bar.hp-low {
      background: linear-gradient(90deg, #f44336, #ff5722);
    }
    #player-hp-text {
      font-size: 0.8rem;
      font-weight: bold;
      color: #fff;
      text-align: center;
    }

    /* ===== アイテムストック表示 ===== */
    #item-stock-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 150px;
    }
    #item-stock-label {
      font-size: 0.85rem;
      color: #4caf50;
      font-weight: bold;
      white-space: nowrap;
    }
    .item-slots-row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .item-slot {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, rgba(80,80,80,0.9) 0%, rgba(50,50,50,0.9) 100%);
      border: 3px solid #4caf50;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 8px rgba(76,175,80,0.3);
    }
    .item-slot.empty {
      opacity: 0.5;
      border-color: #555;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    }
    .item-slot.empty .item-icon {
      opacity: 0.3;
      filter: grayscale(100%);
    }
    .item-icon {
      width: 40px;
      height: 40px;
      image-rendering: auto;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
      object-fit: contain;
    }
    #potion-hint {
      font-size: 0.75rem;
      color: #888;
      font-weight: normal;
      white-space: nowrap;
    }
    /* ポーションドロップ演出（画面中央） */
    #potion-drop-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
    }
    #potion-drop-display.show {
      animation: potionDropPop 3.5s ease-out forwards;
    }
    #potion-drop-display img {
      width: 150px;
      height: 150px;
      object-fit: contain;
      filter: drop-shadow(0 0 30px rgba(76,175,80,0.9)) drop-shadow(0 0 60px rgba(76,175,80,0.6));
    }
    #potion-drop-display .potion-drop-text {
      font-size: 2.5rem;
      font-weight: bold;
      color: #4caf50;
      text-shadow:
        3px 3px 0 #000,
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        0 0 30px rgba(76,175,80,0.9);
      white-space: nowrap;
    }
    @keyframes potionDropPop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.2);
      }
      10% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.3);
      }
      20% {
        transform: translate(-50%, -50%) scale(1);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -60%) scale(0.9);
      }
    }
    /* 腕時計アイテムスロット */
    .watch-slot {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, rgba(80,80,80,0.9) 0%, rgba(50,50,50,0.9) 100%);
      border: 3px solid #ffd700;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 8px rgba(255,215,0,0.3);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .watch-slot:hover:not(.empty) {
      transform: scale(1.1);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 15px rgba(255,215,0,0.6);
    }
    .watch-slot.empty {
      opacity: 0.5;
      border-color: #555;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
      cursor: default;
    }
    .watch-slot.empty .item-icon {
      opacity: 0.3;
      filter: grayscale(100%);
    }
    /* 腕時計ドロップ演出（画面中央） */
    #watch-drop-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
    }
    #watch-drop-display.show {
      animation: watchDropPop 3.5s ease-out forwards;
    }
    #watch-drop-display img {
      width: 150px;
      height: 150px;
      object-fit: contain;
      filter: drop-shadow(0 0 30px rgba(255,215,0,0.9)) drop-shadow(0 0 60px rgba(255,215,0,0.6));
    }
    #watch-drop-display .watch-drop-text {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffd700;
      text-shadow:
        3px 3px 0 #000,
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        0 0 30px rgba(255,215,0,0.9);
      white-space: nowrap;
    }
    @keyframes watchDropPop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.2);
      }
      10% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.3);
      }
      20% {
        transform: translate(-50%, -50%) scale(1);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -60%) scale(0.9);
      }
    }
    /* 腕時計使用演出（時間リセット） */
    .time-reset-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle, rgba(255,215,0,0.7) 0%, rgba(255,215,0,0.3) 40%, rgba(0,0,0,0.5) 100%);
      z-index: 9999;
      pointer-events: none;
      animation: timeResetFlash 2s ease-out forwards;
    }
    @keyframes timeResetFlash {
      0% { opacity: 0; }
      10% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }
    .time-reset-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 8rem;
      font-weight: 900;
      color: #ffd700;
      text-shadow:
        0 0 30px #ffd700,
        0 0 60px #ffeb3b,
        0 0 90px #fff176,
        0 0 120px rgba(255,215,0,0.8),
        4px 4px 0 #000,
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000;
      animation: timeResetPop 2.5s ease-out forwards;
      z-index: 10000;
      pointer-events: none;
      white-space: nowrap;
    }
    @keyframes timeResetPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.2) rotate(-10deg); }
      15% { opacity: 1; transform: translate(-50%, -50%) scale(1.4) rotate(5deg); }
      25% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
      75% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
      100% { opacity: 0; transform: translate(-50%, -60%) scale(0.8) rotate(-5deg); }
    }
    /* 時計の針が回転するエフェクト */
    .time-reset-clock {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      z-index: 10001;
      pointer-events: none;
      animation: clockSpin 2s ease-out forwards;
    }
    .time-reset-clock img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 40px rgba(255,215,0,0.9)) drop-shadow(0 0 80px rgba(255,215,0,0.6));
    }
    @keyframes clockSpin {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3) rotate(0deg); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2) rotate(360deg); }
      40% { transform: translate(-50%, -50%) scale(1) rotate(720deg); }
      70% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(720deg); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5) rotate(720deg); }
    }
    /* HP回復演出（画面いっぱい） */
    .heal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle, rgba(76,175,80,0.4) 0%, rgba(76,175,80,0) 70%);
      z-index: 999;
      pointer-events: none;
      animation: healFlash 1s ease-out forwards;
    }
    @keyframes healFlash {
      0% { opacity: 0; }
      20% { opacity: 1; }
      100% { opacity: 0; }
    }
    .heal-effect {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      font-weight: bold;
      color: #4caf50;
      text-shadow: 0 0 20px #4caf50, 0 0 40px #66bb6a, 0 0 60px #81c784;
      animation: healPop 1.2s ease-out forwards;
      z-index: 1000;
      pointer-events: none;
    }
    @keyframes healPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -70%) scale(1.1); }
    }

    #critical-hit-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: 900;
      color: #ff0000;
      text-shadow: 0 0 20px #ff0000, 0 0 40px #ff4444, 2px 2px 0 #000;
      z-index: 9999;
      pointer-events: none;
      animation: criticalPop 1s ease-out forwards;
    }
    @keyframes criticalPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
      40% { transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
    }
    #damage-number {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2.5rem;
      font-weight: 900;
      color: #ff4444;
      text-shadow: 2px 2px 0 #000;
      z-index: 9998;
      pointer-events: none;
      animation: dmgFloat 1s ease-out forwards;
    }
    #damage-number.critical {
      font-size: 3.5rem;
      color: #ff0000;
      text-shadow: 0 0 10px #ff0000, 2px 2px 0 #000;
    }
    @keyframes dmgFloat {
      0% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-60px); }
    }

    /* ===== タイマーバー ===== */
    #timer-bar-container {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.06);
      border-radius: 3px;
      margin-bottom: 12px;
      overflow: hidden;
      display: none;
    }
    #timer-bar {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      border-radius: 3px;
      transition: width 0.1s linear;
    }
    #timer-bar.warning { background: linear-gradient(90deg, #ff9800, #ffb74d); }
    #timer-bar.danger { background: linear-gradient(90deg, #f44336, #ff5722); }

    #timer-text {
      text-align: center;
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 8px;
      display: none;
    }
    #timer-text.warning { color: #ff9800; }
    #timer-text.danger { color: #f44336; font-weight: bold; }

    /* ===== 本気モード選択 ===== */
    .mode-select {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .mode-card {
      flex: 1;
      max-width: 300px;
      padding: 20px 24px;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .mode-card.mode-normal {
      background: rgba(0,210,255,0.08);
      border-color: rgba(0,210,255,0.2);
      color: #00d2ff;
    }
    .mode-card.mode-normal:hover, .mode-card.mode-normal.selected {
      background: rgba(0,210,255,0.18);
      border-color: #00d2ff;
    }
    .mode-card.mode-mission {
      background: rgba(255,183,77,0.08);
      border-color: rgba(255,183,77,0.2);
      color: #ffb74d;
    }
    .mode-card.mode-mission:hover, .mode-card.mode-mission.selected {
      background: rgba(255,183,77,0.18);
      border-color: #ffb74d;
    }
    .mode-card .mode-title {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .mode-card .mode-desc {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    /* ===== ミッション結果画面 ===== */
    .mission-result-header {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    .mission-streak {
      font-size: 3rem;
      font-weight: bold;
      color: #ffb74d;
      margin: 16px 0;
    }
    .mission-streak .streak-label {
      font-size: 0.9rem;
      color: #aaa;
      display: block;
      margin-top: 4px;
    }
    .mission-detail-stats {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin: 16px 0 24px;
      flex-wrap: wrap;
    }
    .mission-detail-stats .stat-box .num {
      font-size: 1.5rem;
    }

    /* ===== ランキング ===== */
    .ranking-section {
      margin-top: 32px;
      text-align: center;
    }
    .ranking-section h3 {
      font-size: 1rem;
      color: #ffb74d;
      margin-bottom: 12px;
    }
    .ranking-table {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      border-collapse: collapse;
    }
    .ranking-table th {
      padding: 8px 12px;
      font-size: 0.78rem;
      color: #888;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: center;
    }
    .ranking-table td {
      padding: 8px 12px;
      font-size: 0.88rem;
      color: #ddd;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      text-align: center;
    }
    .ranking-table tr.current-record {
      background: rgba(255,183,77,0.1);
    }
    .ranking-table tr.current-record td {
      color: #ffb74d;
      font-weight: bold;
    }
    .ranking-table .rank-num {
      font-weight: bold;
      color: #aaa;
    }
    .ranking-table .rank-1 { color: #ffd700; }
    .ranking-table .rank-2 { color: #c0c0c0; }
    .ranking-table .rank-3 { color: #cd7f32; }

    /* ===== ゲームオーバー演出 ===== */
    #game-over-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15,12,41,0.92);
      z-index: 100;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }
    #game-over-overlay .go-title {
      font-size: 2rem;
      color: #f44336;
      font-weight: bold;
      margin-bottom: 12px;
    }
    #game-over-overlay .go-reason {
      font-size: 1rem;
      color: #ddd;
      margin-bottom: 24px;
    }

    /* ===== ダッシュボード ===== */
    #dashboard {
      margin-bottom: 28px;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .dashboard-card h3 {
      font-size: 0.9rem;
      color: #ffb74d;
      margin-bottom: 12px;
    }
    .my-best {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .my-best .best-streak {
      font-size: 2.4rem;
      font-weight: bold;
      color: #ffb74d;
      line-height: 1;
    }
    .my-best .best-streak .best-unit {
      font-size: 0.85rem;
      color: #aaa;
      font-weight: normal;
    }
    .my-best .best-title-badge {
      display: inline-block;
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
    }
    .my-best-empty {
      color: #666;
      font-size: 0.85rem;
      text-align: center;
      padding: 8px 0;
    }
    .dashboard-ranking {
      max-height: 240px;
      overflow-y: auto;
    }
    .dashboard-ranking table {
      width: 100%;
      border-collapse: collapse;
    }
    .dashboard-ranking th {
      padding: 6px 8px;
      font-size: 0.73rem;
      color: #888;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: center;
      position: sticky;
      top: 0;
      background: rgba(36,36,62,0.95);
    }
    .dashboard-ranking td {
      padding: 6px 8px;
      font-size: 0.82rem;
      color: #ddd;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      text-align: center;
    }
    .dashboard-ranking .rank-num { font-weight: bold; color: #aaa; }
    .dashboard-ranking .rank-1 { color: #ffd700; }
    .dashboard-ranking .rank-2 { color: #c0c0c0; }
    .dashboard-ranking .rank-3 { color: #cd7f32; }
    .dashboard-ranking .name-cell {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dashboard-empty {
      color: #666;
      font-size: 0.85rem;
      text-align: center;
      padding: 16px 0;
    }

    /* ===== 称号一覧 ===== */
    .title-list-subtitle {
      font-size: 0.7rem;
      font-weight: normal;
      color: #888;
      font-style: italic;
    }
    .title-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .title-list th {
      padding: 6px 8px;
      font-size: 0.73rem;
      color: #888;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: center;
      position: sticky;
      top: 0;
      background: rgba(36,36,62,0.95);
    }
    .title-list td {
      padding: 8px 8px;
      font-size: 0.82rem;
      color: #ddd;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      text-align: center;
    }
    .title-list tr.secret td {
      color: #444;
      font-style: italic;
    }
    .title-list .title-name {
      font-weight: bold;
    }
    .title-list .unlocked-by {
      font-size: 0.72rem;
      color: #888;
    }

    /* ===== 名前入力モーダル ===== */
    #name-input-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15,12,41,0.92);
      z-index: 100;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
    }
    .name-input-box {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 32px 28px;
      max-width: 400px;
      width: 100%;
    }
    .name-input-box h3 {
      font-size: 1.1rem;
      color: #ffb74d;
      margin-bottom: 8px;
    }
    .name-input-box p {
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 16px;
    }
    #player-name-input {
      width: 100%;
      max-width: 280px;
      padding: 10px 16px;
      font-size: 1rem;
      background: rgba(255,255,255,0.04);
      border: 2px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      color: #fff;
      outline: none;
      text-align: center;
      margin-bottom: 16px;
    }
    #player-name-input:focus {
      border-color: #ffb74d;
    }
    .name-btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .name-btn-row button {
      padding: 10px 28px;
      font-size: 0.95rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      transition: transform 0.15s;
    }
    .name-btn-row button:hover {
      transform: translateY(-2px);
    }
    .name-btn-save {
      background: linear-gradient(135deg, #ffb74d, #ff9800);
      color: #1a1a2e !important;
    }
    .name-btn-skip {
      background: rgba(255,255,255,0.06);
    }

    /* ===== 称号バッジ ===== */
    .title-badge {
      display: inline-block;
      padding: 10px 28px;
      border-radius: 30px;
      font-size: 1.2rem;
      font-weight: bold;
      margin: 12px 0 8px;
      letter-spacing: 1px;
    }
    .title-badge.rank-beginner {
      background: rgba(158,158,158,0.15);
      border: 2px solid #9e9e9e;
      color: #bdbdbd;
    }
    .title-badge.rank-bronze {
      background: rgba(205,127,50,0.15);
      border: 2px solid #cd7f32;
      color: #cd7f32;
    }
    .title-badge.rank-silver {
      background: rgba(192,192,192,0.15);
      border: 2px solid #c0c0c0;
      color: #fff;
    }
    .title-badge.rank-gold {
      background: rgba(255,215,0,0.12);
      border: 2px solid #ffd700;
      color: #ffd700;
    }
    .title-badge.rank-platinum {
      background: rgba(0,210,255,0.12);
      border: 2px solid #00d2ff;
      color: #00d2ff;
    }
    .title-badge.rank-diamond {
      background: rgba(185,242,255,0.12);
      border: 2px solid #b9f2ff;
      color: #b9f2ff;
      text-shadow: 0 0 8px rgba(185,242,255,0.5);
    }
    .title-badge.rank-master {
      background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,87,34,0.15));
      border: 2px solid #ff9800;
      color: #ffb74d;
      text-shadow: 0 0 8px rgba(255,183,77,0.4);
    }
    .title-badge.rank-legend {
      background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,0,128,0.15));
      border: 2px solid #ffd700;
      color: #ffd700;
      text-shadow: 0 0 12px rgba(255,215,0,0.6);
      animation: legendGlow 2s ease-in-out infinite alternate;
    }
    @keyframes legendGlow {
      from { box-shadow: 0 0 8px rgba(255,215,0,0.2); }
      to { box-shadow: 0 0 20px rgba(255,215,0,0.5); }
    }
    .title-sub {
      font-size: 0.8rem;
      color: #888;
      margin-top: 4px;
    }

    /* ===== 非表示ユーティリティ ===== */
    .hidden { display: none !important; }

    /* ===== レスポンシブ ===== */
    @media (max-width: 900px) {
      #main-layout {
        padding: 8px 12px;
        flex-direction: column;
      }
      .sidebar {
        display: block;
        width: 100%;
        order: 2; /* ゲームコンテナの後に表示 */
      }
      #sidebar-left {
        order: 2;
      }
      #sidebar-right {
        order: 3;
      }
      #game-container {
        order: 1; /* 最初に表示 */
        max-width: 100%;
        width: 100%;
      }
      body.panel-open .sidebar {
        display: none;
      }
      body.panel-open #main-layout {
        flex-direction: column;
      }
      body.panel-open #game-container {
        padding-bottom: 16px;
      }
      #search-side-panel {
        position: fixed;
        width: 100%;
        height: 400px;
        right: 0;
        left: 0;
        top: auto;
        bottom: 0;
        border-radius: 12px 12px 0 0;
        z-index: 10;
      }
    }
    @media (max-width: 600px) {
      header h1 { font-size: 1.3rem; }
      #question-area { padding: 16px 12px; }
      #typing-input { font-size: 1rem; padding: 10px 12px; }
      .result-stats { gap: 16px; }
      .stat-box .num { font-size: 1.5rem; }
      #search-side-panel { height: 350px; }
    }
  </style>
</head>
<body>

<div id="player-damage-overlay"></div>
<div id="player-damage-number"></div>
<div id="potion-drop-display">
  <img src="portion_01_lightblue_02.png" alt="ポーション">
  <div class="potion-drop-text">ポーション GET!</div>
</div>
<div id="watch-drop-display">
  <img src="udedokei_gold.png" alt="腕時計">
  <div class="watch-drop-text">腕時計 GET!</div>
</div>
<div id="critical-flash-overlay"></div>
<div id="magic-effect-container"></div>

<header>
  <div class="header-title-row">
    <h1>ITパスポート タイピングゲーム</h1>
    <div class="header-controls">
      <button class="home-btn" id="btn-home" onclick="goHome()">🏠 ホーム</button>
      <div class="sound-controls">
        <button class="sound-btn" id="btn-mute-all" onclick="toggleMuteAll()">🔊 全音</button>
        <button class="sound-btn" id="btn-mute-bgm" onclick="toggleMuteBgm()">🎵 BGM</button>
        <button class="sound-btn" id="btn-toggle-nav" onclick="toggleNavGuide()">📖 ナビ</button>
      </div>
    </div>
  </div>
  <p>タイピングしながらIT用語を覚えよう！</p>
</header>

<div id="main-layout">

  <!-- ===== 左サイドバー: ランキング ===== -->
  <div id="sidebar-left" class="sidebar">
    <div class="dashboard-card" id="ranking-card">
      <h3>💰 賞金ランキング <span class="title-list-subtitle">- 最も稼いだ者の名がここに刻まれる</span></h3>
      <div class="dashboard-ranking" id="dashboard-ranking-content"></div>
    </div>
  </div>

  <!-- ===== 中央: ゲーム本体 ===== -->
  <div id="game-container">

    <!-- スタート画面 -->
    <div id="start-screen">
      <!-- 自分の最高記録 -->
      <div id="dashboard">
        <div class="dashboard-card" id="my-best-card" style="display:none;">
          <h3>あなたの最高記録</h3>
          <div class="my-best" id="my-best-content"></div>
        </div>
      </div>

      <!-- モード選択 -->
      <div id="mode-select">
        <p style="color:#aaa;font-size:0.9rem;margin-bottom:10px;">ゲームモードを選んでね</p>
        <div class="mode-select">
          <div class="mode-card mode-normal selected" data-mode="normal" onclick="selectMode('normal')">
            <div class="mode-title">練習モード</div>
            <div class="mode-desc">10問ランダム出題<br>気軽に練習しよう</div>
          </div>
          <div class="mode-card mode-mission" data-mode="mission" onclick="selectMode('mission')">
            <div class="mode-title">本気モード</div>
            <div class="mode-desc">HPがなくなるまで敵を倒して<br>稼ぎまくれ！（1問45秒）</div>
          </div>
        </div>
      </div>

      <div id="category-select">
        <p style="color:#aaa;font-size:0.9rem;margin-bottom:10px;">出題する分野を選んでね</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:500px;margin:0 auto 20px;">
          <label style="cursor:pointer;padding:10px 18px;background:rgba(0,210,255,0.15);border:1px solid rgba(0,210,255,0.3);border-radius:8px;color:#00d2ff;font-size:0.9rem;text-align:center;">
            <input type="radio" name="cat" value="all" checked style="margin-right:6px;"> すべて
          </label>
          <label style="cursor:pointer;padding:10px 18px;background:rgba(255,183,77,0.1);border:1px solid rgba(255,183,77,0.3);border-radius:8px;color:#ffb74d;font-size:0.9rem;text-align:center;">
            <input type="radio" name="cat" value="ストラテジ系" style="margin-right:6px;"> ストラテジ系
          </label>
          <label style="cursor:pointer;padding:10px 18px;background:rgba(129,199,132,0.1);border:1px solid rgba(129,199,132,0.3);border-radius:8px;color:#81c784;font-size:0.9rem;text-align:center;">
            <input type="radio" name="cat" value="マネジメント系" style="margin-right:6px;"> マネジメント系
          </label>
          <label style="cursor:pointer;padding:10px 18px;background:rgba(159,134,255,0.1);border:1px solid rgba(159,134,255,0.3);border-radius:8px;color:#9f86ff;font-size:0.9rem;text-align:center;">
            <input type="radio" name="cat" value="テクノロジ系" style="margin-right:6px;"> テクノロジ系
          </label>
        </div>
        <p style="color:#666;font-size:0.8rem;" id="q-count-info">全 -- 問からランダムに10問出題</p>
      </div>

      <!-- 音声設定 -->
      <div id="sound-settings" style="margin-bottom:20px;">
        <p style="color:#aaa;font-size:0.9rem;margin-bottom:10px;">🔊 サウンド設定</p>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button class="sound-btn" id="btn-mute-all-dash" onclick="toggleMuteAll()">🔊 全音ON</button>
          <button class="sound-btn" id="btn-mute-bgm-dash" onclick="toggleMuteBgm()">🎵 BGM ON</button>
        </div>
      </div>

      <button class="btn btn-primary" id="start-btn">スタート</button>
    </div>

    <!-- ゲーム画面 -->
    <div id="game-screen" class="hidden">
      <div id="hud">
        <span>問題 <strong id="q-num">1</strong> / <strong id="q-total">10</strong></span>
        <span class="gold-display" id="gold-display">💰 <span id="gold-val">0</span> G</span>
        <span class="score">スコア: <span id="score-val">0</span></span>
      </div>

      <div id="timer-text"></div>
      <div id="timer-bar-container"><div id="timer-bar"></div></div>

      <div id="question-area">
        <span class="category-badge" id="category-badge">カテゴリ</span>
        <div id="question-text"></div>
      </div>

      <div id="choices-area">
        <h3>選択肢（この中から正しい答えをタイピング）</h3>
        <div class="choices-list" id="choices-list"></div>
      </div>

      <div id="typing-area">
        <label for="typing-input">答えをローマ字 or 英語でタイピング</label>
        <input type="text" id="typing-input" autocomplete="off" spellcheck="false" placeholder="ここにタイピング...">
      </div>

      <!-- ボスバトルUI -->
      <div id="boss-battle-ui" style="display:none;">
        <div id="boss-battle-title">⚔️ BOSS BATTLE ⚔️</div>
        <div id="boss-combo-display">連続正解: 0 / 3</div>
      </div>

      <!-- モンスター表示エリア（ドラクエ風） -->
      <div id="monster-area">
        <div id="monster-container">
          <img id="monster-img" src="character_monster_slime_green.png" alt="モンスター">
          <img id="damage-effect" src="bakuhatsu_01.png" alt="ダメージ">
          <div id="damage-number"></div>
          <div id="money-drop-area"></div>
          <div id="gold-drop-text"></div>
        </div>
      </div>

      <!-- ステータス＆ナビゲーション横並びエリア -->
      <div id="status-nav-row">
        <!-- 左側：HPとポーション（本気モード時のみ表示） -->
        <div id="player-status-container">
          <!-- プレイヤーHPゲージ -->
          <div id="player-hp-box" class="status-box">
            <div id="player-hp-label">❤️ HP</div>
            <div id="player-hp-bar-container">
              <div id="player-hp-bar"></div>
            </div>
            <div id="player-hp-text">100 / 100</div>
          </div>

          <!-- アイテムストック表示 -->
          <div id="item-stock-area" class="status-box">
            <span id="item-stock-label">💊 アイテム</span>
            <div class="item-slots-row">
              <div class="item-slot" id="potion-slot-1" onclick="usePotionFromSlot()" title="クリックで使用（HP回復）">
                <img src="portion_01_lightblue_02.png" alt="ポーション" class="item-icon">
              </div>
              <div class="item-slot" id="potion-slot-2" onclick="usePotionFromSlot()" title="クリックで使用（HP回復）">
                <img src="portion_01_lightblue_02.png" alt="ポーション" class="item-icon">
              </div>
              <div class="watch-slot empty" id="watch-slot-1" onclick="useWatchFromSlot()" title="クリックで使用（時間リセット）">
                <img src="udedokei_gold.png" alt="腕時計" class="item-icon">
              </div>
              <div class="watch-slot empty" id="watch-slot-2" onclick="useWatchFromSlot()" title="クリックで使用（時間リセット）">
                <img src="udedokei_gold.png" alt="腕時計" class="item-icon">
              </div>
            </div>
            <div id="potion-hint">クリックで使用</div>
          </div>
        </div>

        <!-- 右側：ナビゲーションボックス -->
        <div id="nav-guide-box">
          <p>⚔️ <strong>敵が現れた！</strong> 正しい答えをタイピングして撃退しろ！</p>
          <p>🔍 分からなかったら右の <strong>検索ボタン</strong> をクリックして調べろ！</p>
          <p>💊 アイテムは <strong>クリック</strong> で使用！💊=HP回復 ⏰=時間リセット</p>
        </div>
      </div>

      <div id="feedback"></div>

      <div id="explanation-box">
        <h4>解説</h4>
        <p id="explanation-text"></p>
      </div>

      <div id="next-btn-area">
        <button id="next-btn">次の問題へ</button>
        <span id="next-btn-hint">スペースキーでも進めるよ</span>
      </div>

      <div id="critical-hit-text" style="display:none;">CRITICAL HIT!</div>
      <div id="damage-number" style="display:none;"></div>
    </div>

    <!-- 結果画面 -->
    <div id="result-screen">
      <h2>結果発表！</h2>
      <div class="result-stats">
        <div class="stat-box">
          <div class="num" id="res-correct">0</div>
          <div class="label">正解</div>
        </div>
        <div class="stat-box">
          <div class="num" id="res-wrong">0</div>
          <div class="label">不正解</div>
        </div>
        <div class="stat-box">
          <div class="num" id="res-score">0</div>
          <div class="label">スコア</div>
        </div>
        <div class="stat-box">
          <div class="num" id="res-gold" style="color:#ffd700;">0</div>
          <div class="label">💰 獲得ゴールド</div>
        </div>
      </div>
      <p class="result-message" id="result-message"></p>
      <button class="btn btn-primary" id="retry-btn">もう一度遊ぶ</button>
    </div>

  </div>

  <!-- ===== 右サイドバー: 称号一覧 ===== -->
  <div id="sidebar-right" class="sidebar">
    <div class="dashboard-card" id="title-list-card">
      <h3>称号一覧 <span class="title-list-subtitle">- 称号を最初に解放した者の名がここに刻まれる</span></h3>
      <div class="title-list" id="title-list-content"></div>
    </div>
  </div>

  <!-- ===== 検索サイドパネル ===== -->
  <div id="search-side-panel">

    <!-- パネルヘッダー: 検索チップ -->
    <div id="side-panel-header">
      <h3>🔍 選択肢を調べよう！（クリックで検索）</h3>
      <div class="search-chips" id="search-chips"></div>
    </div>

    <!-- ブラウザバー -->
    <div id="search-browser-bar">
      <div class="browser-dots">
        <span class="browser-dot red"></span>
        <span class="browser-dot yellow"></span>
        <span class="browser-dot green"></span>
      </div>
      <div id="search-url-bar">選択肢をクリックして検索してね</div>
    </div>

    <!-- 検索結果表示エリア -->
    <div id="search-content">
      <div id="search-placeholder">
        <div class="placeholder-icon">🔎</div>
        <p>選択肢をクリックすると<br>ここにGoogle検索結果が表示されるよ！</p>
        <p class="placeholder-sub">わからない用語はどんどん調べよう</p>
      </div>
      <div id="search-loading">
        <div class="loading-spinner"></div>
        <p>検索中...</p>
      </div>
      <iframe id="search-iframe" sandbox="allow-scripts allow-same-origin allow-popups" loading="lazy"></iframe>
    </div>

    <!-- パネルフッター -->
    <div id="side-panel-footer">
      <div class="hint-text">うまく表示されないときはこちら ↓</div>
      <a id="google-open-link" class="google-open-btn" href="#" target="_blank" rel="noopener" style="display:none;">Google で開く ↗</a>
    </div>
  </div>

</div>

<!-- ゲームオーバーオーバーレイ -->
<div id="game-over-overlay">
  <div class="go-title">GAME OVER</div>
  <div class="go-reason" id="go-reason"></div>
</div>

<!-- 名前入力オーバーレイ -->
<div id="name-input-overlay">
  <div class="name-input-box">
    <h3>記録をランキングに登録しよう！</h3>
    <p id="name-input-desc">名前を入力してね</p>
    <input type="text" id="player-name-input" maxlength="12" placeholder="なまえ（12文字まで）" autocomplete="off">
    <div class="name-btn-row">
      <button class="name-btn-save" id="name-save-btn">登録する</button>
      <button class="name-btn-skip" id="name-skip-btn">スキップ</button>
    </div>
  </div>
</div>

<script src="questions.js"></script>
<script>

// ---------- ゲーム状態 ----------
let questions = [];
let currentIndex = 0;
let score = 0;
let totalGold = 0;
let correctCount = 0;
let wrongCount = 0;
let waitingForNext = false;
const NORMAL_QUESTIONS = 10;

// ---------- 本気モード状態 ----------
let gameMode = 'normal'; // 'normal' or 'mission'
let missionTimerId = null;
let missionTimeLeft = 0;
let missionTimerInterval = null;
const MISSION_TIME_PER_Q = 45; // 秒

// ---------- DOM要素 ----------
const startScreen    = document.getElementById('start-screen');
const gameScreen     = document.getElementById('game-screen');
const resultScreen   = document.getElementById('result-screen');
const startBtn       = document.getElementById('start-btn');
const retryBtn       = document.getElementById('retry-btn');
const qNum           = document.getElementById('q-num');
const qTotal         = document.getElementById('q-total');
const scoreVal       = document.getElementById('score-val');
const categoryBadge  = document.getElementById('category-badge');
const questionText   = document.getElementById('question-text');
const choicesList    = document.getElementById('choices-list');
const typingInput    = document.getElementById('typing-input');
const feedback       = document.getElementById('feedback');
const explanationBox = document.getElementById('explanation-box');
const explanationTxt = document.getElementById('explanation-text');
const nextBtnArea    = document.getElementById('next-btn-area');
const nextBtn        = document.getElementById('next-btn');

// タイマーDOM
const timerBarContainer = document.getElementById('timer-bar-container');
const timerBar          = document.getElementById('timer-bar');
const timerText         = document.getElementById('timer-text');

// ゲームオーバー
const gameOverOverlay = document.getElementById('game-over-overlay');
const goReason        = document.getElementById('go-reason');

// 検索サイドパネル
const searchSidePanel  = document.getElementById('search-side-panel');
const searchChips      = document.getElementById('search-chips');
const searchUrlBar     = document.getElementById('search-url-bar');
const searchIframe     = document.getElementById('search-iframe');
const searchLoading    = document.getElementById('search-loading');
const searchPlaceholder = document.getElementById('search-placeholder');
const googleOpenLink   = document.getElementById('google-open-link');

// モンスター表示
const monsterImg       = document.getElementById('monster-img');
const damageEffect     = document.getElementById('damage-effect');
const damageNumber     = document.getElementById('damage-number');
const moneyDropArea    = document.getElementById('money-drop-area');
const goldDropText     = document.getElementById('gold-drop-text');
const goldVal          = document.getElementById('gold-val');
const goldDisplay      = document.getElementById('gold-display');

// ポーション関連
const POTION_HEAL_MIN = 15;
const POTION_HEAL_MAX = 30;
const MAX_POTION_STOCK = 2;
let potionStock = 0;

// 腕時計関連
const MAX_WATCH_STOCK = 2;
let watchStock = 0;

// アイテムドロップ確率（100%で何かドロップ、50%でポーション、50%で腕時計）
const ITEM_DROP_CHANCE = 1.0;

// ポーション回復音
const healSound = new Audio('ゲージ回復1.mp3');
healSound.volume = 0.5;

// 腕時計使用音
const watchSound = new Audio('重力魔法1.mp3');
watchSound.volume = 0.5;

// ---------- ユーティリティ ----------
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function normalize(str) {
  return str.trim().toLowerCase().replace(/\s+/g, '');
}

// ---------- サウンド制御 ----------
let isMutedAll = false;
let isMutedBgm = false;

function updateSoundButtons() {
  // ヘッダーのボタン
  const btnAll = document.getElementById('btn-mute-all');
  const btnBgm = document.getElementById('btn-mute-bgm');
  // ダッシュボードのボタン
  const btnAllDash = document.getElementById('btn-mute-all-dash');
  const btnBgmDash = document.getElementById('btn-mute-bgm-dash');

  if (isMutedAll) {
    [btnAll, btnAllDash].forEach(b => { if(b) { b.textContent = '🔇 全音OFF'; b.classList.add('off'); }});
  } else {
    [btnAll, btnAllDash].forEach(b => { if(b) { b.textContent = '🔊 全音ON'; b.classList.remove('off'); }});
  }

  if (isMutedBgm) {
    [btnBgm, btnBgmDash].forEach(b => { if(b) { b.textContent = '🎵 BGM OFF'; b.classList.add('off'); }});
  } else {
    [btnBgm, btnBgmDash].forEach(b => { if(b) { b.textContent = '🎵 BGM ON'; b.classList.remove('off'); }});
  }
}

function isGamePlaying() {
  return document.body.classList.contains('panel-open');
}

function toggleMuteAll() {
  isMutedAll = !isMutedAll;
  if (isMutedAll) {
    stopBgm();
  } else {
    // ゲーム中のみBGMを再生
    if (!isMutedBgm && isGamePlaying()) startBgm();
  }
  updateSoundButtons();
}

function toggleMuteBgm() {
  isMutedBgm = !isMutedBgm;
  if (isMutedBgm) {
    stopBgm();
  } else {
    // ゲーム中のみBGMを再生
    if (!isMutedAll && isGamePlaying()) startBgm();
  }
  updateSoundButtons();
}

// ---------- キー入力音 ----------
const keySoundPool = [];
const KEY_SOUND_POOL_SIZE = 6;
for (let i = 0; i < KEY_SOUND_POOL_SIZE; i++) {
  const a = new Audio('キーボード1.mp3');
  a.volume = 0.4;
  keySoundPool.push(a);
}
let keySoundIndex = 0;

function playKeySound() {
  if (isMutedAll) return;
  const sound = keySoundPool[keySoundIndex];
  sound.currentTime = 0;
  sound.play().catch(() => {});
  keySoundIndex = (keySoundIndex + 1) % KEY_SOUND_POOL_SIZE;
}

// ---------- 正解音 ----------
const correctSound = new Audio('クイズ正解1.mp3');
correctSound.volume = 0.5;

function playCorrectSound() {
  if (isMutedAll) return;
  correctSound.currentTime = 0;
  correctSound.play().catch(() => {});
}

// ---------- 不正解音 ----------
const wrongSound = new Audio('大キック.mp3');
wrongSound.volume = 0.6;

function playWrongSound() {
  if (isMutedAll) return;
  wrongSound.currentTime = 0;
  wrongSound.play().catch(() => {});
}

// ---------- 検索ボタン音 ----------
function playSearchBtnSound() {
  if (isMutedAll) return;
  const s = new Audio('決定ボタンを押す41.mp3');
  s.volume = 0.4;
  s.play().catch(() => {});
}

// ---------- 自分ダメージ演出 ----------
const playerDamageOverlay = document.getElementById('player-damage-overlay');
const gameContainer = document.getElementById('game-container');

function showPlayerDamage() {
  playWrongSound();

  // 画面を赤く点滅
  playerDamageOverlay.className = '';
  void playerDamageOverlay.offsetWidth;
  playerDamageOverlay.className = 'show';

  // ゲーム画面を揺らす
  gameContainer.classList.remove('player-hit');
  void gameContainer.offsetWidth;
  gameContainer.classList.add('player-hit');

  setTimeout(() => {
    playerDamageOverlay.className = '';
    playerDamageOverlay.style.display = 'none';
    gameContainer.classList.remove('player-hit');
  }, 700);
}

// ---------- HPシステム ----------
const PLAYER_MAX_HP = 100;
const DMG_MIN = 1;
const DMG_MAX = 50;
const CRIT_DMG_MIN = 30;
const CRIT_DMG_MAX = 99;
const CRIT_CHANCE = 0.1; // 10%
let playerHp = PLAYER_MAX_HP;

function updateHpBar() {
  const hpBar = document.getElementById('player-hp-bar');
  const hpText = document.getElementById('player-hp-text');
  const pct = (playerHp / PLAYER_MAX_HP) * 100;
  hpBar.style.width = pct + '%';
  hpText.textContent = playerHp + ' / ' + PLAYER_MAX_HP;

  hpBar.classList.remove('hp-mid', 'hp-low');
  if (pct <= 25) {
    hpBar.classList.add('hp-low');
  } else if (pct <= 50) {
    hpBar.classList.add('hp-mid');
  }
}

function showHpBar() {
  const container = document.getElementById('player-status-container');
  if (gameMode === 'mission') {
    container.classList.add('visible');
  } else {
    container.classList.remove('visible');
  }
}

function resetHp() {
  playerHp = PLAYER_MAX_HP;
  potionStock = 0;
  watchStock = 0;
  updateHpBar();
  updatePotionUI();
  updateWatchUI();
}

// ---------- ポーションシステム ----------
function updatePotionUI() {
  const slot1 = document.getElementById('potion-slot-1');
  const slot2 = document.getElementById('potion-slot-2');

  // スロット1
  if (potionStock >= 1) {
    slot1.classList.remove('empty');
  } else {
    slot1.classList.add('empty');
  }
  // スロット2
  if (potionStock >= 2) {
    slot2.classList.remove('empty');
  } else {
    slot2.classList.add('empty');
  }
}

// ---------- 腕時計システム ----------
function updateWatchUI() {
  const slot1 = document.getElementById('watch-slot-1');
  const slot2 = document.getElementById('watch-slot-2');

  if (!slot1 || !slot2) {
    console.error('Watch slots not found!');
    return;
  }

  // スロット2から埋める、スロット2から消す（右から左へ）
  // スロット1
  if (watchStock >= 1) {
    slot1.classList.remove('empty');
  } else {
    slot1.classList.add('empty');
  }
  // スロット2
  if (watchStock >= 2) {
    slot2.classList.remove('empty');
  } else {
    slot2.classList.add('empty');
  }

  console.log('updateWatchUI called, watchStock:', watchStock, 'slot1 empty:', slot1.classList.contains('empty'), 'slot2 empty:', slot2.classList.contains('empty'));
}

function showWatchDrop() {
  // 画面中央に腕時計獲得表示
  const display = document.getElementById('watch-drop-display');
  display.classList.remove('show');
  void display.offsetWidth;
  display.classList.add('show');

  // ドロップ時も効果音を鳴らす
  if (!isMutedAll) {
    watchSound.currentTime = 0;
    watchSound.play().catch(() => {});
  }

  // 3.5秒後に非表示（アニメーションと同期）
  setTimeout(() => {
    display.classList.remove('show');
  }, 3500);
}

function useWatch() {
  console.log('useWatch() called! Creating effects...');
  // 時間をリセット
  missionTimeLeft = MISSION_TIME_PER_Q;
  updateTimerDisplay();
  console.log('Timer reset to:', missionTimeLeft);

  // 効果音
  if (!isMutedAll) {
    console.log('Playing watch sound');
    watchSound.currentTime = 0;
    watchSound.play().catch((e) => console.log('Sound error:', e));
  }

  // 画面いっぱいのエフェクトオーバーレイ（金色フラッシュ）
  console.log('Creating time-reset-overlay');
  const timeOverlay = document.createElement('div');
  timeOverlay.className = 'time-reset-overlay';
  document.body.appendChild(timeOverlay);
  setTimeout(() => timeOverlay.remove(), 2000);

  // 時計が回転するエフェクト
  const clockEffect = document.createElement('div');
  clockEffect.className = 'time-reset-clock';
  clockEffect.innerHTML = '<img src="udedokei_gold.png" alt="時計">';
  document.body.appendChild(clockEffect);
  setTimeout(() => clockEffect.remove(), 2000);

  // 時間リセットテキスト演出（大きく表示）
  const timeText = document.createElement('div');
  timeText.className = 'time-reset-effect';
  timeText.textContent = '⏰ 時間リセット!';
  document.body.appendChild(timeText);
  setTimeout(() => timeText.remove(), 2500);
}

function useWatchFromSlot() {
  console.log('useWatchFromSlot called, watchStock before:', watchStock);
  if (watchStock <= 0) {
    console.log('No watch in stock, returning');
    return;
  }

  watchStock--;
  console.log('watchStock after decrement:', watchStock);
  useWatch();
  updateWatchUI();
}

function usePotionFromSlot() {
  usePotionFromStock();
}

// ---------- アイテムドロップシステム ----------
function tryDropItem() {
  console.log('tryDropItem called, potionStock:', potionStock, 'watchStock:', watchStock);
  // アイテムドロップ判定
  if (Math.random() >= ITEM_DROP_CHANCE) {
    console.log('No item drop (random check failed)');
    return;
  }

  // ポーションと腕時計のどちらをドロップするか決定
  // どちらかが満タンの場合はもう一方をドロップ
  const potionFull = potionStock >= MAX_POTION_STOCK;
  const watchFull = watchStock >= MAX_WATCH_STOCK;
  console.log('potionFull:', potionFull, 'watchFull:', watchFull);

  if (potionFull && watchFull) {
    // 両方満タンなら何もしない
    console.log('Both full, no drop');
    return;
  }

  if (potionFull) {
    // ポーション満タンなら腕時計をドロップ
    watchStock++;
    console.log('Dropped WATCH, new watchStock:', watchStock);
    updateWatchUI();
    showWatchDrop();
  } else if (watchFull) {
    // 腕時計満タンならポーションをドロップ
    potionStock++;
    console.log('Dropped POTION, new potionStock:', potionStock);
    updatePotionUI();
    showPotionDrop();
  } else {
    // どちらも空きがあれば50%の確率でどちらかをドロップ
    if (Math.random() < 0.5) {
      potionStock++;
      console.log('Dropped POTION (random), new potionStock:', potionStock);
      updatePotionUI();
      showPotionDrop();
    } else {
      watchStock++;
      console.log('Dropped WATCH (random), new watchStock:', watchStock);
      updateWatchUI();
      showWatchDrop();
    }
  }
}

function showPotionDrop() {
  // 画面中央にポーション獲得表示
  const display = document.getElementById('potion-drop-display');
  display.classList.remove('show');
  void display.offsetWidth;
  display.classList.add('show');

  // ドロップ時も効果音を鳴らす
  if (!isMutedAll) {
    healSound.currentTime = 0;
    healSound.play().catch(() => {});
  }

  // 3.5秒後に非表示（アニメーションと同期）
  setTimeout(() => {
    display.classList.remove('show');
  }, 3500);
}

function usePotion() {
  if (playerHp >= PLAYER_MAX_HP) return; // 満タンなら使えない

  const healAmount = Math.floor(Math.random() * (POTION_HEAL_MAX - POTION_HEAL_MIN + 1)) + POTION_HEAL_MIN;
  const oldHp = playerHp;
  playerHp = Math.min(PLAYER_MAX_HP, playerHp + healAmount);
  const actualHeal = playerHp - oldHp;

  // 回復音
  if (!isMutedAll) {
    healSound.currentTime = 0;
    healSound.play().catch(() => {});
  }

  // 画面いっぱいの回復オーバーレイ
  const healOverlay = document.createElement('div');
  healOverlay.className = 'heal-overlay';
  document.body.appendChild(healOverlay);
  setTimeout(() => healOverlay.remove(), 1000);

  // 回復テキスト演出
  const healText = document.createElement('div');
  healText.className = 'heal-effect';
  healText.textContent = '+' + actualHeal + ' HP回復！';
  document.body.appendChild(healText);
  setTimeout(() => healText.remove(), 1200);

  updateHpBar();
}

function usePotionFromStock() {
  if (potionStock <= 0) return;
  if (playerHp >= PLAYER_MAX_HP) return;

  potionStock--;
  usePotion();
  updatePotionUI();
}

function dealDamageToPlayer() {
  const isCritical = Math.random() < CRIT_CHANCE;
  let damage;
  if (isCritical) {
    damage = Math.floor(Math.random() * (CRIT_DMG_MAX - CRIT_DMG_MIN + 1)) + CRIT_DMG_MIN;
  } else {
    damage = Math.floor(Math.random() * (DMG_MAX - DMG_MIN + 1)) + DMG_MIN;
  }

  playerHp = Math.max(0, playerHp - damage);
  updateHpBar();

  // 画面中央にダメージ数字を大きく表示
  const playerDmgNum = document.getElementById('player-damage-number');
  playerDmgNum.textContent = '-' + damage;
  playerDmgNum.classList.remove('show');
  void playerDmgNum.offsetWidth;
  playerDmgNum.classList.add('show');
  setTimeout(() => {
    playerDmgNum.classList.remove('show');
  }, 3000);

  // クリティカルヒット演出
  if (isCritical) {
    const critText = document.getElementById('critical-hit-text');
    critText.style.display = 'block';
    critText.style.animation = 'none';
    void critText.offsetWidth;
    critText.style.animation = '';

    // 画面を激しく揺らす（クリティカル専用）
    gameContainer.classList.remove('player-hit', 'critical-hit');
    void gameContainer.offsetWidth;
    gameContainer.classList.add('critical-hit');

    // 赤フラッシュ
    const critFlash = document.getElementById('critical-flash-overlay');
    critFlash.classList.remove('show');
    void critFlash.offsetWidth;
    critFlash.classList.add('show');

    setTimeout(() => {
      critText.style.display = 'none';
      gameContainer.classList.remove('critical-hit');
      critFlash.classList.remove('show');
    }, 1200);
  }

  return playerHp <= 0;
}

// ---------- BGM（3問ごとに切り替え） ----------
const BGM_TRACKS = [
  'iwashiro_elevate_perfect.mp3',
  'iwashiro_pareidolia.mp3',
  'iwashiro_shien_no_makutsu_8bit.mp3',
  'iwashiro_tousoushin1.mp3'
];
const BGM_VOLUME = 0.1;
let currentBgm = null;
let currentBgmIndex = -1;
let bgmDefeatCount = 0;

function startBgm() {
  if (isMutedAll || isMutedBgm) return;
  // 初回 or 3体倒すごとに曲を切り替え
  const needSwitch = currentBgm === null || bgmDefeatCount >= 3;
  if (needSwitch) {
    if (currentBgm) {
      currentBgm.pause();
      currentBgm.currentTime = 0;
    }
    bgmDefeatCount = 0;
    currentBgmIndex = (currentBgmIndex + 1) % BGM_TRACKS.length;
    currentBgm = new Audio(BGM_TRACKS[currentBgmIndex]);
    currentBgm.volume = BGM_VOLUME;
    currentBgm.loop = true;
  }
  currentBgm.play().catch(() => {});
}

function stopBgm() {
  if (currentBgm) {
    currentBgm.pause();
  }
}

function resetBgm() {
  if (currentBgm) {
    currentBgm.pause();
    currentBgm.currentTime = 0;
  }
  currentBgm = null;
  currentBgmIndex = -1;
  bgmDefeatCount = 0;
}

// 旧API互換（既存の呼び出し箇所をそのまま使えるように）
function startTimerSound() {
  startBgm();
}

function stopTimerSound() {
  stopBgm();
}

// ---------- 打撃音（ダメージエフェクト用） ----------
const punchSoundPool = [];
const PUNCH_SOUND_POOL_SIZE = 6;
for (let i = 0; i < PUNCH_SOUND_POOL_SIZE; i++) {
  const a = new Audio('小パンチ.mp3');
  a.volume = 0.5;
  punchSoundPool.push(a);
}
let punchSoundIndex = 0;

function playPunchSound() {
  if (isMutedAll) return;
  const sound = punchSoundPool[punchSoundIndex];
  sound.currentTime = 0;
  sound.play().catch(() => {});
  punchSoundIndex = (punchSoundIndex + 1) % PUNCH_SOUND_POOL_SIZE;
}

// ---------- モンスター演出（ドラクエ風） ----------
const MONSTER_IMAGES = [
  'character_monster_slime_green.png',
  'character_monster_frankenstein_02_green.png',
  'character_monster_gargoyle_stone.png',
  'character_monster_ghost_white.png',
  'character_monster_golem_brown.png',
  'character_monster_golem_gray.png',
  'character_monster_hana_02.png',
  'character_monster_jackolantern_green.png',
  'character_monster_kyuketsuki_02_purple.png',
  'character_monster_mimic_green.png',
  'character_monster_treant_02_green.png',
  'character_monster_yeti_02_black.png'
];
let monsterDefeated = false;

function showMonster() {
  monsterDefeated = false;
  // ランダムにモンスターを選択
  const randomMonster = MONSTER_IMAGES[Math.floor(Math.random() * MONSTER_IMAGES.length)];
  monsterImg.src = randomMonster;
  monsterImg.style.display = '';
  monsterImg.style.opacity = '1';
  monsterImg.style.transform = '';
  monsterImg.className = 'appear';
  damageEffect.className = '';
  damageNumber.className = '';
  damageNumber.textContent = '';
}

function showDamageEffect() {
  if (monsterDefeated) return;

  playPunchSound();

  // ダメージ数値をランダムで表示（ドラクエ風）
  const dmg = Math.floor(Math.random() * 30) + 5;
  damageNumber.textContent = dmg;

  // エフェクトのランダム位置（少しずらす）
  const offsetX = Math.floor(Math.random() * 40) - 20;
  const offsetY = Math.floor(Math.random() * 40) - 20;
  damageEffect.style.left = `calc(50% + ${offsetX}px)`;
  damageEffect.style.top = `calc(50% + ${offsetY}px)`;

  // アニメーションをリセットして再発動
  damageEffect.className = '';
  damageNumber.className = '';
  monsterImg.classList.remove('hit');
  void damageEffect.offsetWidth; // reflow
  damageEffect.className = 'show';
  damageNumber.className = 'show';
  monsterImg.classList.add('hit');

  // hitクラスを短時間後に除去（次のキーで再発動できるように）
  setTimeout(() => {
    monsterImg.classList.remove('hit');
  }, 150);
}

function defeatMonster() {
  monsterDefeated = true;
  monsterImg.className = 'defeat';
  damageEffect.className = '';
  damageNumber.className = '';
}

function fadeOutMonster() {
  monsterDefeated = true;
  monsterImg.className = 'fade-out';
  damageEffect.className = '';
  damageNumber.className = '';
}

// ---------- ボスバトルシステム ----------
const BOSS_IMAGES = [
  'ボス/character_monster_dragon_01_red.png',      // 10問: IT見習い
  'ボス/character_monster_dragon_01_white.png',   // 20問: IT冒険者
  'ボス/character_monster_dragon_02_yellow.png',  // 30問: IT騎士
  'ボス/character_darkknight_04.png',             // 40問: IT勇者
  'ボス/character_datenshi_01_01_black.png',      // 50問: IT魔法使い
  'ボス/character_yosei_01_green.png',            // 60問: IT賢者
  'ボス/character_hero_red.png',                  // 70問: ITマスター
  'ボス/character_daitenshi_02_02_brown.png',     // 80問: IT博士
  'ボス/character_megami_01_pink.png',            // 90問: ITゴッド
  'ボス/character_daiakuma_01_02_black.png'       // 100問: IT伝説王
];
const BOSS_THRESHOLDS = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
const BOSS_COMBO_REQUIRED = 3; // 連続正解数
let isBossBattle = false;
let bossComboCount = 0;
let currentBossIndex = -1;
let bossBattleStartQuestion = 0;

function isBossQuestion(questionNumber) {
  return BOSS_THRESHOLDS.includes(questionNumber);
}

function getBossIndex(questionNumber) {
  return BOSS_THRESHOLDS.indexOf(questionNumber);
}

function startBossBattle(bossIndex) {
  isBossBattle = true;
  bossComboCount = 0;
  currentBossIndex = bossIndex;
  bossBattleStartQuestion = currentIndex;
  showBossUI();
  showBoss(bossIndex);
}

function showBoss(bossIndex) {
  monsterDefeated = false;
  monsterImg.src = BOSS_IMAGES[bossIndex];
  monsterImg.style.display = '';
  monsterImg.style.opacity = '1';
  monsterImg.style.transform = 'scale(1.3)';
  monsterImg.className = 'appear';
  damageEffect.className = '';
  damageNumber.className = '';
  damageNumber.textContent = '';
}

function showBossUI() {
  const bossUI = document.getElementById('boss-battle-ui');
  const bossComboDisplay = document.getElementById('boss-combo-display');
  bossUI.style.display = 'block';
  bossComboDisplay.textContent = `連続正解: ${bossComboCount} / ${BOSS_COMBO_REQUIRED}`;
  bossUI.className = '';
  void bossUI.offsetWidth;
  bossUI.className = 'show';
}

function updateBossCombo() {
  const bossComboDisplay = document.getElementById('boss-combo-display');
  bossComboDisplay.textContent = `連続正解: ${bossComboCount} / ${BOSS_COMBO_REQUIRED}`;
}

function hideBossUI() {
  const bossUI = document.getElementById('boss-battle-ui');
  bossUI.style.display = 'none';
}

function endBossBattle(victory) {
  isBossBattle = false;
  currentBossIndex = -1;
  hideBossUI();
  if (victory) {
    defeatMonster();
  }
}

function resetBossCombo() {
  bossComboCount = 0;
  updateBossCombo();
}

// ---------- お金ドロップ演出 ----------
const moneySound = new Audio('お金がジャラジャラ.mp3');
moneySound.volume = 0.5;

function playMoneySound() {
  if (isMutedAll) return;
  moneySound.currentTime = 0;
  moneySound.play().catch(() => {});
}

function dropMoney() {
  // ランダム金額（100〜999G）
  const gold = Math.floor(Math.random() * 900) + 100;
  totalGold += gold;
  goldVal.textContent = totalGold.toLocaleString();

  // HUDゴールド点滅
  goldDisplay.classList.remove('flash');
  void goldDisplay.offsetWidth;
  goldDisplay.classList.add('flash');

  // 前回のドロップをクリア
  moneyDropArea.innerHTML = '';
  goldDropText.className = '';
  goldDropText.textContent = '';

  // 少し遅延してドロップ演出開始（モンスター吹き飛び後）
  setTimeout(() => {
    playMoneySound();

    // お札とコインをランダムに散らす
    const spriteCount = Math.floor(Math.random() * 4) + 4; // 4〜7枚
    for (let i = 0; i < spriteCount; i++) {
      const img = document.createElement('img');
      img.className = 'money-sprite';
      img.src = Math.random() > 0.5 ? 'shihei_1000yen.png' : 'koka_5yen.png';

      // ランダムな飛散方向
      const angle = Math.random() * 360;
      const dist = 40 + Math.random() * 60;
      const tx = Math.cos(angle * Math.PI / 180) * dist;
      const ty = Math.sin(angle * Math.PI / 180) * dist - 30;
      const rot = (Math.random() - 0.5) * 360;
      const duration = 0.7 + Math.random() * 0.4;
      const delay = Math.random() * 0.15;

      img.style.setProperty('--tx', tx + 'px');
      img.style.setProperty('--ty', ty + 'px');
      img.style.setProperty('--rot', rot + 'deg');
      img.style.setProperty('--duration', duration + 's');
      img.style.animationDelay = delay + 's';

      moneyDropArea.appendChild(img);
      // reflowしてからアニメーション開始
      void img.offsetWidth;
      img.classList.add('animate');
    }

    // ゴールド金額テキスト表示
    goldDropText.textContent = `+${gold} G`;
    void goldDropText.offsetWidth;
    goldDropText.className = 'show';

    // アニメーション後にクリア
    setTimeout(() => {
      moneyDropArea.innerHTML = '';
      goldDropText.className = '';
    }, 1300);
  }, 300);
}

// タイピング入力欄でキーが押されたら音とダメージエフェクトを出す
document.getElementById('typing-input').addEventListener('keydown', (e) => {
  if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key.length === 1) {
    playKeySound();
    showDamageEffect();
  }
});

// ---------- モード選択 ----------
function selectMode(mode) {
  gameMode = mode;
  document.querySelectorAll('.mode-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.mode === mode);
  });
  updateQCountInfo();
}

// ---------- 検索機能 ----------
let currentSearchTerm = '';

// ---------- 魔法エフェクト（検索時） ----------
const magicContainer = document.getElementById('magic-effect-container');

function showMagicEffect() {
  magicContainer.innerHTML = '';

  // パネルの画面上の位置を取得してコンテナを重ねる
  const rect = searchSidePanel.getBoundingClientRect();
  magicContainer.style.left = rect.left + 'px';
  magicContainer.style.top = rect.top + 'px';
  magicContainer.style.width = rect.width + 'px';
  magicContainer.style.height = rect.height + 'px';

  // パネル全体の光演出
  searchSidePanel.classList.remove('magic-glow');
  void searchSidePanel.offsetWidth;
  searchSidePanel.classList.add('magic-glow');

  const types = ['spark', 'star', 'ring'];
  const count = 25;
  const panelW = rect.width;
  const panelH = rect.height;

  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    const type = types[Math.floor(Math.random() * types.length)];
    p.className = 'magic-particle ' + type;

    // パネル四辺から出現
    const edge = Math.floor(Math.random() * 4);
    let startX, startY;
    if (edge === 0) { startX = Math.random() * panelW; startY = 0; }
    else if (edge === 1) { startX = Math.random() * panelW; startY = panelH; }
    else if (edge === 2) { startX = 0; startY = Math.random() * panelH; }
    else { startX = panelW; startY = Math.random() * panelH; }

    p.style.left = startX + 'px';
    p.style.top = startY + 'px';

    // 中心方向に向かって飛ぶ
    const tx = (panelW / 2 - startX) * (0.4 + Math.random() * 0.4);
    const ty = (panelH / 2 - startY) * (0.4 + Math.random() * 0.4);
    const dur = 0.5 + Math.random() * 0.6;
    const delay = Math.random() * 0.3;

    p.style.setProperty('--tx', tx + 'px');
    p.style.setProperty('--ty', ty + 'px');
    p.style.setProperty('--dur', dur + 's');
    p.style.setProperty('--delay', delay + 's');

    magicContainer.appendChild(p);
  }

  setTimeout(() => {
    magicContainer.innerHTML = '';
    searchSidePanel.classList.remove('magic-glow');
  }, 1200);
}

function openSearch(term) {
  playSearchBtnSound();
  showMagicEffect();
  currentSearchTerm = term;
  const searchQuery = term + ' IT用語 とは わかりやすく';
  const googleUrl = 'https://www.google.com/search?igu=1&q=' + encodeURIComponent(searchQuery);
  const directUrl = 'https://www.google.com/search?q=' + encodeURIComponent(searchQuery);

  searchUrlBar.textContent = 'google.com/search?q=' + encodeURIComponent(term + ' IT用語 とは');
  searchPlaceholder.style.display = 'none';
  searchLoading.style.display = 'flex';
  searchIframe.style.display = 'none';
  searchIframe.src = googleUrl;

  searchIframe.onload = function() {
    searchLoading.style.display = 'none';
    searchIframe.style.display = 'block';
  };

  setTimeout(() => {
    if (searchLoading.style.display === 'flex') {
      searchLoading.style.display = 'none';
      searchIframe.style.display = 'block';
    }
  }, 3000);

  googleOpenLink.href = directUrl;
  googleOpenLink.style.display = 'inline-block';
  document.querySelectorAll('.search-chip').forEach(chip => {
    chip.classList.toggle('active', chip.dataset.term === term);
  });
}

function resetSearchPanel() {
  searchPlaceholder.style.display = 'flex';
  searchLoading.style.display = 'none';
  searchIframe.style.display = 'none';
  searchIframe.src = 'about:blank';
  searchUrlBar.textContent = '選択肢をクリックして検索してね';
  googleOpenLink.style.display = 'none';
  document.querySelectorAll('.search-chip').forEach(c => c.classList.remove('active'));
  currentSearchTerm = '';
}

// ---------- カテゴリ選択 ----------
const qCountInfo = document.getElementById('q-count-info');

function getSelectedCategory() {
  const checked = document.querySelector('input[name="cat"]:checked');
  return checked ? checked.value : 'all';
}

function getFilteredQuestions(cat) {
  if (cat === 'all') return ALL_QUESTIONS;
  return ALL_QUESTIONS.filter(q => q.category === cat);
}

function updateQCountInfo() {
  const cat = getSelectedCategory();
  const count = getFilteredQuestions(cat).length;
  if (gameMode === 'mission') {
    qCountInfo.textContent = `全 ${count} 問 ─ HPが尽きるまで敵を倒して稼ぎまくれ！（1問45秒）`;
  } else {
    const numToAsk = Math.min(NORMAL_QUESTIONS, count);
    qCountInfo.textContent = `全 ${count} 問からランダムに${numToAsk}問出題`;
  }
}

document.querySelectorAll('input[name="cat"]').forEach(radio => {
  radio.addEventListener('change', updateQCountInfo);
});

updateQCountInfo();

// ---------- タイマー ----------
function startTimer() {
  missionTimeLeft = MISSION_TIME_PER_Q;
  timerBarContainer.style.display = 'block';
  timerText.style.display = 'block';
  updateTimerDisplay();

  missionTimerInterval = setInterval(() => {
    missionTimeLeft -= 0.1;
    if (missionTimeLeft <= 0) {
      missionTimeLeft = 0;
      clearInterval(missionTimerInterval);
      missionTimerInterval = null;
      updateTimerDisplay();
      handleTimeout();
    } else {
      updateTimerDisplay();
    }
  }, 100);
}

function stopTimer() {
  if (missionTimerInterval) {
    clearInterval(missionTimerInterval);
    missionTimerInterval = null;
  }
}

function hideTimer() {
  timerBarContainer.style.display = 'none';
  timerText.style.display = 'none';
}

function updateTimerDisplay() {
  const pct = (missionTimeLeft / MISSION_TIME_PER_Q) * 100;
  timerBar.style.width = pct + '%';

  const sec = Math.ceil(missionTimeLeft);
  timerText.textContent = `残り ${sec} 秒`;

  // 色の切り替え
  timerBar.classList.remove('warning', 'danger');
  timerText.classList.remove('warning', 'danger');
  if (missionTimeLeft <= 15) {
    timerBar.classList.add('danger');
    timerText.classList.add('danger');
  } else if (missionTimeLeft <= 22) {
    timerBar.classList.add('warning');
    timerText.classList.add('warning');
  }
}

function handleTimeout() {
  stopTimerSound();
  fadeOutMonster();
  showPlayerDamage();
  const q = questions[currentIndex];
  typingInput.disabled = true;
  typingInput.classList.add('wrong');

  // ボス戦中ならコンボリセット
  if (isBossBattle) {
    resetBossCombo();
    feedback.textContent = `タイムアウト！コンボが途切れた！正解は「${q.answer}」`;
  } else {
    feedback.textContent = `タイムアウト！正解は「${q.answer}」でした`;
  }
  feedback.className = 'wrong';
  wrongCount++;

  const blank = document.getElementById('blank-display');
  if (blank) {
    blank.textContent = q.answer;
    blank.style.borderColor = '#f44336';
  }

  document.querySelectorAll('.choice-chip').forEach(chip => {
    chip.classList.remove('highlight');
    if (normalize(chip.dataset.value) === normalize(q.answer)) {
      chip.classList.add('correct-done');
    }
  });

  showExplanation(q);

  // 本気モードの場合、HPダメージ → HP0ならゲームオーバー
  if (gameMode === 'mission') {
    const isDead = dealDamageToPlayer();
    if (isDead) {
      showMissionGameOver('HP消滅');
    } else {
      showNextButton();
    }
  } else {
    showNextButton();
  }
}

// ---------- ゲーム開始 ----------
function startGame() {
  const cat = getSelectedCategory();
  const pool = getFilteredQuestions(cat);

  if (gameMode === 'mission') {
    questions = shuffle(pool); // 全問出題
  } else {
    const numToAsk = Math.min(NORMAL_QUESTIONS, pool.length);
    questions = shuffle(pool).slice(0, numToAsk);
  }

  currentIndex = 0;
  score = 0;
  totalGold = 0;
  correctCount = 0;
  wrongCount = 0;
  resetBgm();
  resetHp();

  qTotal.textContent = questions.length;
  scoreVal.textContent = 0;
  goldVal.textContent = '0';

  startScreen.classList.add('hidden');
  resultScreen.style.display = 'none';
  gameScreen.classList.remove('hidden');

  searchSidePanel.style.display = 'flex';
  document.body.classList.add('panel-open');

  showHpBar();
  showQuestion();
}

// ---------- 問題表示 ----------
function showQuestion() {
  const q = questions[currentIndex];

  qNum.textContent = currentIndex + 1;
  categoryBadge.textContent = q.category;

  const htmlQ = q.question.replace('＿＿＿', '<span class="blank" id="blank-display">？？？</span>');
  questionText.innerHTML = htmlQ;

  choicesList.innerHTML = '';
  const shuffledChoices = shuffle(q.choices);
  shuffledChoices.forEach(c => {
    const chip = document.createElement('div');
    chip.className = 'choice-chip';
    chip.textContent = c;
    chip.dataset.value = c;
    choicesList.appendChild(chip);
  });

  searchChips.innerHTML = '';
  const shuffledSearchChoices = shuffle(q.choices);
  shuffledSearchChoices.forEach(c => {
    const chip = document.createElement('span');
    chip.className = 'search-chip';
    chip.dataset.term = c;
    chip.innerHTML = c + ' <span style="opacity:0.6">🔎</span>';
    chip.addEventListener('click', () => openSearch(c));
    searchChips.appendChild(chip);
  });

  resetSearchPanel();

  typingInput.value = '';
  typingInput.className = '';
  typingInput.disabled = false;
  typingInput.placeholder = `「${q.choices.join('」「')}」のどれかをタイピング`;
  feedback.textContent = '';
  feedback.className = '';
  explanationBox.style.display = 'none';
  hideNextButton();

  // 本気モードならタイマー開始
  if (gameMode === 'mission') {
    startTimer();
  } else {
    hideTimer();
  }

  // タイマーBGM開始
  startTimerSound();

  // ボス戦判定（本気モードで、正解数が称号しきい値に達した場合）
  const questionNumber = correctCount + 1;
  if (gameMode === 'mission' && isBossQuestion(questionNumber) && !isBossBattle) {
    const bossIndex = getBossIndex(questionNumber);
    startBossBattle(bossIndex);
  } else if (!isBossBattle) {
    // 通常モンスター登場
    showMonster();
  }

  typingInput.focus();
}

// ---------- 入力判定 ----------
typingInput.addEventListener('input', () => {
  const q = questions[currentIndex];
  const inputVal = normalize(typingInput.value);
  const answerVal = normalize(q.answer);

  document.querySelectorAll('.choice-chip').forEach(chip => {
    const chipVal = normalize(chip.dataset.value);
    if (chipVal.startsWith(inputVal) && inputVal.length > 0) {
      chip.classList.add('highlight');
    } else {
      chip.classList.remove('highlight');
    }
  });

  if (inputVal === answerVal) {
    handleCorrect(q);
  } else {
    const wrongChoice = q.choices.find(c => normalize(c) === inputVal && normalize(c) !== answerVal);
    if (wrongChoice) {
      handleWrong(q, wrongChoice);
    }
  }
});

typingInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const q = questions[currentIndex];
    const inputVal = normalize(typingInput.value);
    const answerVal = normalize(q.answer);

    if (inputVal === answerVal) {
      handleCorrect(q);
    } else if (inputVal.length > 0) {
      const matched = q.choices.find(c => normalize(c) === inputVal);
      if (matched) {
        if (normalize(matched) === answerVal) {
          handleCorrect(q);
        } else {
          handleWrong(q, matched);
        }
      } else {
        feedback.textContent = '選択肢の中から正しい答えをタイピングしてね！';
        feedback.className = 'wrong';
        typingInput.classList.add('wrong');
        setTimeout(() => typingInput.classList.remove('wrong'), 400);
      }
    }
  }
});

function handleCorrect(q) {
  stopTimer();
  stopTimerSound();
  bgmDefeatCount++;
  playCorrectSound();

  typingInput.disabled = true;
  typingInput.classList.add('correct');
  feedback.className = 'correct';
  score += 100;
  correctCount++;
  scoreVal.textContent = score;

  const blank = document.getElementById('blank-display');
  if (blank) blank.textContent = q.answer;

  document.querySelectorAll('.choice-chip').forEach(chip => {
    chip.classList.remove('highlight');
    if (normalize(chip.dataset.value) === normalize(q.answer)) {
      chip.classList.add('correct-done');
    }
  });

  // ボス戦中の処理
  if (isBossBattle) {
    bossComboCount++;
    updateBossCombo();

    if (bossComboCount >= BOSS_COMBO_REQUIRED) {
      // ボス撃破！
      feedback.textContent = 'ボス撃破！称号解放！';
      endBossBattle(true);
      dropMoney();
      dropMoney(); // ボーナスでもう一回
      // 本気モードならポーションドロップ判定
      if (gameMode === 'mission') tryDropItem();
      showExplanation(q);
      showNextButton();
    } else {
      // まだ続く - ダメージエフェクトだけ見せて次の問題へ
      feedback.textContent = `正解！ あと${BOSS_COMBO_REQUIRED - bossComboCount}問！`;
      showDamageEffect();
      showExplanation(q);
      showNextButton();
    }
  } else {
    // 通常戦闘
    feedback.textContent = '正解！すごい！';
    defeatMonster();
    dropMoney();
    // 本気モードならポーションドロップ判定
    if (gameMode === 'mission') tryDropItem();
    showExplanation(q);
    showNextButton();
  }
}

function handleWrong(q, wrongAnswer) {
  stopTimer();
  stopTimerSound();
  fadeOutMonster();
  showPlayerDamage();
  typingInput.disabled = true;
  typingInput.classList.add('wrong');
  wrongCount++;

  // ボス戦中ならコンボリセット
  if (isBossBattle) {
    resetBossCombo();
    feedback.textContent = `残念！コンボが途切れた！正解は「${q.answer}」`;
  } else {
    feedback.textContent = `残念！正解は「${q.answer}」でした`;
  }
  feedback.className = 'wrong';

  const blank = document.getElementById('blank-display');
  if (blank) {
    blank.textContent = q.answer;
    blank.style.borderColor = '#f44336';
  }

  document.querySelectorAll('.choice-chip').forEach(chip => {
    chip.classList.remove('highlight');
    if (normalize(chip.dataset.value) === normalize(q.answer)) {
      chip.classList.add('correct-done');
    } else if (normalize(chip.dataset.value) === normalize(wrongAnswer)) {
      chip.classList.add('wrong-done');
    }
  });

  showExplanation(q);

  // 本気モードの場合、HPダメージ → HP0ならゲームオーバー
  if (gameMode === 'mission') {
    const isDead = dealDamageToPlayer();
    if (isDead) {
      showMissionGameOver('HP消滅');
    } else {
      showNextButton();
    }
  } else {
    showNextButton();
  }
}

function showExplanation(q) {
  explanationBox.style.display = 'block';
  explanationTxt.textContent = q.explanation;
}

// ---------- 本気モード ゲームオーバー ----------
function showMissionGameOver(reason) {
  const reasonText = reason === 'HP消滅'
    ? `第${currentIndex + 1}問でHPが0に！`
    : `第${currentIndex + 1}問で敗北！`;
  goReason.textContent = reasonText;

  gameOverOverlay.style.display = 'flex';

  // 2秒後にリザルト画面へ
  setTimeout(() => {
    gameOverOverlay.style.display = 'none';
    showMissionResult();
  }, 2000);
}

// ---------- 「次へ」ボタン制御 ----------
function showNextButton() {
  waitingForNext = true;
  if (currentIndex >= questions.length - 1) {
    nextBtn.textContent = '結果を見る';
  } else {
    nextBtn.textContent = '次の問題へ';
  }
  nextBtnArea.style.display = 'block';
  nextBtn.focus();
}

function hideNextButton() {
  waitingForNext = false;
  nextBtnArea.style.display = 'none';
}

function proceedToNext() {
  if (!waitingForNext) return;
  hideNextButton();
  currentIndex++;
  if (currentIndex >= questions.length) {
    if (gameMode === 'mission') {
      showMissionResult();
    } else {
      showResult();
    }
  } else {
    showQuestion();
  }
}

nextBtn.addEventListener('click', proceedToNext);

document.addEventListener('keydown', (e) => {
  if (e.key === ' ' && waitingForNext) {
    e.preventDefault();
    proceedToNext();
  }
  // アイテム使用はクリックのみに変更（キー入力と被るため）
});

// ---------- 練習モード結果画面 ----------
function showResult() {
  gameScreen.classList.add('hidden');
  searchSidePanel.style.display = 'none';
  document.body.classList.remove('panel-open');
  hideTimer();
  resetBgm();
  resultScreen.style.display = 'block';

  document.getElementById('res-correct').textContent = correctCount;
  document.getElementById('res-wrong').textContent = wrongCount;
  document.getElementById('res-score').textContent = score;
  document.getElementById('res-gold').textContent = totalGold.toLocaleString();

  const rate = correctCount / questions.length;
  let msg = '';
  if (rate === 1) {
    msg = 'パーフェクト！IT用語マスターだね！';
  } else if (rate >= 0.8) {
    msg = 'すばらしい！ほとんど正解できたね！';
  } else if (rate >= 0.6) {
    msg = 'いい調子！もう少しで合格ラインだよ！';
  } else if (rate >= 0.4) {
    msg = 'まずまず！繰り返し遊んで覚えよう！';
  } else {
    msg = 'もう一度チャレンジしてみよう！\n繰り返すうちにきっと覚えられるよ！';
  }
  document.getElementById('result-message').textContent = msg;
}

// ---------- 称号システム ----------
function getMissionTitle(streak) {
  if (streak >= 100) return { name: 'IT伝説王',       css: 'rank-legend',   desc: '全問制覇！ 伝説に名を刻んだ！' };
  if (streak >= 90)  return { name: 'ITゴッド',        css: 'rank-legend',   desc: 'あと少しで伝説だ！' };
  if (streak >= 80)  return { name: 'IT博士',          css: 'rank-master',   desc: '誰もが認めるIT博士！' };
  if (streak >= 70)  return { name: 'ITマスター',      css: 'rank-master',   desc: 'IT用語を極めし者！' };
  if (streak >= 60)  return { name: 'IT賢者',          css: 'rank-diamond',  desc: '知識が光り輝いている！' };
  if (streak >= 50)  return { name: 'IT魔法使い',      css: 'rank-diamond',  desc: 'IT用語を自在に操る！' };
  if (streak >= 40)  return { name: 'IT勇者',          css: 'rank-platinum', desc: 'どんな問題にも立ち向かう勇者！' };
  if (streak >= 30)  return { name: 'IT騎士',          css: 'rank-gold',     desc: '知識の剣で戦える騎士だ！' };
  if (streak >= 20)  return { name: 'IT冒険者',        css: 'rank-silver',   desc: 'IT世界の冒険が本格化！' };
  if (streak >= 10)  return { name: 'IT見習い',        css: 'rank-bronze',   desc: 'IT用語の世界に一歩踏み出した！' };
  return              { name: 'かけだしタイパー', css: 'rank-beginner', desc: 'まずは10問連続正解を目指そう！' };
}

// ---------- 本気モード結果画面 ----------
function showMissionResult() {
  gameScreen.classList.add('hidden');
  searchSidePanel.style.display = 'none';
  document.body.classList.remove('panel-open');
  stopTimer();
  hideTimer();
  resetBgm();

  // レコード作成（名前はまだ未設定）
  const record = {
    streak: correctCount,
    total: questions.length,
    category: getSelectedCategory(),
    date: new Date().toISOString(),
    name: '',
    gold: totalGold,
    wrongCount: wrongCount
  };

  // 名前入力画面を表示 → 入力後にリザルト画面へ
  showNameInput(record);
}

function showMissionResultScreen(record) {
  const records = getMissionRecords();

  resultScreen.style.display = 'block';

  const isAllClear = record.streak === record.total;

  // 次の称号への案内メッセージ
  let msg = '';
  if (isAllClear) {
    msg = '全問制覇おめでとう！ 君はIT伝説王だ！';
  } else {
    const nextThresholds = [10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
    const nextTarget = nextThresholds.find(t => t > record.streak);
    if (nextTarget) {
      const nextTitle = getMissionTitle(nextTarget);
      msg = `次の称号「${nextTitle.name}」まであと ${nextTarget - record.streak} 問！ 挑戦し続けよう！`;
    } else {
      msg = 'すごい記録！ さらなる高みを目指そう！';
    }
  }

  // ランキングHTML作成
  let rankingHTML = '';
  if (records.length > 0) {
    rankingHTML = `
      <div class="ranking-section">
        <h3>ランキング</h3>
        <table class="ranking-table">
          <thead>
            <tr>
              <th>順位</th>
              <th>名前</th>
              <th>連続正解</th>
              <th>💰 ゴールド</th>
              <th>称号</th>
              <th>日時</th>
            </tr>
          </thead>
          <tbody>
    `;
    records.forEach((r, i) => {
      const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
      const isCurrent = r.date === record.date && r.streak === record.streak;
      const d = new Date(r.date);
      const dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      const t = getMissionTitle(r.streak);
      const name = r.name || '---';
      const goldStr = (r.gold || 0).toLocaleString();
      rankingHTML += `
        <tr class="${isCurrent ? 'current-record' : ''}">
          <td><span class="rank-num ${rankClass}">${i + 1}</span></td>
          <td style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(name)}</td>
          <td>${r.streak} / ${r.total}</td>
          <td style="color:#ffd700;font-weight:bold;">${goldStr} G</td>
          <td><span style="color:${getColorForCss(t.css)};font-size:0.78rem;">${t.name}</span></td>
          <td>${dateStr}</td>
        </tr>
      `;
    });
    rankingHTML += '</tbody></table></div>';
  }

  const title = getMissionTitle(record.streak);
  const streakCount = record.streak;
  const totalCount = record.total;
  const wrongNum = record.wrongCount || 0;
  const scoreNum = streakCount * 100;

  resultScreen.innerHTML = `
    <h2 class="mission-result-header">${isAllClear ? 'ALL CLEAR!' : 'RESULT'}</h2>
    <div class="mission-streak">
      ${streakCount}<span class="streak-label">問正解 / 全${totalCount}問</span>
    </div>
    <div class="title-badge ${title.css}">${title.name}</div>
    <div class="title-sub">${title.desc}</div>
    <div class="mission-detail-stats">
      <div class="stat-box">
        <div class="num" style="color:#4caf50;">${streakCount}</div>
        <div class="label">正解</div>
      </div>
      <div class="stat-box">
        <div class="num" style="color:#f44336;">${wrongNum}</div>
        <div class="label">不正解</div>
      </div>
      <div class="stat-box">
        <div class="num" style="color:#00d2ff;">${scoreNum}</div>
        <div class="label">スコア</div>
      </div>
      <div class="stat-box">
        <div class="num" style="color:#ffd700;">${(record.gold || 0).toLocaleString()}</div>
        <div class="label">💰 獲得ゴールド</div>
      </div>
    </div>
    <p class="result-message">${msg}</p>
    ${rankingHTML}
    <div style="margin-top:24px;">
      <button class="btn btn-primary" id="retry-btn-mission">もう一度挑戦する</button>
    </div>
  `;

  document.getElementById('retry-btn-mission').addEventListener('click', () => {
    resultScreen.style.display = 'none';
    restoreResultScreen();
    startScreen.classList.remove('hidden');
    updateDashboard();
    updateQCountInfo();
  });
}

// 練習モードのresult-screenの元のHTMLを保持
const originalResultHTML = `
  <h2>結果発表！</h2>
  <div class="result-stats">
    <div class="stat-box">
      <div class="num" id="res-correct">0</div>
      <div class="label">正解</div>
    </div>
    <div class="stat-box">
      <div class="num" id="res-wrong">0</div>
      <div class="label">不正解</div>
    </div>
    <div class="stat-box">
      <div class="num" id="res-score">0</div>
      <div class="label">スコア</div>
    </div>
    <div class="stat-box">
      <div class="num" id="res-gold" style="color:#ffd700;">0</div>
      <div class="label">💰 獲得ゴールド</div>
    </div>
  </div>
  <p class="result-message" id="result-message"></p>
  <button class="btn btn-primary" id="retry-btn">もう一度遊ぶ</button>
`;

function restoreResultScreen() {
  resultScreen.innerHTML = originalResultHTML;
  document.getElementById('retry-btn').addEventListener('click', () => {
    resultScreen.style.display = 'none';
    startScreen.classList.remove('hidden');
    updateDashboard();
    updateQCountInfo();
  });
}

// ---------- localStorage記録管理 ----------
const STORAGE_KEY = 'itpassport_mission_records';
const PLAYER_NAME_KEY = 'itpassport_player_name';

function getMissionRecords() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    return JSON.parse(data);
  } catch {
    return [];
  }
}

function saveMissionRecord(record) {
  const records = getMissionRecords();
  records.push(record);
  // 稼いだゴールドでソート（多い順）
  records.sort((a, b) => (b.gold || 0) - (a.gold || 0));
  const top10 = records.slice(0, 10);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(top10));
}

function getSavedPlayerName() {
  return localStorage.getItem(PLAYER_NAME_KEY) || '';
}

function savePlayerName(name) {
  localStorage.setItem(PLAYER_NAME_KEY, name);
}

// ---------- ダッシュボード表示 ----------
function updateDashboard() {
  const records = getMissionRecords();
  const myBestCard = document.getElementById('my-best-card');
  const myBestContent = document.getElementById('my-best-content');
  const rankingContent = document.getElementById('dashboard-ranking-content');

  updateTitleList();

  if (records.length === 0) {
    myBestCard.style.display = 'none';
    rankingContent.innerHTML = '<p style="color:#888;text-align:center;padding:20px;">まだ記録がありません<br>本気モードで遊んでランクインしよう！</p>';
    return;
  }

  // 自分の最高記録（名前が保存されていれば自分の記録、なければ全体1位）
  const playerName = getSavedPlayerName();
  let bestRecord = records[0]; // 全体1位
  if (playerName) {
    const myRecords = records.filter(r => r.name === playerName);
    if (myRecords.length > 0) {
      bestRecord = myRecords[0]; // 自分のベスト
    }
  }

  const bestTitle = getMissionTitle(bestRecord.streak);
  myBestCard.style.display = 'block';
  const bestGold = (bestRecord.gold || 0).toLocaleString();
  myBestContent.innerHTML = `
    <div class="best-streak">${bestRecord.streak}<span class="best-unit"> 問連続正解</span></div>
    <div style="color:#ffd700;font-size:1.1rem;font-weight:bold;margin:6px 0;">💰 ${bestGold} G</div>
    <span class="best-title-badge title-badge ${bestTitle.css}" style="font-size:0.85rem;padding:5px 14px;margin:0;">${bestTitle.name}</span>
  `;

  // ランキングテーブル（ゴールド順）
  let html = `<table>
    <thead><tr>
      <th>順位</th><th>名前</th><th style="color:#ffd700;">💰 ゴールド</th><th>連続正解</th><th>称号</th><th>日時</th>
    </tr></thead><tbody>`;
  records.forEach((r, i) => {
    const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
    const d = new Date(r.date);
    const dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    const t = getMissionTitle(r.streak);
    const name = r.name || '---';
    const goldStr = (r.gold || 0).toLocaleString();
    html += `<tr>
      <td><span class="rank-num ${rankClass}">${i+1}</span></td>
      <td class="name-cell">${escapeHtml(name)}</td>
      <td style="color:#ffd700;font-weight:bold;">${goldStr} G</td>
      <td>${r.streak} / ${r.total}</td>
      <td><span style="color:${getColorForCss(t.css)};font-size:0.78rem;">${t.name}</span></td>
      <td>${dateStr}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  rankingContent.innerHTML = html;
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function getColorForCss(css) {
  const map = {
    'rank-beginner': '#9e9e9e',
    'rank-bronze': '#cd7f32',
    'rank-silver': '#c0c0c0',
    'rank-gold': '#ffd700',
    'rank-platinum': '#00d2ff',
    'rank-diamond': '#b9f2ff',
    'rank-master': '#ffb74d',
    'rank-legend': '#ffd700'
  };
  return map[css] || '#ccc';
}

// ---------- 称号一覧（シークレット方式） ----------
const TITLE_STORAGE_KEY = 'itpassport_unlocked_titles';
const TITLE_THRESHOLDS = [
  { min: 0,   name: 'かけだしタイパー', css: 'rank-beginner' },
  { min: 10,  name: 'IT見習い',        css: 'rank-bronze' },
  { min: 20,  name: 'IT冒険者',        css: 'rank-silver' },
  { min: 30,  name: 'IT騎士',          css: 'rank-gold' },
  { min: 40,  name: 'IT勇者',          css: 'rank-platinum' },
  { min: 50,  name: 'IT魔法使い',      css: 'rank-diamond' },
  { min: 60,  name: 'IT賢者',          css: 'rank-diamond' },
  { min: 70,  name: 'ITマスター',      css: 'rank-master' },
  { min: 80,  name: 'IT博士',          css: 'rank-master' },
  { min: 90,  name: 'ITゴッド',        css: 'rank-legend' },
  { min: 100, name: 'IT伝説王',       css: 'rank-legend' }
];

function getUnlockedTitles() {
  try {
    const data = localStorage.getItem(TITLE_STORAGE_KEY);
    if (!data) return {};
    return JSON.parse(data);
  } catch {
    return {};
  }
}

function saveUnlockedTitles(titles) {
  localStorage.setItem(TITLE_STORAGE_KEY, JSON.stringify(titles));
}

function unlockTitle(streak, playerName) {
  const unlocked = getUnlockedTitles();
  let changed = false;
  TITLE_THRESHOLDS.forEach(t => {
    const key = String(t.min);
    if (streak >= t.min && !unlocked[key]) {
      unlocked[key] = {
        name: t.name,
        unlockedBy: playerName || ''
      };
      changed = true;
    }
  });
  if (changed) {
    saveUnlockedTitles(unlocked);
  }
}

function updateTitleList() {
  const content = document.getElementById('title-list-content');
  const unlocked = getUnlockedTitles();

  // かけだしタイパー（0問）は常に解放済み
  if (!unlocked['0']) {
    unlocked['0'] = { name: 'かけだしタイパー', unlockedBy: '' };
    saveUnlockedTitles(unlocked);
  }

  let html = `<table>
    <thead><tr>
      <th>正解数</th><th>称号</th><th>解放者</th>
    </tr></thead><tbody>`;

  TITLE_THRESHOLDS.forEach(t => {
    const key = String(t.min);
    const info = unlocked[key];
    if (info) {
      const color = getColorForCss(t.css);
      const byName = info.unlockedBy ? escapeHtml(info.unlockedBy) : '';
      html += `<tr>
        <td>${t.min}問</td>
        <td><span class="title-name" style="color:${color};">${t.name}</span></td>
        <td class="unlocked-by">${byName}</td>
      </tr>`;
    } else {
      html += `<tr class="secret">
        <td>${t.min}問</td>
        <td>??? シークレット ???</td>
        <td>---</td>
      </tr>`;
    }
  });

  html += '</tbody></table>';
  content.innerHTML = html;
}

// ---------- 名前入力フロー ----------
const nameInputOverlay = document.getElementById('name-input-overlay');
const playerNameInput = document.getElementById('player-name-input');
const nameSaveBtn = document.getElementById('name-save-btn');
const nameSkipBtn = document.getElementById('name-skip-btn');
let pendingRecord = null;

function showNameInput(record) {
  pendingRecord = record;
  const savedName = getSavedPlayerName();
  playerNameInput.value = savedName;
  document.getElementById('name-input-desc').textContent =
    `${record.streak}問連続正解！ 名前を入力してランキングに登録しよう`;
  nameInputOverlay.style.display = 'flex';
  playerNameInput.focus();
}

function finishNameInput(name) {
  nameInputOverlay.style.display = 'none';
  if (name) {
    savePlayerName(name);
    pendingRecord.name = name;
  } else {
    pendingRecord.name = getSavedPlayerName() || '';
  }
  saveMissionRecord(pendingRecord);
  unlockTitle(pendingRecord.streak, pendingRecord.name);
  showMissionResultScreen(pendingRecord);
  pendingRecord = null;
}

nameSaveBtn.addEventListener('click', () => {
  const name = playerNameInput.value.trim();
  if (!name) {
    playerNameInput.style.borderColor = '#f44336';
    playerNameInput.focus();
    return;
  }
  finishNameInput(name);
});

nameSkipBtn.addEventListener('click', () => {
  finishNameInput('');
});

playerNameInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    nameSaveBtn.click();
  }
  playerNameInput.style.borderColor = 'rgba(255,255,255,0.08)';
});

// ---------- イベント ----------
startBtn.addEventListener('click', startGame);
retryBtn.addEventListener('click', () => {
  resultScreen.style.display = 'none';
  startScreen.classList.remove('hidden');
  updateDashboard();
  updateQCountInfo();
});

// ホームに戻る
function goHome() {
  // ゲームを中断してホーム画面に戻る（ページをリロード）
  stopBgm();
  stopTimerSound();
  location.reload();
}

// ナビゲーション表示/非表示
let isNavVisible = true;
function toggleNavGuide() {
  const navBox = document.getElementById('nav-guide-box');
  const btn = document.getElementById('btn-toggle-nav');
  const statusContainer = document.getElementById('player-status-container');
  if (!navBox) return;

  isNavVisible = !isNavVisible;
  if (isNavVisible) {
    navBox.classList.remove('hidden');
    if (statusContainer) statusContainer.classList.remove('full-width');
    if (btn) {
      btn.textContent = '📖 ナビON';
      btn.classList.remove('off');
    }
  } else {
    navBox.classList.add('hidden');
    if (statusContainer) statusContainer.classList.add('full-width');
    if (btn) {
      btn.textContent = '📖 ナビOFF';
      btn.classList.add('off');
    }
  }
}

// 初期ダッシュボード表示
updateDashboard();
</script>

</body>
</html>
